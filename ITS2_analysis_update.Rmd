---
title: "ITS2  data analysis"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Use this one. other one for code pull refs. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Load library
```{r}   
# rm(list=ls())

library(readxl)
library(phyloseq)
library(janitor)
library(tidyverse)
library(janitor)
library(phyloseq)  # source('http://bioconductor.org/biocLite.R'); biocLite('phyloseq')
library(zoo)
library(stringr)
library(vegan)
library(multcompView)
library("ggpubr")
library(dplyr)
library(plyr)
library(gridExtra)
library(vegan)
library(decontam)
library(RColorBrewer)
library(ggforce)
library(cowplot)  
library(ggplot2)
library(grid)
library(tidyverse)

#set colors
species_colors <- c("Montipora_capitata" = "#E69F00", "Porites_compressa" = "#56B4E9", "Pavona_varians" = "#CC79A7", "Pocillopora_acuta" = "#009E73")

clade_colors <- c("C31" = "goldenrod1", "C31D4" = "darkorange3", "C15cj" = "powderblue", "C15n" = "#0072B2", "C1"="pink1", "C27"="firebrick", "C1d"="palegreen2", "C42_2"="darkgreen")
```

Load phyloseq objects (if starting at analysis)
```{r}
# Load phyloseq objects - not subsampled or relative abundance yet
load("data/Raw_coral_phyloseq.RData") #coral_profile and coralDIV
```

## Data Wrangle - Build phyloseq dataframes using Symportal outputs for Profiles and DIVs
Read in coral ITS2 profiles: "coral_Profiles"
```{r}    
library(janitor)
library(phyloseq)  # BiocManager::install("phyloseq")
library(cowplot)
library(ggrepel)
library(scales)
library(RColorBrewer)
library(MASS)
library(lme4)
library(emmeans)
library(tidyverse)
library(vegan)
library(ggh4x)
library(stringi)
#add metadata to symportal submission data
Symp_sub<-readxl::read_xlsx("Data/ITS2/ITS2_TT17_Matsuda_metadata_2020_update.xlsx", skip = 1)
  Metadata<-read.csv("Data/ACE21_Metadata_Molec_20210317.csv")

# EDIT sample data, add CLADE COL ####
  #Mcap
  Metadata$Clade[Metadata$Parent.ID==363]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==364]<-"C31D4"
  Metadata$Clade[Metadata$Parent.ID==365]<-"C31D4"
  Metadata$Clade[Metadata$Parent.ID==366]<-"C31D4"
  Metadata$Clade[Metadata$Parent.ID==367]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==368]<-"C31D4"
  Metadata$Clade[Metadata$Parent.ID==369]<-"C31D4"
  Metadata$Clade[Metadata$Parent.ID==370]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==371]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==372]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==373]<-"C31"
  Metadata$Clade[Metadata$Parent.ID==374]<-"C31D4"
 #Pcomp
  Metadata$Clade[Metadata$Parent.ID==314]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==317]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==319]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==320]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==321]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==322]<-"C15cj"
  Metadata$Clade[Metadata$Parent.ID==313]<-"C15n"
  Metadata$Clade[Metadata$Parent.ID==315]<-"C15n"
  Metadata$Clade[Metadata$Parent.ID==316]<-"C15n"
  Metadata$Clade[Metadata$Parent.ID==318]<-"C15n"
  Metadata$Clade[Metadata$Parent.ID==323]<-"C15n"
  Metadata$Clade[Metadata$Parent.ID==324]<-"C15n"
  
  #Pvar
  Metadata$Clade[Metadata$Parent.ID==353]<-"C1"
  Metadata$Clade[Metadata$Parent.ID==358]<-"C1"
  Metadata$Clade[Metadata$Parent.ID==361]<-"C1"
  Metadata$Clade[Metadata$Parent.ID==325]<-"C1"
  Metadata$Clade[Metadata$Parent.ID==356]<-"C1"
  Metadata$Clade[Metadata$Parent.ID==351]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==354]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==355]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==357]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==359]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==360]<-"C27"
  Metadata$Clade[Metadata$Parent.ID==362]<-"C27"
  
#Pacu
  Metadata$Clade[Metadata$Parent.ID==311]<-"C42_2"
  Metadata$Clade[Metadata$Parent.ID==301]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==304]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==306]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==303]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==307]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==308]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==310]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==312]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==302]<-"C1d"
  Metadata$Clade[Metadata$Parent.ID==305]<-"C42_2"
  Metadata$Clade[Metadata$Parent.ID==309]<-"C42_2"
  
Metadata$Clade<-as.factor(Metadata$Clade)
Metadata$Clade <- factor(Metadata$Clade, levels = c("C31", "C31D4", "C15cj","C15n","C1","C27","C1d","C42_2"))
  
# merge profile info
 AsymportalPro<-read.csv("Data/Symportal_profile.csv")  
  AsymportalPro2<-merge(Metadata,AsymportalPro, by="Frag.ID") 
  #write.csv(AsymportalPro2,"AsymportalPro2.csv") 

  names(Metadata)[names(Metadata) == "Frag.ID"] <- "sample_name" #change to same ID to merge
Symp_sub_Meta<-left_join(Symp_sub, Metadata, by="sample_name") # merge
Symp_sub_Meta$Parent.ID<-as.factor(as.character(Symp_sub_Meta$Parent.ID))

#Phyloseq object
sam0 <- Symp_sub_Meta
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file  = "Data/ITS2/its2_type_profiles/133_20201216_DBV_20201216T020209.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

library(tidyverse)

otuVIEW<-read_tsv(
  file  = "Data/ITS2/its2_type_profiles/133_20201216_DBV_20201216T020209.profiles.absolute.abund_and_meta.txt") 
otu0 <- read_tsv(
  file  = "Data/ITS2/its2_type_profiles/133_20201216_DBV_20201216T020209.profiles.absolute.abund_and_meta.txt") %>% 
  dplyr::rename(sample_name = 2) %>%
  dplyr::select(-1) %>%
  slice(7:(n() - 2)) %>%               # Keep rows 7 through (n - 2) 
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coral_profile <- phyloseq(otu, tax, sam)
```
Read in coral post-QC sequence variants: "coralDIV_RELA"
```{r}

taxnames <- read_tsv(file  = "Data/ITS2/post_med_seqs/133_20201216_DBV_20201216T020209.seqs.absolute.abund_only.txt",
  n_max = 0) %>%
  dplyr::select(-1) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV

tax <- tax_table(tax1)
otu0 <- read_tsv(
  file  = "Data/ITS2/post_med_seqs/133_20201216_DBV_20201216T020209.seqs.absolute.abund_and_meta.txt") %>%
  dplyr::select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)
coralDIV <- phyloseq(otu, tax, sam)
```
Save phyloseq objects
```{r}
coral_profile <- coral_profile %>%
  subset_samples(!is.na(host_species))

coralDIV2 <- coralDIV %>% 
  subset_samples(!is.na(host_species))

#save(coral_profile, coralDIV2, file = "Data/coral_phyloseq.RData")
```

#Quality Check
Look at low sequence samples and duplicates
```{r}    
LowSamps<-readxl::read_xlsx("Data/ITS2/post_med_seqs/133_20201216_DBV_20201216T020209.seqs.absolute.meta_only.xlsx")
LowSamps_dups<-merge(LowSamps, Metadata, all.x=T)
LowSamps_dups2<-subset(LowSamps_dups, Notes=="Dup")
LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs_log<-log10(LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs)
hist(LowSamps$post_taxa_id_absolute_symbiodiniaceae_seqs_log, breaks=20)
```
Data wrangle: 
Profiles
```{r}
# check out data coral_profile
ntaxa(coral_profile)  #num taxa
nsamples(coral_profile)   #num samples
sample_names(coral_profile)[1:5] #samp names
rank_names(coral_profile) #ranks are DIV and clade
sample_variables(coral_profile) #all metadata cats

# create df of sample data to view 
sample.data <- as(sample_data(coral_profile), "data.frame") #create sample data frame to view
sample.data$LibrarySize <- sample_sums(coral_profile)
sample.data <- sample.data[order(sample.data$LibrarySize),]
sample.data$Index <- seq(nrow(sample.data))
ggplot(data = sample.data, aes(x=Index, y=LibrarySize, color = sample_type)) +
  geom_point()

##Sample filtering and rarefaction
coral_profile2<-coral_profile #make copy
#remove duplicates that failed
coral_profile2 <- subset_samples(coral_profile2, ID != "S1110B")
coral_profile2 <- subset_samples(coral_profile2, ID != "S1166")
coral_profile2 <- subset_samples(coral_profile2, ID != "S1388b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S1857")
coral_profile2 <- subset_samples(coral_profile2, ID != "S3085")
coral_profile2 <- subset_samples(coral_profile2, ID != "S3149b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S3149")
coral_profile2 <- subset_samples(coral_profile2, ID != "S3477a")
coral_profile2 <- subset_samples(coral_profile2, ID != "S761b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S775b")
coral_profile2 <- subset_samples(coral_profile2, ID != "SN134")
coral_profile2 <- subset_samples(coral_profile2, ID != "SN198b")
coral_profile2 <- subset_samples(coral_profile2, ID != "SN209b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S3085b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S1857")
coral_profile2 <- subset_samples(coral_profile2, ID != "S761b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S198b")
coral_profile2 <- subset_samples(coral_profile2, ID != "SN127")
coral_profile2 <- subset_samples(coral_profile2, ID != "SN98b")
coral_profile2 <- subset_samples(coral_profile2, ID != "S2893")

saveRDS(coral_profile2, file = "coral_profile2_cleaned.RDS", compress = TRUE) #save!
```
DIVs: remove samples with under 7k, remove duplicated samples
```{r}         
## check out data
ntaxa(coralDIV2)  #num taxa
nsamples(coralDIV2)   #num samples
sample_names(coralDIV2)[1:5] #samp names
rank_names(coralDIV2) #ranks are DIV and clade
sample_variables(coralDIV2) #all metadata cats

# create df of sample data to view 
sample.data <- as(sample_data(coralDIV2), "data.frame") #create sample data frame to view
sample.data$LibrarySize <- sample_sums(coralDIV2)
sample.data <- sample.data[order(sample.data$LibrarySize),]
sample.data$Index <- seq(nrow(sample.data))
ggplot(data = sample.data, aes(x=Index, y=LibrarySize, color = sample_type)) +
  geom_point()

#Remove all samples with <5000 reads and create sample data
#These data also useful for beta diversity analyses (non-rarefied)
coralDIV2_nonrare <- prune_samples(sample_sums(coralDIV2)>=7000, coralDIV2) # remove samps <7000, save as new obj
coralDIV2_data.nonrare <- as(sample_data(coralDIV2_nonrare), "data.frame")

##Sample filtering and rarefaction
#remove duplicates that failed
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S1110B")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S1166")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S1388b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S1857")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S3085")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S3149b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S3149")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S3477a")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S761b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S775b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "SN134")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "SN198b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "SN209b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S3085b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S1857")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S761b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S198b")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "SN127")
coralDIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "SN98b")
coral_DIV2_nonrare <- subset_samples(coralDIV2_nonrare, ID != "S2893")
coral_DIV2_data.nonrare <- as(sample_data(coral_DIV2_nonrare), "data.frame")

saveRDS(coral_DIV2_nonrare, file = "coral_DIV2_nonrare.RDS", compress = TRUE)

#Make a rarefied phyloseq object 
coral_DIV2_rare <- rarefy_even_depth(coral_DIV2_nonrare, sample.size = 7000, rngseed = 711)   #this removed 17 DIVs
sample_sums(coral_DIV2_rare) #Double check that the sub-sampling worked, this should report 7000 for each sample
coral_DIV2rare_sd <- as(sample_data(coral_DIV2_rare), "data.frame")

#Make relative abundance df
coral_DIV2_rare_Rel <- transform_sample_counts(coral_DIV2_rare, function(x) 100 * x/sum(x))

saveRDS(coral_DIV2_rare_Rel, file = "coral_DIV2_rare_Rel.RDS", compress = TRUE)
```

Data frames for analysis:
coral_DIV2_nonrare: DIV, not subsampled
coral_DIV2_rare: DIV, subsampled
coral_DIV2rare_sd: sample data
coral_DIV2_rare_Rel: DIV, subsampled, Relative Abundance
coral_profile2: Profiles

# Visualizations 
DIVs: Bar plots for high level visualization
```{r}  
#try glom use raw counts its2.s2
Mcap_its2.s2<-subset_samples(coral_DIV2_rare, Species=="Montipora_capitata") #use raw counts here

Mcap_its2 <- Mcap_its2.s2 %>% 
  tax_glom(taxrank = "DIV", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
Mcap_its2.s2.melt <- psmelt(Mcap_its2)

Mcap_its2.s2.melt$Code<-paste(Mcap_its2.s2.melt$Treatment, Mcap_its2.s2.melt$Time.Point)
Mcap_its2.s2.melt$Parent.ID <- factor(Mcap_its2.s2.melt$Parent.ID, levels = c("363",  "372","373","371", "367","370","364",  "365","366","368",  "369","374"))
Mcap_its2.s2.melt$Code <- factor(Mcap_its2.s2.melt$Code, levels = c("Ambient T0",  "Ambient T1",
                                                                    "Ambient TF","High T0",  "High T1","High TF"))
nb.cols <- 400
mycolors <- colorRampPalette(brewer.pal(11, "RdYlBu"))(nb.cols)

mcap.p <- ggplot(Mcap_its2.s2.melt, aes(x = Parent.ID, y = Abundance, fill = DIV)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=mycolors) +
  ylab("Relative Abundance") +
  xlab("Sample Label") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(legend.position = "none")
mcap.p +  facet_wrap(~ Code, nrow=2)


#try glom use raw counts its2.s2
Pcomp_its2.s2<-subset_samples(coral_DIV2_rare, Species=="Porites_compressa") #use raw counts here

Pcomp_its2 <- Pcomp_its2.s2 %>% 
  tax_glom(taxrank = "DIV", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
Pcomp_its2.s2.melt <- psmelt(Pcomp_its2)

Pcomp_its2.s2.melt$Code<-paste(Pcomp_its2.s2.melt$Treatment, Pcomp_its2.s2.melt$Time.Point)
Pcomp_its2.s2.melt$Parent.ID <- factor(Pcomp_its2.s2.melt$Parent.ID, levels = c("313",  "314","315","316", "317","318","319",  "320", "322","323",  "324","321"))
Pcomp_its2.s2.melt$Code <- factor(Pcomp_its2.s2.melt$Code, levels = c("Ambient T0",  "Ambient T1",
                                                                    "Ambient TF","High T0",  "High T1","High TF"))
nb.cols <- 400
mycolors <- colorRampPalette(brewer.pal(11, "RdYlBu"))(nb.cols)

Pcomp.p <- ggplot(Pcomp_its2.s2.melt, aes(x = Parent.ID, y = Abundance, fill = DIV)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=mycolors) +
  ylab("Relative Abundance") +
  xlab("Sample Label") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(legend.position = "none")
Pcomp.p +  facet_wrap(~ Code, nrow=2)

#try glom use raw counts its2.s2
Pvar_its2.s2<-subset_samples(coral_DIV2_rare, Species=="Pavona_varians") #use raw counts here

Pvar_its2 <- Pvar_its2.s2 %>% 
  tax_glom(taxrank = "DIV", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
Pvar_its2.s2.melt <- psmelt(Pvar_its2)

Pvar_its2.s2.melt$Code<-paste(Pvar_its2.s2.melt$Treatment, Pvar_its2.s2.melt$Time.Point)
Pvar_its2.s2.melt$Parent.ID <- factor(Pvar_its2.s2.melt$Parent.ID, levels = c("361",  "358","353","356", "325","354",  "359", "357","362", "351", "355","360"))
Pvar_its2.s2.melt$Code <- factor(Pvar_its2.s2.melt$Code, levels = c("Ambient T0",  "Ambient T1",
                                                                    "Ambient TF","High T0",  "High T1","High TF"))
nb.cols <- 400
mycolors <- colorRampPalette(brewer.pal(11, "RdYlBu"))(nb.cols)

Pvar.p <- ggplot(Pvar_its2.s2.melt, aes(x = Parent.ID, y = Abundance, fill = DIV)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=mycolors) +
  ylab("Relative Abundance") +
  xlab("Sample Label") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(legend.position = "none")
Pvar.p +  facet_wrap(~ Code, nrow=2)


#try glom use raw counts its2.s2
Pacu_its2.s2<-subset_samples(coral_DIV2_rare, Species=="Pocillopora_acuta") #use raw counts here

Pacu_its2 <- Pacu_its2.s2 %>% 
  tax_glom(taxrank = "DIV", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
Pacu_its2.s2.melt <- psmelt(Pacu_its2)

Pacu_its2.s2.melt$Code<-paste(Pacu_its2.s2.melt$Treatment, Pacu_its2.s2.melt$Time.Point)
Pacu_its2.s2.melt$Parent.ID <- factor(Pacu_its2.s2.melt$Parent.ID, levels = c("304",  "308","312","303", "306","302",  "310", "301","311", "307", "309","305"))
Pacu_its2.s2.melt$Code <- factor(Pacu_its2.s2.melt$Code, levels = c("Ambient T0",  "Ambient T1",
                                                                    "Ambient TF","High T0",  "High T1","High TF"))
nb.cols <- 400
mycolors <- colorRampPalette(brewer.pal(11, "RdYlBu"))(nb.cols)

Pacu.p <- ggplot(Pacu_its2.s2.melt, aes(x = Parent.ID, y = Abundance, fill = DIV)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=mycolors) +
  ylab("Relative Abundance") +
  xlab("Sample Label") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(legend.position = "none")
Pacu.p +  facet_wrap(~ Code, nrow=2)
```

#T0 only bar plots: Figure 3A
```{r}
#PROFILES coral_profile2 df
#try glom use raw counts 
profiles_T0<-subset_samples(coral_profile2, Time.Point=="T0") #use raw counts df here

T0_its2 <- profiles_T0 %>%  #make relative abundance
  tax_glom(taxrank = "its2_type_profile", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
T0_its2.melt <- psmelt(T0_its2)

#Change so all Cs are shades of Blue and all Ds are shades of orange
# Define a color palette with 30 shades of blue
blue_palette <- colorRampPalette(c("lightblue", "blue", "darkblue"))(30)
orange_palette <- colorRampPalette(c("lightyellow", "orange", "darkorange"))(3)

# Display the colors
barplot(rep(1, 30), col = blue_palette, border = NA, space = 0, main = "30 Shades of Blue")
barplot(rep(1, 3), col = orange_palette, border = NA, space = 0, main = "3 Shades of Orange")
# Combine palettes
mycolors <- c(blue_palette, orange_palette)


# Arrange and create an ordered factor for Sample based on Clade within each Species
T0_its2.melt1 <- T0_its2.melt %>%
  arrange(Species, Clade, Sample) %>%
  mutate(Sample = factor(Sample, levels = unique(Sample)))

T0_its2.melt1 <- T0_its2.melt1 %>%
  mutate(Species = factor(Species, levels = c("Montipora_capitata", "Porites_compressa", "Pavona_varians", "Pocillopora_acuta")))  # Adjust order as needed

# Ensure colors are assigned based on Clade groups in `its2_type_profile`
T0.p <- ggplot(T0_its2.melt1, aes(x = Sample, y = Abundance, fill = its2_type_profile)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = mycolors) +
  ylab("Relative Abundance") +
  xlab("") +
  theme_minimal() +  # Apply minimal theme (white background, no grid)
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),  # Rotate x-axis labels
    panel.grid = element_blank(),  # Remove grid lines
    plot.background = element_blank(),
     # legend.position = "none" ,# Remove the outer background
    axis.line = element_line(color = "black")  # Add black axis lines
  )

T0_ITS2_samp <- T0.p + facet_wrap(~Species, scales = "free_x", nrow = 1)
T0_ITS2_samp

#ggsave("ITS2_T0_samp_leg.pdf", plot = T0_ITS2_samp, device = "pdf", width = 20, height = 6)


#Make T0 with DIVs ####
#try glom use raw counts 
DIVs_T0<-subset_samples(coralDIV2, Time.Point=="T0") #use raw counts df here

T0_its2DIV <- DIVs_T0 %>%  #make relative abundance
  tax_glom(taxrank = "DIV", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
T0_its2DIV.melt <- psmelt(T0_its2DIV)

# Extract the sample order (should now work) from Clade plot
sample_order <- levels(T0_its2.melt1$Sample)

# Check if sample_order is not NULL
print(sample_order)  # Should print a list of sample names in order
T0_its2DIV.melt$Sample
T0_its2DIV.melt <- T0_its2DIV.melt %>%
  mutate(Sample = factor(Sample, levels = sample_order))

T0_its2DIV.melt <- T0_its2DIV.melt %>%
  mutate(Species = factor(Species, levels = c("Montipora_capitata", "Porites_compressa", "Pavona_varians", "Pocillopora_acuta")))  # Adjust order as needed

# Ensure colors are assigned based on Clade groups in `its2_type_profile`
T0DIV.p  <- ggplot(T0_its2DIV.melt, aes(x = Sample, y = Abundance, fill = DIV)) +
  geom_bar(stat = "identity", color = "black", size = 0.2) +  # Add black outlines
  ylab("Relative Abundance") +
  xlab("") +
  theme_minimal() +  # Apply minimal theme (white background, no grid)
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),  # Rotate x-axis labels
    panel.grid = element_blank(),  # Remove grid lines
    plot.background = element_blank(),  # Remove the outer background
    axis.line = element_line(color = "black"),  # Add black axis lines
    legend.position = "none"  # Remove the legend
  );T0DIV.p


T0_ITS2_DIV_samp <- T0DIV.p + facet_wrap(~Species, scales = "free_x", nrow = 1)
T0_ITS2_DIV_samp

#ggsave("ITS2_T0_DIV_samp.pdf", plot = T0_ITS2_DIV_samp, device = "pdf", width = 20, height = 6)


#by relative abundance by species
# Calculate relative abundance within each Species
# Calculate relative abundance excluding zero values
T0_its2.melt2 <- T0_its2.melt %>%
  filter(Abundance > 0) %>%  # Exclude rows with zero abundance
  group_by(Species) %>%
  mutate(RelativeAbundance = Abundance / sum(Abundance) * 100) %>%
  ungroup()

print(T0_its2.melt2 %>% group_by(Species) %>% summarize(Total = sum(RelativeAbundance)))

# Plot with relative abundance as percentage (100% stacked bars) This is showing up as 12 total samples, which I can't get to turn into Relative abundance !!!!!!!!!!!

#####################################################################################
Hannah code

percent.phy <- bac.ambient.ra %>% 
  tax_glom(taxrank = "Phylum") 
perc.melt.phy <- psmelt(percent.phy)

sum.phy <- ddply(perc.melt.phy, c("Phylum", "Species"), summarise,
                 N = length(Abundance),
                 mean = mean(Abundance),
                 sd = sd(Abundance), 
                 se = sd/sqrt(N)
)

ggplot(sum.phy, aes(x = Species, y = mean, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ggtitle("Communities by Phyla at Ambient Temperatures (T0)") +
  #guides(fill=NULL) +
  xlab("/nHost Species") +
  ylab("Mean Relative Abundance") +
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA, linetype = 1, linewidth = 0.5))

```

#Beta Diversity - All Species
coral_DIV2_rare_Rel df
```{r}              
DIV_RelA_stats<- coral_DIV2_rare_Rel #make a copy
otu_table(DIV_RelA_stats)[1:5, 1:5] #check rela worked

#bray curtis presence-absense and abundance
```
#### T0 only ######
Figure 2C
```{r}
DIV_RelA_stats.T0<-subset_samples(DIV_RelA_stats, Time.Point=="T0")
  DIV_RelA_stats.T0 = prune_taxa(taxa_sums(DIV_RelA_stats.T0) > 0, DIV_RelA_stats.T0) #this removes any OTU with 0s

  #save as object for mantel test in the 16s rmd
  saveRDS(DIV_RelA_stats.T0,"ITS2_T0_phyloseq.rds")
  
#bray curtis presence-absense and abundance
#all speices
set.seed(30)

#make bray curtis data matrix
bc.all.T0 <- phyloseq::distance(DIV_RelA_stats.T0, method = "bray")
  samp.df.T0 <- as(sample_data(DIV_RelA_stats.T0), "data.frame") #sample df
#adonis test
adonis2(bc.all.T0 ~ Species, data = samp.df.T0)
    
# Homogeneity of dispersion test
betaAll <- betadisper(bc.all.T0, samp.df.T0$Species)
perm<-permutest(betaAll, pairwise = T) 
(bc.all.HSD <- TukeyHSD(betaAll)) #do you need?
plot(bc.all.HSD)

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.T0 <- ordinate(DIV_RelA_stats.T0, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.T0)
scores.ord.DIV_RelA_stats.T0 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.T0, display="sites"))) #make df
scores.ord.DIV_RelA_stats.T0$Treatment <- samp.df.T0$Treatment
scores.ord.DIV_RelA_stats.T0$Species <- samp.df.T0$Species
scores.ord.DIV_RelA_stats.T0$Clade <- samp.df.T0$Clade
scores.ord.DIV_RelA_stats.T0$Code <- paste(samp.df.T0$Species,samp.df.T0$Clade)

# FIGURE 2C ITS2 T0 - shown by Profile group  ####

its2plot<-ggplot(scores.ord.DIV_RelA_stats.T0, aes(x = NMDS1, y = NMDS2, color = Code)) + 
  geom_point(size = 2) +
    stat_ellipse(aes(fill = Code), level = 0.95, alpha = 0.2, linetype = 1, size = 0.5, geom = "polygon") + 
scale_color_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen")) +  # Set colors for points
   scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+   
  xlim(-3, 3) +  # Set lower bound of x-axis to -2.5
    ylim(-3, 3) +  # Set lower bound of x-axis to -2.5
  ggtitle("NMDS - Algal Symbiont Communities") +
   theme_classic() +
  theme(
    axis.text = element_text(size = 9),        # Axis text size
    axis.title = element_text(size = 9),       # Axis labels size
    #legend.position = "none",                   # Remove legend
    plot.title = element_text(size = 12)        # Title size
  )+
  coord_fixed(ratio = 1);its2plot  # Ensure x and y axes have the same scaling

#ggsave("Figures/NMDS_ITS2_T0clade.pdf", plot = its2plot, device = "pdf")
```
#T1TF #### 
```{r}
## REMOVE T0 for models
DIV_RelA_stats.T1F<-subset_samples(DIV_RelA_stats, Time.Point=="T1"|Time.Point=="TF")
  DIV_RelA_stats.T1F = prune_taxa(taxa_sums(DIV_RelA_stats.T1F) > 0, DIV_RelA_stats.T1F) #this removes any OTU with 0s

  #save as object for mantel test in the 16s rmd
  #saveRDS(DIV_RelA_stats.T1F,"ITS2_T1TF_phyloseq.rds")

#T1 
DIV_RelA_stats.T1<-subset_samples(DIV_RelA_stats, Time.Point=="T1")
  DIV_RelA_stats.T1 = prune_taxa(taxa_sums(DIV_RelA_stats.T1) > 0, DIV_RelA_stats.T1) #this removes any OTU with 0s

#bray curtis presence-absense and abundance
#all speices
set.seed(30)
bc.all <- phyloseq::distance(DIV_RelA_stats.T1, method = "bray")#make bray curtis data matrix
  samp.df <- as(sample_data(DIV_RelA_stats.T1), "data.frame") #sample df
#adonis test
adonis2(bc.all ~ Species*Treatment, data = samp.df)
    
# Homogeneity of dispersion test
betaAll <- betadisper(bc.all, samp.df$Species)
permutest(betaAll, pairwise = T) 

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.T1 <- ordinate(DIV_RelA_stats.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.T1)
scores.ord.DIV_RelA_statsT1 <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.T1, display="sites"))) #make df
scores.ord.DIV_RelA_statsT1$Treatment <- samp.df$Treatment
scores.ord.DIV_RelA_statsT1$Species <- samp.df$Species
scores.ord.DIV_RelA_statsT1$Clade <- samp.df$Clade
scores.ord.DIV_RelA_statsT1$Code3<-paste(scores.ord.DIV_RelA_statsT1$Species,scores.ord.DIV_RelA_statsT1$Treatment)
scores.ord.DIV_RelA_statsT1$Code3<-paste(scores.ord.DIV_RelA_statsT1$Species,scores.ord.DIV_RelA_statsT1$Treatment)

ggplot(scores.ord.DIV_RelA_statsT1, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code3), 
               alpha = 0.25)+
    theme_classic()

ggplot(scores.ord.DIV_RelA_statsT1, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Clade, shape=Treatment), size = 4) +
  #scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(color=Clade, fill=4, alpha=0.25)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS its2 Bray Curtis") +
  theme_classic()

#TF only

DIV_RelA_stats.TF<-subset_samples(DIV_RelA_stats, Time.Point=="TF")
  DIV_RelA_stats.TF = prune_taxa(taxa_sums(DIV_RelA_stats.TF) > 0, DIV_RelA_stats.TF) #this removes any OTU with 0s

#all speices
set.seed(30)
#make bray curtis data matrix
bc.all <- phyloseq::distance(DIV_RelA_stats.TF, method = "bray")
  samp.df <- as(sample_data(DIV_RelA_stats.TF), "data.frame") #sample df
#adonis test
adonis2(bc.all ~ Species*Treatment, data = samp.df)
    
# Homogeneity of dispersion test
betaAll <- betadisper(bc.all, samp.df$Species)
permutest(betaAll, pairwise = T) 

#Ordination NMDS for all species
set.seed(30)
ord.DIV_RelA_stats.TF <- ordinate(DIV_RelA_stats.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.DIV_RelA_stats.TF)
scores.ord.DIV_RelA_stats <- as.data.frame(cbind(vegan::scores(ord.DIV_RelA_stats.TF, display="sites"))) #make df
scores.ord.DIV_RelA_stats$Treatment <- samp.df$Treatment
scores.ord.DIV_RelA_stats$Species <- samp.df$Species
scores.ord.DIV_RelA_stats$Clade <- samp.df$Clade
scores.ord.DIV_RelA_stats$Code3<-paste(scores.ord.DIV_RelA_stats$Species,scores.ord.DIV_RelA_stats$Treatment)

ggplot(scores.ord.DIV_RelA_stats, aes(x = NMDS1, y = NMDS2, color = Species, linetype=Treatment)) +
  geom_point(aes(shape=Treatment), size=4) +
  stat_ellipse(geom = "polygon",
               aes(fill = Code3), 
               alpha = 0.25)+
    theme_classic()
```

#T0 Beta diversiry and dispersion, T0
Table S17
```{r} 
#T0 only DIV_RelA_stats.T0

#Mcap
mcap.RelRare.T0 <- subset_samples(DIV_RelA_stats.T0, host_genus == "montipora")
    mcap.RelRare.T0 = prune_taxa(taxa_sums(mcap.RelRare.T0) > 0, mcap.RelRare.T0) 

#make bray curtis data matrix
bc.mcap.T0 <- phyloseq::distance(mcap.RelRare.T0, method = "bray") 
      mcap.DIV.samp.df.T0 <- as(sample_data(mcap.RelRare.T0), "data.frame") 
            mcap.DIV.samp.df.T0$Code<-paste(mcap.DIV.samp.df.T0$Treatment,mcap.DIV.samp.df.T0$Clade)    
    set.seed(30)
    adonis2(bc.mcap.T0 ~ Clade, data = mcap.DIV.samp.df.T0, by="margin") #adonis test no clade
    
     set.seed(30)
    permutest(betadisper(bc.mcap.T0, mcap.DIV.samp.df.T0$Clade, type = "centroid")) #put in distance matrix
    
  #Pcomp
Pcomp.RelRare.T0 <- subset_samples(DIV_RelA_stats.T0, host_genus == "porites")
    Pcomp.RelRare.T0 = prune_taxa(taxa_sums(Pcomp.RelRare.T0) > 0, Pcomp.RelRare.T0) 

#make bray curtis data matrix
bc.Pcomp.T0 <- phyloseq::distance(Pcomp.RelRare.T0, method = "bray") 
      Pcomp.DIV.samp.df.T0 <- as(sample_data(Pcomp.RelRare.T0), "data.frame") 
            Pcomp.DIV.samp.df.T0$Code<-paste(Pcomp.DIV.samp.df.T0$Treatment,Pcomp.DIV.samp.df.T0$Clade)    
    set.seed(30)
    adonis2(bc.Pcomp.T0 ~ Clade, data = Pcomp.DIV.samp.df.T0, by="margin") #adonis test no clade
    
     set.seed(30)
    permutest(betadisper(bc.Pcomp.T0, Pcomp.DIV.samp.df.T0$Clade, type = "centroid")) #put in distance matrix 
    
 #Pvar
Pvar.RelRare.T0 <- subset_samples(DIV_RelA_stats.T0, host_genus == "pavona")
    Pvar.RelRare.T0 = prune_taxa(taxa_sums(Pvar.RelRare.T0) > 0, Pvar.RelRare.T0) 

#make bray curtis data matrix
bc.Pvar.T0 <- phyloseq::distance(Pvar.RelRare.T0, method = "bray") 
      Pvar.DIV.samp.df.T0 <- as(sample_data(Pvar.RelRare.T0), "data.frame") 
            Pvar.DIV.samp.df.T0$Code<-paste(Pvar.DIV.samp.df.T0$Treatment,Pvar.DIV.samp.df.T0$Clade)    
    set.seed(30)
    adonis2(bc.Pvar.T0 ~ Clade, data = Pvar.DIV.samp.df.T0, by="margin") #adonis test no clade
    
     set.seed(30)
    permutest(betadisper(bc.Pvar.T0, Pvar.DIV.samp.df.T0$Clade, type = "centroid")) #put in distance matrix
       
#Pacu
Pacu.RelRare.T0 <- subset_samples(DIV_RelA_stats.T0, host_genus == "pocillopora")
    Pacu.RelRare.T0 = prune_taxa(taxa_sums(Pacu.RelRare.T0) > 0, Pacu.RelRare.T0) 

#make bray curtis data matrix
bc.Pacu.T0 <- phyloseq::distance(Pacu.RelRare.T0, method = "bray") 
      Pacu.DIV.samp.df.T0 <- as(sample_data(Pacu.RelRare.T0), "data.frame") 
            Pacu.DIV.samp.df.T0$Code<-paste(Pacu.DIV.samp.df.T0$Treatment,Pacu.DIV.samp.df.T0$Clade)    
    set.seed(30)
    adonis2(bc.Pacu.T0 ~ Clade, data = Pacu.DIV.samp.df.T0, by="margin") #adonis test no clade
    
     set.seed(30)
    permutest(betadisper(bc.Pacu.T0, Pacu.DIV.samp.df.T0$Clade, type = "centroid")) #put in distance matrix   
```
#Beta T1, TF, by treatment
Montipora





```{r}       
#DIV_RelA_stats.T1F ####
#mcap
mcap.RelRare.T1F <- subset_samples(DIV_RelA_stats.T1F, host_genus == "montipora")
    mcap.RelRare.T1F = prune_taxa(taxa_sums(mcap.RelRare.T1F) > 0, mcap.RelRare.T1F) 

mcap.RelRare.T1 <- subset_samples(mcap.RelRare.T1F, Time.Point == "T1")
    mcap.RelRare.T1 = prune_taxa(taxa_sums(mcap.RelRare.T1) > 0, mcap.RelRare.T1) 

mcap.RelRare.TF <- subset_samples(mcap.RelRare.T1F, Time.Point == "TF")
    mcap.RelRare.TF = prune_taxa(taxa_sums(mcap.RelRare.TF) > 0, mcap.RelRare.TF) 
  
    
#T1
  bc.mcap.T1 <- phyloseq::distance(mcap.RelRare.T1, method = "bray") 
      mcap.DIV.samp.df.T1 <- as(sample_data(mcap.RelRare.T1), "data.frame")
      mcap.DIV.samp.df.T1 <- mcap.DIV.samp.df.T1 %>%
  mutate(
    Clade = as.factor(Clade),
    Treatment = as.factor(Treatment)
  )

  set.seed(30)
    adonis2(bc.mcap.T1 ~ Treatment, data = mcap.DIV.samp.df.T1, by="margin")
  set.seed(30)
        adonis2(bc.mcap.T1 ~ Clade*Treatment, data = mcap.DIV.samp.df.T1, by="margin")  

# Homogeneity of dispersion test  
    set.seed(30)
    permutest(betadisper(bc.mcap.T1, mcap.DIV.samp.df.T1$Clade, type = "centroid")) #put in distance matrix
   set.seed(30)
    permutest(betadisper(bc.mcap.T1, mcap.DIV.samp.df.T1$Treatment, type = "centroid")) #put in distance matrix
    set.seed(30)
    permutest(betadisper(bc.mcap.T1, mcap.DIV.samp.df.T1$Code, type = "centroid")) #put in distance matrix

#TF
  bc.mcap.DIV.TF <- phyloseq::distance(mcap.RelRare.TF, method = "bray")
     mcap.DIV.samp.df.TF <- as(sample_data(mcap.RelRare.TF), "data.frame") 
     mcap.DIV.samp.df.TF$Code<-paste(mcap.DIV.samp.df.TF$Treatment,mcap.DIV.samp.df.TF$Clade)
        set.seed(30)
adonis(bc.mcap.DIV.TF ~ Treatment, data = mcap.DIV.samp.df.TF)
           set.seed(30)
 adonis(bc.mcap.DIV.TF ~ Clade*Treatment, data = mcap.DIV.samp.df.TF)
# Homogeneity of dispersion test  
    set.seed(30)
    permutest(betadisper(bc.mcap.DIV.TF, mcap.DIV.samp.df.TF$Clade, type = "centroid")) #put in distance matrix
   set.seed(30)
    permutest(betadisper(bc.mcap.DIV.TF, mcap.DIV.samp.df.TF$Treatment, type = "centroid")) #put in distance matrix
    set.seed(30)
    permutest(betadisper(bc.mcap.DIV.TF, mcap.DIV.samp.df.TF$Code, type = "centroid")) #put in distance matrix
#### delete if above wokrs ###    

    
#T1
#make bray curtis data matrix 
  bc.mcapT1 <- phyloseq::distance(mcap.RelRare.T1, method = "bray")
  mcap.samp.df.T1 <- as(sample_data(mcap.RelRare.T1), "data.frame") #sample df
  mcap.samp.df.T1$Code<-paste(mcap.samp.df.T1$Treatment,mcap.samp.df.T1$Clade)
  set.seed(30)
adonis(bc.mcapT1 ~ Treatment, data = mcap.samp.df.T1)   #adonis test
       set.seed(30)
adonis(bc.mcapT1 ~ Clade*Treatment, data = mcap.samp.df.T1)   #adonis test
# Homogeneity of dispersion test  
      set.seed(30)
    permutest(betadisper(bc.mcapT1, mcap.samp.df.T1$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.mcapT1, mcap.samp.df.T1$Treatment, type = "centroid"))
       set.seed(30)
    permutest(betadisper(bc.mcapT1, mcap.samp.df.T1$Code, type = "centroid"))

#TF
#make bray curtis data matrix 
  bc.mcap.TF <- phyloseq::distance(mcap.RelRare.TF, method = "bray")
  mcap.samp.df.TF <- as(sample_data(mcap.RelRare.TF), "data.frame") #sample df
  mcap.samp.df.TF$Code<-paste(mcap.samp.df.TF$Treatment, mcap.samp.df.TF$Clade)
#adonis test
   set.seed(30)
 adonis(bc.mcap.TF ~Treatment, data = mcap.samp.df.TF)
      set.seed(30)
 adonis(bc.mcap.TF ~ Clade*Treatment, data = mcap.samp.df.TF)
  # Homogeneity of dispersion test  
      set.seed(30)
    permutest(betadisper(bc.mcap.TF, mcap.samp.df.TF$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.mcap.TF, mcap.samp.df.TF$Treatment, type = "centroid"))
       set.seed(30)
    permutest(betadisper(bc.mcap.TF, mcap.samp.df.TF$Code, type = "centroid"))

## by clade: C vs CD####
  
# C only, new objs
mcap.RelRare.T1F.C <- subset_samples(mcap.RelRare.T1F, Clade == "C")
mcap.RelRare.T1.C <- subset_samples(mcap.RelRare.T1, Clade == "C")
mcap.RelRare.TF.C <- subset_samples(mcap.RelRare.TF, Clade == "C")
  
#T1TF.C
#make bray curtis data matrix -T1 and TF
  bc.mcap.T1F.C <- phyloseq::distance(mcap.RelRareT1F.C, method = "bray")
  mcap.samp.df.T1F.C <- as(sample_data(mcap.RelRareT1F.C), "data.frame") #sample df
#adonis test
  adonis(bc.mcap.T1F.C ~ Treatment*Time.Point, data = mcap.samp.df.T1F.C)

#T1.C
#make bray curtis data matrix 
  bc.mcapT1.C <- phyloseq::distance(mcap.RelRare.T1.C, method = "bray")
  mcap.samp.df.T1.C <- as(sample_data(mcap.RelRare.T1.C), "data.frame") #sample df
#adonis test
  adonis(bc.mcapT1.C ~ Treatment, data = mcap.samp.df.T1.C)
# Homogeneity of dispersion test  
  beta.mcap.T1.C <- betadisper(bc.mcapT1.C, mcap.samp.df.T1.C$Treatment)
  permutest(beta.mcap.T1.C, pairwise = T) 

#TF.C
#make bray curtis data matrix 
  bc.mcap.TF.C <- phyloseq::distance(mcap.RelRare.TF.C, method = "bray")
  mcap.samp.df.TF.C <- as(sample_data(mcap.RelRare.TF.C), "data.frame") #sample df
#adonis test
  adonis(bc.mcap.TF.C ~ Treatment, data = mcap.samp.df.TF.C)
# Homogeneity of dispersion test  
  beta.mcap.TF.C <- betadisper(bc.mcap.TF.C, mcap.samp.df.TF.C$Treatment)
  permutest(beta.mcap.TF.C, pairwise = T) 


# CD only, new objs
mcap.RelRareT1F.CD <- subset_samples(mcap.RelRareT1F, Clade == "CD")
mcap.RelRare.T1.CD <- subset_samples(mcap.RelRare.T1, Clade == "CD")
mcap.RelRare.TF.CD <- subset_samples(mcap.RelRare.TF, Clade == "CD")
  
#T1TF.CD
#make bray curtis data matrix -T1 and TF
  bc.mcap.T1F.CD <- phyloseq::distance(mcap.RelRareT1F.CD, method = "bray")
  mcap.samp.df.T1F.CD <- as(sample_data(mcap.RelRareT1F.CD), "data.frame") #sample df
#adonis test
  adonis(bc.mcap.T1F.CD ~ Treatment*Time.Point, data = mcap.samp.df.T1F.CD)

#T1.CD
#make bray curtis data matrix 
  bc.mcapT1.CD <- phyloseq::distance(mcap.RelRare.T1.CD, method = "bray")
  mcap.samp.df.T1.CD <- as(sample_data(mcap.RelRare.T1.CD), "data.frame") #sample df
  adonis(bc.mcapT1.CD ~ Treatment, data = mcap.samp.df.T1.CD)#adonis test
# Homogeneity of dispersion test  
  beta.mcap.T1.CD <- betadisper(bc.mcapT1.CD, mcap.samp.df.T1.CD$Treatment)
  permutest(beta.mcap.T1.CD, pairwise = T) 

#TF.CD
#make bray curtis data matrix 
  bc.mcap.TF.CD <- phyloseq::distance(mcap.RelRare.TF.CD, method = "bray")
  mcap.samp.df.TF.CD <- as(sample_data(mcap.RelRare.TF.CD), "data.frame") #sample df
#adonis test
  adonis(bc.mcap.TF.CD ~ Treatment, data = mcap.samp.df.TF.CD)
# Homogeneity of dispersion test  
  beta.mcap.TF.CD <- betadisper(bc.mcap.TF.CD, mcap.samp.df.TF.CD$Treatment)
  permutest(beta.mcap.TF.CD, pairwise = T) 
``` 
Mcap NMDS
```{r} 
library(RColorBrewer)
library(colorRamps) 
library(devtools)

## create palette for parent.ID and treatments
Mcap.Parent.colors <- c("363" = "green4",  "364" = "firebrick3", "365" ="deeppink4", "366" = "orange", "367" = "green1","368" = "gold",  "369"= "hotpink", "370" ="darkslateblue", "371" = "cyan", "372" = "darkorange","373" ="darkorchid1", "374" = "lightblue", Ambient = "Blue", High = "Red","C Ambient"="blue","C High"="red", "CD Ambient"="darkblue", "CD High"="darkred") 

#T1 and TF
ord.mcap <- ordinate(mcap.RelRare.T1F, method="NMDS", "bray", trymax = 100, set.seed(30)) 
stressplot(ord.mcap)
scores.mcap.samp.df <- as.data.frame(points(ord.mcap) ) 

scores.mcap.samp.df$Time.Point <- mcap.DIV.samp.df.T1F$Time.Point
scores.mcap.samp.df$Parent.ID <- mcap.DIV.samp.df.T1F$Parent.ID
scores.mcap.samp.df$Treatment <- mcap.DIV.samp.df.T1F$Treatment
scores.mcap.samp.df$Clade <- mcap.DIV.samp.df.T1F$Clade
scores.mcap.samp.df$Code <- paste(scores.mcap.samp.df$Parent.ID,scores.mcap.samp.df$Time.Point)
scores.mcap.samp.df$Code2 <- paste(scores.mcap.samp.df$Treatment,scores.mcap.samp.df$Time.Point)


#http://evomics.org/wp-content/uploads/2016/01/phyloseq-Lab-Section-01-Main-Lab.html#procrustes-and-ggplot2 
ggplot(scores.mcap.samp.df, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Treatment, shape = Clade), size = 4) +
  scale_color_manual(values=Mcap.Parent.colors)+
    geom_line(aes(group = Code), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata Bray Curtis") +
  theme_classic()
#ggsave("McapT1its2.pdf")

ggplot(scores.mcap.samp.df, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Treatment, shape = Time.Point), size = 4) +
  scale_color_manual(values=Mcap.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata Bray CurtisT1TF") +
  theme_classic()
#ggsave("McapT1its2.pdf")

ggplot(scores.mcap.samp.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=mcap.g.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Code2))) +
    scale_linetype_manual(values=c(2,2,3,3))+
  ggtitle("M. capitata Bray T1TF its") +
  theme_classic()

#workaround-for when this randomly breaks
# plot_ordination(mcap.RelRare.TF, ordinate(mcap.RelRare, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)



#T1 only  mcap.samp.df.T1
set.seed(30)
ord.mcapT1 <- ordinate(mcap.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcapT1)

scores.mcapT1<-as.data.frame(cbind(vegan::scores(ord.mcapT1, display="sites"))) # these are "points" ask hannah 

scores.mcapT1$Treatment <- mcap.samp.df.T1$Treatment
scores.mcapT1$Parent.ID <- mcap.samp.df.T1$Parent.ID
scores.mcapT1$Clade <- mcap.samp.df.T1$Clade
scores.mcapT1$CladeTreat <- as.factor(paste(mcap.samp.df.T1$Clade,mcap.samp.df.T1$Treatment))


ggplot(scores.mcapT1, aes(x = NMDS1, y = NMDS2)) + 
 geom_point(aes(stroke=1.5, colour = Parent.ID, size = 4) )+
    geom_point(aes(colour = Treatment), size = 4) +
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("M. capitata T1 Bray Curtis") +
  theme_classic()
#ggsave("McapT1_its2_nmds_Poutline.pdf")

ggplot(scores.mcapT1, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=mcap.g.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,2,3,3))+
  ggtitle("M. capitata Bray T1 its") +
  theme_classic()

#TF only
set.seed(30)
ord.mcapTF <- ordinate(mcap.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcapTF)
scores.mcapTF <- as.data.frame(scores(ord.mcapTF))
scores.mcapTF$Treatment <- mcap.samp.df.TF$Treatment
scores.mcapTF$Parent.ID <- mcap.samp.df.TF$Parent.ID
scores.mcapTF$Clade <- mcap.samp.df.TF$Clade
scores.mcapTF$CladeTreat <- as.factor(paste(mcap.samp.df.TF$Clade,mcap.samp.df.TF$Treatment))

ggplot(scores.mcapTF, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(stroke=1.5, colour = Parent.ID, size = 4) )+
    geom_point(aes(colour = Treatment), size = 4) +
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  ggtitle("M. capitata TF Bray Curtis") +
  theme_classic()
#ggsave("Mcap_TF_its_nmds_parent_outline.pdf")

ggplot(scores.mcapTF, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=mcap.g.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,2,3,3))+
  ggtitle("M. capitata Bray TF its") +
  theme_classic()

#### BY CLADE####
#ords
#C T1 and TF
set.seed(30)
ord.mcap_C <- ordinate(Mcap_DIV_C, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_C)
scores.mcap_C <- as.data.frame(scores(ord.mcap_C))
scores.mcap_C$Treatment <- mcap.samp.df.T1F.C$Treatment
scores.mcap_C$Parent.ID <- mcap.samp.df.T1F.C$Parent.ID
scores.mcap_C$Time.Point <- mcap.samp.df.T1F.C$Time.Point

ggplot(scores.mcap_C, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Mcap.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata Cladocopium") +
  theme_classic()
#ggsave("McapTFits_C.pdf")

##### by clade ####
#C T1
set.seed(30)
ord.mcap_C.T1 <- ordinate(mcap.RelRare.T1.C, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_C.T1)
scores.mcap_C.T1 <- as.data.frame(scores(ord.mcap_C.T1))
scores.mcap_C.T1$Treatment <- mcap.samp.df.T1.C$Treatment
scores.mcap_C.T1$Parent.ID <- mcap.samp.df.T1.C$Parent.ID
scores.mcap_C.T1$Time.Point <- mcap.samp.df.T1.C$Time.Point

ggplot(scores.mcap_C.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=2, colour = Parent.ID,shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4,shape=Treatment)) +
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata T1 Cladocopium") +
  theme_classic()
#ggsave("Mcap_T1_its_C.pdf")

#C TF
set.seed(30)
ord.mcap_C.TF <- ordinate(mcap.RelRare.TF.C, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_C.TF)
scores.mcap_C.TF <- as.data.frame(scores(ord.mcap_C.TF))
scores.mcap_C.TF$Treatment <- mcap.samp.df.TF.C$Treatment
scores.mcap_C.TF$Parent.ID <- mcap.samp.df.TF.C$Parent.ID
scores.mcap_C.TF$Time.Point <- mcap.samp.df.TF.C$Time.Point

ggplot(scores.mcap_C.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata C TF") +
  theme_classic()
#ggsave("Mcap_TF_its_TF_C.pdf")


#CD
set.seed(30)
ord.mcap_CD <- ordinate(Mcap_DIV_CD, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_CD)
scores.mcap_CD <- as.data.frame(scores(ord.mcap_CD))
scores.mcap_CD$Treatment <- mcap.samp.df.T1F.CD$Treatment
scores.mcap_CD$Parent.ID <- mcap.samp.df.T1F.CD$Parent.ID
scores.mcap_CD$Time.Point <- mcap.samp.df.T1F.CD$Time.Point

ggplot(scores.mcap_CD, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +  
  scale_color_manual(values=Mcap.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata C&D") +
  theme_classic()
#ggsave("Mcap_ITS2_CD_its_T1TF.pdf")

#CD T1
set.seed(30)
ord.mcap_CD.T1 <- ordinate(mcap.RelRare.T1.CD, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_CD.T1)
scores.mcap_CD.T1 <- as.data.frame(scores(ord.mcap_CD.T1))
scores.mcap_CD.T1$Treatment <- mcap.samp.df.T1.CD$Treatment
scores.mcap_CD.T1$Parent.ID <- mcap.samp.df.T1.CD$Parent.ID
scores.mcap_CD.T1$Time.Point <- mcap.samp.df.T1.CD$Time.Point

ggplot(scores.mcap_CD.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata T1 CD") +
  theme_classic()
#ggsave("Mcap_ITS2_CD_T1.pdf")

#CD TF
set.seed(30)
ord.mcap_CD.TF <- ordinate(mcap.RelRare.TF.CD, "NMDS", "bray", trymax = 100) 
stressplot(ord.mcap_CD.TF)
scores.mcap_CD.TF <- as.data.frame(scores(ord.mcap_CD.TF))
scores.mcap_CD.TF$Treatment <- mcap.samp.df.TF.CD$Treatment
scores.mcap_CD.TF$Parent.ID <- mcap.samp.df.TF.CD$Parent.ID
scores.mcap_CD.TF$Time.Point <- mcap.samp.df.TF.CD$Time.Point

ggplot(scores.mcap_CD.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Mcap.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata CD TF") +
  theme_classic()
ggsave("Mcap_ITS2_CD_TF.pdf")



```

Porites - T1 and TF together, then independent. PERMANOVA
```{r}     
#DIV_RelA_stats.T1F
#Pcomp
Pcomp.RelRare.T1F <- subset_samples(DIV_RelA_stats.T1F, host_genus == "porites")
    Pcomp.RelRare.T1F = prune_taxa(taxa_sums(Pcomp.RelRare.T1F) > 0, Pcomp.RelRare.T1F) 
Pcomp.RelRare.T1 <- subset_samples(Pcomp.RelRare.T1F, Time.Point == "T1")
    Pcomp.RelRare.T1 = prune_taxa(taxa_sums(Pcomp.RelRare.T1) > 0, Pcomp.RelRare.T1) 
Pcomp.RelRare.TF <- subset_samples(Pcomp.RelRare.T1F, Time.Point == "TF")
    Pcomp.RelRare.TF = prune_taxa(taxa_sums(Pcomp.RelRare.TF) > 0, Pcomp.RelRare.TF) 


#T1TF
#make bray curtis data matrix -T1 and TF
  bc.Pcomp.T1F <- phyloseq::distance(Pcomp.RelRare.T1F, method = "bray")
  Pcomp.samp.df.T1F <- as(sample_data(Pcomp.RelRare.T1F), "data.frame")            #sample df
  Pcomp.samp.df.T1F$Code<-paste(Pcomp.samp.df.T1F$Treatment,Pcomp.samp.df.T1F$Time.Point)
    Pcomp.samp.df.T1F$Code2<-paste(Pcomp.samp.df.T1F$Treatment,Pcomp.samp.df.T1F$Time.Point,Pcomp.samp.df.T1F$Clade)

  set.seed(30)
  adonis(bc.Pcomp.T1F ~ Treatment*Time.Point, data = Pcomp.samp.df.T1F)
  set.seed(30)
  adonis(bc.Pcomp.T1F ~ Clade*Treatment*Time.Point, data = Pcomp.samp.df.T1F)      #adonis test
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pcomp.T1F, Pcomp.samp.df.T1F$Time.Point, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pcomp.T1F, Pcomp.samp.df.T1F$Treatment, type = "centroid"))
       set.seed(30)
    permutest(betadisper(bc.Pcomp.T1F, Pcomp.samp.df.T1F$Code, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pcomp.T1F, Pcomp.samp.df.T1F$Code2, type = "centroid"))
  
  
#T1
#make bray curtis data matrix 
  bc.PcompT1 <- phyloseq::distance(Pcomp.RelRare.T1, method = "bray")
  Pcomp.samp.df.T1 <- as(sample_data(Pcomp.RelRare.T1), "data.frame") #sample df
  Pcomp.samp.df.T1$Code<-paste(Pcomp.samp.df.T1$Clade,Pcomp.samp.df.T1$Treatment)
   set.seed(30)
 adonis(bc.PcompT1 ~ Treatment, data = Pcomp.samp.df.T1)   #adonis test
      set.seed(30)
 adonis(bc.PcompT1 ~ Clade*Treatment, data = Pcomp.samp.df.T1)   #adonis test
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.PcompT1, Pcomp.samp.df.T1$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.PcompT1, Pcomp.samp.df.T1$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.PcompT1, Pcomp.samp.df.T1$Code, type = "centroid"))

#TF
#make bray curtis data matrix 
  bc.Pcomp.TF <- phyloseq::distance(Pcomp.RelRare.TF, method = "bray")
  Pcomp.samp.df.TF <- as(sample_data(Pcomp.RelRare.TF), "data.frame") #sample df
  Pcomp.samp.df.TF$Code<-paste(Pcomp.samp.df.TF$Treatment,Pcomp.samp.df.TF$Clade)
 set.seed(30)
 adonis(bc.Pcomp.TF ~ Treatment, data = Pcomp.samp.df.TF)    
 set.seed(30)
 adonis(bc.Pcomp.TF ~ Clade*Treatment, data = Pcomp.samp.df.TF)
 # Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pcomp.TF, Pcomp.samp.df.TF$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pcomp.TF, Pcomp.samp.df.TF$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.Pcomp.TF, Pcomp.samp.df.TF$Code, type = "centroid"))


## by clade: C vs CD
  
# C15cj only, new objs
Pcomp.RelRareT1F.C15cj <- subset_samples(Pcomp.RelRare.T1F, Clade == "C15cj")
Pcomp.RelRare.T1.C15cj <- subset_samples(Pcomp.RelRare.T1, Clade == "C15cj")
Pcomp.RelRare.TF.C15cj <- subset_samples(Pcomp.RelRare.TF, Clade == "C15cj")
  
#T1TF.C
#make bray curtis data matrix -T1 and TF
  bc.Pcomp.T1F.C15cj <- phyloseq::distance(Pcomp.RelRareT1F.C15cj, method = "bray")
  Pcomp.samp.df.T1F.C15cj <- as(sample_data(Pcomp.RelRareT1F.C15cj), "data.frame") #sample df
#adonis test
  adonis(bc.Pcomp.T1F.C15cj ~ Treatment*Time.Point, data = Pcomp.samp.df.T1F.C15cj)

#T1.C15cj
#make bray curtis data matrix 
  bc.PcompT1.C15cj <- phyloseq::distance(Pcomp.RelRare.T1.C15cj, method = "bray")
  Pcomp.samp.df.T1.C15cj <- as(sample_data(Pcomp.RelRare.T1.C15cj), "data.frame") #sample df
#adonis test
  adonis(bc.PcompT1.C15cj ~ Treatment, data = Pcomp.samp.df.T1.C15cj)
# Homogeneity of dispersion test  
  beta.Pcomp.T1.C15cj <- betadisper(bc.PcompT1.C15cj, Pcomp.samp.df.T1.C15cj$Treatment)
  permutest(beta.Pcomp.T1.C15cj, pairwise = T) 

#TF.C15cj
#make bray curtis data matrix 
  bc.Pcomp.TF.C15cj <- phyloseq::distance(Pcomp.RelRare.TF.C15cj, method = "bray")
  Pcomp.samp.df.TF.C15cj <- as(sample_data(Pcomp.RelRare.TF.C15cj), "data.frame") #sample df
#adonis test
  adonis(bc.Pcomp.TF.C15cj ~ Treatment, data = Pcomp.samp.df.TF.C15cj)
# Homogeneity of dispersion test  
  beta.Pcomp.TF.C15cj <- betadisper(bc.Pcomp.TF.C15cj, Pcomp.samp.df.TF.C15cj$Treatment)
  permutest(beta.Pcomp.TF.C15cj, pairwise = T) 


# C15n only, new objs
Pcomp.RelRareT1F.C15n <- subset_samples(Pcomp.RelRare.T1F, Clade == "C15n")
Pcomp.RelRare.T1.C15n <- subset_samples(Pcomp.RelRare.T1, Clade == "C15n")
Pcomp.RelRare.TF.C15n <- subset_samples(Pcomp.RelRare.TF, Clade == "C15n")
  
#T1TF.C15n
#make bray curtis data matrix -T1 and TF
  bc.Pcomp.T1F.C15n <- phyloseq::distance(Pcomp.RelRareT1F.C15n, method = "bray")
  Pcomp.samp.df.T1F.C15n <- as(sample_data(Pcomp.RelRareT1F.C15n), "data.frame") #sample df
#adonis test
  adonis(bc.Pcomp.T1F.C15n ~ Treatment*Time.Point, data = Pcomp.samp.df.T1F.C15n)

#T1.C15n
#make bray curtis data matrix 
  bc.PcompT1.C15n <- phyloseq::distance(Pcomp.RelRare.T1.C15n, method = "bray")
  Pcomp.samp.df.T1.C15n <- as(sample_data(Pcomp.RelRare.T1.C15n), "data.frame") #sample df
  adonis(bc.PcompT1.C15n ~ Treatment, data = Pcomp.samp.df.T1.C15n)#adonis test
# Homogeneity of dispersion test  
  beta.Pcomp.T1.C15n <- betadisper(bc.PcompT1.C15n, Pcomp.samp.df.T1.C15n$Treatment)
  permutest(beta.Pcomp.T1.C15n, pairwise = T) 

#TF.C15n
#make bray curtis data matrix 
  bc.Pcomp.TF.C15n <- phyloseq::distance(Pcomp.RelRare.TF.C15n, method = "bray")
  Pcomp.samp.df.TF.C15n <- as(sample_data(Pcomp.RelRare.TF.C15n), "data.frame") #sample df
#adonis test
  adonis(bc.Pcomp.TF.C15n ~ Treatment, data = Pcomp.samp.df.TF.C15n)
# Homogeneity of dispersion test  
  beta.Pcomp.TF.C15n <- betadisper(bc.Pcomp.TF.C15n, Pcomp.samp.df.TF.C15n$Treatment)
  permutest(beta.Pcomp.TF.C15n, pairwise = T) 
  
  
  
#which Cs are which   T1F
TopNOTUspcomp = names(sort(taxa_sums(Pcomp.RelRare.T1F), TRUE)[1:10])
TopNOTUspcomp10 = prune_taxa(TopNOTUspcomp, Pcomp.RelRare.T1F)

OTU.pcompits = as(otu_table(TopNOTUspcomp10), "matrix")
# transpose if necessary
if(taxa_are_rows(Pcomp.RelRare.T1F)){OTU.pcompits <- t(OTU.pcompits)}
# Coerce to data.frame
OTU.pcompitsdf = as.data.frame(OTU.pcompits)  

#add meta
      TopNOTUspcomp10.sd <- as(sample_data(TopNOTUspcomp10), "data.frame")

OTU.pcompitsdf$Parent.ID<-TopNOTUspcomp10.sd$Parent.ID
  OTU.pcompitsdf$Time.Point<-TopNOTUspcomp10.sd$Time.Point
    OTU.pcompitsdf$Clade<-TopNOTUspcomp10.sd$Clade
    OTU.pcompitsdf$Treatment<-TopNOTUspcomp10.sd$Treatment


write.csv(OTU.pcompitsdf,"OTU.pcompitsdfT1.csv")    
  
``` 
Pcomp NMDS
```{r} 
library(RColorBrewer)
library(colorRamps)
library(devtools)
 
## create palette for parent.ID and treatments
Pcomp.Parent.colors <- c("313" = "green4",  "314" = "firebrick3", "315" ="deeppink4", "316" = "orange", "317" = "green1","318" = "gold",  "319"= "hotpink", "320" ="darkslateblue", "321" = "cyan", "322" = "darkorange","323" ="darkorchid1", "324" = "lightblue","Ambient" = "#4575B4", "High" = "#D73027",     "C15cj Ambient"="blue","C15cj High"="red", "C15n Ambient"="darkblue", "C15n High"="darkred") 

#T1 and TF
ord.Pcomp <- ordinate(Pcomp.RelRare.T1F, method="NMDS", "bray", trymax = 100, set.seed(30)) 
stressplot(ord.Pcomp)

scores.Pcomp.samp.df <- as.data.frame(scores(ord.Pcomp) ) 
scores.Pcomp.samp.df$Time.Point <- Pcomp.samp.df.T1F$Time.Point
scores.Pcomp.samp.df$Parent.ID <- Pcomp.samp.df.T1F$Parent.ID
scores.Pcomp.samp.df$Treatment <- Pcomp.samp.df.T1F$Treatment
scores.Pcomp.samp.df$Clade <- Pcomp.samp.df.T1F$Clade
scores.Pcomp.samp.df$Code <- paste(Pcomp.samp.df.T1F$Parent.ID, Pcomp.samp.df.T1F$Time.Point)
scores.Pcomp.samp.df$Code2 <- paste(Pcomp.samp.df.T1F$Treatment, Pcomp.samp.df.T1F$Time.Point)


ggplot(scores.Pcomp.samp.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Code2))) +
    scale_linetype_manual(values=c(2,2,3,3))+
  ggtitle("Pcomp Bray T1TF its") +
  theme_classic()

ggplot(scores.Pcomp.samp.df, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
   # geom_line(aes(group = Code), color = "black") + 
  ggtitle("P. comp Bray Curtis") +
  theme_classic()
#ggsave("Pcomp_T1TF_its2.pdf")

ggplot(scores.Pcomp.samp.df, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Treatment, shape = Time.Point), size = 4) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("M. capitata Bray Curtis") +
  theme_classic()
#ggsave("PcompT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(Pcomp.RelRare.TF, ordinate(Pcomp.RelRare, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)



#T1 only
set.seed(30)
ord.PcompT1 <- ordinate(Pcomp.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.PcompT1)
scores.PcompT1 <- as.data.frame(scores(ord.PcompT1))
scores.PcompT1$Treatment <- Pcomp.samp.df.T1$Treatment
scores.PcompT1$Parent.ID <- Pcomp.samp.df.T1$Parent.ID
scores.PcompT1$Clade <- Pcomp.samp.df.T1$Clade
scores.PcompT1$CladeTreat <- as.factor(paste(Pcomp.samp.df.T1$Clade,Pcomp.samp.df.T1$Treatment))


ggplot(scores.PcompT1, aes(x = NMDS1, y = NMDS2)) + 
 geom_point(aes(stroke=1.5, colour = Treatment, size = 4) )+
    geom_point(aes(colour = Treatment), size = 4) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("Pcomp T1 Bray Curtis") +
  theme_classic()

ggplot(scores.PcompT1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Treatment, shape=Clade, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Clade)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  #    geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("P. comp T1 Bray Curtis") +
  theme_classic()
#ggsave("Pcomp_T1_its2_nmds_clade.pdf")

#TF only
set.seed(30)
ord.PcompTF <- ordinate(Pcomp.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.PcompTF)
scores.PcompTF <- as.data.frame(scores(ord.PcompTF))
scores.PcompTF$Treatment <- Pcomp.samp.df.TF$Treatment
scores.PcompTF$Parent.ID <- Pcomp.samp.df.TF$Parent.ID
scores.PcompTF$Clade <- Pcomp.samp.df.TF$Clade
scores.PcompTF$CladeTreat <- as.factor(paste(Pcomp.samp.df.TF$Clade,Pcomp.samp.df.TF$Treatment))


ggplot(scores.PcompTF, aes(x = NMDS1, y = NMDS2)) + 
 geom_point(aes(stroke=1.5, colour = Treatment, size = 4) )+
    geom_point(aes(colour = Treatment), size = 4) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("Pcomp TF Bray Curtis") +
  theme_classic()


ggplot(scores.PcompTF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  ggtitle("P. comp TF Bray Curtis") +
  theme_classic()
#ggsave("Pcomp_TF_its_nmds.pdf")



 Pcomp.RelRare.T1F
Pcomp.RelRare.T1
Pcomp.RelRare.TF. 

#### BY CLADE ####
#ords
#C T1 and TF
set.seed(30)
ord.pcomp_C15cj  <- ordinate(Pcomp.RelRare.T1F, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15cj)
scores.pcomp_C15cj <- as.data.frame(scores(ord.pcomp_C15cj))
scores.pcomp_C15cj$Treatment <- Pcomp.samp.df.T1F$Treatment
scores.pcomp_C15cj$Parent.ID <- Pcomp.samp.df.T1F$Parent.ID
scores.pcomp_C15cj$Time.Point <- Pcomp.samp.df.T1F$Time.Point

ggplot(scores.pcomp_C15cj, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P comp C15cj") +
  theme_classic()
#ggsave("pcompTFits_C15cj.pdf")


#C T1
set.seed(30)
ord.pcomp_C15cj.T1 <- ordinate(Pcomp.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15cj.T1)
scores.pcomp_C15cj.T1 <- as.data.frame(scores(ord.pcomp_C15cj.T1))
scores.pcomp_C15cj.T1$Treatment <- pcomp.samp.df.T1$Treatment
scores.pcomp_C15cj.T1$Parent.ID <- pcomp.samp.df.T1$Parent.ID
scores.pcomp_C15cj.T1$Time.Point <- pcomp.samp.df.T1$Time.Point

ggplot(scores.pcomp_C15cj.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=2, colour = Parent.ID,shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4,shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. comp T1 C15cj") +
  theme_classic()
#ggsave("pcomp_T1_its_C15cj.pdf")

#C TF
set.seed(30)
ord.pcomp_C15cj.TF <- ordinate(pcomp.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15cj.TF)
scores.pcomp_C15cj.TF <- as.data.frame(scores(ord.pcomp_C15cj.TF))
scores.pcomp_C15cj.TF$Treatment <- pcomp.samp.df.TF$Treatment
scores.pcomp_C15cj.TF$Parent.ID <- pcomp.samp.df.TF$Parent.ID
scores.pcomp_C15cj.TF$Time.Point <- pcomp.samp.df.TF$Time.Point

ggplot(scores.pcomp_C15cj.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata C TF") +
  theme_classic()
#ggsave("pcomp_TF_its_TF_C15cj.pdf")


#C15n
set.seed(30)
ord.pcomp_C15n <- ordinate(pcomp_DIV_C15n, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15n)
scores.pcomp_C15n <- as.data.frame(scores(ord.pcomp_C15n))
scores.pcomp_C15n$Treatment <- pcomp.samp.df.T1F.CD$Treatment
scores.pcomp_C15n$Parent.ID <- pcomp.samp.df.T1F.CD$Parent.ID
scores.pcomp_C15n$Time.Point <- pcomp.samp.df.T1F.CD$Time.Point

ggplot(scores.pcomp_C15n, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +  
  scale_color_manual(values=pcomp.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("M. capitata C&D") +
  theme_classic()
#ggsave("pcomp_ITS2_C15n_its_T1TF.pdf")

#C15n T1
set.seed(30)
ord.pcomp_C15n.T1 <- ordinate(pcomp.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15n.T1)
scores.pcomp_C15n.T1 <- as.data.frame(scores(ord.pcomp_C15n.T1))
scores.pcomp_C15n.T1$Treatment <- pcomp.samp.df.T1$Treatment
scores.pcomp_C15n.T1$Parent.ID <- pcomp.samp.df.T1$Parent.ID
scores.pcomp_C15n.T1$Time.Point <- pcomp.samp.df.T1$Time.Point

ggplot(scores.pcomp_C15n.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P comp T1 C15n") +
  theme_classic()
#ggsave("pcomp_ITS2_C15n_T1.pdf")

#CD TF
set.seed(30)
ord.pcomp_C15n.TF <- ordinate(pcomp.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.pcomp_C15n.TF)
scores.pcomp_C15n.TF <- as.data.frame(scores(ord.pcomp_C15n.TF))
scores.pcomp_C15n.TF$Treatment <- pcomp.samp.df.TF$Treatment
scores.pcomp_C15n.TF$Parent.ID <- pcomp.samp.df.TF$Parent.ID
scores.pcomp_C15n.TF$Time.Point <- pcomp.samp.df.TF$Time.Point

ggplot(scores.pcomp_C15n.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pcomp.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. comp C15n TF") +
  theme_classic()
#ggsave("pcomp_ITS2_C15n_TF.pdf")


```
Pavona - T1 and TF together, then independent. PERMANOVA
```{r}     
#DIV_RelA_st ats.T1F
#Pvar 
Pvar.RelRare.T1F <- subset_samples(DIV_RelA_stats.T1F, host_genus == "pavona")
Pvar.RelRare.T1 <- subset_samples(Pvar.RelRare.T1F, Time.Point == "T1")
Pvar.RelRare.TF <- subset_samples(Pvar.RelRare.T1F, Time.Point == "TF")

#T1TF
#make bray curtis data matrix -T1 and TF
  bc.Pvar.T1F <- phyloseq::distance(Pvar.RelRare.T1F, method = "bray")
  Pvar.samp.df.T1F <- as(sample_data(Pvar.RelRare.T1F), "data.frame")            #sample df
  Pvar.samp.df.T1F$Code<-paste(Pvar.samp.df.T1F$Treatment,Pvar.samp.df.T1F$Time.Point)
    Pvar.samp.df.T1F$Code2<-paste(Pvar.samp.df.T1F$Treatment,Pvar.samp.df.T1F$Time.Point,Pvar.samp.df.T1F$Clade)

  set.seed(30)
  adonis(bc.Pvar.T1F ~ Treatment*Time.Point, data = Pvar.samp.df.T1F)      #adonis test
  set.seed(30)
  adonis(bc.Pvar.T1F ~ Clade*Treatment*Time.Point, data = Pvar.samp.df.T1F)      #adonis test
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Time.Point, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Code, type = "centroid"))
      set.seed(30) 
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Code2, type = "centroid"))
    TukeyHSD(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Code, type = "centroid"))
    
#T1
#make bray curtis data matrix 
  bc.PvarT1 <- phyloseq::distance(Pvar.RelRare.T1, method = "bray")
  Pvar.samp.df.T1 <- as(sample_data(Pvar.RelRare.T1), "data.frame") #sample df
  Pvar.samp.df.T1$Code<-paste(Pvar.samp.df.T1$Treatment,Pvar.samp.df.T1$Clade)
   set.seed(30)
 adonis(bc.PvarT1 ~ Treatment, data = Pvar.samp.df.T1)   #adonis test
  set.seed(30)
 adonis(bc.PvarT1 ~ Clade*Treatment, data = Pvar.samp.df.T1)   #adonis test
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.PvarT1, Pvar.samp.df.T1$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.PvarT1, Pvar.samp.df.T1$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.PvarT1, Pvar.samp.df.T1$Code, type = "centroid"))
 
#TF
#make bray curtis data matrix 
  bc.Pvar.TF <- phyloseq::distance(Pvar.RelRare.TF, method = "bray")
  Pvar.samp.df.TF <- as(sample_data(Pvar.RelRare.TF), "data.frame") #sample df
  Pvar.samp.df.TF$Code<-paste(Pvar.samp.df.TF$Treatment,Pvar.samp.df.TF$Clade)
        set.seed(30)
      adonis(bc.Pvar.TF ~ Treatment, data = Pvar.samp.df.TF)       
      set.seed(30)
      adonis(bc.Pvar.TF ~ Clade*Treatment, data = Pvar.samp.df.TF)
 # Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pvar.TF, Pvar.samp.df.TF$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pvar.TF, Pvar.samp.df.TF$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.Pvar.TF, Pvar.samp.df.TF$Code, type = "centroid"))
    TukeyHSD(betadisper(bc.Pvar.TF, Pvar.samp.df.TF$Code, type = "centroid"))


## by clade: C1 vs C27
  
# C1 only, new objs
Pvar.RelRareT1F.C1 <- subset_samples(Pvar.RelRare.T1F, Clade == "C1")
Pvar.RelRare.T1.C1 <- subset_samples(Pvar.RelRare.T1, Clade == "C1")
Pvar.RelRare.TF.C1 <- subset_samples(Pvar.RelRare.TF, Clade == "C1")
  
#T1TF.C1
#make bray curtis data matrix -T1 and TF
  bc.Pvar.T1F.C1 <- phyloseq::distance(Pvar.RelRareT1F.C1, method = "bray")
  Pvar.samp.df.T1F.C1 <- as(sample_data(Pvar.RelRareT1F.C1), "data.frame") #sample df
#adonis test
  adonis(bc.Pvar.T1F.C1 ~ Treatment*Time.Point, data = Pvar.samp.df.T1F.C1)

#T1.C1
#make bray curtis data matrix 
  bc.PvarT1.C1 <- phyloseq::distance(Pvar.RelRare.T1.C1, method = "bray")
  Pvar.samp.df.T1.C1 <- as(sample_data(Pvar.RelRare.T1.C1), "data.frame") #sample df
#adonis test
  adonis(bc.PvarT1.C1 ~ Treatment, data = Pvar.samp.df.T1.C1)
# Homogeneity of dispersion test  
  beta.Pvar.T1.C1 <- betadisper(bc.PvarT1.C1, Pvar.samp.df.T1.C1$Treatment)
  permutest(beta.Pvar.T1.C1, pairwise = T) 

#TF.C1
#make bray curtis data matrix 
  bc.Pvar.TF.C1 <- phyloseq::distance(Pvar.RelRare.TF.C1, method = "bray")
  Pvar.samp.df.TF.C1 <- as(sample_data(Pvar.RelRare.TF.C1), "data.frame") #sample df
#adonis test
  adonis(bc.Pvar.TF.C1 ~ Treatment, data = Pvar.samp.df.TF.C1)
# Homogeneity of dispersion test  
  beta.Pvar.TF.C1 <- betadisper(bc.Pvar.TF.C1, Pvar.samp.df.TF.C1$Treatment)
  permutest(beta.Pvar.TF.C1, pairwise = T) 


# C27 only, new objs
Pvar.RelRareT1F.C27 <- subset_samples(Pvar.RelRare.T1F, Clade == "C27")
Pvar.RelRare.T1.C27 <- subset_samples(Pvar.RelRare.T1, Clade == "C27")
Pvar.RelRare.TF.C27 <- subset_samples(Pvar.RelRare.TF, Clade == "C27")
  
#T1TF.C27
#make bray curtis data matrix -T1 and TF
  bc.Pvar.T1F.C27 <- phyloseq::distance(Pvar.RelRareT1F.C27, method = "bray")
  Pvar.samp.df.T1F.C27 <- as(sample_data(Pvar.RelRareT1F.C27), "data.frame") #sample df
#adonis test
  adonis(bc.Pvar.T1F.C27 ~ Treatment*Time.Point, data = Pvar.samp.df.T1F.C27)

#T1.C27
#make bray curtis data matrix 
  bc.PvarT1.C27 <- phyloseq::distance(Pvar.RelRare.T1.C27, method = "bray")
  Pvar.samp.df.T1.C27 <- as(sample_data(Pvar.RelRare.T1.C27), "data.frame") #sample df
  adonis(bc.PvarT1.C27 ~ Treatment, data = Pvar.samp.df.T1.C27)#adonis test
# Homogeneity of dispersion test  
  beta.Pvar.T1.C27 <- betadisper(bc.PvarT1.C27, Pvar.samp.df.T1.C27$Treatment)
  permutest(beta.Pvar.T1.C27, pairwise = T) 

#TF.C27
#make bray curtis data matrix 
  bc.Pvar.TF.C27 <- phyloseq::distance(Pvar.RelRare.TF.C27, method = "bray")
  Pvar.samp.df.TF.C27 <- as(sample_data(Pvar.RelRare.TF.C27), "data.frame") #sample df
#adonis test
  adonis(bc.Pvar.TF.C27 ~ Treatment, data = Pvar.samp.df.TF.C27)
# Homogeneity of dispersion test  
  beta.Pvar.TF.C27 <- betadisper(bc.Pvar.TF.C27, Pvar.samp.df.TF.C27$Treatment)
  permutest(beta.Pvar.TF.C27, pairwise = T) 
  
  
  
  
  
  
#which Cs are which   T1F
TopNOTUspvar = names(sort(taxa_sums(Pvar.RelRare.T1F), TRUE)[1:10])
TopNOTUspvar10 = prune_taxa(TopNOTUspvar, Pvar.RelRare.T1F)

OTU.pvarits = as(otu_table(TopNOTUspvar10), "matrix")
# transpose if necessary
if(taxa_are_rows(Pvar.RelRare.T1F)){OTU.pvarits <- t(OTU.pvarits)}
# Coerce to data.frame
OTU.pvaritsdf = as.data.frame(OTU.pvarits)  

#add meta
      TopNOTUspvar10.sd <- as(sample_data(TopNOTUspvar10), "data.frame")

OTU.pvaritsdf$Parent.ID<-TopNOTUspvar10.sd$Parent.ID
  OTU.pvaritsdf$Time.Point<-TopNOTUspvar10.sd$Time.Point
    OTU.pvaritsdf$Clade<-TopNOTUspvar10.sd$Clade
    OTU.pvaritsdf$Treatment<-TopNOTUspvar10.sd$Treatment


write.csv(OTU.pvaritsdf,"OTU.pvaritsdfT1.csv")   
``` 
Pvar NMDS
```{r}   
#dfs 
# C1 only, new objs
# Pvar.RelRareT1F.C1 <- subset_samples(Pvar.RelRare.T1F, Clade == "C1")
# Pvar.RelRare.T1.C1 <- subset_samples(Pvar.RelRare.T1, Clade == "C1")
# Pvar.RelRare.TF.C1 <- subset_samples(Pvar.RelRare.TF, Clade == "C1")


library(RColorBrewer)
library(colorRamps)
library(devtools)

## create palette for parent.ID and treatments
Pvar.Parent.colors <- c("325" = "green4",  "351" = "firebrick3", "353" ="deeppink4", "354" = "orange", "355" = "green1","356" = "gold",  "357"= "hotpink", "358" ="darkslateblue", "359" = "honeydew4", "360" = "khaki4","361" ="ivory4", "362" = "lightblue", "Ambient" = "#4575B4", "High" = "#D73027","C1 Ambient"="blue","C1 High"="red", "C27 Ambient"="darkblue", "C27 High"="darkred") 

#T1 and TF
ord.Pvar <- ordinate(Pvar.RelRare.T1F, method="NMDS", "bray", trymax = 100, set.seed(30)) 
stressplot(ord.Pvar)

scores.Pvar.samp.df <- as.data.frame(scores(ord.Pvar) ) 
scores.Pvar.samp.df$Time.Point <- Pvar.samp.df.T1F$Time.Point
scores.Pvar.samp.df$Parent.ID <- Pvar.samp.df.T1F$Parent.ID
scores.Pvar.samp.df$Treatment <- Pvar.samp.df.T1F$Treatment
scores.Pvar.samp.df$Clade <- Pvar.samp.df.T1F$Clade
scores.Pvar.samp.df$Code <- paste(Pvar.samp.df.T1F$Parent.ID, Pvar.samp.df.T1F$Time.Point)
scores.Pvar.samp.df$Code2 <- paste(Pvar.samp.df.T1F$Treatment, Pvar.samp.df.T1F$Time.Point)


ggplot(scores.Pvar.samp.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Code2))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pvar Bray T1TF its") +
  theme_classic()


ggplot(scores.Pvar.samp.df, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
   # geom_line(aes(group = Code), color = "black") + 
  ggtitle("P.var Bray Curtis") +
  theme_classic()
#ggsave("Pvar_T1TF_its2.pdf")

ggplot(scores.Pvar.samp.df, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Treatment, shape = Time.Point), size = 4) +
  scale_color_manual(values=Pvar.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("P. var Bray Curtis") +
  theme_classic()
#ggsave("PvarT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(Pvar.RelRare.TF, ordinate(Pvar.RelRare, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)



#T1 only
set.seed(30)
ord.PvarT1 <- ordinate(Pvar.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.PvarT1)
scores.PvarT1 <- as.data.frame(scores(ord.PvarT1))
scores.PvarT1$Treatment <- Pvar.samp.df.T1$Treatment
scores.PvarT1$Parent.ID <- Pvar.samp.df.T1$Parent.ID
scores.PvarT1$Clade <- Pvar.samp.df.T1$Clade
scores.PvarT1$CladeTreat <- as.factor(paste(Pvar.samp.df.T1$Clade,Pvar.samp.df.T1$Treatment))

ggplot(scores.PvarT1, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pvar Bray T1 its") +
  theme_classic()

ggplot(scores.PvarT1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  #    geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("P. var T1 Bray Curtis") +
  theme_classic()
#ggsave("Pvar_T1_its2_nmds_clade.pdf")

#TF only
set.seed(30)
ord.PvarTF <- ordinate(Pvar.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.PvarTF)
scores.PvarTF <- as.data.frame(scores(ord.PvarTF))
scores.PvarTF$Treatment <- Pvar.samp.df.TF$Treatment
scores.PvarTF$Parent.ID <- Pvar.samp.df.TF$Parent.ID
scores.PvarTF$Clade <- Pvar.samp.df.TF$Clade
scores.PvarTF$CladeTreat <- as.factor(paste(Pvar.samp.df.TF$Clade,Pvar.samp.df.TF$Treatment))

ggplot(scores.PvarTF, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pvar Bray TF its") +
  theme_classic()


ggplot(scores.PvarTF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Clade, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Clade)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  ggtitle("P. var TF Bray Curtis") +
  theme_classic()
#gsave("Pvar_TF_its_nmds.pdf")



# C1 only, new objs
#Pvar.RelRareT1F.C1 , Pvar.samp.df.T1F.C1
#Pvar.RelRare.T1.C1 , Pvar.samp.df.T1.C1
#Pvar.RelRare.TF.C1 ,Pvar.samp.df.TF.C1

#### BY CLADE ####

#CCC T1 and TF
set.seed(30)
ord.Pvar_CCC  <- ordinate(Pvar.RelRare.T1F, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_CCC)
scores.Pvar_CCC <- as.data.frame(scores(ord.Pvar_CCC))
scores.Pvar_CCC$Treatment <- Pvar.samp.df.T1F$Treatment
scores.Pvar_CCC$Parent.ID <- Pvar.samp.df.T1F$Parent.ID
scores.Pvar_CCC$Time.Point <- Pvar.samp.df.T1F$Time.Point

ggplot(scores.Pvar_CCC, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P var CCC") +
  theme_classic()
#ggsave("PvarTFits_CCC.pdf")


#C T1
set.seed(30)
ord.Pvar_CCC.T1 <- ordinate(Pvar.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_CCC.T1)
scores.Pvar_CCC.T1 <- as.data.frame(scores(ord.Pvar_CCC.T1))
scores.Pvar_CCC.T1$Treatment <- Pvar.samp.df.T1$Treatment
scores.Pvar_CCC.T1$Parent.ID <- Pvar.samp.df.T1$Parent.ID
scores.Pvar_CCC.T1$Time.Point <- Pvar.samp.df.T1$Time.Point

ggplot(scores.Pvar_CCC.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=2, colour = Parent.ID,shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4,shape=Treatment)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var T1 CCC") +
  theme_classic()
#ggsave("Pvar_T1_its_CCC.pdf")

#C TF
set.seed(30)
ord.Pvar_CCC.TF <- ordinate(Pvar.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_CCC.TF)
scores.Pvar_CCC.TF <- as.data.frame(scores(ord.Pvar_CCC.TF))
scores.Pvar_CCC.TF$Treatment <- Pvar.samp.df.TF$Treatment
scores.Pvar_CCC.TF$Parent.ID <- Pvar.samp.df.TF$Parent.ID
scores.Pvar_CCC.TF$Time.Point <- Pvar.samp.df.TF$Time.Point

ggplot(scores.Pvar_CCC.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var CCC TF") +
  theme_classic()
#ggsave("Pvar_TF_its_TF_CCC.pdf")





#C27
set.seed(30)
ord.Pvar_C27 <- ordinate(Pvar.RelRareT1F.C27, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_C27)
scores.Pvar_C27 <- as.data.frame(scores(ord.Pvar_C27))
scores.Pvar_C27$Treatment <- Pvar.samp.df.T1F$Treatment
scores.Pvar_C27$Parent.ID <- Pvar.samp.df.T1F$Parent.ID
scores.Pvar_C27$Time.Point <- Pvar.samp.df.T1F$Time.Point

ggplot(scores.Pvar_C27, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +  
  scale_color_manual(values=Pvar.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var C&D") +
  theme_classic()
#ggsave("Pvar_ITS2_C27_its_T1TF.pdf")

#C27 T1
set.seed(30)
ord.Pvar_C27.T1 <- ordinate(Pvar.RelRare.T1.C27 , "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_C27.T1)
scores.Pvar_C27.T1 <- as.data.frame(scores(ord.Pvar_C27.T1))
scores.Pvar_C27.T1$Treatment <- Pvar.samp.df.T1.C27$Treatment
scores.Pvar_C27.T1$Parent.ID <- Pvar.samp.df.T1.C27$Parent.ID
scores.Pvar_C27.T1$Time.Point <- Pvar.samp.df.T1.C27$Time.Point

ggplot(scores.Pvar_C27.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P var T1 C27") +
  theme_classic()
#ggsave("Pvar_ITS2_C27_T1.pdf")

#CD TF
set.seed(30)
ord.Pvar_C27.TF <- ordinate(Pvar.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pvar_C27.TF)
scores.Pvar_C27.TF <- as.data.frame(scores(ord.Pvar_C27.TF))
scores.Pvar_C27.TF$Treatment <- Pvar.samp.df.TF$Treatment
scores.Pvar_C27.TF$Parent.ID <- Pvar.samp.df.TF$Parent.ID
scores.Pvar_C27.TF$Time.Point <- Pvar.samp.df.TF$Time.Point

ggplot(scores.Pvar_C27.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pvar.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var C27 TF") +
  theme_classic()
#ggsave("Pvar_ITS2_C27_TF.pdf")



```

Pocillopora - T1 and TF together, then independent. PERMANOVA
```{r}   

#DIV_RelA_stats.T1F
#Pacu
Pacu.RelRare.T1F <- subset_samples(DIV_RelA_stats.T1F, host_genus == "pocillopora")
Pacu.RelRare.T1 <- subset_samples(Pacu.RelRare.T1F, Time.Point == "T1")
Pacu.RelRare.TF <- subset_samples(Pacu.RelRare.T1F, Time.Point == "TF")

#T1TF
#make bray curtis data matrix -T1 and TF
  bc.Pacu.T1F <- phyloseq::distance(Pacu.RelRare.T1F, method = "bray")
  Pacu.samp.df.T1F <- as(sample_data(Pacu.RelRare.T1F), "data.frame")            #sample df
  Pacu.samp.df.T1F$Code<-paste(Pacu.samp.df.T1F$Treatment,Pacu.samp.df.T1F$Time.Point)
    Pacu.samp.df.T1F$Code2<-paste(Pacu.samp.df.T1F$Treatment,Pacu.samp.df.T1F$Time.Point,Pacu.samp.df.T1F$Clade)

  set.seeed(30)
  adonis(bc.Pacu.T1F ~ Treatment*Time.Point, data = Pacu.samp.df.T1F)      #adonis test
  set.seed(30)
  adonis(bc.Pacu.T1F ~ Clade*Treatment*Time.Point, data = Pacu.samp.df.T1F)      #adonis test
#write.csv(Pacu.samp.df.T1F, "Pacu_its2_samp_df.csv")
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Time.Point, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Treatment, type = "centroid"))
       set.seed(30) 
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Code, type = "centroid"))
      set.seed(30) 
    permutest(betadisper(bc.Pvar.T1F, Pvar.samp.df.T1F$Code2, type = "centroid"))
    
  #T1
#make bray curtis data matrix 
  bc.PacuT1 <- phyloseq::distance(Pacu.RelRare.T1, method = "bray")
  Pacu.samp.df.T1 <- as(sample_data(Pacu.RelRare.T1), "data.frame") #sample df
  Pacu.samp.df.T1$Code<-paste(Pacu.samp.df.T1$Treatment,Pacu.samp.df.T1$Clade)
      set.seed(30)
 adonis(bc.PacuT1 ~ Treatment, data = Pacu.samp.df.T1)   #adonis test
   set.seed(30)
 adonis(bc.PacuT1 ~ Clade*Treatment, data = Pacu.samp.df.T1)   #adonis test
# Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.PacuT1, Pacu.samp.df.T1$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.PacuT1, Pacu.samp.df.T1$Treatment, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.PacuT1, Pacu.samp.df.T1$Code, type = "centroid"))

#TF
#make bray curtis data matrix 
  bc.Pacu.TF <- phyloseq::distance(Pacu.RelRare.TF, method = "bray")
  Pacu.samp.df.TF <- as(sample_data(Pacu.RelRare.TF), "data.frame") #sample df
  Pacu.samp.df.TF$Code<-paste(Pacu.samp.df.TF$Treatment,Pacu.samp.df.TF$Clade)
#adonis test
      set.seed(30)
 adonis(bc.Pacu.TF ~ Treatment, data = Pacu.samp.df.TF)
 set.seed 
 adonis(bc.Pacu.TF ~ Clade*Treatment, data = Pacu.samp.df.TF)
 # Homogeneity of dispersion test  
   set.seed(30)
    permutest(betadisper(bc.Pacu.TF, Pacu.samp.df.TF$Clade, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pacu.TF, Pacu.samp.df.TF$Treatment, type = "centroid"))
     set.seed(30)
    permutest(betadisper(bc.Pacu.TF, Pacu.samp.df.TF$Code, type = "centroid"))

TukeyHSD(betadisper(bc.Pacu.TF, Pacu.samp.df.TF$Code, type = "centroid"))

## by clade: CCC vs C42 ####
  
# C only, new objs
Pacu.RelRareT1F.CCC <- subset_samples(Pacu.RelRare.T1F, Clade == "CCC")
Pacu.RelRare.T1.CCC <- subset_samples(Pacu.RelRare.T1, Clade == "CCC")
Pacu.RelRare.TF.CCC <- subset_samples(Pacu.RelRare.TF, Clade == "CCC")
  
#T1TF.CCC
#make bray curtis data matrix -T1 and TF
  bc.Pacu.T1F.CCC <- phyloseq::distance(Pacu.RelRareT1F.CCC, method = "bray")
  Pacu.samp.df.T1F.CCC <- as(sample_data(Pacu.RelRareT1F.CCC), "data.frame") #sample df
#adonis test
  adonis(bc.Pacu.T1F.CCC ~ Treatment*Time.Point, data = Pacu.samp.df.T1F.CCC)

#T1.CCC
#make bray curtis data matrix 
  bc.PacuT1.CCC <- phyloseq::distance(Pacu.RelRare.T1.CCC, method = "bray")
  Pacu.samp.df.T1.CCC <- as(sample_data(Pacu.RelRare.T1.CCC), "data.frame") #sample df
#adonis test
  adonis(bc.PacuT1.CCC ~ Treatment, data = Pacu.samp.df.T1.CCC)
# Homogeneity of dispersion test  
  beta.Pacu.T1.CCC <- betadisper(bc.PacuT1.CCC, Pacu.samp.df.T1.CCC$Treatment)
  permutest(beta.Pacu.T1.CCC, pairwise = T) 

#TF.CCC
#make bray curtis data matrix 
  bc.Pacu.TF.CCC <- phyloseq::distance(Pacu.RelRare.TF.CCC, method = "bray")
  Pacu.samp.df.TF.CCC <- as(sample_data(Pacu.RelRare.TF.CCC), "data.frame") #sample df
#adonis test
  adonis(bc.Pacu.TF.CCC ~ Treatment, data = Pacu.samp.df.TF.CCC)
# Homogeneity of dispersion test  
  beta.Pacu.TF.CCC <- betadisper(bc.Pacu.TF.CCC, Pacu.samp.df.TF.CCC$Treatment)
  permutest(beta.Pacu.TF.CCC, pairwise = T) 


# C42 only, new objs
Pacu.RelRareT1F.C42 <- subset_samples(Pacu.RelRare.T1F, Clade == "C42")
Pacu.RelRare.T1.C42 <- subset_samples(Pacu.RelRare.T1, Clade == "C42")
Pacu.RelRare.TF.C42 <- subset_samples(Pacu.RelRare.TF, Clade == "C42")
  
#T1TF.C42
#make bray curtis data matrix -T1 and TF
  bc.Pacu.T1F.C42 <- phyloseq::distance(Pacu.RelRareT1F.C42, method = "bray")
  Pacu.samp.df.T1F.C42 <- as(sample_data(Pacu.RelRareT1F.C42), "data.frame") #sample df
#adonis test
  adonis(bc.Pacu.T1F.C42 ~ Treatment*Time.Point, data = Pacu.samp.df.T1F.C42)

#T1.C42
#make bray curtis data matrix 
  bc.PacuT1.C42 <- phyloseq::distance(Pacu.RelRare.T1.C42, method = "bray")
  Pacu.samp.df.T1.C42 <- as(sample_data(Pacu.RelRare.T1.C42), "data.frame") #sample df
  adonis(bc.PacuT1.C42 ~ Treatment, data = Pacu.samp.df.T1.C42)#adonis test
# Homogeneity of dispersion test  
  beta.Pacu.T1.C42 <- betadisper(bc.PacuT1.C42, Pacu.samp.df.T1.C42$Treatment)
  permutest(beta.Pacu.T1.C42, pairwise = T) 

#TF.C42
#make bray curtis data matrix 
  bc.Pacu.TF.C42 <- phyloseq::distance(Pacu.RelRare.TF.C42, method = "bray")
  Pacu.samp.df.TF.C42 <- as(sample_data(Pacu.RelRare.TF.C42), "data.frame") #sample df
#adonis test
  adonis(bc.Pacu.TF.C42 ~ Treatment, data = Pacu.samp.df.TF.C42)
# Homogeneity of dispersion test  
  beta.Pacu.TF.C42 <- betadisper(bc.Pacu.TF.C42, Pacu.samp.df.TF.C42$Treatment)
  permutest(beta.Pacu.TF.C42, pairwise = T) 
  
  
  
  
  
#which Cs are which   T1F
TopNOTUspacu = names(sort(taxa_sums(Pacu.RelRare.T1F), TRUE)[1:20])
TopNOTUspacu10 = prune_taxa(TopNOTUspacu, Pacu.RelRare.T1F)

OTU.pacuits = as(otu_table(TopNOTUspacu10), "matrix")
# transpose if necessary
if(taxa_are_rows(Pacu.RelRare.T1F)){OTU.pacuits <- t(OTU.pacuits)}
# Coerce to data.frame
OTU.pacuitsdf = as.data.frame(OTU.pacuits)  

#add meta
      TopNOTUspacu10.sd <- as(sample_data(TopNOTUspacu10), "data.frame")

OTU.pacuitsdf$Parent.ID<-TopNOTUspacu10.sd$Parent.ID
  OTU.pacuitsdf$Time.Point<-TopNOTUspacu10.sd$Time.Point
    OTU.pacuitsdf$Clade<-TopNOTUspacu10.sd$Clade
    OTU.pacuitsdf$Treatment<-TopNOTUspacu10.sd$Treatment


write.csv(OTU.pacuitsdf,"OTU.pacuitsdfT1b.csv")   

#again for C42 only
Pacu.RelRare.T1F.c42<-subset_samples(Pacu.RelRare.T1F, Clade=="C42")
TopNOTUspacu = names(sort(taxa_sums(Pacu.RelRare.T1F.c42), TRUE)[1:20])
TopNOTUspacu10 = prune_taxa(TopNOTUspacu, Pacu.RelRare.T1F.c42)

OTU.pacuits = as(otu_table(TopNOTUspacu10), "matrix")
# transpose if necessary
if(taxa_are_rows(Pacu.RelRare.T1F.c42)){OTU.pacuits <- t(OTU.pacuits)}
# Coerce to data.frame
OTU.pacuitsdf = as.data.frame(OTU.pacuits)  

#add meta
      TopNOTUspacu10.sd <- as(sample_data(TopNOTUspacu10), "data.frame")

OTU.pacuitsdf$Parent.ID<-TopNOTUspacu10.sd$Parent.ID
  OTU.pacuitsdf$Time.Point<-TopNOTUspacu10.sd$Time.Point
    OTU.pacuitsdf$Clade<-TopNOTUspacu10.sd$Clade
    OTU.pacuitsdf$Treatment<-TopNOTUspacu10.sd$Treatment


write.csv(OTU.pacuitsdf,"OTU.pacuitsdfT1bC42.csv")   
``` 

Pacu NMDS
```{r} 
# C only, new objs 
Pacu.RelRareT1F.CCC <- subset_samples(Pacu.RelRare.T1F, Clade == "CCC")
Pacu.RelRare.T1.CCC <- subset_samples(Pacu.RelRare.T1, Clade == "CCC")
Pacu.RelRare.TF.CCC <- subset_samples(Pacu.RelRare.TF, Clade == "CCC")
# # pull df sections for craig Pacu.RelRare.T1F
# OTU_Pacu<-out_table(Pacu.RelRare.T1F)
# tax  = tax_table(coralDIV2_rare2)
# otu  = otu_table(coralDIV2_rare2)
# 
# OTU1 = as(otu_table(Pacu.RelRare.T1F), "matrix")
# # transpose if necessary
# if(taxa_are_rows(Pacu.RelRare.T1F)){OTU1 <- t(OTU1)}
# # Coerce to data.frame
# OTUdf = as.data.frame(OTU1)
# write.csv(OTUdf, "Pacuta_its2_T1TF.csv")
# 


library(RColorBrewer)
library(colorRamps)
library(devtools)

## create palette for parent.ID and treatments
Pacu.Parent.colors <- c("305" = "green4",  "306" = "firebrick3", "307" ="deeppink4", "308" = "orange", "309" = "green1","310" = "gold",  "311"= "hotpink", "312" ="darkslateblue", "302" = "honeydew4", "303" = "khaki4","304" ="ivory4", "305" = "lightblue", "Ambient" = "#4575B4", "High" = "#D73027","CCC Ambient"="blue","CCC High"="red", "C42 Ambient"="darkblue", "C42 High"="darkred") 




 
#T1 and TF
ord.Pacu <- ordinate(Pacu.RelRare.T1F, method="NMDS", "bray", trymax = 100, set.seed(30)) 
stressplot(ord.Pacu)

scores.Pacu.samp.df <- as.data.frame(scores(ord.Pacu) ) 
scores.Pacu.samp.df$Time.Point <- Pacu.samp.df.T1F$Time.Point
scores.Pacu.samp.df$Parent.ID <- Pacu.samp.df.T1F$Parent.ID
scores.Pacu.samp.df$Treatment <- Pacu.samp.df.T1F$Treatment
scores.Pacu.samp.df$Clade <- Pacu.samp.df.T1F$Clade
scores.Pacu.samp.df$Code <- paste(Pacu.samp.df.T1F$Parent.ID, Pacu.samp.df.T1F$Time.Point)
scores.Pacu.samp.df$Code2 <- paste(Pacu.samp.df.T1F$Treatment, Pacu.samp.df.T1F$Time.Point)

ggplot(scores.Pacu.samp.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Code2))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pacu Bray T1TF its") +
  theme_classic()

ggplot(scores.Pacu.samp.df, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
   # geom_line(aes(group = Code), color = "black") + 
  ggtitle("P.acu Bray Curtis") +
  theme_classic()
#ggsave("Pacu_T1TF_its2.pdf")

ggplot(scores.Pacu.samp.df, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Treatment, shape = Time.Point), size = 4) +
  scale_color_manual(values=Pacu.Parent.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
     # geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("P. var Bray Curtis") +
  theme_classic()
#ggsave("PacuT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(Pacu.RelRare.TF, ordinate(Pacu.RelRare, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)



#T1 only
set.seed(30)
ord.PacuT1 <- ordinate(Pacu.RelRare.T1, "NMDS", "bray", trymax = 100) 
stressplot(ord.PacuT1)
scores.PacuT1 <- as.data.frame(scores(ord.PacuT1))
scores.PacuT1$Treatment <- Pacu.samp.df.T1$Treatment
scores.PacuT1$Parent.ID <- Pacu.samp.df.T1$Parent.ID
scores.PacuT1$Clade <- Pacu.samp.df.T1$Clade
scores.PacuT1$CladeTreat <- as.factor(paste(Pacu.samp.df.T1$Clade,Pacu.samp.df.T1$Treatment))

ggplot(scores.PacuT1, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pvar.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pacu Bray T1 its") +
  theme_classic()

ggplot(scores.PacuT1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  #    geom_line(aes(group = Parent.ID), color = "black") + 
  ggtitle("P. var T1 Bray Curtis") +
  theme_classic()
#ggsave("Pacu_T1_its2_nmds_clade.pdf")




#TF only
set.seed(30)
ord.PacuTF <- ordinate(Pacu.RelRare.TF, "NMDS", "bray", trymax = 100) 
stressplot(ord.PacuTF)
scores.PacuTF <- as.data.frame(scores(ord.PacuTF))
scores.PacuTF$Treatment <- Pacu.samp.df.TF$Treatment
scores.PacuTF$Parent.ID <- Pacu.samp.df.TF$Parent.ID
scores.PacuTF$Clade <- Pacu.samp.df.TF$Clade
scores.PacuTF$CladeTreat <- as.factor(paste(Pacu.samp.df.TF$Clade,Pacu.samp.df.TF$Treatment))

ggplot(scores.PacuTF, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Treatment, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pvar.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(CladeTreat))) +
    scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("Pacu Bray TF its") +
  theme_classic()


ggplot(scores.PacuTF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Clade, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Clade)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = CladeTreat), linetype = 2) +
  ggtitle("P. var TF Bray Curtis") +
  theme_classic()
#gsave("Pacu_TF_its_nmds.pdf")










#### BY CLADE####

#CCC T1 and TF
Pacu.RelRare.T1F.CCC<-subset_samples(Pacu.RelRare.T1F, Clade=="CCC")
  Pacu.samp.df.T1F.CCC <- as(sample_data(Pacu.RelRare.T1F.CCC), "data.frame") #sample df
set.seed(30)
ord.Pacu_CCCT1F  <- ordinate(Pacu.RelRare.T1F.CCC, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pacu_CCCT1F)

scores.Pacu_CCCT1f <- as.data.frame(scores(ord.Pacu_CCCT1F))
scores.Pacu_CCCT1f$Treatment <- Pacu.samp.df.T1F.CCC$Treatment
scores.Pacu_CCCT1f$Parent.ID <- Pacu.samp.df.T1F.CCC$Parent.ID
scores.Pacu_CCCT1f$Time.Point <- Pacu.samp.df.T1F.CCC$Time.Point
scores.Pacu_CCCT1f$Code<-paste(scores.Pacu_CCCT1f$Treatment, scores.Pacu_CCCT1f$Time.Point)

ggplot(scores.Pacu_CCCT1f, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code, lty=factor(Code))) +

  ggtitle("P var CCC") +
  theme_classic()
#ggsave("PacuTFits_CCC.pdf")


#CCC T1
Pacu.RelRare.T1.CCC<-subset_samples(Pacu.RelRare.T1, Clade=="CCC")
  Pacu.samp.df.T1.CCC <- as(sample_data(Pacu.RelRare.T1.CCC), "data.frame") #sample df
set.seed(30)
ord.Pacu_CCC.T1 <- ordinate(Pacu.RelRare.T1.CCC, "NMDS", "bray", trymax = 500) 
stressplot(ord.Pacu_CCC.T1)
scores.Pacu_CCC.T1 <- as.data.frame(scores(ord.Pacu_CCC.T1))
scores.Pacu_CCC.T1$Treatment <- Pacu.samp.df.T1.CCC$Treatment
scores.Pacu_CCC.T1$Parent.ID <- Pacu.samp.df.T1.CCC$Parent.ID
scores.Pacu_CCC.T1$Time.Point <- Pacu.samp.df.T1.CCC$Time.Point

ggplot(scores.Pacu_CCC.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=2, colour = Parent.ID,shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4,shape=Treatment)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var T1 CCC") +
  theme_classic()
#ggsave("Pacu_T1_its_CCC.pdf")




#CCC TF 

Pacu.RelRare.TF.CCC<-subset_samples(Pacu.RelRare.TF, Clade=="CCC")
  Pacu.samp.df.TF.CCC <- as(sample_data(Pacu.RelRare.TF.CCC), "data.frame") #sample df
set.seed(30)
ord.Pacu_CCC.TF <- ordinate(Pacu.RelRare.TF.CCC, "NMDS", "bray", trymax = 500) 
stressplot(ord.Pacu_CCC.TF)

scores.Pacu_CCC.TF <- as.data.frame(scores(ord.Pacu_CCC.TF))
scores.Pacu_CCC.TF$Treatment <- Pacu.samp.df.TF.CCC$Treatment
scores.Pacu_CCC.TF$Parent.ID <- Pacu.samp.df.TF.CCC$Parent.ID
scores.Pacu_CCC.TF$Time.Point <- Pacu.samp.df.TF.CCC$Time.Point

ggplot(scores.Pacu_CCC.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=2, colour = Parent.ID,shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4,shape=Treatment)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P. var TF CCC") +
  theme_classic()
#ggsave("Pacu_TF_its_CCC.pdf")




#C42
#C42 T1 and TF
Pacu.RelRare.T1F.C42<-subset_samples(Pacu.RelRare.T1F, Clade=="C42")
  Pacu.samp.df.T1F.C42 <- as(sample_data(Pacu.RelRare.T1F.C42), "data.frame") #sample df
set.seed(30)
ord.Pacu_C42T1F  <- ordinate(Pacu.RelRare.T1F.C42, "NMDS", "bray", trymax = 100) 
stressplot(ord.Pacu_C42T1F)

scores.Pacu_C42T1f <- as.data.frame(scores(ord.Pacu_C42T1F))
scores.Pacu_C42T1f$Treatment <- Pacu.samp.df.T1F.C42$Treatment
scores.Pacu_C42T1f$Parent.ID <- Pacu.samp.df.T1F.C42$Parent.ID
scores.Pacu_C42T1f$Time.Point <- Pacu.samp.df.T1F.C42$Time.Point
scores.Pacu_C42T1f$Code<-paste(scores.Pacu_C42T1f$Treatment, scores.Pacu_C42T1f$Time.Point)

ggplot(scores.Pacu_C42T1f, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Time.Point,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Time.Point)) +
  scale_color_manual(values=Pacu.Parent.colors)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code, lty=factor(Time.Point))) +

  ggtitle("P var C42") +
  theme_classic()
#ggsave("PacuTFits_C42.pdf")

#C42 T1
set.seed(30)
ord.Pacu_C42.T1 <- ordinate(Pacu.RelRare.T1.C42 , "NMDS", "bray", trymax = 100) 
stressplot(ord.Pacu_C42.T1)
scores.Pacu_C42.T1 <- as.data.frame(scores(ord.Pacu_C42.T1))
scores.Pacu_C42.T1$Treatment <- Pacu.samp.df.T1.C42$Treatment
scores.Pacu_C42.T1$Parent.ID <- Pacu.samp.df.T1.C42$Parent.ID
scores.Pacu_C42.T1$Time.Point <- Pacu.samp.df.T1.C42$Time.Point

ggplot(scores.Pacu_C42.T1, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P var T1 C42") +
  theme_classic()
#ggsave("Pacu_ITS2_C42_T1.pdf")

#C42 TF
set.seed(30)
ord.Pacu_C42.TF <- ordinate(Pacu.RelRare.TF.C42 , "NMDS", "bray", trymax = 100) 
stressplot(ord.Pacu_C42.TF)
scores.Pacu_C42.TF <- as.data.frame(scores(ord.Pacu_C42.TF))
scores.Pacu_C42.TF$Treatment <- Pacu.samp.df.TF.C42$Treatment
scores.Pacu_C42.TF$Parent.ID <- Pacu.samp.df.TF.C42$Parent.ID
scores.Pacu_C42.TF$Time.Point <- Pacu.samp.df.TF.C42$Time.Point

ggplot(scores.Pacu_C42.TF, aes(x = NMDS1, y = NMDS2)) + 
geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment, size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) + 
  scale_color_manual(values=Pacu.Parent.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment), linetype = 2) +
  ggtitle("P var TF C42") +
  theme_classic()
#ggsave("Pacu_ITS2_C42_TF.pdf")





```

#Alpha diversit: observed richness, Shannon (+evenness) - microbiome packages  
Use rarefied data, not relative abunances   
df:coralDIV2_rare2  
```{r}         

Sp.colors <- c("Montipora_capitata"= "#D43F3AFF","Porites_compressa"="#EEA236FF","Pavona_varians"="#5CB85CFF","Pocillopora_acuta"="#46B8DAFF", "High"="darkRed","Ambient"="navyBlue")

its2.al.alpha<-coralDIV2_rare2 #make a copy of df, use COUNTS

#its2.al.alpha<-subset_samples(its2.al.alpha, Time.Point=="T1" |Time.Point=="TF")  # ONLY KEEP T1 and TF!
its2.al.alpha2 <- prune_taxa(taxa_sums(its2.al.alpha) > 0, its2.al.alpha) #prune taxa 0s
its2.al.alpha2.sd <- as(sample_data(its2.al.alpha2), "data.frame") #create sample data frame to view


#####try microbiome package for evenness and alpha diversity. use raw counts
library(microbiome)  
library(knitr)

erich.tab <-microbiome::alpha(its2.al.alpha2, index = "all") # pull out: observed, diversity_shannon, evenness_pielou

erich.tab2its<-erich.tab[-c(2:4,6:8,10:22)] #keep the cols you need

 erich.tab2its$Treatment <- its2.al.alpha2.sd$Treatment       #add its2k in meta
  erich.tab2its$Time.Point <- its2.al.alpha2.sd$Time.Point
  erich.tab2its$Parent.ID <- its2.al.alpha2.sd$Parent.ID
  erich.tab2its$ID <- its2.al.alpha2.sd$Frag.ID
  erich.tab2its$Species <- its2.al.alpha2.sd$Species
    erich.tab2its$Clade <- its2.al.alpha2.sd$Clade
    erich.tab2its$Tank.num <- its2.al.alpha2.sd$Tank.num

  erich.tab2its$Time.Point = factor(erich.tab2its$Time.Point, levels = c("T0", "T1", "TF"))


#all species - to show significance and to subset  <- you can cut you do below

#ANOVA
#shannon
  aov.shannon.species = aov(diversity_shannon ~ Species*Time.Point*Treatment, data=erich.tab2its)
  summary(aov.shannon.species) # sig diff between species
  TukeyHSD(aov.shannon.species)
#observed  
  aov.observed.species = aov(observed ~ Species*Time.Point*Treatment, data=erich.tab2its)
  summary(aov.observed.species) # sig diff between species
  TukeyHSD(aov.observed.species)
#evenness
  aov.evenness.species = aov(evenness_pielou ~ Species*Time.Point*Treatment, data=erich.tab2its)
  summary(aov.evenness.species) # sig diff between species
  TukeyHSD(aov.evenness.species)  
#Plot
  boxplot(diversity_shannon ~ Species, data=erich.tab2its, ylab="Shannon's diversity") 
  boxplot(observed ~ Species, data=erich.tab2its, ylab="Observed") 
  boxplot(evenness_pielou ~ Species, data=erich.tab2its, ylab="Evenness_pielou") 

#violin plots
  # create a list of pairwise comaprisons
al.species <- levels(erich.tab2its$Species) # get the variables

# make a pairwise list that we want to compare.
  al.species.pairs <- combn(seq_along(al.species), 2, simplify = FALSE, FUN = function(i)al.species[i])
  print(al.species.pairs)

  
  erich.tab2its$Code<-paste(erich.tab2its$Species,erich.tab2its$Clade)
  
#observed
p1 <- ggviolin(erich.tab2its, x = "Species", y = "observed",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)
  
  p1 <- ggviolin(erich.tab2its, x = "Code", y = "observed",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)

    
#Shannon
p1 <- ggviolin(erich.tab2its, x = "Species", y = "diversity_shannon",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)
p1 <- p1 + stat_compare_means(comparisons = al.species.pairs) #non-parametric test (Wilcoxon test)
  print(p1)
  
#Evenness
p1 <- ggviolin(erich.tab2its, x = "Species", y = "evenness_pielou",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)
#
p1 <- ggviolin(erich.tab2its, x = "Code", y = "evenness_pielou",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)


#by species:
erich.tab2its.mcap<-subset(erich.tab2its, Species=="Montipora_capitata")
erich.tab2its.pcomp<-subset(erich.tab2its, Species=="Porites_compressa")
erich.tab2its.pvar<-subset(erich.tab2its, Species=="Pavona_varians")
erich.tab2its.pacu<-subset(erich.tab2its, Species=="Pocillopora_acuta")


#look at data
#observed
hist(erich.tab2its$observed)
ggqqplot(erich.tab2its$observed)
hist(log(erich.tab2its$observed))
ggqqplot(log10(erich.tab2its$observed))
erich.tab2its$observed_log<-log10(erich.tab2its$observed)
#by species:
erich.tab2its.mcap<-subset(erich.tab2its, Species=="Montipora_capitata")
erich.tab2its.pcomp<-subset(erich.tab2its, Species=="Porites_compressa")
erich.tab2its.pvar<-subset(erich.tab2its, Species=="Pavona_varians")
erich.tab2its.pacu<-subset(erich.tab2its, Species=="Pocillopora_acuta")

hist(erich.tab2its.mcap$observed_log)
hist(erich.tab2its.mcap$observed)

ggqqplot(erich.tab2its.mcap$observed)
 hist(erich.tab2its.pcomp$observed_log)
ggqqplot(erich.tab2its.pcomp$observed_log)
   hist(erich.tab2its.pvar$observed_log)
ggqqplot(erich.tab2its.pvar$observed_log)
        hist(erich.tab2its.pacu$observed_log)
                hist(erich.tab2its.pacu$observed)
ggqqplot(erich.tab2its.pacu$observed_log)



#shannon
hist(erich.tab2its$diversity_shannon)
ggqqplot(erich.tab2its$diversity_shannon)
hist(log10(erich.tab2its$diversity_shannon))
ggqqplot(log10(erich.tab2its$diversity_shannon))
hist(sqrt(erich.tab2its$diversity_shannon))
ggqqplot(sqrt(erich.tab2its$diversity_shannon))
hist((erich.tab2its$diversity_shannon)^(1/4))
ggqqplot(sqrt(erich.tab2its$diversity_shannon))


#evenness
hist(erich.tab2its$evenness_pielou) #best
ggqqplot(erich.tab2its$evenness_pielou)
erich.tab2its$evenness_pielou_log<-log10(erich.tab2its$evenness_pielou)
hist(log10(erich.tab2its$evenness_pielou))#worse
ggqqplot(erich.tab2its$evenness_pielou)
erich.tab2its$even.t<-sqrt(max(erich.tab2its$evenness_pielou+1)-erich.tab2its$evenness_pielou)
hist(sqrt(max(erich.tab2its$evenness_pielou+1)-erich.tab2its$evenness_pielou))
ggqqplot(sqrt(max(erich.tab2its$evenness_pielou+1)-erich.tab2its$evenness_pielou))

hist(erich.tab2its.mcap$evenness_pielou)
ggqqplot(erich.tab2its.mcap$evenness_pielou)
 hist(erich.tab2its.pcomp$evenness_pielou)
ggqqplot(erich.tab2its.pcomp$evenness_pielou)
   hist(erich.tab2its.pvar$evenness_pielou)
ggqqplot(erich.tab2its.pvar$evenness_pielou)
        hist(erich.tab2its.pacu$evenness_pielou)
ggqqplot(erich.tab2its.pacu$evenness_pielou)

#by species:
erich.tab2its.mcap<-subset(erich.tab2its, Species=="Montipora_capitata")
erich.tab2its.pcomp<-subset(erich.tab2its, Species=="Porites_compressa")
erich.tab2its.pvar<-subset(erich.tab2its, Species=="Pavona_varians")
erich.tab2its.pacu<-subset(erich.tab2its, Species=="Pocillopora_acuta")

hist(erich.tab2its.mcap$evenness_pielou_log)
ggqqplot(erich.tab2its.mcap$evenness_pielou_log)
 hist(erich.tab2its.pcomp$evenness_pielou_log)
ggqqplot(erich.tab2its.pcomp$evenness_pielou_log)
   hist(erich.tab2its.pvar$evenness_pielou_log)
ggqqplot(erich.tab2its.pvar$evenness_pielou_log)
        hist(erich.tab2its.pacu$evenness_pielou_log)
ggqqplot(erich.tab2its.pacu$evenness_pielou_log)






#by species:
erich.tab2its.mcap<-subset(erich.tab2its, Species=="Montipora_capitata")
erich.tab2its.pcomp<-subset(erich.tab2its, Species=="Porites_compressa")
erich.tab2its.pvar<-subset(erich.tab2its, Species=="Pavona_varians")
erich.tab2its.pacu<-subset(erich.tab2its, Species=="Pocillopora_acuta")

hist(erich.tab2its.mcap$observed_log)
hist(erich.tab2its.mcap$observed) #better
hist(erich.tab2its.pcomp$observed_log)#better
hist(erich.tab2its.pcomp$observed) 
hist(erich.tab2its.pvar$observed_log)#better
hist(erich.tab2its.pvar$observed) 
hist(erich.tab2its.pacu$observed_log)#better
hist(erich.tab2its.pacu$observed) 





```
#Observed Richness not transformed
```{r}     
#observed   

observed_alpha_mod<-lmer(observed ~ Species*Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its) #adding tank is singularity
set.seed(30)
  anova(observed_alpha_mod) 
  qqPlot(residuals(observed_alpha_mod)) 
  emm<-emmeans(observed_alpha_mod,  ~ Species, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  observed_alpha_mod<-lmer(observed ~ Species*Time.Point*Treatment*Clade+(1|Parent.ID), data=erich.tab2its) #adding tank is singularity
  anova(observed_alpha_mod) 
  qqPlot(residuals(observed_alpha_mod)) 
  emm<-emmeans(observed_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

#T0 only ####
  erich.tab2its.T0<-subset(erich.tab2its, Time.Point=="T0")
  hist(erich.tab2its.T0$observed)
  observed_alpha_mod<-lmer(observed ~ Species+(1|Tank.num), data=erich.tab2its.T0) #adding tank is singularity
set.seed(30)
  anova(observed_alpha_mod) 
  qqPlot(residuals(observed_alpha_mod)) 
  emm<-emmeans(observed_alpha_mod,  ~ Species, adjust="Tukey")
  cld(emm)
  pairs(emm)

  observed_alpha_mod<-lmer(observed ~ Species*Clade+(1|Tank.num), data=erich.tab2its.T0) #adding tank is singularity
set.seed(30)
  anova(observed_alpha_mod) 
  qqPlot(residuals(observed_alpha_mod)) 
  emm<-emmeans(observed_alpha_mod,  ~ Species*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm) 
  
  #Richness
p1 <- ggviolin(erich.tab2its.T0, x = "Species", y = "observed",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)
#Evenness
p1 <- ggviolin(erich.tab2its.T0, x = "Species", y = "evenness_pielou",
   add = "boxplot", fill = "Species", palette = c(Sp.colors)) 
  print(p1)

  
  
  #T0 by species 
#   erich.tab2its.T0.mcap<-subset(erich.tab2its.T0, Species=="Montipora_capitata")
#   hist(erich.tab2its.T0.mcap$observed_log)
#   observed_alpha_mod<-lmer(observed ~ Clade+(1|Tank.num), data=erich.tab2its.T0.mcap) #adding tank is singularity
# set.seed(30)
#   anova(observed_alpha_mod) 
#   qqPlot(residuals(observed_alpha_mod)) 
#   emm<-emmeans(observed_alpha_mod,  ~ Species, adjust="Tukey")
#   cld(emm)
#   pairs(emm)
  
  
  
  
 
##Mcap only ####
  hist(erich.tab2its.mcap$observed)
ggqqplot(erich.tab2its.mcap$observed)

  erich.tab2its.mcap.t1tf<-subset(erich.tab2its.mcap, Time.Point=="T1"|Time.Point=="TF")
 #t1TF
  Mcap_alpha_mod<-lmer(observed ~ Time.Point*Treatment+(1|Parent.ID), data=erich.tab2its.mcap.t1tf) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(observed ~ Time.Point*Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.t1tf) #adding tank is singularity
  anova(Mcap_alpha_mod) 
qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.mcap.T1<-subset(erich.tab2its.mcap, Time.Point=="T1")

  Mcap_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.T1) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.T1) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#T1 by clade richness
 #C
  erich.tab2its.mcap.T1.C<-subset(erich.tab2its.mcap.T1, Clade=="C")

  Mcap_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.T1.C) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  #CD
  erich.tab2its.mcap.T1.CD<-subset(erich.tab2its.mcap.T1, Clade=="CD")

  Mcap_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.T1.CD) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  
  #tf
  erich.tab2its.mcap.TF<-subset(erich.tab2its.mcap, Time.Point=="TF")

   Mcap_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.TF) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.TF) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

#t0  <- WHY IS THIS ONE BEING WEIRD CAN YOU USE OR NO
  erich.tab2its.mcap.T0<-subset(erich.tab2its.mcap, Time.Point=="T0")
hist(erich.tab2its.mcap.T0$observed)
   Mcap_alpha_mod<-lmer(observed ~ Clade+(1|Tank.num), data=erich.tab2its.mcap.T0) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)   
  
####### PCOMP only ####
   
  #t1TF
  erich.tab2its.pcompT1TF<-subset(erich.tab2its.pcomp, Time.Point=="T1"|Time.Point=="TF")
  pcomp_alpha_mod<-lmer(observed ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcompT1TF) 
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(observed ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcomp) 
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pcomp.T1<-subset(erich.tab2its.pcomp, Time.Point=="T1")

  pcomp_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.pcomp.T1) 
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pcomp.T1)
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.pcomp.TF<-subset(erich.tab2its.pcomp, Time.Point=="TF")

   pcomp_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcomp.TF) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pcomp.TF) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  #t0
  erich.tab2its.pcomp.T0<-subset(erich.tab2its.pcomp, Time.Point=="T0")
hist(erich.tab2its.pcomp.T0$observed)
   pcomp_alpha_mod<-lmer(observed ~ Clade+(1|Tank.num), data=erich.tab2its.pcomp.T0) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  

####### pvar only####
   
  #t1TF
  erich.tab2its.pvarT1TF<-subset(erich.tab2its.pvar, Time.Point=="T1"|Time.Point=="TF")

  pvar_alpha_mod<-lmer(observed ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvarT1TF) 
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(observed ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvar) 
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pvar.T1<-subset(erich.tab2its.pvar, Time.Point=="T1")

  pvar_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvar.T1) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pvar.T1) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.pvar.TF<-subset(erich.tab2its.pvar, Time.Point=="TF")

   pvar_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvar.TF) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pvar.TF) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#t0
  erich.tab2its.pvar.T0<-subset(erich.tab2its.pvar, Time.Point=="T0")
hist(erich.tab2its.pvar.T0$observed)
   pvar_alpha_mod<-lmer(observed ~ Clade+(1|Tank.num), data=erich.tab2its.pvar.T0) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)    
  ####### pacu only####

  #t1TF
    erich.tab2its.pacuT1TF<-subset(erich.tab2its.pacu, Time.Point=="T1"|Time.Point=="TF")

  pacu_alpha_mod<-lmer(observed ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacuT1TF) 
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pacu_alpha_mod<-lmer(observed ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacu) 
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pacu.T1<-subset(erich.tab2its.pacu, Time.Point=="T1")

  pacu_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID), data=erich.tab2its.pacu.T1) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pacu_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pacu.T1) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.pacu.TF<-subset(erich.tab2its.pacu, Time.Point=="TF")

   pacu_alpha_mod<-lmer(observed ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacu.TF) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pacu_alpha_mod<-lmer(observed ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pacu.TF) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t0
  erich.tab2its.pacu.T0<-subset(erich.tab2its.pacu, Time.Point=="T0")
hist(erich.tab2its.pacu.T0$observed)
   pacu_alpha_mod<-lmer(observed ~ Clade+(1|Tank.num), data=erich.tab2its.pacu.T0) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)     
  
  
  
``` 
alpha Observed Plots, no clade
```{r} 
#Means
observed_mean <- ddply(erich.tab2its, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                 N    = length(observed[!is.na(observed)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(observed, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(observed, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(observed, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
observed_mean

observed_mean<-subset(observed_mean, Time.Point=="T1"|Time.Point=="TF")
#Mcap 
Mcap_observed_mean<-subset(observed_mean, Species=="Montipora_capitata") #Subset Mcap
# Pcomp 
Pcomp_observed_mean<-subset(observed_mean, Species=="Porites_compressa") #Subset Pcomp
# Pacu 
Pacu_observed_mean<-subset(observed_mean, Species=="Pocillopora_acuta") #Subset Pacu
# Pvar 
Pvar_observed_mean<-subset(observed_mean, Species=="Pavona_varians") #Subset Pvar

#mcap plots
#plot Mcap
Mcap_observed_plot<-ggplot(data=Mcap_observed_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
 ylim(0, 40) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Mcap Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_observed_plot


#plot Pcomp
Pcomp_observed_plot<-ggplot(data=Pcomp_observed_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
 ylim(0, 40) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pcomp Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_observed_plot

#Pvar plots
#plot Pvar
Pvar_observed_plot<-ggplot(data=Pvar_observed_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
 ylim(0, 40) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pvar Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pvar_observed_plot


#Pacu plots
#plot Pacu
Pacu_observed_plot<-ggplot(data=Pacu_observed_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylim(0, 40) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pacu Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pacu_observed_plot

###### All plots together
Mcap_observed_plot<-Mcap_observed_plot+ theme(legend.position = "none") #remove legend
Pcomp_observed_plot<-Pcomp_observed_plot+ theme(legend.position = "none") #remove legend
Pvar_observed_plot<-Pvar_observed_plot+ theme(legend.position = "none") #remove legend
Pacu_observed_plot<-Pacu_observed_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_observed_plot, Pcomp_observed_plot, Pvar_observed_plot,Pacu_observed_plot, nrow = 1)
 
```  

alpha Observed Plots, clade  
```{r}   
# color pal from eta mcap.g.Parent.colors
alpha.colors <- c( "Ambient" = "dodgerblue", "High" = "darkred",
                        "C Ambient"="#1F78B4","C High"="#6A3D9A", "CD Ambient"="#E31A1C", "CD High"="#FF7F00") 

#Means
observed_mean.C <- ddply(erich.tab2its, c("Treatment", "Species", "Time.Point","Clade"), summarise, #summarize cell counts
                 N    = length(observed[!is.na(observed)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(observed, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(observed, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(observed, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
observed_mean.C
observed_mean.C$Code<-paste(observed_mean.C$Clade, observed_mean.C$Treatment)

#Mcap 
Mcap_observed_mean.C<-subset(observed_mean.C, Species=="Montipora_capitata") #Subset Mcap
# Pcomp 
Pcomp_observed_mean.C<-subset(observed_mean.C, Species=="Porites_compressa") #Subset Pcomp
# Pacu 
Pacu_observed_mean.C<-subset(observed_mean.C, Species=="Pocillopora_acuta") #Subset Pacu
# Pvar 
Pvar_observed_mean.C<-subset(observed_mean.C, Species=="Pavona_varians") #Subset Pvar

#mcap plots
#plot Mcap 
Mcap_observed_plot<-ggplot(data=Mcap_observed_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
 # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Mcap Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_observed_plot

#plot for defense Mcap T1 and TF
Mcap_observed_mean.C_T1TF<-subset(Mcap_observed_mean.C, Time.Point=="T1"|Time.Point=="TF")
Mcap_observed_plot<-ggplot(data=Mcap_observed_mean.C_T1TF, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
 ylim(0, 45) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Mcap Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_observed_plot


#Pcomp plots
#plot Pcomp
Pcomp_observed_mean.C_T1TF<-subset(Pcomp_observed_mean.C, Time.Point=="T1"|Time.Point=="TF")

Pcomp_observed_plot<-ggplot(data=Pcomp_observed_mean.C_T1TF, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
  ylim(0, 45) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pcomp Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_observed_plot

#Pvar plots
#plot Pvar
Pvar_observed_mean.C_T1TF<-subset(Pvar_observed_mean.C, Time.Point=="T1"|Time.Point=="TF")

Pvar_observed_plot<-ggplot(data=Pvar_observed_mean.C_T1TF, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
 xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
   ylim(0, 45) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pvar Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pvar_observed_plot


#plot Pacu
Pacu_observed_plot<-ggplot(data=Pacu_observed_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0,45)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pacu Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pacu_observed_plot

#plot Pacu FOR DEFENSE T1TF
Pacu_observed_mean.C_T1TF<-subset(Pacu_observed_mean.C, Time.Point=="T1"|Time.Point=="TF")
Pacu_observed_plot<-ggplot(data=Pacu_observed_mean.C_T1TF, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 45) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pacu Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pacu_observed_plot

###### All plots together
Mcap_observed_plot<-Mcap_observed_plot+ theme(legend.position = "none") #remove legend
Pcomp_observed_plot<-Pcomp_observed_plot+ theme(legend.position = "none") #remove legend
Pvar_observed_plot<-Pvar_observed_plot+ theme(legend.position = "none") #remove legend
Pacu_observed_plot<-Pacu_observed_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_observed_plot, Pcomp_observed_plot, Pvar_observed_plot,Pacu_observed_plot, nrow = 1)
 
```
 
#evenness_pielou Richness 
```{r}     
#evenness_pielou  
#not transformed

evenness_pielou_alpha_mod<-lmer(evenness_pielou ~ Species*Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its) #adding tank is singularity
  anova(evenness_pielou_alpha_mod) 
  qqPlot(residuals(evenness_pielou_alpha_mod)) 
  emm<-emmeans(evenness_pielou_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  evenness_pielou_alpha_mod<-lmer(evenness_pielou ~ Species*Time.Point*Treatment*Clade+(1|Parent.ID), data=erich.tab2its) #adding tank is singularity
  anova(evenness_pielou_alpha_mod) 
  qqPlot(residuals(evenness_pielou_alpha_mod)) 
  emm<-emmeans(evenness_pielou_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

 
 #T0 only
  erich.tab2its.T0<-subset(erich.tab2its, Time.Point=="T0")
  evenness_pielou_alpha_mod<-lmer(evenness_pielou ~ Species+(1|Tank.num), data=erich.tab2its.T0) #adding tank is singularity
  anova(evenness_pielou_alpha_mod) 
  qqPlot(residuals(evenness_pielou_alpha_mod)) 
  emm<-emmeans(evenness_pielou_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
   
   #T0 only clade
  evenness_pielou_alpha_mod<-lmer(evenness_pielou ~ Species*Clade+(1|Tank.num), data=erich.tab2its.T0) #adding tank is singularity
  anova(evenness_pielou_alpha_mod) 
  qqPlot(residuals(evenness_pielou_alpha_mod)) 
  emm<-emmeans(evenness_pielou_alpha_mod,  ~ Clade*Species, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  
  
  

################Mcap only
 #t1TF
  Mcap_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment+(1|Parent.ID), data=erich.tab2its.mcap.t1tf) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.t1tf) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.mcap.T1<-subset(erich.tab2its.mcap, Time.Point=="T1")

  Mcap_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.T1) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.T1) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.mcap.TF<-subset(erich.tab2its.mcap, Time.Point=="TF")

   Mcap_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID), data=erich.tab2its.mcap.TF) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  Mcap_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.mcap.TF) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #t0
  erich.tab2its.mcap.T0<-subset(erich.tab2its.mcap, Time.Point=="T0")
hist(erich.tab2its.mcap.T0$observed)
   Mcap_alpha_mod<-lmer(evenness_pielou ~ Clade+(1|Tank.num), data=erich.tab2its.mcap.T0) #adding tank is singularity
  anova(Mcap_alpha_mod) 
  qqPlot(residuals(Mcap_alpha_mod)) 
  emm<-emmeans(Mcap_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
####### PCOMP only
  #t1TF
  pcomp_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcompT1TF) 
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcompT1TF) 
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pcomp.T1<-subset(erich.tab2its.pcomp, Time.Point=="T1")

  pcomp_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID), data=erich.tab2its.pcomp.T1) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pcomp.T1) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.pcomp.TF<-subset(erich.tab2its.pcomp, Time.Point=="TF")

   pcomp_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pcomp.TF) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pcomp_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pcomp.TF) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#t0
  erich.tab2its.pcomp.T0<-subset(erich.tab2its.pcomp, Time.Point=="T0")
hist(erich.tab2its.pcomp.T0$observed)
   pcomp_alpha_mod<-lmer(evenness_pielou ~ Clade+(1|Tank.num), data=erich.tab2its.pcomp.T0) #adding tank is singularity
  anova(pcomp_alpha_mod) 
  qqPlot(residuals(pcomp_alpha_mod)) 
  emm<-emmeans(pcomp_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
####### pvar only ####
  #t1TF
  pvar_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvarT1TF) 
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvarT1TF) 
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pvar.T1<-subset(erich.tab2its.pvar, Time.Point=="T1")

  pvar_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID), data=erich.tab2its.pvar.T1) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pvar.T1) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #tf
  erich.tab2its.pvar.TF<-subset(erich.tab2its.pvar, Time.Point=="TF")

   pvar_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pvar.TF) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pvar_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pvar.TF) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #t0
  erich.tab2its.pvar.T0<-subset(erich.tab2its.pvar, Time.Point=="T0")
hist(erich.tab2its.pvar.T0$observed)
   pvar_alpha_mod<-lmer(evenness_pielou ~ Clade+(1|Tank.num), data=erich.tab2its.pvar.T0) #adding tank is singularity
  anova(pvar_alpha_mod) 
  qqPlot(residuals(pvar_alpha_mod)) 
  emm<-emmeans(pvar_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
    
  
  ####### pacu only####
  #t1TF
  pacu_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacuT1TF) 
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  pacu_alpha_mod<-lmer(evenness_pielou ~ Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacuT1TF) 
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t1
  erich.tab2its.pacu.T1<-subset(erich.tab2its.pacu, Time.Point=="T1")

  pacu_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID), data=erich.tab2its.pacu.T1) #adding tank is singularity
  anova(pacu_alpha_mod) 
   pacu_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID), data=erich.tab2its.pacu.T1) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
    
  
  
  #tf
  erich.tab2its.pacu.TF<-subset(erich.tab2its.pacu, Time.Point=="TF")

   pacu_alpha_mod<-lmer(evenness_pielou ~ Treatment+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacu.TF) 
  anova(pacu_alpha_mod) 
  pacu_alpha_mod<-lmer(evenness_pielou ~ Treatment*Clade+(1|Parent.ID)+(1|Tank.num), data=erich.tab2its.pacu.TF) 
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #t0
  erich.tab2its.pacu.T0<-subset(erich.tab2its.pacu, Time.Point=="T0")
hist(erich.tab2its.pacu.T0$observed)
   pacu_alpha_mod<-lmer(evenness_pielou ~ Clade+(1|Tank.num), data=erich.tab2its.pacu.T0) #adding tank is singularity
  anova(pacu_alpha_mod) 
  qqPlot(residuals(pacu_alpha_mod)) 
  emm<-emmeans(pacu_alpha_mod,  ~ Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)  
 
```
alpha evenness_pielou Plots, no clade
```{r} 
#Means 
evenness_pielou_mean <- ddply(erich.tab2its, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
evenness_pielou_mean
 
#Mcap 
Mcap_evenness_pielou_mean<-subset(evenness_pielou_mean, Species=="Montipora_capitata") #Subset Mcap
# Pcomp 
Pcomp_evenness_pielou_mean<-subset(evenness_pielou_mean, Species=="Porites_compressa") #Subset Pcomp
# Pacu 
Pacu_evenness_pielou_mean<-subset(evenness_pielou_mean, Species=="Pocillopora_acuta") #Subset Pacu
# Pvar 
Pvar_evenness_pielou_mean<-subset(evenness_pielou_mean, Species=="Pavona_varians") #Subset Pvar
 
#mcap plots
#plot Mcap
Mcap_evenness_pielou_plot<-ggplot(data=Mcap_evenness_pielou_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Mcap Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_evenness_pielou_plot



#by clade
erich.tab2its.mcapT1<-subset(erich.tab2its.mcap, Time.Point=="T1")
erich.tab2its.mcapT1mean <- ddply(erich.tab2its.mcapT1, c("Treatment", "Clade"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
erich.tab2its.mcapT1mean

Mcap_evenness_pielou_plot<-ggplot(data=erich.tab2its.mcapT1mean, aes(x=Time.Point, y=mean, group = Clade, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
 geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  ylab(expression(paste("Alpha Diversity"))) +
  ggtitle("Mcap Evenness by clade")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_evenness_pielou_plot

#by clade
erich.tab2its.mcapTF<-subset(erich.tab2its.mcap, Time.Point=="TF")
erich.tab2its.mcapTFmean <- ddply(erich.tab2its.mcapTF, c("Treatment", "Clade"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
erich.tab2its.mcapTFmean

Mcap_evenness_pielou_plot<-ggplot(data=erich.tab2its.mcapTFmean, aes(x=Clade, y=mean, group = Clade, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
 # geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
 # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  ylab(expression(paste("Alpha Diversity"))) +
  ggtitle("Mcap Evenness by clade TF")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_evenness_pielou_plot


#plot Pcomp
Pcomp_evenness_pielou_plot<-ggplot(data=Pcomp_evenness_pielou_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pcomp Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_evenness_pielou_plot

#Pvar plots
#plot Pvar
Pvar_evenness_pielou_plot<-ggplot(data=Pvar_evenness_pielou_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
xlab("") + #Label the X Axis
  ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pvar Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pvar_evenness_pielou_plot


#Pacu plots
#plot Pacu
Pacu_evenness_pielou_plot<-ggplot(data=Pacu_evenness_pielou_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
xlab("") + #Label the X Axis
  ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
 # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pacu Richness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pacu_evenness_pielou_plot

###### All plots together
Mcap_evenness_pielou_plot<-Mcap_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pcomp_evenness_pielou_plot<-Pcomp_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pvar_evenness_pielou_plot<-Pvar_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pacu_evenness_pielou_plot<-Pacu_evenness_pielou_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_evenness_pielou_plot, Pcomp_evenness_pielou_plot, Pvar_evenness_pielou_plot,Pacu_evenness_pielou_plot, nrow = 1)
 
```  

alpha evenness_pielou Plots, clade  
```{r}  
# color pal from eta mcap.g.Parent.colors
alpha.colors <- c( "Ambient" = "dodgerblue", "High" = "darkred",
                        "C Ambient"="#1F78B4","C High"="#6A3D9A", "CD Ambient"="#E31A1C", "CD High"="#FF7F00") 

#Means
evenness_pielou_mean.C <- ddply(erich.tab2its, c("Treatment", "Species", "Time.Point","Clade"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
evenness_pielou_mean.C
evenness_pielou_mean.C$Code<-paste(evenness_pielou_mean.C$Clade, evenness_pielou_mean.C$Treatment)

#Mcap 
Mcap_evenness_pielou_mean.C<-subset(evenness_pielou_mean.C, Species=="Montipora_capitata") #Subset Mcap
# Pcomp 
Pcomp_evenness_pielou_mean.C<-subset(evenness_pielou_mean.C, Species=="Porites_compressa") #Subset Pcomp
# Pacu 
Pacu_evenness_pielou_mean.C<-subset(evenness_pielou_mean.C, Species=="Pocillopora_acuta") #Subset Pacu
# Pvar 
Pvar_evenness_pielou_mean.C<-subset(evenness_pielou_mean.C, Species=="Pavona_varians") #Subset Pvar

#mcap plots
#plot Mcap
Mcap_evenness_pielou_plot<-ggplot(data=Mcap_evenness_pielou_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Mcap Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_evenness_pielou_plot

#Pcomp plots
#plot Pcomp
Pcomp_evenness_pielou_plot<-ggplot(data=Pcomp_evenness_pielou_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pcomp Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_evenness_pielou_plot

#Pvar plots
#plot Pvar
Pvar_evenness_pielou_plot<-ggplot(data=Pvar_evenness_pielou_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pvar Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pvar_evenness_pielou_plot


#plot Pacu
Pacu_evenness_pielou_plot<-ggplot(data=Pacu_evenness_pielou_mean.C, aes(x=Time.Point, y=mean, group = Code, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment, shape=Clade), size=4, show.legend = T)+
  geom_line(aes(color=Treatment, linetype=Clade), show.legend = T)+
  scale_color_manual(values=alpha.colors)+
xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  ylim(0, 1) + #set Y limits
  # ylim(0, 11) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("Alpha Diversity"))) +
  # ggtitle("Pacu Evenness")+
  theme(plot.title = element_text(size=20, face = "italic"));Pacu_evenness_pielou_plot

###### All plots together
Mcap_evenness_pielou_plot<-Mcap_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pcomp_evenness_pielou_plot<-Pcomp_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pvar_evenness_pielou_plot<-Pvar_evenness_pielou_plot+ theme(legend.position = "none") #remove legend
Pacu_evenness_pielou_plot<-Pacu_evenness_pielou_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_evenness_pielou_plot, Pcomp_evenness_pielou_plot, Pvar_evenness_pielou_plot,Pacu_evenness_pielou_plot, nrow = 1)
 
```
 

































