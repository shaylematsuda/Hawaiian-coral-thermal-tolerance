---
title: "ACE21_overview_figure"
author: "Shayle Matsuda"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##  Combine Physio, ITS2, and 16S

Load libraries
```{r cars}

library(ggplot2)
library(lmerTest)
library(car)
library(emmeans)
library(factoextra)
library(vegan)
library(pairwiseAdonis)
library(tidyverse)
library(phyloseq)
```

Load data

```{r}
physio<-read.csv("PhysioData.csv")
    physio$sample.id<-as.factor(physio$sample.id)  #change to tidy language when you have time. 
     physio$treatment<-as.factor(physio$treatment)
      physio$species<-as.factor(physio$species)
            physio$parent.ID<-as.factor(physio$parent.ID)
        physio$time.point<-as.factor(physio$time.point)
                physio$code<-as.factor(physio$code)
                physio$size<-as.factor(physio$size)
            physio$clade<-as.factor(physio$clade)
                        physio$repro.mode<-as.factor(physio$repro.mode)
                        physio$sex<-as.factor(physio$sex)
                        physio$repro.mode<-as.factor(physio$repro.mode)
                    physio$tank.num<-as.factor(physio$tank.num)
                            physio$transmission<-as.factor(physio$transmission)
                                physio$skeletal.density<-as.factor(physio$skeletal.density)
                                    physio$shape<-as.factor(physio$shape)
  names(physio)[1]<-"ID"   


  physio<-na.omit(physio) #remove rows with NAs in any trait
  physio$respiration<-physio$respiration*-1 #make resp positive

                            
its2<-read.csv("ITS2_T0_nmds.scores.csv")
    its2$sample.id<-as.factor(its2$sample.id)
its2.nmds1_T0<-subset(its2,its2$Time.Point=="T0")
its2.nmds1_T0<-its2.nmds1_T0[, c("sample.id", "ITS2.NMDS1")]


bacteria<-read.csv("16s_nmds.scores.ord.u_RelA_stats.T0.csv") #only T0
    names(bacteria)[1]<-"sample.id"
    bacteria$sample.id<-as.factor(bacteria$sample.id)
# bacteria_T0<-subset(bacteria,bacteria$Time.Point=="T0")
bacteria.nmds1<-bacteria[, c("sample.id", "bac.NMDS1")]
#remove duplicates 



  
  
#### make df with just a priori data one row per species 

apriori<-read.csv("apriori2.csv") #ths only loads bc you opened in textwrangler and hit a hard return and saved....

  
```

First go at this, not sure you need 
```{r}
# center data
physio.T0<-subset(physio, time.point=="T0") #T0 only

physio.scale <- prcomp(physio.T0[c(15:24)], center = TRUE, scale = TRUE) #center and scale
summary(physio.scale)
 
str(physio.scale)

library(ggbiplot)
ggbiplot(physio.scale) #quick look at plot

#exract scores for gg
Miss_scores <- as.data.frame(physio.scale$x)
Miss_scores$sample.id <- physio.T0$sample.id
Miss_scores$parent.ID <- physio.T0$parent.ID
Miss_scores$treatment <- physio.T0$treatment
Miss_scores$species <- physio.T0$species
Miss_scores$clade <- physio.T0$clade
Miss_scores$transmission <- physio.T0$transmission
Miss_scores$skeletal.density <- physio.T0$skeletal.density
Miss_scores$size <- physio.T0$size


#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = species), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

plot<-ggbiplot(physio.scale,
         ellipse = T, groups=physio$species) 
plot +theme_classic()










apData<-PhysioData #make a copy
apData$Respiration<-apData$Respiration*-1 #make respiration all positive
apData<-subset(apData, Time.Point=="T1"|Time.Point=="TF") #only T1 and TF
apData<-na.omit(apData) #remove NAs
apData<-apData[,c("Parent.ID","Treatment","Species", "Time.Point", "Calcification","AFDWmg.cm2","zoox.cm2_log","Chl a","Protein", "Yield","Photosynthesis", "Respiration","PR")] #put cols in correct order

apData2 <- prcomp(apData[c(5:13)], center = TRUE, scale = TRUE) #center and scale
summary(apData2)
 
str(apData2)

ggbiplot(apData2) #quick look at plot

#exract scores for gg
Miss_scores <- as.data.frame(apData2$x)
Miss_scores$frag.id <- apData$Frag.ID
Miss_scores$parent.id <- apData$Parent.ID
Miss_scores$treatment <- apData$Treatment
Miss_scores$species <- apData$Species
Miss_scores$time.point <- apData$Time.Point


#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

#plot by time and species
Miss_scores$treatSpecies<-paste0(Miss_scores$species, Miss_scores$treatment )
Miss_scores$treatTime<-paste0(Miss_scores$treatment, Miss_scores$time.point )

ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2) +
  theme_classic()

```



 Try MCoA http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/114-mca-multiple-correspondence-analysis-in-r-essentials/
```{r}
library("FactoMineR")
library("factoextra")
library(phyloseq)


apriori.df<-apriori[2:11]
summary(apriori.df)[,1:4]
  apriori.df$clade<-as.factor(apriori.df$clade)
    apriori.df$repro.mode<-as.factor(apriori.df$repro.mode)
  apriori.df$transmission<-as.factor(apriori.df$transmission)
  apriori.df$sex<-as.factor(apriori.df$sex)
  apriori.df$skeletal.density<-as.factor(apriori.df$skeletal.density)
  apriori.df$size<-as.factor(apriori.df$size)


  
  
  
  
  
  
res.apriori<-MCA(apriori.df,  graph = TRUE)
print(res.apriori)
eig.val <- get_eigenvalue(res.apriori)
fviz_screeplot(res.apriori, addlabels = TRUE, ylim = c(0, 45))

fviz_mca_biplot(res.apriori, 
               repel = TRUE, # Avoid text overlapping (slow if many point)
               ggtheme = theme_minimal())

var <- get_mca_var(res.apriori)

```
 
Try mantel test for comparing 16S and ITS2 at T1 and then at T2
 r value of 
 -1 suggests a strong negative correlation
 0 suggests no relationship 
 1 suggests a strong positive relationship
T0
```{r}
# figure out which samples are represented in the its2 and 16s dfs
#read in 16s

readRDS(file = "16S_rel.u.rds")


# T0 only  #####

#set up 16s
    Bac.s.rel.u.T0<-subset_samples(Bac.s.rel.u, Time.Point=="T0")
    Bac.s.rel.u.T0 = prune_taxa(taxa_sums(Bac.s.rel.u.T0) > 0, Bac.s.rel.u.T0) #this removes any OTU with 0s
  # look at sample names
    bac.T0.sd <- as(sample_data(Bac.s.rel.u.T0), "data.frame") #sample df
    #save just sample names
      bac.T0.sd.samps<-bac.T0.sd[['sample_name.1']]

#set up ITS2 T0, import  (already pruned)
    ITS2_T0_mantel <- readRDS("ITS2_T0_phyloseq.rds")
  # look at sample names
    ITS.T0.sd <- as(sample_data(ITS2_T0_mantel), "data.frame") #sample df
  #save just sample names
      ITS.T0.sd.samps<-ITS.T0.sd[['ID']]
 
# compare ITS to 16s at T0
  #identify missing samples btw datasets     
      setdiff(bac.T0.sd.samps,ITS.T0.sd.samps) #samples in 16s but not ITS: S208b, SN70b
      setdiff(ITS.T0.sd.samps,bac.T0.sd.samps) #samples in ITS but not 16s: "S208"  "SN60"  "SN70"  "S49"   "SN11"  "SN145" "SN40"  "SN111" "SN6"   "SN56"  "SN109"
        
      # in 16S change sample S208b name to S208

  # 16s changes: rename sample S208b = S208

    # pull OTU table
     OTU.16sT0 = as(otu_table(Bac.s.rel.u.T0), "matrix") #pull otu
       OTU.16sT0<-as.data.frame(OTU.16sT0) #make into df
        row.names(OTU.16sT0)[5] <- "S208"   #change row name by row number
                row.names(OTU.16sT0)[31] <- "SN70"   #change row name by row number

    #pull TAX table
     aTax.16sT0 = as(tax_table(Bac.s.rel.u.T0), "matrix") #pull tax
     
     #pull phy tree table
     tree.seq = phy_tree(Bac.s.rel.u.T0) #pull out tree

    #pull SAMPLE DATA
     aSD.16sT0 = as(sample_data(Bac.s.rel.u.T0), "matrix") #pull samp.data
     aSD.16sT0<-as.data.frame(aSD.16sT0) #change to df
        row.names(aSD.16sT0)[5] <- "S208"  #replace name S208b
        row.names(aSD.16sT0)[31] <- "SN70"  #replace name S208b
            

    #remake the phyloseq obj
      samdata = sample_data(aSD.16sT0)
        seqtab = otu_table(OTU.16sT0, taxa_are_rows = FALSE)
        taxtab = tax_table(aTax.16sT0)
        phy_tree = read_tree(phyTree.16sT0)
          Bac_T0_mantel = phyloseq(otu_table(seqtab), tax_table(taxtab), sample_data(samdata),phy_tree(tree.seq))
          
          
   #ITS2 - remove samps not in the 16s df - "SN60"  "S49"   "SN11"  "SN145" "SN40"  "SN111" "SN6"   "SN56"  "SN109" 
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN60" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "S49" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN11" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN145" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN40" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN111" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN6" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN56" )
        ITS2_T0_mantel <- subset_samples(ITS2_T0_mantel, ID != "SN109" )

        # both have 39 samples - Bac_T0_mantel ITS2_T0_mantel
      
  # reorder ps object so samples are in the same order
        library(microbiome)
        library(microViz)
        
        Bac_T0_mantel <- Bac_T0_mantel %>% ps_arrange(sample_name.1, desc(sample_name.1))
        phyloseq::sample_data(Bac_T0_mantel) %>% head(8)
        
        ITS2_T0_mantel <- ITS2_T0_mantel %>% ps_arrange(ID, desc(ID))
        phyloseq::sample_data(ITS2_T0_mantel) %>% head(8)
        
  # MAKE data matrix
       library(vegan)
  
  #16s T0        
        unifrac.Bac.T0.mantel <- phyloseq::distance(Bac_T0_mantel, method = "wunifrac")
        
  #ITS2 T0
     bray.ITS2.T0.mantel <- phyloseq::distance(ITS2_T0_mantel, method = "bray") 

  # Run mantel test
      mantel(unifrac.Bac.T0.mantel, bray.ITS2.T0.mantel,  permutations=1000)
    # r=0.497 so a pos correlation. p<0.001
        
#### T0 Mcap only ####        
 # Bac_T0_mantel ITS2_T0_mantel
    
    #subset df for mcap
    Bac_T0_mantel.Mcap <- subset_samples(Bac_T0_mantel, Species == "Montipora_capitata")
    Bac_T0_mantel.Mcap = prune_taxa(taxa_sums(Bac_T0_mantel.Mcap) > 0, Bac_T0_mantel.Mcap) 
    
    ITS2_T0_mantel.Mcap  <- subset_samples(ITS2_T0_mantel, Species == "Montipora_capitata")
    ITS2_T0_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T0_mantel.Mcap) > 0, ITS2_T0_mantel.Mcap)
        
    #16s T0 mcap dist        
      unifrac.Bac_T0_mantel.Mcap <- phyloseq::distance(Bac_T0_mantel.Mcap, method = "wunifrac")
        
   #ITS2 T0 mcap dist
     bray.ITS2.T0.mantel.Mcap <- phyloseq::distance(ITS2_T0_mantel.Mcap, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Mcap, bray.ITS2.T0.mantel.Mcap,  permutations=1000)
    
#### T0 Pcomp only ####        
 # Bac_T0_mantel ITS2_T0_mantel
    
    #subset df for Pcomp
    Bac_T0_mantel.Pcomp <- subset_samples(Bac_T0_mantel, Species == "Porites_compressa")
    Bac_T0_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T0_mantel.Pcomp) > 0, Bac_T0_mantel.Pcomp) 
    
    ITS2_T0_mantel.Pcomp  <- subset_samples(ITS2_T0_mantel, Species == "Porites_compressa")
    ITS2_T0_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T0_mantel.Pcomp) > 0, ITS2_T0_mantel.Pcomp)
        
    #16s T0 Pcomp dist        
      unifrac.Bac_T0_mantel.Pcomp <- phyloseq::distance(Bac_T0_mantel.Pcomp, method = "wunifrac")
        
   #ITS2 T0 Pcomp dist
     bray.ITS2.T0.mantel.Pcomp <- phyloseq::distance(ITS2_T0_mantel.Pcomp, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pcomp, bray.ITS2.T0.mantel.Pcomp,  permutations=1000)        
        
        
  #### T0 Pvar only ####        
 # Bac_T0_mantel ITS2_T0_mantel
    
    #subset df for Pvar
    Bac_T0_mantel.Pvar <- subset_samples(Bac_T0_mantel, Species == "Pavona_varians")
    Bac_T0_mantel.Pvar = prune_taxa(taxa_sums(Bac_T0_mantel.Pvar) > 0, Bac_T0_mantel.Pvar) 
    
    ITS2_T0_mantel.Pvar  <- subset_samples(ITS2_T0_mantel, Species == "Pavona_varians")
    ITS2_T0_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T0_mantel.Pvar) > 0, ITS2_T0_mantel.Pvar)
        
    #16s T0 Pvar dist        
      unifrac.Bac_T0_mantel.Pvar <- phyloseq::distance(Bac_T0_mantel.Pvar, method = "wunifrac")
        
   #ITS2 T0 Pvar dist
     bray.ITS2.T0.mantel.Pvar <- phyloseq::distance(ITS2_T0_mantel.Pvar, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pvar, bray.ITS2.T0.mantel.Pvar,  permutations=1000)            
        
        
     #### T0 Pacu only ####        
 # Bac_T0_mantel ITS2_T0_mantel
    
    #subset df for Pacu
    Bac_T0_mantel.Pacu <- subset_samples(Bac_T0_mantel, Species == "Pavona_varians")
    Bac_T0_mantel.Pacu = prune_taxa(taxa_sums(Bac_T0_mantel.Pacu) > 0, Bac_T0_mantel.Pacu) 
    
    ITS2_T0_mantel.Pacu  <- subset_samples(ITS2_T0_mantel, Species == "Pavona_varians")
    ITS2_T0_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T0_mantel.Pacu) > 0, ITS2_T0_mantel.Pacu)
        
    #16s T0 Pacu dist        
      unifrac.Bac_T0_mantel.Pacu <- phyloseq::distance(Bac_T0_mantel.Pacu, method = "wunifrac")
        
   #ITS2 T0 Pacu dist
     bray.ITS2.T0.mantel.Pacu <- phyloseq::distance(ITS2_T0_mantel.Pacu, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pacu, bray.ITS2.T0.mantel.Pacu,  permutations=1000)            
        
        
    


```
T1 High only
```{r}
# figure out which samples are represented in the its2 and 16s dfs

# T1 only  #####

#high only 

#set up 16s
    Bac.s.rel.u.T1<-subset_samples(Bac.s.rel.u, Time.Point=="T1")
    Bac.s.rel.u.T1.High<-subset_samples(Bac.s.rel.u.T1, Treatment=="High")

    Bac.s.rel.u.T1.High = prune_taxa(taxa_sums(Bac.s.rel.u.T1.High) > 0, Bac.s.rel.u.T1.High) #this removes any OTU with 0s
  # look at sample names
    bac.T1.sd <- as(sample_data(Bac.s.rel.u.T1.High), "data.frame") #sample df
    #save just sample names
      bac.T1.High.sd.samps<-bac.T1.sd[['sample_name.1']]
      

#set up ITS2 T1, import  T1TF
    ITS2_T1TF_mantel <- readRDS("ITS2_T1TF_phyloseq.rds") 
     ITS2_T1_mantel<-subset_samples(ITS2_T1TF_mantel, Time.Point=="T1")
    ITS2_T1_mantel.High<-subset_samples(ITS2_T1_mantel, Treatment=="High")
      ITS2_T1_mantel.High = prune_taxa(taxa_sums(ITS2_T1_mantel.High) > 0, ITS2_T1_mantel.High) #this removes any OTU with 0s

    
  # look at sample names
    ITS.T1.High.sd <- as(sample_data(ITS2_T1_mantel.High), "data.frame") #sample df
  #save just sample names
      ITS.T1.High.sd.samps<-ITS.T1.High.sd[['ID']]

# compare ITS to 16s at T1
  #identify missing samples btw datasets     
      setdiff(bac.T1.High.sd.samps,ITS.T1.High.sd.samps) #samples in 16s but not ITS: "S1857" "S3469" "SN134"
      setdiff(ITS.T1.High.sd.samps,bac.T1.High.sd.samps) #samples in ITS but not 16s: "S1857b" "S3468"  "SN134b" "S670"   "S3025"  "S1388a"
        
      # in 16S remove S3469
      #in ITS change S1857b to S1857 and SN134b to SN134. Remove S3468, S670, S3025, S1388a

  # 16s changes: rename sample S3469
      
    Bac.T1.High.mantel <- subset_samples(Bac.s.rel.u.T1.High, sample_name.1 != "S3469" )
        #40 samples
          
   #ITS2 - remove samps not in the 16s df - " S3468, S670, S3025, S1388a
        ITS2_T1_mantel.High <- subset_samples(ITS2_T1_mantel.High, ID != "S3468" )
        ITS2_T1_mantel.High <- subset_samples(ITS2_T1_mantel.High, ID != "S670" )
        ITS2_T1_mantel.High <- subset_samples(ITS2_T1_mantel.High, ID != "S3025" )
        ITS2_T1_mantel.High <- subset_samples(ITS2_T1_mantel.High, ID != "S1388a" )

        
    #change names ITS2 S1857b to S1857 and SN134b to SN134

    # pull OTU table
     OTU.ITS2T1.High = as(otu_table(ITS2_T1_mantel.High), "matrix") #pull otu
       OTU.ITS2T1.High<-as.data.frame(OTU.ITS2T1.High) #make into df
        row.names(OTU.ITS2T1.High)[7] <- "S1857"   #change row name by row number
                row.names(OTU.ITS2T1.High)[17] <- "SN134"   #change row name by row number

    #pull TAX table
     aTax.ITS2T1.High = as(tax_table(ITS2_T1_mantel.High), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.ITS2T1.High = as(sample_data(ITS2_T1_mantel.High), "matrix") #pull samp.data
     aSD.ITS2T1.High<-as.data.frame(aSD.ITS2T1.High) #change to df
        row.names(aSD.ITS2T1.High)[7] <- "S1857"  #replace name S208b
        row.names(aSD.ITS2T1.High)[17] <- "SN134"  #replace name S208b
            

    #remake the phyloseq obj
      samdata.High = sample_data(aSD.ITS2T1.High)
        seqtab.High = otu_table(OTU.ITS2T1.High, taxa_are_rows = FALSE)
        taxtab.High = tax_table(aTax.ITS2T1.High)
          ITS_T1.High_mantel = phyloseq(otu_table(seqtab.High), tax_table(taxtab.High), sample_data(samdata.High))
             
        # both have 40 samples - 
      
        # reorder ps object so samples are in the same order
        
        Bac.T1.High.mantel <- Bac.T1.High.mantel %>% ps_arrange(sample_name.1, desc(sample_name.1))
        phyloseq::sample_data(Bac.T1.High.mantel) %>% head(8)
        
        ITS_T1.High_mantel <- ITS_T1.High_mantel %>% ps_arrange(ID, desc(ID))
        phyloseq::sample_data(ITS_T1.High_mantel) %>% head(8)
        
  # MAKE data matrix
  
  #16s T1 High        
        unifrac.Bac.T1.High.mantel <- phyloseq::distance(Bac.T1.High.mantel, method = "wunifrac")
        
  #ITS2 T1 High
     bray.ITS2.T1.High.mantel <- phyloseq::distance(ITS_T1.High_mantel, method = "bray") 

  # Run mantel test
      mantel(unifrac.Bac.T1.High.mantel, bray.ITS2.T1.High.mantel,  permutations=1000)
    
        
#### T1.High Mcap only ####        
 # Bac_T1.High_mantel ITS2_T1.High_mantel
    
    #subset df for mcap
    Bac_T1.High_mantel.Mcap <- subset_samples(Bac.T1.High.mantel, Species == "Montipora_capitata")
    Bac_T1.High_mantel.Mcap = prune_taxa(taxa_sums(Bac_T1.High_mantel.Mcap) > 0, Bac_T1.High_mantel.Mcap) 
    
    ITS2_T1.High_mantel.Mcap  <- subset_samples(ITS_T1.High_mantel, Species == "Montipora_capitata")
    ITS2_T1.High_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T1.High_mantel.Mcap) > 0, ITS2_T1.High_mantel.Mcap)
        
    #16s T1.High mcap dist        
      unifrac.Bac_T1.High_mantel.Mcap <- phyloseq::distance(Bac_T1.High_mantel.Mcap, method = "wunifrac")
        
   #ITS2 T1.High mcap dist
     bray.ITS2.T1.High.mantel.Mcap <- phyloseq::distance(ITS2_T1.High_mantel.Mcap, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.High_mantel.Mcap, bray.ITS2.T1.High.mantel.Mcap,  permutations=1000)
    
#### T1.High Pcomp only ####        
 # Bac_T1.High_mantel ITS2_T1.High_mantel
    
    #subset df for Pcomp
    Bac_T1.High_mantel.Pcomp <- subset_samples(Bac.T1.High.mantel, Species == "Porites_compressa")
    Bac_T1.High_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T1.High_mantel.Pcomp) > 0, Bac_T1.High_mantel.Pcomp) 
    
    ITS2_T1.High_mantel.Pcomp  <- subset_samples(ITS_T1.High_mantel, Species == "Porites_compressa")
    ITS2_T1.High_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T1.High_mantel.Pcomp) > 0, ITS2_T1.High_mantel.Pcomp)
        
    #16s T1.High Pcomp dist        
      unifrac.Bac_T1.High_mantel.Pcomp <- phyloseq::distance(Bac_T1.High_mantel.Pcomp, method = "wunifrac")
        
   #ITS2 T1.High Pcomp dist
     bray.ITS2.T1.High.mantel.Pcomp <- phyloseq::distance(ITS2_T1.High_mantel.Pcomp, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.High_mantel.Pcomp, bray.ITS2.T1.High.mantel.Pcomp,  permutations=1000)        
        
    
#### T1.High Pvar only ####        
 # Bac_T1.High_mantel ITS2_T1.High_mantel
    
    #subset df for Pvar
    Bac_T1.High_mantel.Pvar <- subset_samples(Bac.T1.High.mantel, Species == "Pavona_varians")
    Bac_T1.High_mantel.Pvar = prune_taxa(taxa_sums(Bac_T1.High_mantel.Pvar) > 0, Bac_T1.High_mantel.Pvar) 
    
    ITS2_T1.High_mantel.Pvar  <- subset_samples(ITS_T1.High_mantel, Species == "Pavona_varians")
    ITS2_T1.High_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T1.High_mantel.Pvar) > 0, ITS2_T1.High_mantel.Pvar)
        
    #16s T1.High Pvar dist        
      unifrac.Bac_T1.High_mantel.Pvar <- phyloseq::distance(Bac_T1.High_mantel.Pvar, method = "wunifrac")
        
   #ITS2 T1.High Pvar dist
     bray.ITS2.T1.High.mantel.Pvar <- phyloseq::distance(ITS2_T1.High_mantel.Pvar, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.High_mantel.Pvar, bray.ITS2.T1.High.mantel.Pvar,  permutations=1000)       
      
      #### T1.High Pacu only ####        
 # Bac_T1.High_mantel ITS2_T1.High_mantel
    
    #subset df for Pacu
    Bac_T1.High_mantel.Pacu <- subset_samples(Bac.T1.High.mantel, Species == "Pocillopora_acuta")
    Bac_T1.High_mantel.Pacu = prune_taxa(taxa_sums(Bac_T1.High_mantel.Pacu) > 0, Bac_T1.High_mantel.Pacu) 
    
    ITS2_T1.High_mantel.Pacu  <- subset_samples(ITS_T1.High_mantel, Species == "Pocillopora_acuta")
    ITS2_T1.High_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T1.High_mantel.Pacu) > 0, ITS2_T1.High_mantel.Pacu)
        
    #16s T1.High Pacu dist        
      unifrac.Bac_T1.High_mantel.Pacu <- phyloseq::distance(Bac_T1.High_mantel.Pacu, method = "wunifrac")
        
   #ITS2 T1.High Pacu dist
     bray.ITS2.T1.High.mantel.Pacu <- phyloseq::distance(ITS2_T1.High_mantel.Pacu, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.High_mantel.Pacu, bray.ITS2.T1.High.mantel.Pacu,  permutations=1000)  

```
T1 Ambient only
```{r}
# figure out which samples are represented in the its2 and 16s dfs

# T1 only  #####

#Ambient only 

#set up 16s
    Bac.s.rel.u.T1<-subset_samples(Bac.s.rel.u, Time.Point=="T1")
    Bac.s.rel.u.T1.Ambient<-subset_samples(Bac.s.rel.u.T1, Treatment=="Ambient")

    Bac.s.rel.u.T1.Ambient = prune_taxa(taxa_sums(Bac.s.rel.u.T1.Ambient) > 0, Bac.s.rel.u.T1.Ambient) #this removes any OTU with 0s
  # look at sample names
    bac.T1.sd <- as(sample_data(Bac.s.rel.u.T1.Ambient), "data.frame") #sample df
    #save just sample names
      bac.T1.Ambient.sd.samps<-bac.T1.sd[['sample_name.1']]

#set up ITS2 T1, import  T1TF
    ITS2_T1TF_mantel <- readRDS("ITS2_T1TF_phyloseq.rds") 
     ITS2_T1_mantel<-subset_samples(ITS2_T1TF_mantel, Time.Point=="T1")
    ITS2_T1_mantel.Ambient<-subset_samples(ITS2_T1_mantel, Treatment=="Ambient")
      ITS2_T1_mantel.Ambient = prune_taxa(taxa_sums(ITS2_T1_mantel.Ambient) > 0, ITS2_T1_mantel.Ambient) #this removes any OTU with 0s

    
  # look at sample names
    ITS.T1.Ambient.sd <- as(sample_data(ITS2_T1_mantel.Ambient), "data.frame") #sample df
  #save just sample names
      ITS.T1.Ambient.sd.samps<-ITS.T1.Ambient.sd[['ID']]

# compare ITS to 16s at T1
  #identify missing samples btw datasets     
      setdiff(bac.T1.Ambient.sd.samps,ITS.T1.Ambient.sd.samps) #samples in 16s but not ITS: "S1443b" "SN108b" "SN197b" "SN222"
      setdiff(ITS.T1.Ambient.sd.samps,bac.T1.Ambient.sd.samps) #samples in ITS but not 16s: "S1573" "S2424" "S3035" "S1443" "S1895" "SN209" "SN63"  "S1418" "SN197" "SN126" "S785"  "SN108"
        
      # in 16S remove SN222, remove the b's on the rest "S1443b" "SN108b" "SN197b" "SN222"
      #in ITS  Remove "S1573" "S2424" "S3035" "S1895" "SN209" "SN63"  "S1418" " "SN126" "S785"  

      
    #######stoped here#########  
    
  # 16s changes: remove "SN222"  rename "SN108b""S1443b"  "SN197b",
      
 # remove
    Bac.T1.Ambient.mantel <- subset_samples(Bac.s.rel.u.T1.Ambient, sample_name.1 != "SN222" )
    
 #rename
   #change names 16s S1857b to S1857 and SN134b to SN134
    # pull OTU table
     OTU.16ST1.Ambient = as(otu_table(Bac.T1.Ambient.mantel), "matrix") #pull otu
       OTU.16ST1.Ambient<-as.data.frame(OTU.16ST1.Ambient) #make into df
        row.names(OTU.16ST1.Ambient)[20] <- "SN108"   #change row name by row number
        row.names(OTU.16ST1.Ambient)[3] <- "S1443"   #change row name by row number
        row.names(OTU.16ST1.Ambient)[30] <- "SN197"   #change row name by row number

    #pull TAX table
     OTU.16ST1.Ambient = as(tax_table(Bac.T1.Ambient.mantel), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.16ST1.Ambient = as(sample_data(Bac.T1.Ambient.mantel), "matrix") #pull samp.data
     aSD.16ST1.Ambient<-as.data.frame(aSD.16ST1.Ambient) #change to df
       row.names(aSD.16ST1.Ambient)[20] <- "SN108"   #change row name by row number
        row.names(aSD.16ST1.Ambient)[3] <- "S1443"   #change row name by row number
        row.names(aSD.16ST1.Ambient)[30] <- "SN197"   #change row name by row number
          
    #remake the phyloseq obj
      samdata.Ambient = sample_data(aSD.16ST1.Ambient)
        seqtab.Ambient = otu_table(OTU.16ST1.Ambient, taxa_are_rows = FALSE)
        taxtab.Ambient = tax_table(OTU.16ST1.Ambient)
          BacT1.Ambient_mantel = phyloseq(otu_table(seqtab.Ambient), tax_table(taxtab.Ambient), sample_data(samdata.Ambient))
    
          
   #ITS2 - remove samps not in the 16s df - "S1573" "S2424" "S3035" "S1895" "SN209" "SN63"  "S1418" " "SN126" "S785"  
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S1573" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S2424" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S3035" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S1895" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "SN209" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "SN63" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S1418" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "SN126" )
        ITS2_T1_mantel.Ambient <- subset_samples(ITS2_T1_mantel.Ambient, ID != "S785" )
#both 37 samples
        

        # reorder ps object so samples are in the same order
        
        Bac.T1.Ambient.mantel <- Bac.T1.Ambient.mantel %>% ps_arrange(sample_name.1, desc(sample_name.1))
        phyloseq::sample_data(Bac.T1.Ambient.mantel) %>% head(8)
        
        ITS2_T1_mantel.Ambient <- ITS2_T1_mantel.Ambient %>% ps_arrange(ID, desc(ID))
        phyloseq::sample_data(ITS2_T1_mantel.Ambient) %>% head(8)
        
  # MAKE data matrix
  
  #16s T1 Ambient        
        unifrac.Bac.T1.Ambient.mantel <- phyloseq::distance(Bac.T1.Ambient.mantel, method = "wunifrac")
        
  #ITS2 T1 Ambient
     bray.ITS2.T1.Ambient.mantel <- phyloseq::distance(ITS2_T1_mantel.Ambient, method = "bray") 

  # Run mantel test
      mantel(unifrac.Bac.T1.Ambient.mantel, bray.ITS2.T1.Ambient.mantel,  permutations=1000)
    
        
#### T1.Ambient Mcap only ####        
 # Bac_T1.Ambient_mantel ITS2_T1.Ambient_mantel
    
    #subset df for mcap
    Bac_T1.Ambient_mantel.Mcap <- subset_samples(Bac.T1.Ambient.mantel, Species == "Montipora_capitata")
    Bac_T1.Ambient_mantel.Mcap = prune_taxa(taxa_sums(Bac_T1.Ambient_mantel.Mcap) > 0, Bac_T1.Ambient_mantel.Mcap) 
    
    ITS2_T1.Ambient_mantel.Mcap  <- subset_samples(ITS2_T1_mantel.Ambient, Species == "Montipora_capitata")
    ITS2_T1.Ambient_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T1.Ambient_mantel.Mcap) > 0, ITS2_T1.Ambient_mantel.Mcap)
        
    #16s T1.Ambient mcap dist        
      unifrac.Bac_T1.Ambient_mantel.Mcap <- phyloseq::distance(Bac_T1.Ambient_mantel.Mcap, method = "wunifrac")
        
   #ITS2 T1.Ambient mcap dist
     bray.ITS2.T1.Ambient.mantel.Mcap <- phyloseq::distance(ITS2_T1.Ambient_mantel.Mcap, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.Ambient_mantel.Mcap, bray.ITS2.T1.Ambient.mantel.Mcap,  permutations=1000)
    
#### T1.Ambient Pcomp only ####        
 # Bac_T1.Ambient_mantel ITS2_T1.Ambient_mantel
    
    #subset df for Pcomp
    Bac_T1.Ambient_mantel.Pcomp <- subset_samples(Bac.T1.Ambient.mantel, Species == "Porites_compressa")
    Bac_T1.Ambient_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T1.Ambient_mantel.Pcomp) > 0, Bac_T1.Ambient_mantel.Pcomp) 
    
    ITS2_T1.Ambient_mantel.Pcomp  <- subset_samples(ITS2_T1_mantel.Ambient, Species == "Porites_compressa")
    ITS2_T1.Ambient_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T1.Ambient_mantel.Pcomp) > 0, ITS2_T1.Ambient_mantel.Pcomp)
        
    #16s T1.Ambient Pcomp dist        
      unifrac.Bac_T1.Ambient_mantel.Pcomp <- phyloseq::distance(Bac_T1.Ambient_mantel.Pcomp, method = "wunifrac")
        
   #ITS2 T1.Ambient Pcomp dist
     bray.ITS2.T1.Ambient.mantel.Pcomp <- phyloseq::distance(ITS2_T1.Ambient_mantel.Pcomp, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.Ambient_mantel.Pcomp, bray.ITS2.T1.Ambient.mantel.Pcomp,  permutations=1000)        
        
    
#### T1.Ambient Pvar only ####        
 # Bac_T1.Ambient_mantel ITS2_T1.Ambient_mantel
    
    #subset df for Pvar
    Bac_T1.Ambient_mantel.Pvar <- subset_samples(Bac.T1.Ambient.mantel, Species == "Pavona_varians")
    Bac_T1.Ambient_mantel.Pvar = prune_taxa(taxa_sums(Bac_T1.Ambient_mantel.Pvar) > 0, Bac_T1.Ambient_mantel.Pvar) 
    
    ITS2_T1.Ambient_mantel.Pvar  <- subset_samples(ITS2_T1_mantel.Ambient, Species == "Pavona_varians")
    ITS2_T1.Ambient_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T1.Ambient_mantel.Pvar) > 0, ITS2_T1.Ambient_mantel.Pvar)
        
    #16s T1.Ambient Pvar dist        
      unifrac.Bac_T1.Ambient_mantel.Pvar <- phyloseq::distance(Bac_T1.Ambient_mantel.Pvar, method = "wunifrac")
        
   #ITS2 T1.Ambient Pvar dist
     bray.ITS2.T1.Ambient.mantel.Pvar <- phyloseq::distance(ITS2_T1.Ambient_mantel.Pvar, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.Ambient_mantel.Pvar, bray.ITS2.T1.Ambient.mantel.Pvar,  permutations=1000)       
      
      #### T1.Ambient Pacu only ####        
 # Bac_T1.Ambient_mantel ITS2_T1.Ambient_mantel
    
    #subset df for Pacu
    Bac_T1.Ambient_mantel.Pacu <- subset_samples(Bac.T1.Ambient.mantel, Species == "Pocillopora_acuta")
    Bac_T1.Ambient_mantel.Pacu = prune_taxa(taxa_sums(Bac_T1.Ambient_mantel.Pacu) > 0, Bac_T1.Ambient_mantel.Pacu) 
    
    ITS2_T1.Ambient_mantel.Pacu  <- subset_samples(ITS2_T1_mantel.Ambient, Species == "Pocillopora_acuta")
    ITS2_T1.Ambient_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T1.Ambient_mantel.Pacu) > 0, ITS2_T1.Ambient_mantel.Pacu)
        
    #16s T1.Ambient Pacu dist        
      unifrac.Bac_T1.Ambient_mantel.Pacu <- phyloseq::distance(Bac_T1.Ambient_mantel.Pacu, method = "wunifrac")
        
   #ITS2 T1.Ambient Pacu dist
     bray.ITS2.T1.Ambient.mantel.Pacu <- phyloseq::distance(ITS2_T1.Ambient_mantel.Pacu, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_T1.Ambient_mantel.Pacu, bray.ITS2.T1.Ambient.mantel.Pacu,  permutations=1000)  

```

TF High only
```{r}
# figure out which samples are represented in the its2 and 16s dfs

# TF only  #####

#high only 

#set up 16s
    Bac.s.rel.u.TF<-subset_samples(Bac.s.rel.u, Time.Point=="TF")
    Bac.s.rel.u.TF.High<-subset_samples(Bac.s.rel.u.TF, Treatment=="High")

    Bac.s.rel.u.TF.High = prune_taxa(taxa_sums(Bac.s.rel.u.TF.High) > 0, Bac.s.rel.u.TF.High) #this removes any OTU with 0s
  # look at sample names
    bac.TF.sd <- as(sample_data(Bac.s.rel.u.TF.High), "data.frame") #sample df
    #save just sample names
      bac.TF.High.sd.samps<-bac.TF.sd[['sample_name.1']]

#set up ITS2 TF, import  TFTF
     ITS2_TF_mantel<-subset_samples(ITS2_T1TF_mantel, Time.Point=="TF")
    ITS2_TF_mantel.High<-subset_samples(ITS2_TF_mantel, Treatment=="High")
      ITS2_TF_mantel.High = prune_taxa(taxa_sums(ITS2_TF_mantel.High) > 0, ITS2_TF_mantel.High) #this removes any OTU with 0s

# look at sample names
    ITS.TF.High.sd <- as(sample_data(ITS2_TF_mantel.High), "data.frame") #sample df
  #save just sample names
      ITS.TF.High.sd.samps<-ITS.TF.High.sd[['ID']]

# compare ITS to 16s at TF
  #identify missing samples btw datasets     
      setdiff(bac.TF.High.sd.samps,ITS.TF.High.sd.samps) #samples in 16s but not ITS:   "S2893"  "S3476b" "S3481"  "S775"  
      setdiff(ITS.TF.High.sd.samps,bac.TF.High.sd.samps) #samples in ITS but not 16s: "S3474"   "S3471"  "SN138"    "S2018"  "S840"   "S3515"  "S477"   "S3489"  "SN141"  "S1771" "S1166b"
        
      # in 16S remove  "S2893"   "S3481"  "S775" ,change "S3476b"
      #in ITS remove "S3474"   "S3471"  "SN138"    "S2018"  "S840"   "S3515"  "S477"   "S3489"  "SN141"  "S1771" "S1166b"

  # 16s changes: remove  "S2893"   "S3481"  "S775" 
      
    Bac.TF.High.mantel <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S2893" )
        Bac.TF.High.mantel <- subset_samples(Bac.TF.High.mantel, sample_name.1 != "S3481" )
    Bac.TF.High.mantel <- subset_samples(Bac.TF.High.mantel, sample_name.1 != "S775" )

        
   #rename S3476b to S3476
      # pull OTU table
     OTU.16STF.High = as(otu_table(Bac.TF.High.mantel), "matrix") #pull otu
       OTU.16STF.High<-as.data.frame(OTU.16STF.High) #make into df
        row.names(OTU.16STF.High)[22] <- "S3476"   #change row name by row number
       
    #pull TAX table
     OTU.16STF.High = as(tax_table(Bac.TF.High.mantel), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.16STF.High = as(sample_data(Bac.TF.High.mantel), "matrix") #pull samp.data
     aSD.16STF.High<-as.data.frame(aSD.16STF.High) #change to df
        row.names(aSD.16STF.High)[22] <- "S3476"   #change row name by row number
          
    #remake the phyloseq obj
      samdata.High = sample_data(aSD.16STF.High)
        seqtab.High = otu_table(OTU.16STF.High, taxa_are_rows = FALSE)
        taxtab.High = tax_table(OTU.16STF.High)
          BacTF.High_mantel = phyloseq(otu_table(seqtab.High), tax_table(taxtab.High), sample_data(samdata.High))
      
        #31 samples
          
   #ITS2 - remove samps not in the 16s df - "S3474" "S3471"  "SN138"   "S2018"  "S840"   "S3515"  "S477"   "S3489"  "SN141"  "S1771"  "S1166b"
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S3474" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S3471" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "SN138" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S2018" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S840" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S3515" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S477" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S3489" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "SN141" )
        ITS2_TF_mantel.High <- subset_samples(ITS2_TF_mantel.High, ID != "S1771" )


    #change names ITS2 replace "S1166b"

    # pull OTU table
     OTU.ITS2TF.High = as(otu_table(ITS2_TF_mantel.High), "matrix") #pull otu
       OTU.ITS2TF.High<-as.data.frame(OTU.ITS2TF.High) #make into df
        row.names(OTU.ITS2TF.High)[6] <- "S1166"   #change row name by row number

    #pull TAX table
     aTax.ITS2TF.High = as(tax_table(ITS2_TF_mantel.High), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.ITS2TF.High = as(sample_data(ITS2_TF_mantel.High), "matrix") #pull samp.data
     aSD.ITS2TF.High<-as.data.frame(aSD.ITS2TF.High) #change to df
        row.names(OTU.ITS2TF.High)[6] <- "S1166b"   #change row name by row number

    #remake the phyloseq obj
      samdata.High = sample_data(aSD.ITS2TF.High)
        seqtab.High = otu_table(OTU.ITS2TF.High, taxa_are_rows = FALSE)
        taxtab.High = tax_table(aTax.ITS2TF.High)
          ITS_TF.High_mantel = phyloseq(otu_table(seqtab.High), tax_table(taxtab.High), sample_data(samdata.High))
             
        # both have 31 samples - 
      
        # reorder ps object so samples are in the same order
        
        Bac.TF.High.mantel <- Bac.TF.High.mantel %>% ps_arrange(sample_name.1, desc(sample_name.1))
        phyloseq::sample_data(Bac.TF.High.mantel) %>% head(8)
        
        ITS_TF.High_mantel <- ITS_TF.High_mantel %>% ps_arrange(ID, desc(ID))
        phyloseq::sample_data(ITS_TF.High_mantel) %>% head(8)
        
  # MAKE data matrix
  
  #16s TF High        
        unifrac.Bac.TF.High.mantel <- phyloseq::distance(Bac.TF.High.mantel, method = "wunifrac")
        
  #ITS2 TF High
     bray.ITS2.TF.High.mantel <- phyloseq::distance(ITS_TF.High_mantel, method = "bray") 

  # Run mantel test
      mantel(unifrac.Bac.TF.High.mantel, bray.ITS2.TF.High.mantel,  permutations=1000)
    
        
#### TF.High Mcap only ####        
 # Bac_TF.High_mantel ITS2_TF.High_mantel
    
    #subset df for mcap
    Bac_TF.High_mantel.Mcap <- subset_samples(Bac.TF.High.mantel, Species == "Montipora_capitata")
    Bac_TF.High_mantel.Mcap = prune_taxa(taxa_sums(Bac_TF.High_mantel.Mcap) > 0, Bac_TF.High_mantel.Mcap) 
    
    ITS2_TF.High_mantel.Mcap  <- subset_samples(ITS_TF.High_mantel, Species == "Montipora_capitata")
    ITS2_TF.High_mantel.Mcap = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Mcap) > 0, ITS2_TF.High_mantel.Mcap)
        
    #16s TF.High mcap dist        
      unifrac.Bac_TF.High_mantel.Mcap <- phyloseq::distance(Bac_TF.High_mantel.Mcap, method = "wunifrac")
        
   #ITS2 TF.High mcap dist
     bray.ITS2.TF.High.mantel.Mcap <- phyloseq::distance(ITS2_TF.High_mantel.Mcap, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Mcap, bray.ITS2.TF.High.mantel.Mcap,  permutations=1000)
    
#### TF.High Pcomp only ####        
 # Bac_TF.High_mantel ITS2_TF.High_mantel
    
    #subset df for Pcomp
    Bac_TF.High_mantel.Pcomp <- subset_samples(Bac.TF.High.mantel, Species == "Porites_compressa")
    Bac_TF.High_mantel.Pcomp = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pcomp) > 0, Bac_TF.High_mantel.Pcomp) 
    
    ITS2_TF.High_mantel.Pcomp  <- subset_samples(ITS_TF.High_mantel, Species == "Porites_compressa")
    ITS2_TF.High_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pcomp) > 0, ITS2_TF.High_mantel.Pcomp)
        
    #16s TF.High Pcomp dist        
      unifrac.Bac_TF.High_mantel.Pcomp <- phyloseq::distance(Bac_TF.High_mantel.Pcomp, method = "wunifrac")
        
   #ITS2 TF.High Pcomp dist
     bray.ITS2.TF.High.mantel.Pcomp <- phyloseq::distance(ITS2_TF.High_mantel.Pcomp, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pcomp, bray.ITS2.TF.High.mantel.Pcomp,  permutations=1000)        
        
    
#### TF.High Pvar only ####        
 # Bac_TF.High_mantel ITS2_TF.High_mantel
    
    #subset df for Pvar
    Bac_TF.High_mantel.Pvar <- subset_samples(Bac.TF.High.mantel, Species == "Pavona_varians")
    Bac_TF.High_mantel.Pvar = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pvar) > 0, Bac_TF.High_mantel.Pvar) 
    
    ITS2_TF.High_mantel.Pvar  <- subset_samples(ITS_TF.High_mantel, Species == "Pavona_varians")
    ITS2_TF.High_mantel.Pvar = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pvar) > 0, ITS2_TF.High_mantel.Pvar)
        
    #16s TF.High Pvar dist        
      unifrac.Bac_TF.High_mantel.Pvar <- phyloseq::distance(Bac_TF.High_mantel.Pvar, method = "wunifrac")
        
   #ITS2 TF.High Pvar dist
     bray.ITS2.TF.High.mantel.Pvar <- phyloseq::distance(ITS2_TF.High_mantel.Pvar, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pvar, bray.ITS2.TF.High.mantel.Pvar,  permutations=1000)       
      
      #### TF.High Pacu only ####        
 # Bac_TF.High_mantel ITS2_TF.High_mantel
    
    #subset df for Pacu
    Bac_TF.High_mantel.Pacu <- subset_samples(Bac.TF.High.mantel, Species == "Pocillopora_acuta")
    Bac_TF.High_mantel.Pacu = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pacu) > 0, Bac_TF.High_mantel.Pacu) 
    
    ITS2_TF.High_mantel.Pacu  <- subset_samples(ITS_TF.High_mantel, Species == "Pocillopora_acuta")
    ITS2_TF.High_mantel.Pacu = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pacu) > 0, ITS2_TF.High_mantel.Pacu)
        
    #16s TF.High Pacu dist        
      unifrac.Bac_TF.High_mantel.Pacu <- phyloseq::distance(Bac_TF.High_mantel.Pacu, method = "wunifrac")
        
   #ITS2 TF.High Pacu dist
     bray.ITS2.TF.High.mantel.Pacu <- phyloseq::distance(ITS2_TF.High_mantel.Pacu, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pacu, bray.ITS2.TF.High.mantel.Pacu,  permutations=1000)  

```
TF Ambient only
```{r}
# figure out which samples are represented in the its2 and 16s dfs

# TF only  #####

#Ambient only 

#set up 16s
    Bac.s.rel.u.TF<-subset_samples(Bac.s.rel.u, Time.Point=="TF")
    Bac.s.rel.u.TF.Ambient<-subset_samples(Bac.s.rel.u.TF, Treatment=="Ambient")

    Bac.s.rel.u.TF.Ambient = prune_taxa(taxa_sums(Bac.s.rel.u.TF.Ambient) > 0, Bac.s.rel.u.TF.Ambient) #this removes any OTU with 0s
  # look at sample names
    bac.TF.sd <- as(sample_data(Bac.s.rel.u.TF.Ambient), "data.frame") #sample df
    #save just sample names
      bac.TF.Ambient.sd.samps<-bac.TF.sd[['sample_name.1']]

#set up ITS2 TF, import  TFTF
     ITS2_TF_mantel<-subset_samples(ITS2_T1TF_mantel, Time.Point=="TF")
    ITS2_TF_mantel.Ambient<-subset_samples(ITS2_TF_mantel, Treatment=="Ambient")
      ITS2_TF_mantel.Ambient = prune_taxa(taxa_sums(ITS2_TF_mantel.Ambient) > 0, ITS2_TF_mantel.Ambient) #this removes any OTU with 0s

    
  # look at sample names
    ITS.TF.Ambient.sd <- as(sample_data(ITS2_TF_mantel.Ambient), "data.frame") #sample df
  #save just sample names
      ITS.TF.Ambient.sd.samps<-ITS.TF.Ambient.sd[['ID']]

# compare ITS to 16s at TF
  #identify missing samples btw datasets     
      setdiff(bac.TF.Ambient.sd.samps,ITS.TF.Ambient.sd.samps) #samples in 16s but not ITS: "S1104" "S785b" 
      setdiff(ITS.TF.Ambient.sd.samps,bac.TF.Ambient.sd.samps) #samples in ITS but not 16s: S1736"  "SN208"  "SN223"  "S779"   "SN183"  "S3317"  "S1279"   "SN102"  RENAME "SN217b"
      
      # in 16S remove "S1104" "S785b"
      #in ITS  Remove S1736"  "SN208"  "SN223"  "S779"   "SN183"  "S3317"  "S1279"   "SN102"  RENAME "SN217b"

      

  # 16s changes: remove "S1104" "S785b"
      
 # remove
    Bac.TF.Ambient.mantel <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S1104" )
        Bac.TF.Ambient.mantel <- subset_samples(Bac.TF.Ambient.mantel, sample_name.1 != "S785b" )

#38 samps
          
   #ITS2 - remove samps not in the 16s df -  S1736"  "SN208"  "SN223"  "S779"   "SN183"  "S3317"  "S1279"   "SN102"  RENAME "SN217b"

        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "S1736" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "SN208" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "SN223" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "S779" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "SN183" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "S3317" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "S1279" )
        ITS2_TF_mantel.Ambient <- subset_samples(ITS2_TF_mantel.Ambient, ID != "SN102" )
#rename 217b
         
    # pull OTU table
     OTU.ITS2TF.Ambient = as(otu_table(ITS2_TF_mantel.Ambient), "matrix") #pull otu
       OTU.ITS2TF.Ambient<-as.data.frame(OTU.ITS2TF.Ambient) #make into df
        row.names(OTU.ITS2TF.Ambient)[43] <- "S217"   #change row name by row number

    #pull TAX table
     aTax.ITS2TF.Ambient = as(tax_table(ITS2_TF_mantel.Ambient), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.ITS2TF.Ambient = as(sample_data(ITS2_TF_mantel.Ambient), "matrix") #pull samp.data
     aSD.ITS2TF.Ambient<-as.data.frame(aSD.ITS2TF.Ambient) #change to df
        row.names(OTU.ITS2TF.Ambient)[43] <- "S217"   #change row name by row number

    #remake the phyloseq obj
      samdata.Ambient = sample_data(aSD.ITS2TF.Ambient)
        seqtab.Ambient = otu_table(OTU.ITS2TF.Ambient, taxa_are_rows = FALSE)
        taxtab.Ambient = tax_table(aTax.ITS2TF.Ambient)
          ITS_TF.Ambient_mantel = phyloseq(otu_table(seqtab.Ambient), tax_table(taxtab.Ambient), sample_data(samdata.Ambient))
      
        # reorder ps object so samples are in the same order
        
        Bac.TF.Ambient.mantel <- Bac.TF.Ambient.mantel %>% ps_arrange(sample_name.1, desc(sample_name.1))
        phyloseq::sample_data(Bac.TF.Ambient.mantel) %>% head(8)
        
        ITS2_TF_mantel.Ambient <- ITS2_TF_mantel.Ambient %>% ps_arrange(ID, desc(ID))
        phyloseq::sample_data(ITS2_TF_mantel.Ambient) %>% head(8)
        
  # MAKE data matrix
  
  #16s TF Ambient        
        unifrac.Bac.TF.Ambient.mantel <- phyloseq::distance(Bac.TF.Ambient.mantel, method = "wunifrac")
        
  #ITS2 TF Ambient
     bray.ITS2.TF.Ambient.mantel <- phyloseq::distance(ITS2_TF_mantel.Ambient, method = "bray") 

  # Run mantel test
      mantel(unifrac.Bac.TF.Ambient.mantel, bray.ITS2.TF.Ambient.mantel,  permutations=1000)
    
        
#### TF.Ambient Mcap only ####        
 # Bac_TF.Ambient_mantel ITS2_TF.Ambient_mantel
    
    #subset df for mcap
    Bac_TF.Ambient_mantel.Mcap <- subset_samples(Bac.TF.Ambient.mantel, Species == "Montipora_capitata")
    Bac_TF.Ambient_mantel.Mcap = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Mcap) > 0, Bac_TF.Ambient_mantel.Mcap) 
    
    ITS2_TF.Ambient_mantel.Mcap  <- subset_samples(ITS2_TF_mantel.Ambient, Species == "Montipora_capitata")
    ITS2_TF.Ambient_mantel.Mcap = prune_taxa(taxa_sums(ITS2_TF.Ambient_mantel.Mcap) > 0, ITS2_TF.Ambient_mantel.Mcap)
        
    #16s TF.Ambient mcap dist        
      unifrac.Bac_TF.Ambient_mantel.Mcap <- phyloseq::distance(Bac_TF.Ambient_mantel.Mcap, method = "wunifrac")
        
   #ITS2 TF.Ambient mcap dist
     bray.ITS2.TF.Ambient.mantel.Mcap <- phyloseq::distance(ITS2_TF.Ambient_mantel.Mcap, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Mcap, bray.ITS2.TF.Ambient.mantel.Mcap,  permutations=1000)
    
#### TF.Ambient Pcomp only ####        
 # Bac_TF.Ambient_mantel ITS2_TF.Ambient_mantel
    
    #subset df for Pcomp
    Bac_TF.Ambient_mantel.Pcomp <- subset_samples(Bac.TF.Ambient.mantel, Species == "Porites_compressa")
    Bac_TF.Ambient_mantel.Pcomp = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pcomp) > 0, Bac_TF.Ambient_mantel.Pcomp) 
    
    ITS2_TF.Ambient_mantel.Pcomp  <- subset_samples(ITS2_TF_mantel.Ambient, Species == "Porites_compressa")
    ITS2_TF.Ambient_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_TF.Ambient_mantel.Pcomp) > 0, ITS2_TF.Ambient_mantel.Pcomp)
        
    #16s TF.Ambient Pcomp dist        
      unifrac.Bac_TF.Ambient_mantel.Pcomp <- phyloseq::distance(Bac_TF.Ambient_mantel.Pcomp, method = "wunifrac")
        
   #ITS2 TF.Ambient Pcomp dist
     bray.ITS2.TF.Ambient.mantel.Pcomp <- phyloseq::distance(ITS2_TF.Ambient_mantel.Pcomp, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pcomp, bray.ITS2.TF.Ambient.mantel.Pcomp,  permutations=1000)        
        
    
#### TF.Ambient Pvar only ####        
 # Bac_TF.Ambient_mantel ITS2_TF.Ambient_mantel
    
    #subset df for Pvar
    Bac_TF.Ambient_mantel.Pvar <- subset_samples(Bac.TF.Ambient.mantel, Species == "Pavona_varians")
    Bac_TF.Ambient_mantel.Pvar = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pvar) > 0, Bac_TF.Ambient_mantel.Pvar) 
    
    ITS2_TF.Ambient_mantel.Pvar  <- subset_samples(ITS2_TF_mantel.Ambient, Species == "Pavona_varians")
    ITS2_TF.Ambient_mantel.Pvar = prune_taxa(taxa_sums(ITS2_TF.Ambient_mantel.Pvar) > 0, ITS2_TF.Ambient_mantel.Pvar)
        
    #16s TF.Ambient Pvar dist        
      unifrac.Bac_TF.Ambient_mantel.Pvar <- phyloseq::distance(Bac_TF.Ambient_mantel.Pvar, method = "wunifrac")
        
   #ITS2 TF.Ambient Pvar dist
     bray.ITS2.TF.Ambient.mantel.Pvar <- phyloseq::distance(ITS2_TF.Ambient_mantel.Pvar, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pvar, bray.ITS2.TF.Ambient.mantel.Pvar,  permutations=1000)       
      
      #### TF.Ambient Pacu only ####        
 # Bac_TF.Ambient_mantel ITS2_TF.Ambient_mantel
    
    #subset df for Pacu
    Bac_TF.Ambient_mantel.Pacu <- subset_samples(Bac.TF.Ambient.mantel, Species == "Pocillopora_acuta")
    Bac_TF.Ambient_mantel.Pacu = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pacu) > 0, Bac_TF.Ambient_mantel.Pacu) 
    
    ITS2_TF.Ambient_mantel.Pacu  <- subset_samples(ITS2_TF_mantel.Ambient, Species == "Pocillopora_acuta")
    ITS2_TF.Ambient_mantel.Pacu = prune_taxa(taxa_sums(ITS2_TF.Ambient_mantel.Pacu) > 0, ITS2_TF.Ambient_mantel.Pacu)
        
    #16s TF.Ambient Pacu dist        
      unifrac.Bac_TF.Ambient_mantel.Pacu <- phyloseq::distance(Bac_TF.Ambient_mantel.Pacu, method = "wunifrac")
        
   #ITS2 TF.Ambient Pacu dist
     bray.ITS2.TF.Ambient.mantel.Pacu <- phyloseq::distance(ITS2_TF.Ambient_mantel.Pacu, method = "bray") 

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pacu, bray.ITS2.TF.Ambient.mantel.Pacu,  permutations=1000)  

```





##Physio and 16s

T0
```{r}

# T0 only  #####

#set up 16s
    Bac.s.rel.u.T0<-subset_samples(Bac.s.rel.u, Time.Point=="T0")
    Bac.s.rel.u.T0 = prune_taxa(taxa_sums(Bac.s.rel.u.T0) > 0, Bac.s.rel.u.T0) #this removes any OTU with 0s
  # look at sample names
    bac.T0.sd <- as(sample_data(Bac.s.rel.u.T0), "data.frame") #sample df
    #save just sample names
      bac.T0.sd.samps<-bac.T0.sd[['sample_name.1']]

      
#set up physio T0
      
      physio.T0<-subset(physio, time.point=="T0")
      physio.T0<-physio.T0[,c(1,5,16:23)]
  # look at sample names
    physio.T0.sd <- as(sample_data(physio.T0), "data.frame") #sample df
  #save just sample names
      physio.T0.sd.samps<-physio.T0.sd[['ID']]
# compare physio to 16s at T0
  #identify missing samples btw datasets     
      setdiff(bac.T0.sd.samps,physio.T0.sd.samps) #samples in 16s but not phys: "S208b" "S915"  "SN3"   "SN70b"
      setdiff(physio.T0.sd.samps,bac.T0.sd.samps) #samples in phys but not 16s: ""SN11"  "SN145" "SN40"  "S208"  "SN56"  "SN6"   "SN109" "SN111" "SN70"  "S49"   "SN60" 
        
      # in 16S RENAME sample S208b name to S208 and SN70b to SN70, REMOVE S915 and SN3

      # physio changes: REMOVE "SN11"  "SN145" "SN40"   "SN56"  "SN6"   "SN109" "SN111"  "S49"   "SN60" 

#remove 16S
      Bac.s.rel.u.T0 <- subset_samples(Bac.s.rel.u.T0, Frag.ID != "915" )
            Bac.s.rel.u.T0 <- subset_samples(Bac.s.rel.u.T0, Frag.ID != "N3" )

#rename 16S:
    # pull OTU table
     OTU.16sT0 = as(otu_table(Bac.s.rel.u.T0), "matrix") #pull otu
       OTU.16sT0<-as.data.frame(OTU.16sT0) #make into df
        row.names(OTU.16sT0)[5] <- "S208"   #change row name by row number
        row.names(OTU.16sT0)[31] <- "SN70"   #change row name by row number

    #pull TAX table
     aTax.16sT0 = as(tax_table(Bac.s.rel.u.T0), "matrix") #pull tax
     
     #pull phy tree table
     tree.seq = phy_tree(Bac.s.rel.u.T0) #pull out tree

    #pull SAMPLE DATA
     aSD.16sT0 = as(sample_data(Bac.s.rel.u.T0), "matrix") #pull samp.data
     aSD.16sT0<-as.data.frame(aSD.16sT0) #change to df
        row.names(aSD.16sT0)[5] <- "S208"  #replace name S208b
        row.names(aSD.16sT0)[31] <- "SN70"  #replace name S208b

    #remake the phyloseq obj
      samdata = sample_data(aSD.16sT0)
        seqtab = otu_table(OTU.16sT0, taxa_are_rows = FALSE)
        taxtab = tax_table(aTax.16sT0)
        phy_tree = read_tree(tree.seq)
          Bac_T0_mantel = phyloseq(otu_table(seqtab), tax_table(taxtab), sample_data(samdata),phy_tree(tree.seq))
          
          #39
   #physio - remove samps not in the 16s df-  "SN11"  "SN145" "SN40"  "SN56"  "SN6"   "SN109" "SN111"   "S49"   "SN60" 

        physio_T0_mantel<-physio.T0 #make a copy
        
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN11"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN145"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN40"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN56"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN6"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN109"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN111"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="S49"),]
        physio_T0_mantel<-physio_T0_mantel[!(physio_T0_mantel$ID=="SN60"),]
        # both have 37 samples - Bac_T0_mantel physio_T0_mantel
      
  # reorder ps object so samples are in the same order
      
                rownames(physio_T0_mantel) <- physio_T0_mantel[,1] #make first col row names

        vec <- c("S1108","S148","S1753","S1982","S208","S231","S263","S31","S391","S488","S616","S74","S755","S914","SN107", "SN18","SN19","SN21","SN25","SN2","SN30","SN33","SN35","SN38","SN47","SN4","SN50","SN64","SN70","SN72","SN7","SN82","SN84","SN85","SN87","SN94","SN9")               # Create  vector order
         physio_T0_mantel <- physio_T0_mantel[match(vec, physio_T0_mantel$ID), ]  
        
        
        
        #build matrix  
  #16s T0        
        unifrac.Bac.T0.mantel <- phyloseq::distance(Bac_T0_mantel, method = "wunifrac")
        

   #   Scale and center
   physio_T0_mantel2<-  physio_T0_mantel[,3:10]
   physio_T0_mantel2<-scale(physio_T0_mantel2)
   euc.physio.T0.mantel3 <- dist(physio_T0_mantel2, method = "euclidian")
     
  # Run mantel test
      mantel(unifrac.Bac.T0.mantel, euc.physio.T0.mantel3,  permutations=999)
    # r=0.3041 p=0.001
        
#### T0 Mcap only ####        
 # Bac_T0_mantel physio_T0_mantel
    
    #subset df for mcap
    Bac_T0_mantel.Mcap <- subset_samples(Bac_T0_mantel, Species == "Montipora_capitata")
    Bac_T0_mantel.Mcap = prune_taxa(taxa_sums(Bac_T0_mantel.Mcap) > 0, Bac_T0_mantel.Mcap) 
  
    physio_T0_mantel.Mcap  <- subset(physio_T0_mantel, species == "Montipora_capitata")

    #16s T0 mcap dist        
      unifrac.Bac_T0_mantel.Mcap <- phyloseq::distance(Bac_T0_mantel.Mcap, method = "wunifrac")
        
   #physio T0 mcap dist
        physio_T0_mantel.Mcap2<-  physio_T0_mantel.Mcap[,3:10]         #   Scale and center
        physio_T0_mantel.Mcap2<-scale(physio_T0_mantel.Mcap2)
        euc.physio.T0.mantel.Mcap  <- dist(physio_T0_mantel.Mcap2, method = "euclidian") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Mcap, euc.physio.T0.mantel.Mcap,  permutations=1000)
    
#### T0 Pcomp only ####        
 # Bac_T0_mantel physio_T0_mantel
    
    #subset df for Pcomp
    Bac_T0_mantel.Pcomp <- subset_samples(Bac_T0_mantel, Species == "Porites_compressa")
    Bac_T0_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T0_mantel.Pcomp) > 0, Bac_T0_mantel.Pcomp) 
    
    physio_T0_mantel.Pcomp  <- subset(physio_T0_mantel, species == "Porites_compressa")

    #16s T0 Pcomp dist        
      unifrac.Bac_T0_mantel.Pcomp <- phyloseq::distance(Bac_T0_mantel.Pcomp, method = "wunifrac")
        
   #physio T0 Pcomp dist
        physio_T0_mantel.Pcomp2<-  physio_T0_mantel.Pcomp[,3:10]         #   Scale and center
        physio_T0_mantel.Pcomp2<-scale(physio_T0_mantel.Pcomp2)
        euc.physio_T0_mantel.Pcomp2  <- dist(physio_T0_mantel.Pcomp2, method = "euclidian") 
        
   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pcomp, euc.physio_T0_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T0 Pvar only ####        
 # Bac_T0_mantel physio_T0_mantel
    
    #subset df for Pvar
    Bac_T0_mantel.Pvar <- subset_samples(Bac_T0_mantel, Species == "Pavona_varians")
    Bac_T0_mantel.Pvar = prune_taxa(taxa_sums(Bac_T0_mantel.Pvar) > 0, Bac_T0_mantel.Pvar) 
    
    physio_T0_mantel.Pvar  <- subset(physio_T0_mantel, species == "Pavona_varians")

    #16s T0 Pvar dist        
      unifrac.Bac_T0_mantel.Pvar <- phyloseq::distance(Bac_T0_mantel.Pvar, method = "wunifrac")
        
   #physio T0 Pvar dist
      physio_T0_mantel.Pvar2<-  physio_T0_mantel.Pvar[,3:10]         #   Scale and center
        physio_T0_mantel.Pvar2<-scale(physio_T0_mantel.Pvar2)
        euc.physio_T0_mantel.Pvar2 <- dist(physio_T0_mantel.Pvar2, method = "euclidian") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pvar, euc.physio_T0_mantel.Pvar2,  permutations=1000)            
        
        
     #### T0 Pacu only ####        
 # Bac_T0_mantel physio_T0_mantel
    
    #subset df for Pacu
    Bac_T0_mantel.Pacu <- subset_samples(Bac_T0_mantel, Species == "Pocillopora_acuta")
    Bac_T0_mantel.Pacu = prune_taxa(taxa_sums(Bac_T0_mantel.Pacu) > 0, Bac_T0_mantel.Pacu) 
    
    physio_T0_mantel.Pacu  <- subset(physio_T0_mantel, species == "Pocillopora_acuta")

    #16s T0 Pacu dist        
      unifrac.Bac_T0_mantel.Pacu <- phyloseq::distance(Bac_T0_mantel.Pacu, method = "wunifrac")
        
   #physio T0 Pacu dist
     physio_T0_mantel.Pacu2<-  physio_T0_mantel.Pacu[,3:10]         #   Scale and center
        physio_T0_mantel.Pacu2<-scale(physio_T0_mantel.Pacu2)
        euc.physio_T0_mantel.Pacu2 <- dist(physio_T0_mantel.Pacu2, method = "euclidian") 

   # Run mantel test
      mantel(unifrac.Bac_T0_mantel.Pacu, euc.physio_T0_mantel.Pacu2,  permutations=1000)            
        
        
    


```
T1 High only
```{r}

# T1 only  #####

#set up 16s
      Bac.s.rel.u.T1<-subset_samples(Bac.s.rel.u, Time.Point=="T1")
      Bac.s.rel.u.T1.High<-subset_samples(Bac.s.rel.u.T1, Treatment=="High")

      Bac.s.rel.u.T1.High = prune_taxa(taxa_sums(Bac.s.rel.u.T1.High) > 0, Bac.s.rel.u.T1.High) #this removes any OTU with 0s
  # look at sample names
      bac.T1.High.sd <- as(sample_data(Bac.s.rel.u.T1.High), "data.frame") #sample df
    #save just sample names
      bac.T1.High.sd.samps<-bac.T1.High.sd[['sample_name.1']]
      bac.T1.High.sd.samps<-as.data.frame(bac.T1.High.sd.samps)
      
#set up physio T1
      
      physio.T1<-subset(physio, time.point=="T1")
            physio.T1.High<-subset(physio.T1, treatment=="High")
      physio.T1.High<-physio.T1.High[,c(1,5,15:23)]

  # look at sample names
    physio.T1.High.sd <- as(sample_data(physio.T1.High), "data.frame") #sample df
  #save just sample names
      physio.T1.High.sd<-physio.T1.High.sd[['ID']]

      # compare physio to 16s at T1
  #identify missing samples btw datasets     ***** This is not running i think it is a computer issue*** did by hand
      setdiff(bac.T1.High.sd.samps,physio.T1.High.sd) #samples in 16s but not phys: 
      setdiff(physio.T1.High.sd,bac.T1.High.sd.samps) #samples in phys but not 16s: S1388, S3025, S3085, S3486, S3477, S670
        
   #physio - remove samps not in the 16s df-  S1388, S3025, S3085, S3468, S3477, S670

        physio_T1.High_mantel<-physio.T1.High #make a copy
        
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S1388"),]
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S3025"),]
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S3085"),]
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S3468"),]
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S3477"),]
        physio_T1.High_mantel<-physio_T1.High_mantel[!(physio_T1.High_mantel$ID=="S670"),]
  
        # both have 42 obs
      
  # reorder ps object so samples are in the same order
        rownames(physio_T1.High_mantel) <- physio_T1.High_mantel[,1] #make first col row names

        vec <- c("S1068","S1110","S1133","S1441","S1791","S179","S1857","S1943","S2001","S2142","S226","S2402","S2629","S2736","S2849","S2911","S3059","S3086","S3137","S314","S3246","S3340","S3458","S3469","S3472","S3475","S3478","S3479","S3482","S3488","S3490","S3512","S3513","S3514","S490","S634","S946","SN134","SN150","SN157","SN190")               # Create  vector order
         physio_T1.High_mantel.ord <- physio_T1.High_mantel[match(vec, physio_T1.High_mantel$ID), ]  
        
       
#build matrix  
  #16s T1        
        Bac.s.rel.u.T1.High.mantel<-Bac.s.rel.u.T1.High
        uni.Bac.s.rel.u.T1.High.mantel <- phyloseq::distance(Bac.s.rel.u.T1.High.mantel, method = "wunifrac")
        
  #physio T1 high
        #   Scale and center
   physio_T1.High_mantel2<-  physio_T1.High_mantel.ord[,3:10]
   physio_T1.High_mantel2<-scale(physio_T1.High_mantel2)
   euc.physio_T1.High_mantel2 <- dist(physio_T1.High_mantel2, method = "euclidian")

  # Run mantel test
      mantel(uni.Bac.s.rel.u.T1.High.mantel, euc.physio_T1.High_mantel2,  permutations=999)
    # r=0.1104 p=0.038
        
#### T1 Mcap only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for mcap
    Bac_T1_mantel.Mcap <- subset_samples(Bac.s.rel.u.T1.High.mantel, Species == "Montipora_capitata")
    Bac_T1_mantel.Mcap = prune_taxa(taxa_sums(Bac_T1_mantel.Mcap) > 0, Bac_T1_mantel.Mcap) 
    
    physio_T1_mantel.Mcap  <- subset(physio_T1.High_mantel.ord, species == "Montipora_capitata")

    #16s T1 mcap dist        
      unifrac.Bac_T1_mantel.Mcap <- phyloseq::distance(Bac_T1_mantel.Mcap, method = "wunifrac")
        
   #physio T1 mcap dist
       physio_T1_mantel.Mcap2<-  physio_T1_mantel.Mcap[,3:10]
       physio_T1_mantel.Mcap2<-scale(physio_T1_mantel.Mcap2)
       euc.physio_T1_mantel.Mcap2 <- dist(physio_T1_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1_mantel.Mcap, euc.physio_T1_mantel.Mcap2,  permutations=1000)
    
#### T1 Pcomp only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for Pcomp
    Bac_T1_mantel.Pcomp <- subset_samples(Bac.s.rel.u.T1.High.mantel, Species == "Porites_compressa")
    Bac_T1_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T1_mantel.Pcomp) > 0, Bac_T1_mantel.Pcomp) 
    
    physio_T1_mantel.Pcomp  <- subset(physio_T1.High_mantel.ord, species == "Porites_compressa")

    #16s T1 Pcomp dist        
      unifrac.Bac_T1_mantel.Pcomp <- phyloseq::distance(Bac_T1_mantel.Pcomp, method = "wunifrac")
        
   #physio T1 Pcomp dist
      physio_T1_mantel.Pcomp2<-  physio_T1_mantel.Pcomp[,3:10]
       physio_T1_mantel.Pcomp2<-scale(physio_T1_mantel.Pcomp2)
       euc.physio_T1_mantel.Pcomp2 <- dist(physio_T1_mantel.Pcomp2, method = "euclidian")
       
   # Run mantel test
      mantel(unifrac.Bac_T1_mantel.Pcomp, euc.physio_T1_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T1 Pvar only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for Pvar
    Bac_T1_mantel.Pvar <- subset_samples(Bac.s.rel.u.T1.High.mantel, Species == "Pavona_varians")
    Bac_T1_mantel.Pvar = prune_taxa(taxa_sums(Bac_T1_mantel.Pvar) > 0, Bac_T1_mantel.Pvar) 
    
    physio_T1_mantel.Pvar  <- subset(physio_T1.High_mantel.ord, species == "Pavona_varians")

    #16s T1 Pvar dist        
      unifrac.Bac_T1_mantel.Pvar <- phyloseq::distance(Bac_T1_mantel.Pvar, method = "wunifrac")
        
   #physio T1 Pvar dist
     physio_T1_mantel.Pvar2<-  physio_T1_mantel.Pvar[,3:10]
       physio_T1_mantel.Pvar2<-scale(physio_T1_mantel.Pvar2)
       euc.physio_T1_mantel.Pvar2 <- dist(physio_T1_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1_mantel.Pvar, euc.physio_T1_mantel.Pvar2,  permutations=1000)            
        
        
     #### T1 Pacu only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for Pacu
    Bac_T1_mantel.Pacu <- subset_samples(Bac.s.rel.u.T1.High.mantel, Species == "Pocillopora_acuta")
    Bac_T1_mantel.Pacu = prune_taxa(taxa_sums(Bac_T1_mantel.Pacu) > 0, Bac_T1_mantel.Pacu) 
    
    physio_T1_mantel.Pacu  <- subset(physio_T1.High_mantel.ord, species == "Pocillopora_acuta")

    #16s T1 Pacu dist        
      unifrac.Bac_T1_mantel.Pacu <- phyloseq::distance(Bac_T1_mantel.Pacu, method = "wunifrac")
        
   #physio T1 Pacu dist
       physio_T1_mantel.Pacu2<-  physio_T1_mantel.Pacu[,3:10]
       physio_T1_mantel.Pacu2<-scale(physio_T1_mantel.Pacu2)
       euc.physio_T1_mantel.Pacu2 <- dist(physio_T1_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1_mantel.Pacu, euc.physio_T1_mantel.Pacu2,  permutations=1000)            
```
T1 Amb only








```{r}

# T1 only  #####

#set up 16s
    Bac.s.rel.u.T1.Amb<-subset_samples(Bac.s.rel.u.T1, Treatment=="Ambient")
    Bac.s.rel.u.T1.Amb = prune_taxa(taxa_sums(Bac.s.rel.u.T1.Amb) > 0, Bac.s.rel.u.T1.Amb) 
  # look at sample names
    bac.T1.Amb.sd <- as(sample_data(Bac.s.rel.u.T1.Amb), "data.frame") #sample df
    #save just sample names
      bac.T1.Amb.sd.samps<-bac.T1.Amb.sd[['sample_name.1']]
      bac.T1.Amb.sd.samps<-as.data.frame(bac.T1.Amb.sd.samps)
      
#set up physio T1
      physio.T1<-subset(physio, time.point=="T1")
      physio.T1.Amb<-subset(physio.T1, treatment=="Ambient")
      physio.T1.Amb<-physio.T1.Amb[,c(1,5,15:23)]

  # look at sample names
      physio.T1.Amb.sd <- as(sample_data(physio.T1.Amb), "data.frame") #sample df
  #save just sample names
      physio.T1.Amb.sd<-physio.T1.Amb.sd[['ID']]

      # compare physio to 16s at T1
      #identify missing samples btw datasets     ***** This is not running i think it is a computer issue*** did by hand
      setdiff(bac.T1.Amb.sd.samps,physio.T1.Amb.sd) #samples in 16s but not phys: RENAME: S1443b, SN108b, SN197b, REMOVE: SN161, SN181
      setdiff(physio.T1.Amb.sd,bac.T1.Amb.sd.samps) #samples in phys but not 16s: REMOVE: S1195, S1418, S1573, S1895, S2424, S3035, S785, SN126, SN209 
      
      
 #remove 16S SN161, SN181
      Bac.s.rel.u.T1.Amb <- subset_samples(Bac.s.rel.u.T1.Amb, sample_name.1 != "SN161" )
            Bac.s.rel.u.T1.Amb <- subset_samples(Bac.s.rel.u.T1.Amb, sample_name.1 != "SN181" )

#rename 16S:S1443b, SN108b, SN197b,
    # pull OTU table
     OTU.16sT1.Amb = as(otu_table(Bac.s.rel.u.T1.Amb), "matrix") #pull otu
       OTU.16sT1.Amb<-as.data.frame(OTU.16sT1.Amb) #make into df
        row.names(OTU.16sT1.Amb)[3] <- "S1443"   #change row name by row number
        row.names(OTU.16sT1.Amb)[20] <- "SN108"   #change row name by row number
        row.names(OTU.16sT1.Amb)[28] <- "SN197"   #change row name by row number

    #pull TAX table
     aTax.16sT1.Amb = as(tax_table(Bac.s.rel.u.T1.Amb), "matrix") #pull tax
     
     #pull phy tree table
     tree.seq.T1Amb = phy_tree(Bac.s.rel.u.T1.Amb) #pull out tree

    #pull SAMPLE DATA
     aSD.16sT1.Amb = as(sample_data(Bac.s.rel.u.T1.Amb), "matrix") #pull samp.data
     aSD.16sT1.Amb<-as.data.frame(aSD.16sT1.Amb) #change to df
        row.names(aSD.16sT1.Amb)[3] <- "S208"  #replace name S208b
        row.names(aSD.16sT1.Amb)[20] <- "SN108"  #replace name S208b
        row.names(aSD.16sT1.Amb)[28] <- "SN197"  #replace name S208b

    #remake the phyloseq obj
      samdata = sample_data(aSD.16sT1.Amb)
        seqtab = otu_table(OTU.16sT1.Amb, taxa_are_rows = FALSE)
        taxtab = tax_table(aTax.16sT1.Amb)
        phy_tree = read_tree(tree.seq.T1Amb)
          Bac_T1.Amb_mantel = phyloseq(otu_table(seqtab), tax_table(taxtab), sample_data(samdata),phy_tree(tree.seq))
        
   #physio - remove samps not in the 16s df-  S1195, S1418, S1573, S1895, S2424, S3035, S785, SN126, SN209

        physio_T1.Amb_mantel<-physio.T1.Amb #make a copy
        
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S1195"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S1418"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S1573"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S1895"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S2424"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S3035"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="S785"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="SN126"),]
        physio_T1.Amb_mantel<-physio_T1.Amb_mantel[!(physio_T1.Amb_mantel$ID=="SN209"),]

        # both have  obs
      
  # reorder ps object so samples are in the same order
        physio_T1.Amb_mantel <- physio_T1.Amb_mantel[order(physio_T1.Amb_mantel$ID),]
        rownames(physio_T1.Amb_mantel) <- physio_T1.Amb_mantel[,1] #make first col row names
#build matrix  
  #16s T1        
        Bac.s.rel.u.T1.Amb.mantel<-Bac.s.rel.u.T1.Amb
        uni.Bac.s.rel.u.T1.Amb.mantel <- phyloseq::distance(Bac.s.rel.u.T1.Amb.mantel, method = "wunifrac")
        
  #physio T1 Amb
       physio_T1.Amb_mantel2<-  physio_T1.Amb_mantel[,3:10]
       physio_T1.Amb_mantel2<-scale(physio_T1.Amb_mantel2)
       euc.physio_T1.Amb_mantel2 <- dist(physio_T1.Amb_mantel2, method = "euclidian")

  # Run mantel test
      mantel(uni.Bac.s.rel.u.T1.Amb.mantel, euc.physio_T1.Amb_mantel2,  permutations=999)
    # r=0.2119  p=0.001
        
#### T1 Mcap only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for mcap
    Bac_T1.Amb_mantel.Mcap <- subset_samples(Bac.s.rel.u.T1.Amb.mantel, Species == "Montipora_capitata")
    Bac_T1.Amb_mantel.Mcap = prune_taxa(taxa_sums(Bac_T1.Amb_mantel.Mcap) > 0, Bac_T1.Amb_mantel.Mcap) 
    
    physio_T1.Amb_mantel.Mcap  <- subset(physio_T1.Amb_mantel, species == "Montipora_capitata")

    #16s T1 mcap dist        
      unifrac.Bac_T1.Amb_mantel.Mcap <- phyloseq::distance(Bac_T1.Amb_mantel.Mcap, method = "wunifrac")
        
   #physio T1 mcap dist
       physio_T1.Amb_mantel.Mcap2<-  physio_T1.Amb_mantel.Mcap[,3:10]
       physio_T1.Amb_mantel.Mcap2<-scale(physio_T1.Amb_mantel.Mcap2)
       euc.physio_T1.Amb_mantel.Mcap2 <- dist(physio_T1.Amb_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1.Amb_mantel.Mcap, euc.physio_T1.Amb_mantel.Mcap2,  permutations=1000)
    
#### T1 Pcomp only ####        
 # Bac_T1_mantel physio_T1_mantel
    
    #subset df for Pcomp
    Bac_T1.Amb_mantel.Pcomp <- subset_samples(Bac.s.rel.u.T1.Amb.mantel, Species == "Porites_compressa")
    Bac_T1.Amb_mantel.Pcomp = prune_taxa(taxa_sums(Bac_T1.Amb_mantel.Pcomp) > 0, Bac_T1.Amb_mantel.Pcomp) 
    
    physio_T1.Amb_mantel.Pcomp  <- subset(physio_T1.Amb_mantel, species == "Porites_compressa")

    #16s T1 Pcomp dist        
      unifrac.Bac_T1.Amb_mantel.Pcomp <- phyloseq::distance(Bac_T1.Amb_mantel.Pcomp, method = "wunifrac")
        
   #physio T1 Pcomp dist
       physio_T1.Amb_mantel.Pcomp2<-  physio_T1.Amb_mantel.Pcomp[,3:10]
       physio_T1.Amb_mantel.Pcomp2<-scale(physio_T1.Amb_mantel.Pcomp2)
       euc.physio_T1.Amb_mantel.Pcomp2 <- dist(physio_T1.Amb_mantel.Pcomp2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1.Amb_mantel.Pcomp, euc.physio_T1.Amb_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T1 Pvar only ####        
 # Bac_T1.Amb_mantel physio_T1.Amb_mantel
    
    #subset df for Pvar
    Bac_T1.Amb_mantel.Pvar <- subset_samples(Bac.s.rel.u.T1.Amb.mantel, Species == "Pavona_varians")
    Bac_T1.Amb_mantel.Pvar = prune_taxa(taxa_sums(Bac_T1.Amb_mantel.Pvar) > 0, Bac_T1.Amb_mantel.Pvar) 
    
    physio_T1.Amb_mantel.Pvar  <- subset(physio_T1.Amb_mantel, species == "Pavona_varians")

    #16s T1 Pvar dist        
      unifrac.Bac_T1.Amb_mantel.Pvar <- phyloseq::distance(Bac_T1.Amb_mantel.Pvar, method = "wunifrac")
        
   #physio T1 Pvar dist
       physio_T1.Amb_mantel.Pvar2<-  physio_T1.Amb_mantel.Pvar[,3:10]
       physio_T1.Amb_mantel.Pvar2<-scale(physio_T1.Amb_mantel.Pvar2)
       euc.physio_T1.Amb_mantel.Pvar2 <- dist(physio_T1.Amb_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1.Amb_mantel.Pvar, euc.physio_T1.Amb_mantel.Pvar2,  permutations=1000)            
        
        
     #### T1 Pacu only ####        
 # Bac_T1.Amb_mantel physio_T1.Amb_mantel
    
    #subset df for Pacu
    Bac_T1.Amb_mantel.Pacu <- subset_samples(Bac.s.rel.u.T1.Amb.mantel, Species == "Pocillopora_acuta")
    Bac_T1.Amb_mantel.Pacu = prune_taxa(taxa_sums(Bac_T1.Amb_mantel.Pacu) > 0, Bac_T1.Amb_mantel.Pacu) 
    
    physio_T1.Amb_mantel.Pacu  <- subset(physio_T1.Amb_mantel, species == "Pocillopora_acuta")

    #16s T1 Pacu dist        
      unifrac.Bac_T1.Amb_mantel.Pacu <- phyloseq::distance(Bac_T1.Amb_mantel.Pacu, method = "wunifrac")
        
   #physio T1 Pacu dist
       physio_T1.Amb_mantel.Pacu2<-  physio_T1.Amb_mantel.Pacu[,3:10]
       physio_T1.Amb_mantel.Pacu2<-scale(physio_T1.Amb_mantel.Pacu2)
       euc.physio_T1.Amb_mantel.Pacu2 <- dist(physio_T1.Amb_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_T1.Amb_mantel.Pacu, euc.physio_T1.Amb_mantel.Pacu2,  permutations=1000)            
        
        
    


```
TF High only
```{r}

# TF only  #####

#set up 16s
    Bac.s.rel.u.TF<-subset_samples(Bac.s.rel.u, Time.Point=="TF")
    Bac.s.rel.u.TF.High<-subset_samples(Bac.s.rel.u.TF, Treatment=="High")

    Bac.s.rel.u.TF.High = prune_taxa(taxa_sums(Bac.s.rel.u.TF.High) > 0, Bac.s.rel.u.TF.High) #this removes any OTU with 0s
  # look at sample names
    bac.TF.High.sd <- as(sample_data(Bac.s.rel.u.TF.High), "data.frame") #sample df
    #save just sample names
      bac.TF.High.sd.samps<-bac.TF.High.sd[['sample_name.1']]
 bac.TF.High.sd.samps<-as.data.frame(bac.TF.High.sd.samps)
      
#set up physio TF
      
      physio.TF<-subset(physio, time.point=="TF")
            physio.TF.High<-subset(physio.TF, treatment=="High")
      physio.TF.High<-physio.TF.High[,c(1,5,15:23)]

  # look at sample names
    physio.TF.High.sd <- as(sample_data(physio.TF.High), "data.frame") #sample df
  #save just sample names
      physio.TF.High.sd<-physio.TF.High.sd[['ID']]

      # compare physio to 16s at TF
  #identify missing samples btw datasets     ***** This is not running i think it is a computer issue*** did by hand
      setdiff(bac.TF.High.sd.samps,physio.TF.High.sd) #samples in 16s but not phys: REMOVE S1502, S2284, S3481, S3485, S619, S972 REPLACE: S3476b
      setdiff(physio.TF.High.sd,bac.TF.High.sd.samps) #samples in phys but not 16s:REMOVE: S1771, S2018, S3471, S3474, S3489,S3484 S3515, S3516, S477, S840, SN141, SN212   
        
#16 remove: S1502, S2284, S3481, S3485, S619, S972
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S1502" )
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S2284" )
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S3481" )
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S3485" )
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S619" )
            Bac.s.rel.u.TF.High <- subset_samples(Bac.s.rel.u.TF.High, sample_name.1 != "S972" )

#rename 16S:S3476b
    # pull OTU table
     OTU.16sTF.High = as(otu_table(Bac.s.rel.u.TF.High), "matrix") #pull otu
       OTU.16sTF.High<-as.data.frame(OTU.16sTF.High) #make into df
        row.names(OTU.16sTF.High)[21] <- "S3476"   #change row name by row number


    #pull TAX table
     aTax.16sTF.High = as(tax_table(Bac.s.rel.u.TF.High), "matrix") #pull tax
     
     #pull phy tree table
     tree.seq.TFHigh = phy_tree(Bac.s.rel.u.TF.High) #pull out tree

    #pull SAMPLE DATA
     aSD.16sTF.High = as(sample_data(Bac.s.rel.u.TF.High), "matrix") #pull samp.data
     aSD.16sTF.High<-as.data.frame(aSD.16sTF.High) #change to df
        row.names(aSD.16sTF.High)[21] <- "S3476"  #replace name S208b


    #remake the phyloseq obj
      samdata = sample_data(aSD.16sTF.High)
        seqtab = otu_table(OTU.16sTF.High, taxa_are_rows = FALSE)
        taxtab = tax_table(aTax.16sTF.High)
        phy_tree = read_tree(tree.seq.TFHigh)
          Bac_TF.High_mantel = phyloseq(otu_table(seqtab), tax_table(taxtab), sample_data(samdata),phy_tree(tree.seq))      
      
    
   #physio - remove samps not in the 16s df-  S1771, S2018, S3471, S3474, S3489, S3515, S3516, S477, S840, SN141, SN212  , S3484 

        physio_TF.High_mantel<-physio.TF.High #make a copy
        
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S1771"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S2018"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3471"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3474"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3489"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3484"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3515"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3516"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S477"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S840"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="SN141"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="SN212"),]


  
        # both have 30 obs...
      
  # reorder ps object so samples are in the same order
        physio_TF.High_mantel <- physio_TF.High_mantel[order(physio_TF.High_mantel$ID),]
        rownames(physio_TF.High_mantel) <- physio_TF.High_mantel[,1] #make first col row names
#build matrix  
  #16s TF        
        Bac_TF.High_mantel2<-Bac_TF.High_mantel
        Bac_TF.High_mantel2 <- phyloseq::distance(Bac_TF.High_mantel2, method = "wunifrac")
        
  #physio TF high
        physio_TF.High_mantel2<-  physio_TF.High_mantel[,3:10]
       physio_TF.High_mantel2<-scale(physio_TF.High_mantel2)
       euc.physio_TF.High_mantel2 <- dist(physio_TF.High_mantel2, method = "euclidian")

  # Run mantel test
      mantel(Bac_TF.High_mantel2, euc.physio_TF.High_mantel2,  permutations=999)
    # r=--0.1498  . p=0.971 
        
#### TF Mcap only ####        
 # Bac_TF_mantel physio_TF_mantel
    
    #subset df for mcap
    Bac_TF.High_mantel.Mcap <- subset_samples(Bac_TF.High_mantel, Species == "Montipora_capitata")
    Bac_TF.High_mantel.Mcap = prune_taxa(taxa_sums(Bac_TF.High_mantel.Mcap) > 0, Bac_TF.High_mantel.Mcap) 
    
    physio_TF.High_mantel.Mcap  <- subset(physio_TF.High_mantel, species == "Montipora_capitata")

    #16s TF mcap dist        
      unifrac.Bac_TF.High_mantel.Mcap <- phyloseq::distance(Bac_TF.High_mantel.Mcap, method = "wunifrac")
        
   #physio TF mcap dist
       physio_TF.High_mantel.Mcap2<-  physio_TF.High_mantel.Mcap[,3:10]
       physio_TF.High_mantel.Mcap2<-scale(physio_TF.High_mantel.Mcap2)
       euc.physio_TF.High_mantel.Mcap2<- dist(physio_TF.High_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Mcap, euc.physio_TF.High_mantel.Mcap2,  permutations=1000)
    
#### TF Pcomp only ####        
 # Bac_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pcomp
    Bac_TF.High_mantel.Pcomp <- subset_samples(Bac_TF.High_mantel, Species == "Porites_compressa")
    Bac_TF.High_mantel.Pcomp = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pcomp) > 0, Bac_TF.High_mantel.Pcomp) 
    
    physio_TF.High_mantel.Pcomp  <- subset(physio_TF.High_mantel, species == "Porites_compressa")

    #16s TF Pcomp dist        
      unifrac.Bac_TF.High_mantel.Pcomp <- phyloseq::distance(Bac_TF.High_mantel.Pcomp, method = "wunifrac")
        
   #physio TF Pcomp dist
      physio_TF.High_mantel.Pcomp2<-  physio_TF.High_mantel.Pcomp[,3:10]
       physio_TF.High_mantel.Pcomp2<-scale(physio_TF.High_mantel.Pcomp2)
       euc.physio_TF.High_mantel.Pcomp2<- dist(physio_TF.High_mantel.Pcomp2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pcomp, euc.physio_TF.High_mantel.Pcomp2,  permutations=1000)        
        
        
  #### TF Pvar only ####        
 # Bac_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pvar
    Bac_TF.High_mantel.Pvar <- subset_samples(Bac_TF.High_mantel, Species == "Pavona_varians")
    Bac_TF.High_mantel.Pvar = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pvar) > 0, Bac_TF.High_mantel.Pvar) 
    
    physio_TF.High_mantel.Pvar  <- subset(physio_TF.High_mantel, species == "Pavona_varians")

    #16s TF Pvar dist        
      unifrac.Bac_TF.High_mantel.Pvar <- phyloseq::distance(Bac_TF.High_mantel.Pvar, method = "wunifrac")
        
   #physio TF Pvar dist
       physio_TF.High_mantel.Pvar2<-  physio_TF.High_mantel.Pvar[,3:10]
       physio_TF.High_mantel.Pvar2<-scale(physio_TF.High_mantel.Pvar2)
       euc.physio_TF.High_mantel.Pvar2<- dist(physio_TF.High_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pvar, euc.physio_TF.High_mantel.Pvar2,  permutations=1000)            
        
        
     #### TF Pacu only ####        
 # Bac_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pacu
    Bac_TF.High_mantel.Pacu <- subset_samples(Bac_TF.High_mantel, Species == "Pocillopora_acuta")
    Bac_TF.High_mantel.Pacu = prune_taxa(taxa_sums(Bac_TF.High_mantel.Pacu) > 0, Bac_TF.High_mantel.Pacu) 
    
    physio_TF.High_mantel.Pacu  <- subset(physio_TF.High_mantel, species == "Pocillopora_acuta")

    #16s TF Pacu dist        
      unifrac.Bac_TF.High_mantel.Pacu <- phyloseq::distance(Bac_TF.High_mantel.Pacu, method = "wunifrac")
        
   #physio TF Pacu dist
      physio_TF.High_mantel.Pacu2<-  physio_TF.High_mantel.Pacu[,3:10]
       physio_TF.High_mantel.Pacu2<-scale(physio_TF.High_mantel.Pacu2)
       euc.physio_TF.High_mantel.Pacu2<- dist(physio_TF.High_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.High_mantel.Pacu, euc.physio_TF.High_mantel.Pacu2,  permutations=1000)            
        
        
    


```
TF Amb only
```{r}

# TF only  #####

#set up 16s
    Bac.s.rel.u.TF<-subset_samples(Bac.s.rel.u, Time.Point=="TF")
    Bac.s.rel.u.TF.Ambient<-subset_samples(Bac.s.rel.u.TF, Treatment=="Ambient")

    Bac.s.rel.u.TF.Ambient = prune_taxa(taxa_sums(Bac.s.rel.u.TF.Ambient) > 0, Bac.s.rel.u.TF.Ambient) #this removes any OTU with 0s
  # look at sample names
    bac.TF.Ambient.sd <- as(sample_data(Bac.s.rel.u.TF.Ambient), "data.frame") #sample df
    #save just sample names
      bac.TF.Ambient.sd.samps<-bac.TF.Ambient.sd[['sample_name.1']]
 bac.TF.Ambient.sd.samps<-as.data.frame(bac.TF.Ambient.sd.samps)
      
#set up physio TF
      
      physio.TF<-subset(physio, time.point=="TF")
            physio.TF.Ambient<-subset(physio.TF, treatment=="Ambient")
      physio.TF.Ambient<-physio.TF.Ambient[,c(1,5,15:23)]

  # look at sample names
    physio.TF.Ambient.sd <- as(sample_data(physio.TF.Ambient), "data.frame") #sample df
  #save just sample names
      physio.TF.Ambient.sd<-physio.TF.Ambient.sd[['ID']]

      # compare physio to 16s at TF
  #identify missing samples btw datasets     ***** This is not running i think it is a computer issue*** did by hand
      setdiff(bac.TF.Ambient.sd.samps,physio.TF.Ambient.sd) #samples in 16s but not phys: REMOVE: S1226, S1688. S2214, S2226, S377. S471. S955. SN110 SN158, SN169, SN217, 
      setdiff(physio.TF.Ambient.sd,bac.TF.Ambient.sd.samps) #samples in phys but not 16s:REMOVE:SN42 REAL: S3317, S779, SN102, SN208, S1279 S 1556 S785b
      
      
#16 remove: S1226, S1688, S2214, S2226, S377 S471 S955 SN110 SN158, SN169, SN217, SN42 S785b
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S1226" )
                        Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S1556" )
                        Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S785b" )

            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S1688" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S2214" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S2226" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S377" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S471" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "S955" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "SN110" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "SN158" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "SN169" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "SN217" )
            Bac.s.rel.u.TF.Ambient <- subset_samples(Bac.s.rel.u.TF.Ambient, sample_name.1 != "SN42" )


   #physio - remove samps not in the 16s df-  S1226, S1688. S2214, S2226, S377 S471 S955 SN110 SN158, SN169, SN217, SN42

        physio_TF.Ambient_mantel<-physio.TF.Ambient #make a copy
        
        physio_TF.Ambient_mantel<-physio_TF.Ambient_mantel[!(physio_TF.Ambient_mantel$ID=="S3317"),]
        physio_TF.Ambient_mantel<-physio_TF.Ambient_mantel[!(physio_TF.Ambient_mantel$ID=="S779"),]
        physio_TF.Ambient_mantel<-physio_TF.Ambient_mantel[!(physio_TF.Ambient_mantel$ID=="SN102"),]
        physio_TF.Ambient_mantel<-physio_TF.Ambient_mantel[!(physio_TF.Ambient_mantel$ID=="SN208"),]
        physio_TF.Ambient_mantel<-physio_TF.Ambient_mantel[!(physio_TF.Ambient_mantel$ID=="S1279"),]

        
        

        # both have 27 obs...
      
  # reorder ps object so samples are in the same order
        physio_TF.Ambient_mantel <- physio_TF.Ambient_mantel[order(physio_TF.Ambient_mantel$ID),]
        rownames(physio_TF.Ambient_mantel) <- physio_TF.Ambient_mantel[,1] #make first col row names
#build matrix  
  #16s TF        
        Bac_TF.Ambient_mantel2<-Bac.s.rel.u.TF.Ambient
        Bac_TF.Ambient_mantel2 <- phyloseq::distance(Bac_TF.Ambient_mantel2, method = "wunifrac")
        
  #physio TF Ambient
        physio_TF.Ambient_mantel2<-  physio_TF.Ambient_mantel[,3:10]
       physio_TF.Ambient_mantel2<-scale(physio_TF.Ambient_mantel2)
       euc.physio_TF.Ambient_mantel2<- dist(physio_TF.Ambient_mantel2, method = "euclidian")

  # Run mantel test
      mantel(Bac_TF.Ambient_mantel2, euc.physio_TF.Ambient_mantel2,  permutations=999)
    # r=-0.2536 . p=0.005
        
#### TF Mcap only ####        
 # Bac_TF_mantel physio_TF_mantel
    
    #subset df for mcap
    Bac_TF.Ambient_mantel.Mcap <- subset_samples(Bac.s.rel.u.TF.Ambient, Species == "Montipora_capitata")
    Bac_TF.Ambient_mantel.Mcap = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Mcap) > 0, Bac_TF.Ambient_mantel.Mcap) 
    
    physio_TF.Ambient_mantel.Mcap  <- subset(physio_TF.Ambient_mantel, species == "Montipora_capitata")

    #16s TF mcap dist        
      unifrac.Bac_TF.Ambient_mantel.Mcap <- phyloseq::distance(Bac_TF.Ambient_mantel.Mcap, method = "wunifrac")
        
   #physio TF mcap dist
            physio_TF.Ambient_mantel.Mcap2<-  physio_TF.Ambient_mantel.Mcap[,3:10]
       physio_TF.Ambient_mantel.Mcap2<-scale(physio_TF.Ambient_mantel.Mcap2)
       euc.physio_TF.Ambient_mantel.Mcap2<- dist(physio_TF.Ambient_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Mcap, euc.physio_TF.Ambient_mantel.Mcap2,  permutations=1000)
    
#### TF Pcomp only ####        
 # Bac_TF.Ambient_mantel physio_TF.Ambient_mantel
    
    #subset df for Pcomp
    Bac_TF.Ambient_mantel.Pcomp <- subset_samples(Bac.s.rel.u.TF.Ambient, Species == "Porites_compressa")
    Bac_TF.Ambient_mantel.Pcomp = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pcomp) > 0, Bac_TF.Ambient_mantel.Pcomp) 
    
    physio_TF.Ambient_mantel.Pcomp  <- subset(physio_TF.Ambient_mantel, species == "Porites_compressa")

    #16s TF Pcomp dist        
      unifrac.Bac_TF.Ambient_mantel.Pcomp <- phyloseq::distance(Bac_TF.Ambient_mantel.Pcomp, method = "wunifrac")
        
   #physio TF Pcomp dist
       physio_TF.Ambient_mantel.Pcomp2<-  physio_TF.Ambient_mantel.Pcomp[,3:10]
       physio_TF.Ambient_mantel.Pcomp2<-scale(physio_TF.Ambient_mantel.Pcomp2)
       euc.physio_TF.Ambient_mantel.Pcomp2<- dist(physio_TF.Ambient_mantel.Pcomp2, method = "euclidian")
       
   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pcomp, euc.physio_TF.Ambient_mantel.Pcomp2,  permutations=1000)        
        
        
  #### TF Pvar only ####        
 # Bac_TF.Ambient_mantel physio_TF.Ambient_mantel
    
    #subset df for Pvar
    Bac_TF.Ambient_mantel.Pvar <- subset_samples(Bac.s.rel.u.TF.Ambient, Species == "Pavona_varians")
    Bac_TF.Ambient_mantel.Pvar = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pvar) > 0, Bac_TF.Ambient_mantel.Pvar) 
    
    physio_TF.Ambient_mantel.Pvar  <- subset(physio_TF.Ambient_mantel, species == "Pavona_varians")

    #16s TF Pvar dist        
      unifrac.Bac_TF.Ambient_mantel.Pvar <- phyloseq::distance(Bac_TF.Ambient_mantel.Pvar, method = "wunifrac")
        
   #physio TF Pvar dist
        physio_TF.Ambient_mantel.Pvar2<-  physio_TF.Ambient_mantel.Pvar[,3:10]
       physio_TF.Ambient_mantel.Pvar2<-scale(physio_TF.Ambient_mantel.Pvar2)
       euc.physio_TF.Ambient_mantel.Pvar2<- dist(physio_TF.Ambient_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pvar, euc.physio_TF.Ambient_mantel.Pvar2,  permutations=1000)            
        
        
     #### TF Pacu only ####        
 # Bac_TF.Ambient_mantel physio_TF.Ambient_mantel
    
    #subset df for Pacu
    Bac_TF.Ambient_mantel.Pacu <- subset_samples(Bac.s.rel.u.TF.Ambient, Species == "Pocillopora_acuta")
    Bac_TF.Ambient_mantel.Pacu = prune_taxa(taxa_sums(Bac_TF.Ambient_mantel.Pacu) > 0, Bac_TF.Ambient_mantel.Pacu) 
    
    physio_TF.Ambient_mantel.Pacu  <- subset(physio_TF.Ambient_mantel, species == "Pocillopora_acuta")

    #16s TF Pacu dist        
      unifrac.Bac_TF.Ambient_mantel.Pacu <- phyloseq::distance(Bac_TF.Ambient_mantel.Pacu, method = "wunifrac")
        
   #physio TF Pacu dist
       physio_TF.Ambient_mantel.Pacu2<-  physio_TF.Ambient_mantel.Pacu[,3:10]
       physio_TF.Ambient_mantel.Pacu2<-scale(physio_TF.Ambient_mantel.Pacu2)
       euc.physio_TF.Ambient_mantel.Pacu2<- dist(physio_TF.Ambient_mantel.Pacu2, method = "euclidian")


   # Run mantel test
      mantel(unifrac.Bac_TF.Ambient_mantel.Pacu, euc.physio_TF.Ambient_mantel.Pacu2,  permutations=1000)            
        
        
    


```


##Physio and ITS2

T0
```{r}
#load its2
ITS2_T0_mantel <- readRDS("ITS2_T0_phyloseq.rds")

ITS2_T1TF_mantel <- readRDS("ITS2_T1TF_phyloseq.rds")

# T0 only  #####

#set up its
    ITS2.T0<-ITS2_T0_mantel
    ITS2.T0 = prune_taxa(taxa_sums(ITS2.T0) > 0, ITS2.T0) #this removes any OTU with 0s
  # look at sample names
    ITS2.T0.sd <- as(sample_data(ITS2.T0), "data.frame") #sample df
    #save just sample names
      ITS2.T0.sd.samps<-ITS2.T0.sd[['ID']]

      
#set up physio T0
      
      physio.T0<-subset(physio, time.point=="T0")
      physio.T0<-physio.T0[,c(1,5,16:23)]
  # look at sample names
    physio.T0.sd <- as(sample_data(physio.T0), "data.frame") #sample df
  #save just sample names
      physio.T0.sd.samps<-physio.T0.sd[['ID']]
# compare physio to 16s at T0
  
      #identify missing samples btw datasets     
      setdiff(ITS2.T0.sd.samps,physio.T0.sd.samps) #samples in ITSs but not phys: S915, SN3
      setdiff(physio.T0.sd.samps,ITS2.T0.sd.samps) #samples in phys but not 16s: NONE
        
      # in ITS2 REMOVE S915, SN3 

#remove ITS2

      ITS2.T0 <- subset_samples(ITS2.T0, ID != "S915" )
            ITS2.T0 <- subset_samples(ITS2.T0, ID != "SN3" )
      
  # reorder ps object so samples are in the same order
       physio_T0_mantel<-     physio.T0
        rownames(physio_T0_mantel) <- physio_T0_mantel[,1] #make first col row names
 
         vec <- c("S616","SN84","S1108","S1982","S391","S208","S231","SN60","SN107","SN70","SN47","SN25","SN50","S49","SN19","S74","S31","SN7","SN33","SN11","SN94","S1753","SN38","SN145","SN40","SN18","SN111","SN4","SN6","S755","SN2","SN9","S148","S914","SN56","SN87","SN82","S488","SN35","SN64","SN21","SN109","SN72","S263","SN85","SN30")               # Create  vector order
         
        
        physio_T0_mantel <- physio_T0_mantel[match(vec, physio_T0_mantel$ID), ]  

  #build matrix  
  #ITS2 T0        
        bray.ITS2.T0.mantel <- phyloseq::distance(ITS2.T0, method = "bray")
        
  #physio T0 
       physio_T0_mantel2<-  physio_T0_mantel[,3:10]
       physio_T0_mantel2<-scale(physio_T0_mantel2)
       euc.physio_T0_mantel2<- dist(physio_T0_mantel2, method = "euclidian")

  # Run mantel test
      mantel(bray.ITS2.T0.mantel, euc.physio_T0_mantel2,  permutations=999)
    # r=0.01523  p=0.281
        
#### T0 Mcap only ####        
 # ITS2_T0_mantel physio_T0_mantel
    
    #subset df for mcap
    ITS2_T0_mantel.Mcap <- subset_samples(ITS2.T0, Species == "Montipora_capitata")
    ITS2_T0_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T0_mantel.Mcap) > 0, ITS2_T0_mantel.Mcap) 
    
    physio_T0_mantel.Mcap  <- subset(physio_T0_mantel, species == "Montipora_capitata")

    #ITS2 T0 mcap dist        
      bray.ITS2_T0_mantel.Mcap <- phyloseq::distance(ITS2_T0_mantel.Mcap, method = "bray")
        
   #physio T0 mcap dist
       physio_T0_mantel.Mcap2<-  physio_T0_mantel.Mcap[,3:10]
       physio_T0_mantel.Mcap2<-scale(physio_T0_mantel.Mcap2)
       euc.physio_T0_mantel.Mcap2<- dist(physio_T0_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T0_mantel.Mcap, euc.physio_T0_mantel.Mcap2,  permutations=1000)
    
#### T0 Pcomp only ####        
 # ITS2_T0_mantel physio_T0_mantel
    
    #subset df for Pcomp
    ITS2_T0_mantel.Pcomp <- subset_samples(ITS2.T0, Species == "Porites_compressa")
    ITS2_T0_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T0_mantel.Pcomp) > 0, ITS2_T0_mantel.Pcomp) 
    
    physio_T0_mantel.Pcomp  <- subset(physio_T0_mantel, species == "Porites_compressa")

    #ITS2 T0 Pcomp dist        
      bray.ITS2_T0_mantel.Pcomp <- phyloseq::distance(ITS2_T0_mantel.Pcomp, method = "bray")
        
   #physio T0 Pcomp dist
      physio_T0_mantel.Pcomp2<-  physio_T0_mantel.Pcomp[,3:10]
       physio_T0_mantel.Pcomp2<-scale(physio_T0_mantel.Pcomp2)
       euc.physio_T0_mantel.Pcomp2<- dist(physio_T0_mantel.Pcomp2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T0_mantel.Pcomp, euc.physio_T0_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T0 Pvar only ####        
 # ITS2_T0_mantel physio_T0_mantel
    
    #subset df for Pvar
    ITS2_T0_mantel.Pvar <- subset_samples(ITS2.T0, Species == "Pavona_varians")
    ITS2_T0_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T0_mantel.Pvar) > 0, ITS2_T0_mantel.Pvar) 
    
    physio_T0_mantel.Pvar  <- subset(physio_T0_mantel, species == "Pavona_varians")

    #ITS2 T0 Pvar dist        
      bray.ITS2_T0_mantel.Pvar <- phyloseq::distance(ITS2_T0_mantel.Pvar, method = "bray")
        
   #physio T0 Pvar dist
      physio_T0_mantel.Pvar2<-  physio_T0_mantel.Pvar[,3:10]
       physio_T0_mantel.Pvar2<-scale(physio_T0_mantel.Pvar2)
       euc.physio_T0_mantel.Pvar2<- dist(physio_T0_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T0_mantel.Pvar, euc.physio_T0_mantel.Pvar2,  permutations=1000)            
        
        
     #### T0 Pacu only ####        
 # ITS2_T0_mantel physio_T0_mantel
    
    #subset df for Pacu
    ITS2_T0_mantel.Pacu <- subset_samples(ITS2.T0, Species == "Pocillopora_acuta")
    ITS2_T0_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T0_mantel.Pacu) > 0, ITS2_T0_mantel.Pacu) 
    
    physio_T0_mantel.Pacu  <- subset(physio_T0_mantel, species == "Pocillopora_acuta")

    #ITS2 T0 Pacu dist        
      bray.ITS2_T0_mantel.Pacu <- phyloseq::distance(ITS2_T0_mantel.Pacu, method = "bray")
        
   #physio T0 Pacu dist
      physio_T0_mantel.Pacu2<-  physio_T0_mantel.Pacu[,3:10]
       physio_T0_mantel.Pacu2<-scale(physio_T0_mantel.Pacu2)
       euc.physio_T0_mantel.Pacu2<- dist(physio_T0_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T0_mantel.Pacu, euc.physio_T0_mantel.Pacu2,  permutations=1000)            
        
        
    


```
T1 High 
```{r}

# T1 only  #####

#set up ITS2
    ITS2.T1<-subset_samples(ITS2_T1TF_mantel, Time.Point=="T1")
    ITS2.T1.High<-subset_samples(ITS2.T1, Treatment=="High")

    ITS2.T1.High = prune_taxa(taxa_sums(ITS2.T1.High) > 0, ITS2.T1.High) #this removes any OTU with 0s
  # look at sample names
    ITS2.T1.High.sd <- as(sample_data(ITS2.T1.High), "data.frame") #sample df
    #save just sample names
      ITS2.T1.High.sd.samps<-ITS2.T1.High.sd[['ID']]
 ITS2.T1.High.sd.samps<-as.data.frame(ITS2.T1.High.sd.samps)
      
#set up physio T1
      
      physio.T1<-subset(physio, time.point=="T1")
            physio.T1.High<-subset(physio.T1, treatment=="High")
      physio.T1.High<-physio.T1.High[,c(1,5,15:23)]

  # look at sample names
    physio.T1.High.sd <- as(sample_data(physio.T1.High), "data.frame") #sample df
  #save just sample names
      physio.T1.High.sd<-physio.T1.High.sd[['ID']]

      # compare physio to ITS2 at T1
  #identify missing samples btw datasets     ***** This is not running i think it is a computer issue*** did by hand
      setdiff(ITS2.T1.High.sd.samps,physio.T1.High.sd) #samples in ITS2 but not phys: 
              #RENAME S1388a, S1857b, SN134b
      setdiff(physio.T1.High.sd,ITS2.T1.High.sd.samps) #samples in phys but not ITS2:REMOVE S3085, S3469, S3477, 

      
#physio REMOVE S3085, S3469, S3477, 
              physio.T1.High<-physio.T1.High[!(physio.T1.High$ID=="S3085"),]
              physio.T1.High<-physio.T1.High[!(physio.T1.High$ID=="S3469"),]
              physio.T1.High<-physio.T1.High[!(physio.T1.High$ID=="S3477"),]
      

#its2        
      ITS2_T1_mantel.High<-ITS2.T1.High
      
#change names ITS2 RENAME S1388a, S1857b, SN134b

    # pull OTU table
     OTU.ITS2T1.High = as(otu_table(ITS2_T1_mantel.High), "matrix") #pull otu
       OTU.ITS2T1.High<-as.data.frame(OTU.ITS2T1.High) #make into df
        row.names(OTU.ITS2T1.High)[44] <- "S1388"   #change row name by row number
                row.names(OTU.ITS2T1.High)[7] <- "S1857"   #change row name by row number
                row.names(OTU.ITS2T1.High)[18] <- "SN134"   #change row name by row number

    #pull TAX table
     aTax.ITS2T1.High = as(tax_table(ITS2_T1_mantel.High), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.ITS2T1.High = as(sample_data(ITS2_T1_mantel.High), "matrix") #pull samp.data
     aSD.ITS2T1.High<-as.data.frame(aSD.ITS2T1.High) #change to df
        row.names(aSD.ITS2T1.High)[44] <- "S1388"  
        row.names(aSD.ITS2T1.High)[7] <- "S1857"  
        row.names(aSD.ITS2T1.High)[18] <- "SN134" 


    #remake the phyloseq obj
      samdata.High = sample_data(aSD.ITS2T1.High)
        seqtab.High = otu_table(OTU.ITS2T1.High, taxa_are_rows = FALSE)
        taxtab.High = tax_table(aTax.ITS2T1.High)
          ITS_T1.High_mantel = phyloseq(otu_table(seqtab.High), tax_table(taxtab.High), sample_data(samdata.High))
             
 


  # reorder ps object so samples are in the same order
        physio.T1.High_mantel<-physio.T1.High
                rownames(physio.T1.High_mantel) <- physio.T1.High_mantel[,1] #make first col row names

        vec <- c("S3137","S2001","S490","S2849","S2629","S2911","S1857","S634","S3488","S946","S3475","S3468","S226","S3340","S3458","SN157","S1110","SN134","S3514","SN190","S3479","S670","S3490","S3512","S3025","S2402","S3059","S3513","S1791","SN150","S1068","S1441","S3086","S314","S3482","S3246","S179","S3472","S2142","S1133","S2736","S1943","S3478","S1388")               # Create  vector order
         physio_T1.High_mantel2 <- physio.T1.High_mantel[match(vec, physio.T1.High_mantel$ID), ]  

        
        #build matrix  
  #ITS2 T1        
        ITS2.T1.High.mantel<-ITS2.T1.High
        bray.ITS2.T1.High.mantel <- phyloseq::distance(ITS2.T1.High.mantel, method = "bray")
        
  #physio T1 high
        physio_T1.High_mantel2<-  physio_T1.High_mantel2[,3:10]
       physio_T1.High_mantel2<-scale(physio_T1.High_mantel2)
       euc.physio_T1.High_mantel2<- dist(physio_T1.High_mantel2, method = "euclidian")

  # Run mantel test
      mantel(euc.physio_T1.High_mantel2,bray.ITS2.T1.High.mantel,  permutations=999)
    # r=0.2765 p=0.001
        
#### T1 Mcap only ####        
 # ITS2_T1_mantel physio_T1_mantel
    
    #subset df for mcap
    ITS2_T1_mantel.Mcap <- subset_samples(ITS2.T1.High.mantel, Species == "Montipora_capitata")
    ITS2_T1_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T1_mantel.Mcap) > 0, ITS2_T1_mantel.Mcap) 
    
    physio_T1_mantel.Mcap  <- subset(physio_T1.High_mantel, species == "Montipora_capitata")

    #ITS2 T1 mcap dist        
      bray.ITS2_T1_mantel.Mcap <- phyloseq::distance(ITS2_T1_mantel.Mcap, method = "bray")
        
   #physio T1 mcap dist
        physio_T1_mantel.Mcap2<-  physio_T1_mantel.Mcap[,3:10]
       physio_T1_mantel.Mcap2<-scale(physio_T1_mantel.Mcap2)
       euc.physio_T1_mantel.Mcap2<- dist(physio_T1_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1_mantel.Mcap, euc.physio_T1_mantel.Mcap2,  permutations=1000)
    
#### T1 Pcomp only ####        
 # ITS2_T1_mantel physio_T1_mantel
    
    #subset df for Pcomp
    ITS2_T1_mantel.Pcomp <- subset_samples(ITS2.T1.High.mantel, Species == "Porites_compressa")
    ITS2_T1_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T1_mantel.Pcomp) > 0, ITS2_T1_mantel.Pcomp) 
    
    physio_T1_mantel.Pcomp  <- subset(physio_T1.High_mantel, species == "Porites_compressa")

    #ITS2 T1 Pcomp dist        
      bray.ITS2_T1_mantel.Pcomp <- phyloseq::distance(ITS2_T1_mantel.Pcomp, method = "bray")
        
   #physio T1 Pcomp dist
       physio_T1_mantel.Pcomp2<-  physio_T1_mantel.Pcomp[,3:10]
       physio_T1_mantel.Pcomp2<-scale(physio_T1_mantel.Pcomp2)
       euc.physio_T1_mantel.Pcomp2<- dist(physio_T1_mantel.Pcomp2, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_T1_mantel.Pcomp, euc.physio_T1_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T1 Pvar only ####        
 # ITS2_T1_mantel physio_T1_mantel
    
    #subset df for Pvar
    ITS2_T1_mantel.Pvar <- subset_samples(ITS2.T1.High.mantel, Species == "Pavona_varians")
    ITS2_T1_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T1_mantel.Pvar) > 0, ITS2_T1_mantel.Pvar) 
    
    physio_T1_mantel.Pvar  <- subset(physio_T1.High_mantel, species == "Pavona_varians")

    #ITS2 T1 Pvar dist        
      bray.ITS2_T1_mantel.Pvar <- phyloseq::distance(ITS2_T1_mantel.Pvar, method = "bray")
        
   #physio T1 Pvar dist
    physio_T1_mantel.Pvar2<-  physio_T1_mantel.Pvar[,3:10]
       physio_T1_mantel.Pvar2<-scale(physio_T1_mantel.Pvar2)
       euc.physio_T1_mantel.Pvar2<- dist(physio_T1_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1_mantel.Pvar, euc.physio_T1_mantel.Pvar2,  permutations=1000)            
     
      
     #### T1 Pacu only ####        
 # ITS2_T1_mantel physio_T1_mantel
    
    #subset df for Pacu
    ITS2_T1_mantel.Pacu <- subset_samples(ITS2.T1.High.mantel, Species == "Pocillopora_acuta")
    ITS2_T1_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T1_mantel.Pacu) > 0, ITS2_T1_mantel.Pacu) 
    
    physio_T1_mantel.Pacu  <- subset(physio_T1.High_mantel, species == "Pocillopora_acuta")

    #ITS2 T1 Pacu dist        
      bray.ITS2_T1_mantel.Pacu <- phyloseq::distance(ITS2_T1_mantel.Pacu, method = "bray")
        
   #physio T1 Pacu dist
         physio_T1_mantel.Pacu2<-  physio_T1_mantel.Pacu[,3:10]
       physio_T1_mantel.Pacu2<-scale(physio_T1_mantel.Pacu2)
       euc.physio_T1_mantel.Pacu2<- dist(physio_T1_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1_mantel.Pacu, euc.physio_T1_mantel.Pacu2,  permutations=1000)            
        
        
    


```
T1 Amb only
```{r}

# T1 only  #####

#set up ITS2
    ITS2.T1.Amb<-subset_samples(ITS2.T1, Treatment=="Ambient")
    ITS2.T1.Amb = prune_taxa(taxa_sums(ITS2.T1.Amb) > 0, ITS2.T1.Amb) 
  # look at sample names
    ITS2.T1.Amb.sd <- as(sample_data(ITS2.T1.Amb), "data.frame") #sample df
    #save just sample names
      ITS2.T1.Amb.sd.samps<-ITS2.T1.Amb.sd[['ID']]
      ITS2.T1.Amb.sd.samps<-as.data.frame(ITS2.T1.Amb.sd.samps)
      
#set up physio T1
      physio.T1<-subset(physio, time.point=="T1")
      physio.T1.Amb<-subset(physio.T1, treatment=="Ambient")
      physio.T1.Amb<-physio.T1.Amb[,c(1,5,15:23)]

  # look at sample names
      physio.T1.Amb.sd <- as(sample_data(physio.T1.Amb), "data.frame") #sample df
  #save just sample names
      physio.T1.Amb.sd<-physio.T1.Amb.sd[['ID']]

# compare physio to ITS2 at T1
#physio: REMOVE: SN222, S1195
#ITS: REMOVE: SN161, SN181, SN63
      
#physio REMOVE: SN222, S1195
      physio.T1.Amb<-physio.T1.Amb[!(physio.T1.Amb$ID=="SN222"),]
            physio.T1.Amb<-physio.T1.Amb[!(physio.T1.Amb$ID=="S1195"),]

  #remove ITS2  SN161, SN181, SN63
      ITS2.T1.Amb <- subset_samples(ITS2.T1.Amb, ID != "SN161" )
            ITS2.T1.Amb <- subset_samples(ITS2.T1.Amb, ID != "SN181" )
            ITS2.T1.Amb <- subset_samples(ITS2.T1.Amb, ID != "SN63" )


        
   #physio - remove samps not in the ITS2 df-  S1195, S1418, S1573, S1895, S2424, S3035, S785, SN126, SN209

        
   
  # reorder ps object so samples are in the same order
        physio_T1.Amb_mantel<-physio.T1.Amb #make a copy

        # physio_T1.Amb_mantel<-na.omit(physio_T1.Amb_mantel)
        rownames(physio_T1.Amb_mantel) <- physio_T1.Amb_mantel[,1] #make first col row names

        
        
  
        vec <- c("S554","S761","S1573","S249","S436","S1254","S2424","S2286","SN124","S809","SN78","SN117","S650","S199","SN37","S284","SN149","S419","S848","S153","S797","SN172","S3035","SN104","S1443","S1895","S431","SN209","SN184","S1418","SN197","SN198","SN192","S1144","SN45","SN126","SN49","S785","SN92","S664","SN89","SN108","SN170")              
         
        physio_T1.High_mantel2 <- physio_T1.Amb_mantel[match(vec, physio_T1.Amb_mantel$ID), ]  

        
        
        
        
        
#build matrix  
  #ITS2 T1        
        ITS2.T1.Amb.mantel<-ITS2.T1.Amb
        uni.ITS2.T1.Amb.mantel <- phyloseq::distance(ITS2.T1.Amb.mantel, method = "bray")
        
  #physio T1 Amb
       physio_T1.Amb_mantel2<-  physio_T1.Amb_mantel[,3:10]
       physio_T1.Amb_mantel2<-scale(physio_T1.Amb_mantel2)
       euc.physio_T1.Amb_mantel2<- dist(physio_T1.Amb_mantel2, method = "euclidian")

  # Run mantel test
      mantel(uni.ITS2.T1.Amb.mantel, euc.physio_T1.Amb_mantel2,  permutations=999)
    # r=0.07357  p=0.012
      
      
#### T1 Mcap only ####     
 # ITS2.T1.Amb physio_T1.Amb_mantel
    
    #subset df for mcap
    ITS2_T1.Amb_mantel.Mcap <- subset_samples(ITS2.T1.Amb.mantel, Species == "Montipora_capitata")
    ITS2_T1.Amb_mantel.Mcap = prune_taxa(taxa_sums(ITS2_T1.Amb_mantel.Mcap) > 0, ITS2_T1.Amb_mantel.Mcap) 
    physio_T1.Amb_mantel.Mcap  <- subset(physio_T1.Amb_mantel, species == "Montipora_capitata")

    #ITS2 T1 mcap dist        
      bray.ITS2_T1.Amb_mantel.Mcap <- phyloseq::distance(ITS2_T1.Amb_mantel.Mcap, method = "bray")
        
   #physio T1 mcap dist
       physio_T1.Amb_mantel.Mcap2<-  physio_T1.Amb_mantel.Mcap[,3:10]
       physio_T1.Amb_mantel.Mcap2<-scale(physio_T1.Amb_mantel.Mcap2)
       euc.physio_T1.Amb_mantel.Mcap2<- dist(physio_T1.Amb_mantel.Mcap2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1.Amb_mantel.Mcap, euc.physio_T1.Amb_mantel.Mcap2,  permutations=1000)
      
  
#### T1 Pcomp only ####        
 # ITS2_T1_mantel physio_T1_mantel
    
    #subset df for Pcomp
    ITS2_T1.Amb_mantel.Pcomp <- subset_samples(ITS2.T1.Amb.mantel, Species == "Porites_compressa")
    ITS2_T1.Amb_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_T1.Amb_mantel.Pcomp) > 0, ITS2_T1.Amb_mantel.Pcomp) 
    
    physio_T1.Amb_mantel.Pcomp  <- subset(physio_T1.Amb_mantel, species == "Porites_compressa")

    #ITS2 T1 Pcomp dist        
      bray.ITS2_T1.Amb_mantel.Pcomp <- phyloseq::distance(ITS2_T1.Amb_mantel.Pcomp, method = "bray")
        
   #physio T1 Pcomp dist
      physio_T1.Amb_mantel.Pcomp2<-  physio_T1.Amb_mantel.Pcomp[,3:10]
       physio_T1.Amb_mantel.Pcomp2<-scale(physio_T1.Amb_mantel.Pcomp2)
       euc.physio_T1.Amb_mantel.Pcomp2<- dist(physio_T1.Amb_mantel.Pcomp2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1.Amb_mantel.Pcomp, euc.physio_T1.Amb_mantel.Pcomp2,  permutations=1000)        
        
        
  #### T1 Pvar only ####        
 # ITS2_T1.Amb_mantel physio_T1.Amb_mantel
    
    #subset df for Pvar
    ITS2_T1.Amb_mantel.Pvar <- subset_samples(ITS2.T1.Amb.mantel, Species == "Pavona_varians")
    ITS2_T1.Amb_mantel.Pvar = prune_taxa(taxa_sums(ITS2_T1.Amb_mantel.Pvar) > 0, ITS2_T1.Amb_mantel.Pvar) 
    
    physio_T1.Amb_mantel.Pvar  <- subset(physio_T1.Amb_mantel, species == "Pavona_varians")

    #ITS2 T1 Pvar dist        
      bray.ITS2_T1.Amb_mantel.Pvar <- phyloseq::distance(ITS2_T1.Amb_mantel.Pvar, method = "bray")
        
   #physio T1 Pvar dist
       physio_T1.Amb_mantel.Pvar2<-  physio_T1.Amb_mantel.Pvar[,3:10]
       physio_T1.Amb_mantel.Pvar2<-scale(physio_T1.Amb_mantel.Pvar2)
       euc.physio_T1.Amb_mantel.Pvar2<- dist(physio_T1.Amb_mantel.Pvar2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1.Amb_mantel.Pvar, euc.physio_T1.Amb_mantel.Pvar2,  permutations=1000)            
        
        
     #### T1 Pacu only ####        
 # ITS2_T1.Amb_mantel physio_T1.Amb_mantel
    
    #subset df for Pacu
    ITS2_T1.Amb_mantel.Pacu <- subset_samples(ITS2.T1.Amb.mantel, Species == "Pocillopora_acuta")
    ITS2_T1.Amb_mantel.Pacu = prune_taxa(taxa_sums(ITS2_T1.Amb_mantel.Pacu) > 0, ITS2_T1.Amb_mantel.Pacu) 
    
    physio_T1.Amb_mantel.Pacu  <- subset(physio_T1.Amb_mantel, species == "Pocillopora_acuta")

    #ITS2 T1 Pacu dist        
      bray.ITS2_T1.Amb_mantel.Pacu <- phyloseq::distance(ITS2_T1.Amb_mantel.Pacu, method = "bray")
        
   #physio T1 Pacu dist
      physio_T1.Amb_mantel.Pacu2<-  physio_T1.Amb_mantel.Pacu[,3:10]
       physio_T1.Amb_mantel.Pacu2<-scale(physio_T1.Amb_mantel.Pacu2)
       euc.physio_T1.Amb_mantel.Pacu2<- dist(physio_T1.Amb_mantel.Pacu2, method = "euclidian")

   # Run mantel test
      mantel(bray.ITS2_T1.Amb_mantel.Pacu, euc.physio_T1.Amb_mantel.Pacu2,  permutations=1000)            
        
        
    


```
TF High only
```{r}

# TF only  #####

#set up ITS2
    ITS2.TF<-subset_samples(ITS2_T1TF_mantel, Time.Point=="TF")
    ITS2.TF.High<-subset_samples(ITS2.TF, Treatment=="High")

    ITS2.TF.High = prune_taxa(taxa_sums(ITS2.TF.High) > 0, ITS2.TF.High) #this removes any OTU with 0s
  # look at sample names
    ITS2.TF.High.sd <- as(sample_data(ITS2.TF.High), "data.frame") #sample df
    #save just sample names
      ITS2.TF.High.sd.samps<-ITS2.TF.High.sd[['ID']]
 ITS2.TF.High.sd.samps<-as.data.frame(ITS2.TF.High.sd.samps)
      
#set up physio TF
      
      physio.TF<-subset(physio, time.point=="TF")
            physio.TF.High<-subset(physio.TF, treatment=="High")
      physio.TF.High<-physio.TF.High[,c(1,5,15:23)]

  # look at sample names
    physio.TF.High.sd <- as(sample_data(physio.TF.High), "data.frame") #sample df
  #save just sample names
      physio.TF.High.sd<-physio.TF.High.sd[['ID']]

      # compare physio to ITS2 at TF
  #samples in ITS2 but not phys: REMOVE S1502, S2284, S3485, S619, S972, SN138 REPLACE: 1166b
  #samples in phys but not ITS2:REMOVE: S2893, S3484, S3516, S775, SN212   
        
#ITS2 remove: S1502, S2284, S3485, S619, S972, SN138
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "S1502" )
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "S2284" )
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "S3485" )
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "S619" )
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "S972" )
            ITS2.TF.High <- subset_samples(ITS2.TF.High, ID != "SN138" ) #36 samples left

#rename ITS2:1166b
    # pull OTU table
     OTU.ITS2TF.High = as(otu_table(ITS2.TF.High), "matrix") #pull otu
       OTU.ITS2TF.High<-as.data.frame(OTU.ITS2TF.High) #make into df
        row.names(OTU.ITS2TF.High)[7] <- "S1166"   #change row name by row number


    #pull TAX table
     aTax.ITS2TF.High = as(tax_table(ITS2.TF.High), "matrix") #pull tax

    #pull SAMPLE DATA
     aSD.ITS2TF.High = as(sample_data(ITS2.TF.High), "matrix") #pull samp.data
     aSD.ITS2TF.High<-as.data.frame(aSD.ITS2TF.High) #change to df
        row.names(aSD.ITS2TF.High)[7] <- "S1166"  #replace name S1166b


    #remake the phyloseq obj
      samdata = sample_data(aSD.ITS2TF.High)
        seqtab = otu_table(OTU.ITS2TF.High, taxa_are_rows = FALSE)
        taxtab = tax_table(aTax.ITS2TF.High)
          ITS2_TF.High_mantel = phyloseq(otu_table(seqtab), tax_table(taxtab), sample_data(samdata))      
      
    
   #physio - remove samps not in the ITS2 df-  S2893, S3484 ,  S3516, S775, SN212   

        physio_TF.High_mantel<-physio.TF.High #make a copy
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S2893"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3484"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S3516"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="S775"),]
        physio_TF.High_mantel<-physio_TF.High_mantel[!(physio_TF.High_mantel$ID=="SN212"),]

        # both have 39 obs...
      
  # reorder ps object so samples are in the same order
        # physio_TF.High_mantel <- physio_TF.High_mantel[order(physio_TF.High_mantel$ID),]
        rownames(physio_TF.High_mantel) <- physio_TF.High_mantel[,1] #make first col row names
        
        
        vec <- c("S2663","S2328","S3474","S1413","S2948","S2136","S1166","S3444","SN55","S3471","S3467","S3476","S3517","S3491","S3480","S2018","S3470","S1437","S3204","S840","S2879","S3515","S477","S3489","S3486","S3487","S335","S1803","S3383","S473","S3422","S2731","SN141","S3473","S1771","S1526")               # Create  vector order
         
        
        physio_TF.High_mantel <- physio_TF.High_mantel[match(vec, physio_TF.High_mantel$ID), ]  
       
        
#build matrix  
  #ITS2 TF        
        ITS2_TF.High_mantel2<-ITS2_TF.High_mantel  
        ITS2_TF.High_mantel3 <- phyloseq::distance(ITS2_TF.High_mantel2, method = "bray")
        
  #physio TF high
         physio_TF.High_mantel2<-  physio_TF.High_mantel[,3:10]
       physio_TF.High_mantel3<-scale(physio_TF.High_mantel2)
       euc.physio_TF.High_mantel4<- dist(physio_TF.High_mantel3, method = "euclidian")
       
# Run mantel test
      mantel(ITS2_TF.High_mantel3, euc.physio_TF.High_mantel4,  permutations=999)
    # r=0.2281 . p=0.001
        
#### TF Mcap only ####        
 # ITS2_TF_mantel physio_TF_mantel
    
    #subset df for mcap
    ITS2_TF.High_mantel.Mcap <- subset_samples(ITS2_TF.High_mantel, Species == "Montipora_capitata")
    ITS2_TF.High_mantel.Mcap = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Mcap) > 0, ITS2_TF.High_mantel.Mcap) 
    
    physio_TF.High_mantel.Mcap  <- subset(physio_TF.High_mantel, species == "Montipora_capitata")

    #ITS2 TF mcap dist        
      bray.ITS2_TF.High_mantel.Mcap <- phyloseq::distance(ITS2_TF.High_mantel.Mcap, method = "bray")
        
   #physio TF mcap dist
    physio_TF.High_mantel.Mcap2<-  physio_TF.High_mantel.Mcap[,3:10]
       physio_TF.High_mantel.Mcap3<-scale(physio_TF.High_mantel.Mcap2)
       physio_TF.High_mantel.Mcap4<- dist(physio_TF.High_mantel.Mcap3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.High_mantel.Mcap, physio_TF.High_mantel.Mcap4,  permutations=1000)
    
#### TF Pcomp only ####        
 # ITS2_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pcomp
    ITS2_TF.High_mantel.Pcomp <- subset_samples(ITS2_TF.High_mantel, Species == "Porites_compressa")
    ITS2_TF.High_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pcomp) > 0, ITS2_TF.High_mantel.Pcomp) 
    
    physio_TF.High_mantel.Pcomp  <- subset(physio_TF.High_mantel, species == "Porites_compressa")

    #ITS2 TF Pcomp dist        
      bray.ITS2_TF.High_mantel.Pcomp <- phyloseq::distance(ITS2_TF.High_mantel.Pcomp, method = "bray")
        
   #physio TF Pcomp dist
 physio_TF.High_mantel.Pcomp2<-  physio_TF.High_mantel.Pcomp[,3:10]
       physio_TF.High_mantel.Pcomp3<-scale(physio_TF.High_mantel.Pcomp2)
       physio_TF.High_mantel.Pcomp4<- dist(physio_TF.High_mantel.Pcomp3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.High_mantel.Pcomp, physio_TF.High_mantel.Pcomp4,  permutations=1000)        
        
        
  #### TF Pvar only ####        
 # ITS2_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pvar
    ITS2_TF.High_mantel.Pvar <- subset_samples(ITS2_TF.High_mantel, Species == "Pavona_varians")
    ITS2_TF.High_mantel.Pvar = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pvar) > 0, ITS2_TF.High_mantel.Pvar) 
    
    physio_TF.High_mantel.Pvar  <- subset(physio_TF.High_mantel, species == "Pavona_varians")

    #ITS2 TF Pvar dist        
      bray.ITS2_TF.High_mantel.Pvar <- phyloseq::distance(ITS2_TF.High_mantel.Pvar, method = "bray")
        
   #physio TF Pvar dist
 physio_TF.High_mantel.Pvar2<-  physio_TF.High_mantel.Pvar[,3:10]
       physio_TF.High_mantel.Pvar3<-scale(physio_TF.High_mantel.Pvar2)
       physio_TF.High_mantel.Pvar4<- dist(physio_TF.High_mantel.Pvar3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.High_mantel.Pvar, physio_TF.High_mantel.Pvar4,  permutations=1000)            
        
        
     #### TF Pacu only ####        
 # ITS2_TF.High_mantel physio_TF.High_mantel
    
    #subset df for Pacu
    ITS2_TF.High_mantel.Pacu <- subset_samples(ITS2_TF.High_mantel, Species == "Pocillopora_acuta")
    ITS2_TF.High_mantel.Pacu = prune_taxa(taxa_sums(ITS2_TF.High_mantel.Pacu) > 0, ITS2_TF.High_mantel.Pacu) 
    
    physio_TF.High_mantel.Pacu  <- subset(physio_TF.High_mantel, species == "Pocillopora_acuta")

    #ITS2 TF Pacu dist        
      bray.ITS2_TF.High_mantel.Pacu <- phyloseq::distance(ITS2_TF.High_mantel.Pacu, method = "bray")
        
   #physio TF Pacu dist
 physio_TF.High_mantel.Pacu2<-  physio_TF.High_mantel.Pacu[,3:10]
       physio_TF.High_mantel.Pacu3<-scale(physio_TF.High_mantel.Pacu2)
       physio_TF.High_mantel.Pacu4<- dist(physio_TF.High_mantel.Pacu3, method = "euclidian")
       
   # Run mantel test
      mantel(bray.ITS2_TF.High_mantel.Pacu, physio_TF.High_mantel.Pacu4,  permutations=1000)            
        
        
    


```
TF Amb only
```{r}

# TF only  #####

#set up ITS2
    ITS2.TF<-subset_samples(ITS2_T1TF_mantel, Time.Point=="TF")
    ITS2.TF.Amb<-subset_samples(ITS2.TF, Treatment=="Ambient")

    ITS2.TF.Amb = prune_taxa(taxa_sums(ITS2.TF.Amb) > 0, ITS2.TF.Amb) #this removes any OTU with 0s
  # look at sample names
    ITS2.TF.Amb.sd <- as(sample_data(ITS2.TF.Amb), "data.frame") #sample df
    #save just sample names
      ITS2.TF.Amb.sd.samps<-ITS2.TF.Amb.sd[['ID']]
 ITS2.TF.Amb.sd.samps<-as.data.frame(ITS2.TF.Amb.sd.samps)
      
#set up physio TF
      
      physio.TF<-subset(physio, time.point=="TF")
            physio.TF.Amb<-subset(physio.TF, treatment=="Ambient")
      physio.TF.Amb<-physio.TF.Amb[,c(1,5,15:23)]

  # look at sample names
    physio.TF.Amb.sd <- as(sample_data(physio.TF.Amb), "data.frame") #sample df
  #save just sample names
      physio.TF.Amb.sd<-physio.TF.Amb.sd[['ID']]

      # compare physio to ITS2 at TF
  #samples in ITS2 but not phys: REMOVE: S1226, S1688. S2214, S2226, S377, S471, S955, SN110 SN158, SN169, SN217b,SN183, SN223, SN42, S1556, S1688, S1736, S2214, S2226, S3081
  #samples in phys but not ITS2:REMOVE: S1104, S3081,       REPLACE: S785b  
        
#ITS2 remove:  S1226, S1688. S2214, S2226, S377. S471, S955, SN110 SN158, SN169, SN217b,SN183, SN223, SN42,   S1556, S1688, S1736, S2214, S2226, S3081
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S1226" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S1688" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S2214" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S2226" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S377" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S471" ) 
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S955" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN110" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN158" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN169" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN217b" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN183" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN223" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "SN42" )
                        ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S1556" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S1688" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S1736" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S2214" )
                        ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S2226" )
            ITS2.TF.Amb <- subset_samples(ITS2.TF.Amb, ID != "S3081" )
            #28 samples left

          ITS2_TF.Amb_mantel <- ITS2.TF.Amb     
      
    
   #physio - remove samps not in the ITS2 df-  REMOVE: S1104, S3081,       
        physio_TF.Amb_mantel<-physio.TF.Amb #make a copy
        physio_TF.Amb_mantel<-physio_TF.Amb_mantel[!(physio_TF.Amb_mantel$ID=="S1104"),]
           physio_TF.Amb_mantel<-physio_TF.Amb_mantel[!(physio_TF.Amb_mantel$ID=="S3081"),]

          physio_TF.Amb_mantel
          
      
      
  # reorder ps object so samples are in the same order
        # physio_TF.Amb_mantel <- physio_TF.Amb_mantel[order(physio_TF.Amb_mantel$ID),]
        rownames(physio_TF.Amb_mantel) <- physio_TF.Amb_mantel[,1] #make first col row names
        
        
        vec <- c("S420","S832","S422","S3442","S3337","SN189","SN211","SN131","S579","SN122","SN98","SN115","SN205","SN77","SN105","SN208","SN152","S3164","SN132","S779","S1061","S1037","SN191","S3317","S1279","SN96","SN102","S403")               # Create  vector order
         
        
        physio_TF.Amb_mantel <- physio_TF.Amb_mantel[match(vec, physio_TF.Amb_mantel$ID), ]  
       
        
#build matrix  
  #ITS2 TF        
        ITS2_TF.Amb_mantel2<-ITS2_TF.Amb_mantel  
        ITS2_TF.Amb_mantel3 <- phyloseq::distance(ITS2_TF.Amb_mantel2, method = "bray")
        
  #physio TF Amb
         physio_TF.Amb_mantel2<-  physio_TF.Amb_mantel[,3:10]
       physio_TF.Amb_mantel3<-scale(physio_TF.Amb_mantel2)
       euc.physio_TF.Amb_mantel4<- dist(physio_TF.Amb_mantel3, method = "euclidian")
       
# Run mantel test
      mantel(ITS2_TF.Amb_mantel3, euc.physio_TF.Amb_mantel4,  permutations=999)
    # r=0.2525 . p=0.001
        
#### TF Mcap only ####        
 # ITS2_TF_mantel physio_TF_mantel
    
    #subset df for mcap
    ITS2_TF.Amb_mantel.Mcap <- subset_samples(ITS2_TF.Amb_mantel, Species == "Montipora_capitata")
    ITS2_TF.Amb_mantel.Mcap = prune_taxa(taxa_sums(ITS2_TF.Amb_mantel.Mcap) > 0, ITS2_TF.Amb_mantel.Mcap) 
    
    physio_TF.Amb_mantel.Mcap  <- subset(physio_TF.Amb_mantel, species == "Montipora_capitata")

    #ITS2 TF mcap dist        
      bray.ITS2_TF.Amb_mantel.Mcap <- phyloseq::distance(ITS2_TF.Amb_mantel.Mcap, method = "bray")
        
   #physio TF mcap dist
       physio_TF.Amb_mantel.Mcap2<-  physio_TF.Amb_mantel.Mcap[,3:10]
       physio_TF.Amb_mantel.Mcap3<-scale(physio_TF.Amb_mantel.Mcap2)
       physio_TF.Amb_mantel.Mcap4<- dist(physio_TF.Amb_mantel.Mcap3, method = "euclidian")
       

   # Run mantel test
      mantel(bray.ITS2_TF.Amb_mantel.Mcap, physio_TF.Amb_mantel.Mcap4,  permutations=1000)
    
#### TF Pcomp only ####        
 # ITS2_TF.Amb_mantel physio_TF.Amb_mantel
    
    #subset df for Pcomp
    ITS2_TF.Amb_mantel.Pcomp <- subset_samples(ITS2_TF.Amb_mantel, Species == "Porites_compressa")
    ITS2_TF.Amb_mantel.Pcomp = prune_taxa(taxa_sums(ITS2_TF.Amb_mantel.Pcomp) > 0, ITS2_TF.Amb_mantel.Pcomp) 
    
    physio_TF.Amb_mantel.Pcomp  <- subset(physio_TF.Amb_mantel, species == "Porites_compressa")

    #ITS2 TF Pcomp dist        
      bray.ITS2_TF.Amb_mantel.Pcomp <- phyloseq::distance(ITS2_TF.Amb_mantel.Pcomp, method = "bray")
        
   #physio TF Pcomp dist
       physio_TF.Amb_mantel.Pcom2<-  physio_TF.Amb_mantel.Pcomp[,3:10]
       physio_TF.Amb_mantel.Pcom3<-scale(physio_TF.Amb_mantel.Pcom2)
       physio_TF.Amb_mantel.Pcom4<- dist(physio_TF.Amb_mantel.Pcom3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.Amb_mantel.Pcomp, physio_TF.Amb_mantel.Pcom4,  permutations=1000)        
        
        
  #### TF Pvar only ####        
 # ITS2_TF.Amb_mantel physio_TF.Amb_mantel
    
    #subset df for Pvar
    ITS2_TF.Amb_mantel.Pvar <- subset_samples(ITS2_TF.Amb_mantel, Species == "Pavona_varians")
    ITS2_TF.Amb_mantel.Pvar = prune_taxa(taxa_sums(ITS2_TF.Amb_mantel.Pvar) > 0, ITS2_TF.Amb_mantel.Pvar) 
    
    physio_TF.Amb_mantel.Pvar  <- subset(physio_TF.Amb_mantel, species == "Pavona_varians")

    #ITS2 TF Pvar dist        
      bray.ITS2_TF.Amb_mantel.Pvar <- phyloseq::distance(ITS2_TF.Amb_mantel.Pvar, method = "bray")
        
   #physio TF Pvar dist
     physio_TF.Amb_mantel.Pvar2<-  physio_TF.Amb_mantel.Pvar[,3:10]
       physio_TF.Amb_mantel.Pvar3<-scale(physio_TF.Amb_mantel.Pvar2)
       physio_TF.Amb_mantel.Pvar4<- dist(physio_TF.Amb_mantel.Pvar3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.Amb_mantel.Pvar, physio_TF.Amb_mantel.Pvar4,  permutations=1000)            
        
        
     #### TF Pacu only ####        
 # ITS2_TF.Amb_mantel physio_TF.Amb_mantel
    
    #subset df for Pacu
    ITS2_TF.Amb_mantel.Pacu <- subset_samples(ITS2_TF.Amb_mantel, Species == "Pocillopora_acuta")
    ITS2_TF.Amb_mantel.Pacu = prune_taxa(taxa_sums(ITS2_TF.Amb_mantel.Pacu) > 0, ITS2_TF.Amb_mantel.Pacu) 
    
    physio_TF.Amb_mantel.Pacu  <- subset(physio_TF.Amb_mantel, species == "Pocillopora_acuta")

    #ITS2 TF Pacu dist        
      bray.ITS2_TF.Amb_mantel.Pacu <- phyloseq::distance(ITS2_TF.Amb_mantel.Pacu, method = "bray")
        
   #physio TF Pacu dist
        physio_TF.Amb_mantel.Pacu2<-  physio_TF.Amb_mantel.Pacu[,3:10]
       physio_TF.Amb_mantel.Pacu3<-scale(physio_TF.Amb_mantel.Pacu2)
       physio_TF.Amb_mantel.Pacu4<- dist(physio_TF.Amb_mantel.Pacu3, method = "euclidian")
   # Run mantel test
      mantel(bray.ITS2_TF.Amb_mantel.Pacu, physio_TF.Amb_mantel.Pacu4,  permutations=1000)            
        
        
    


```

