---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Data analysis for the All Coral Experiment #2021. Physiological variables:  
AFDW
Flow Cytometry (cell counts)
Protien
Biomass
BW
PAM


#Data and libraries
```{r}
library(plyr)
library(dplyr)
library(ggplot2)
library('ggpubr')
library(lmerTest)
library(car)
library(emmeans)
library(gridExtra)
library(multcomp)
library(reshape)
library(tidyverse)
library(factoextra)
library(reshape2)


```

Load meta
```{r}  
meta  <- read.csv("Data/Master_Metadata_20190402.csv")
#remove frags that re duplicated or T3
meta<-meta[!(meta$X=="REMOVE"),]

# load in datasheets 
#Ashfreedryweight, Wax dipping, Total airbrush volume, metadata

AFDW <- read.csv("Data/ACE21_AFDW_20210308.csv")
AFDW <- AFDW[!(AFDW$Frag.ID == "1195"),]
AFDW <- AFDW[!(AFDW$Frag.ID == "N49"),]
AFDW <- AFDW[!(AFDW$Frag.ID == "3149"),]
AFDW <- AFDW[!(AFDW$Frag.ID == "634"),]


WaxDipping <- read.csv("Data/WaxDipping_Results_20190403.csv")
WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "1195"),]
WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "N49"),]
WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "3149"),]
WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "634"),]

Slurry <- read.csv("Data/TT17_airbrush_totalVol_20190420.csv")
Slurry <- Slurry[!(Slurry$Frag.ID == "1195"),]
Slurry <- Slurry[!(Slurry$Frag.ID == "N49"),]
Slurry <- Slurry[!(Slurry$Frag.ID == "3149"),]
Slurry <- Slurry[!(WaxDipping$Frag.ID == "634"),]


#merge 
#testAFDW<-merge(AFDW, meta, all=T)
#testSlurry<-merge(Slurry, meta, all.y=T)
#testflow<-merge(tData, meta, all.y=T)
#testWax<-merge(SA, meta, all.y=T)




```


#Biomass (AFDW and SA)
```{r}   

SA<-WaxDipping
SA<- SA[,c("Frag.ID","Surface.area")] # keep only columns you need

# merge AFDW and slurry
AFDW.slurry <- merge(AFDW, Slurry)
AFDW.slurry$AFDW.mg.ml <- AFDW.slurry$AFDW.g.mL*1000  # grams to mg
AFDW.slurry$AFDWmg <-AFDW.slurry$AFDW.mg.ml*AFDW.slurry$TotalVolume # now we have mg of AFDW


DUP2<-duplicated(AFDW.slurry$Frag.ID) #look for duplicate entries

# SA cm2 and AFDW g/mL --> mg/cm2

# merge
biomass <- merge(AFDW.slurry, SA)
biomass$Surface.area<-as.numeric(as.character(biomass$Surface.area))
biomass<- biomass[,c("Frag.ID", "AFDWmg", "Surface.area")] # keep only columns you need
biomass$AFDWmg.cm2 <-biomass$AFDWmg/biomass$Surface.area # mg/cm2

# merge with metadata to plot by treatments
biomass2 <- merge(biomass, meta)


# Mcap_biomass
biomass2_mean <- ddply(biomass2, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                 N    = length(AFDWmg.cm2[!is.na(AFDWmg.cm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                 mean = mean(AFDWmg.cm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(AFDWmg.cm2, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(AFDWmg.cm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
biomass2_mean #display table
#Mcap_biomass_mean <-Mcap_biomass_mean[-3,] # Remove T0
#biomass2_mean

# Make "BOTH" into Ambeint and High...THIS IS UGLY CODE BUT IT WORKS
# Mcap 
#Mcap_biomass_mean<-subset(biomass2_mean, Species=="Montipora_capitata") #Subset Mcap

#Mcap_biomass_mean_Both<-Mcap_biomass_mean #copy df
#row.names.remove <- c("1","2","13","14") #remove high and amb by row numbers
#Mcap_biomass_mean_Both<-Mcap_biomass_mean_Both[!(row.names(Mcap_biomass_mean_Both) %in% row.names.remove), ] #remove

#Mcap_biomass_mean_Both2<-Mcap_biomass_mean_Both # make a copy of the BOTH df
#Mcap_biomass_mean_Both[Mcap_biomass_mean_Both=="Both"]<-"Ambient"  #rename "Both" to "Ambient"
#Mcap_biomass_mean_Both2[Mcap_biomass_mean_Both2=="Both"]<-"High"  #rename "Both" to "High"

#row.names.remove <- c("9") #remove "high and amb by row numbers "both""
#Mcap_biomass_mean<-Mcap_biomass_mean[!(row.names(Mcap_biomass_mean) %in% row.names.remove), ]
#Mcap_biomass_mean<-rbind(Mcap_biomass_mean,Mcap_biomass_mean_Both,Mcap_biomass_mean_Both2) #bind together

#Mcap 
Mcap_biomass_mean<-subset(biomass2_mean, Species=="Montipora_capitata") #Subset Mcap
# Pcomp 
Pcomp_biomass_mean<-subset(biomass2_mean, Species=="Porites_compressa") #Subset Pcomp
# Pacu 
Pacu_biomass_mean<-subset(biomass2_mean, Species=="Pocillopora_acuta") #Subset Pacu
# Pvar 
Pvar_biomass_mean<-subset(biomass2_mean, Species=="Pavona_varians") #Subset Pvar



#Stats - T0 is n=6, not n=12

Biomass_stats<-biomass2

hist(Biomass_stats$AFDWmg.cm2) 
Biomass_stats$AFDWmg.cm2_log<-log10(Biomass_stats$AFDWmg.cm2+1)
hist(Biomass_stats$AFDWmg.cm2_log) #normal (use)

Biomass_model<-lmer(AFDWmg.cm2_log~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), Biomass_stats)
anova(Biomass_model) 
qqPlot(residuals(Biomass_model)) 

  emm<-emmeans(Biomass_model,  ~ Time.Point|Treatment*Species, adjust="Tukey")
cld(emm)
pairs(emm)

```
PLOTS
```{r}
#plot Mcap
Mcap_biomass_plot<-ggplot(data=Mcap_biomass_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylim(0, 10) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Tissue biomass mg cm"^"-2"))) +
  ggtitle("Montipora capitata")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_biomass_plot

# Pcomp 

Pcomp_biomass_plot<-ggplot(data=Pcomp_biomass_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylab("") + #Label the X Axis
  ylim(0, 10) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  #ylab(expression(paste("Tissue biomass mg cm"^"-2"))) +
  ggtitle("Porites compressa")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_biomass_plot

# Pvar 

Pvar_biomass_mean_plot<-ggplot(data=Pvar_biomass_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylim(2.5, 6) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Tissue biomass mg cm"^"-2"))) +
  ggtitle("Pavona varians")+
  theme(plot.title = element_text(size=20, face = "italic"));Pvar_biomass_mean_plot

# Pacu 

Pacu_biomass_mean_plot<-ggplot(data=Pacu_biomass_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = F)+
  geom_point(aes(color=Treatment), size=4, show.legend = F)+
  geom_line(aes(color=Treatment), linetype=2, show.legend = F)+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
  xlab("") + #Label the X Axis
  ylab("") + #Label the Y Axis
  ylim(0, 10) + #set Y limits
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        plot.background =element_blank(), #Set the plot background
        text = element_text(size=18),  # set element text
        legend.key = element_blank()) + #Set plot legend key
  #ylab(expression(paste("Tissue biomass mg cm"^"-2"))) +
  ggtitle("Pocillopora acuta")+
  theme(plot.title = element_text(size=20,face = "italic"));Pacu_biomass_mean_plot


###### All plots together
Mcap_biomass_plot_plot<-Mcap_biomass_plot+ theme(legend.position = "none") #remove legend
Pcomp_biomass_plot<-Pcomp_biomass_plot+ theme(legend.position = "none") #remove legend
Pvar_biomass_mean_plot<-Pvar_biomass_mean_plot+ theme(legend.position = "none") #remove legend
Pacu_biomass_mean_plot<-Pacu_biomass_mean_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_FC_Plot, Pcomp_FC_Plot, Pvar_FC_Plot,Pacu_FC_Plot, nrow = 2)

```

# Flow cytometry  cell counts
```{r}  
#import data
Std.curve <- read.csv("Data/standard_curve_fcm20181312.csv")

###notes: 2289 isn't anywhere. 

PlateA <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateA.csv")
PlateA <- subset(PlateA, Gate.Name == "Symbiodinium")       # keep only Symbiodinium rows
keepA <- c("Sample.Name", "Concentration") # keep only Sample.name and concentration
PlateA <- PlateA[keepA]
A_meta <- read.csv("Data/TT17_FC_PlateA.csv") # load Plate A location data
PlateA <- merge(PlateA, A_meta)   # merge with location data
PlateA <-merge(PlateA, meta, all.x = TRUE) # merge with Sample metadata
PlateA <- na.omit(PlateA) # omit NAs
PlateA<- PlateA[!(PlateC$Frag.ID == "1133"),] # redid in plate E
PlateA<- PlateA[!(PlateC$Frag.ID == "172"),] # redid in plate E


PlateB <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateB1.csv")
PlateB$Concentration<-as.numeric(as.character(PlateB$Concentration)) # this is loading in as a factor, not sure why
PlateB <- subset(PlateB, Gate.Name == "Symbiodinium")
keepB <- c("Sample.Name", "Concentration")
PlateB <- PlateB[keepB]
B_meta <- read.csv("Data/TT17_FC_PlateB.csv") # lood Plate B location data
PlateB <- merge(PlateB, B_meta)
PlateB <-merge(PlateB, meta, all.x = TRUE)
PlateB <- na.omit(PlateB)
PlateB<- PlateB[!(PlateC$Frag.ID == "428"),] # redid in plate E

PlateC <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateCredo.csv")
PlateC$Concentration<-as.numeric(as.character(PlateC$Concentration)) # this is loading in as a factor, not sure why
PlateC <- subset(PlateC, Gate.Name == "Symbiodinium")
keepC <- c("Sample.Name", "Concentration")
PlateC <- PlateC[keepC]
C_meta <- read.csv("Data/TT17_FC_PlateCredo.csv") # lood Plate C location data
PlateC <- merge(PlateC, C_meta)
PlateC <-merge(PlateC, meta, all.x = TRUE)
PlateC <- na.omit(PlateC)
PlateC<- PlateC[!(PlateC$Frag.ID == "3481"),] # redid in plate E

#note: Frag.ID 403 Pacu seems abnormally high

PlateE <- read.csv("Data/Symbio.Count.apr.02.2019.PlateE.csv")
PlateE$Concentration<-as.numeric(as.character(PlateE$Concentration)) # this is loading in as a factor, not sure why
PlateE <- subset(PlateE, Gate.Name == "Symbiodinium")
keepE <- c("Sample.Name", "Concentration")
PlateE <- PlateE[keepE]
E_meta <- read.csv("Data/TT17_FC_PlateE.csv") # lood Plate A location data
PlateE <- merge(PlateE, E_meta)
PlateE <-merge(PlateE, meta, all.x = TRUE)
PlateE <- na.omit(PlateE)


# Bind all runs together
tData <- rbind(PlateA, PlateB, PlateC, PlateE)
tData$Parent.ID<- as.factor(tData$Parent.ID) #for some reason, "Concentration" was a chr not numeric. Check by calling str()

# Create column to relate to standard curve
tData$corrected <- tData$Concentration*3.2959 # <- also confirm you did this correctly. 

# Use Slurry
#merge with tdata
tData <- merge(tData, Slurry)
tData$TotalVolume <- tData$TotalVolume * 1000 # change total volume to from mL to uL


#use SA for slurry

#merge with tData, make numeric
tData <- merge(tData, SA)
tData$Surface.area<- as.numeric(as.character(tData$Surface.area))


write.csv(tData, "tdataCHECK.csv")
#Subset by Species and correct for 10% dilutions in Mcap and Pcomp
Mcap_FC <- subset(tData, Species == "Montipora_capitata")
Mcap_FC$corrected <- Mcap_FC$corrected*10 # to compensate for the 10% dultion

Pcomp_FC <- subset(tData, Species == "Porites_compressa")
Pcomp_FC$corrected <- Pcomp_FC$corrected*10 # to compensate for the 10% dultion

Pvar_FC <- subset(tData, Species == "Pavona_varians") #not diluted
Pacu_FC <- subset(tData, Species == "Pocillopora_acuta") #not diluted

# Create new column for total cells in total slurry
Mcap_FC$Tot.zoox <- Mcap_FC$corrected*(Mcap_FC$TotalVolume)
Pcomp_FC$Tot.zoox <- Pcomp_FC$corrected*(Pcomp_FC$TotalVolume)
Pvar_FC$Tot.zoox <- Pvar_FC$corrected*(Pvar_FC$TotalVolume)
Pacu_FC$Tot.zoox <- Pacu_FC$corrected*(Pacu_FC$TotalVolume)

# Calculate zoox/cm2
Mcap_FC$zoox.cm2<-Mcap_FC$Tot.zoox/Mcap_FC$Surface.area
Pcomp_FC$zoox.cm2<-Pcomp_FC$Tot.zoox/Pcomp_FC$Surface.area
Pvar_FC$zoox.cm2<-Pvar_FC$Tot.zoox/Pvar_FC$Surface.area
Pacu_FC$zoox.cm2<-Pacu_FC$Tot.zoox/Pacu_FC$Surface.area

FC_Data <- rbind(Mcap_FC, Pcomp_FC, Pvar_FC, Pacu_FC) #combine

#Stats


hist(FC_Data$zoox.cm2) 
FC_Data$zoox.cm2_log<-log10(FC_Data$zoox.cm2+1)
hist(FC_Data$zoox.cm2_log) #normal (use)

CellCount_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), FC_Data)
anova(CellCount_model) 
qqPlot(residuals(CellCount_model)) 

  emm<-emmeans(CellCount_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)













#mean tables
# Mcap
Mcap_FC_Sum <- ddply(Mcap_FC, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                   N    = length(zoox.cm2[!is.na(zoox.cm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(zoox.cm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(zoox.cm2, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(zoox.cm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Mcap_FC_Sum #display table

# Pcomp
Pcomp_FC_Sum <- ddply(Pcomp_FC, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                   N    = length(zoox.cm2[!is.na(zoox.cm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(zoox.cm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(zoox.cm2, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(zoox.cm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Pcomp_FC_Sum #display table


# Pvar
Pvar_FC_Sum <- ddply(Pvar_FC, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                   N    = length(zoox.cm2[!is.na(zoox.cm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(zoox.cm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(zoox.cm2, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(zoox.cm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Pvar_FC_Sum #display table

# Pacu
Pacu_FC_Sum <- ddply(Pacu_FC, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                   N    = length(zoox.cm2[!is.na(zoox.cm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(zoox.cm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(zoox.cm2, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(zoox.cm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Pacu_FC_Sum #display table

```

Line plots
```{r} 
# Mcap  

Mcap_FC_lineplot<-ggplot(data=Mcap_FC_Sum, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c('blue','red'))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
       scale_y_log10()+
      ylim(0, 4000000)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("cells"))) +
  ggtitle("Mcap Flow Cytometry")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_FC_lineplot

# Pcomp 

Pcomp_FC_lineplot<-ggplot(data=Pcomp_FC_Sum, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c('blue','red'))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
       scale_y_log10()+
    ylim(0, 4000000)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("cells"))) +
  ggtitle("Pcomp Flow Cytometry")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_FC_lineplot


# Pvar 

Pvar_FC_lineplot<-ggplot(data=Pvar_FC_Sum, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c('blue','red'))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
       scale_y_log10()+
    ylim(0, 4000000)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("cells"))) +
  ggtitle("Pvar Flow Cytometry")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_FC_lineplot

# Pacu 

Pacu_FC_lineplot<-ggplot(data=Pacu_FC_Sum, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c('blue','red'))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
       scale_y_log10()+
  #ylim(0, 4000000)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("cells"))) +
  ggtitle("Pacu Flow Cytometry")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_FC_lineplot

###### All plots together
Mcap_FC_lineplot<-Mcap_FC_lineplot+ theme(legend.position = "none") #remove legend
Pcomp_FC_lineplot<-Pcomp_FC_lineplot+ theme(legend.position = "none") #remove legend
Pvar_FC_lineplot<-Pvar_FC_lineplot+ theme(legend.position = "none") #remove legend
Pacu_FC_lineplot<-Pacu_FC_lineplot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_FC_lineplot, Pcomp_FC_lineplot, Pvar_FC_lineplot,Pacu_FC_lineplot, nrow = 2)

```
#Buoyant Weight/Calcification

calibration (not sure what this does)
```{r}  
BWCalData <- read.csv('Data/Bouyant_weight_calibration_curve.csv')
#Data with Standard weights in grams in deionized water, saltwater, and the temp that they were measured at

### Standard Cruve
#plot relationship between temp and Standard in fresh and salt water
plot(BWCalData$Temp, BWCalData$StandardSalt, col = 'red', ylab = 'Salt Weight (g)', xlab = 'Temp C')
par(new=TRUE)
plot(BWCalData$Temp, BWCalData$StandardFresh, col = 'blue',xaxt="n",yaxt="n",xlab="",ylab="")
axis(4)
mtext("'Fresh Weight (g)'",side=4,line=3)
legend("topleft",col=c("red","blue"),lty=1,legend=c("Salt","Fresh"), bty = "n")

#linear regression between temp and Standard
#Salt
StandardSaltModel <- lm(BWCalData$StandardSalt~BWCalData$Temp)
summary(StandardSaltModel)
summary(StandardSaltModel)$r.squared
StandardSaltModel$coef

#Fresh
StandardFreshModel <- lm(BWCalData$StandardFresh~BWCalData$Temp)
summary(StandardFreshModel)
summary(StandardFreshModel)$r.squared
StandardFreshModel$coef

```
Analysis 
```{r} 

#load coral weight data
BW.data <-read.csv('Data/BW_TT17.csv') # this is a file I compiled with all dates

# merge to sample data for sorting
AllBWdata<-merge(BW.data, meta, by = "Frag.ID")

## Split data by species, change to numeric
Mcap_BW<- subset(AllBWdata, Species =="Montipora_capitata")
Mcap_BW$Temp.C <- as.numeric(as.character(Mcap_BW$Temp.C))
BW_Mcap <- Mcap_BW$Mass.g
Temp_Mcap <- Mcap_BW$Temp.C 

Pcomp_BW<- subset(AllBWdata, Species =="Porites_compressa")
Pcomp_BW$Temp.C <- as.numeric(as.character(Pcomp_BW$Temp.C))
BW_Pcomp <- Pcomp_BW$Mass.g
Temp_Pcomp <- Pcomp_BW$Temp.C 

Pvar_BW<- subset(AllBWdata, Species =="Pavona_varians")
Pvar_BW$Temp.C <- as.numeric(as.character(Pvar_BW$Temp.C))
BW_Pvar <- Pvar_BW$Mass.g
Temp_Pvar <- Pvar_BW$Temp.C 

Pacu_BW<- subset(AllBWdata, Species =="Pocillopora_acuta")
BW_Pacu <- Pacu_BW$Mass.g
Temp_Pacu <- Pacu_BW$Temp.C  
```
Montipora capitata
```{r}
BWCalc_Mcap <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 2.03){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  #Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  # Porites asteroides T Hughes 1987 1.69 at 5m (KB got 1.82)
  # below: Medellin-Maldonado et al 2016
  # Pavona varians 1.04 +-0.07
  # panama 8.5380° N, 80.7821° W, 
  # coasta rica 9.7489° N, 83.7534° W
  # mexico la entrega 15.7424° N, 96.1282° W
  # hawaii 19.8968° N, 155.5828° W
  # Pocillopora 1.78 +- 0.31
  
  
  # You can change the density to literatrue values for the specific coral species of interest in the function. 
  
 #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the glass Standard to calculate
  # the density of the Standard (Davies eq. 4)
FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
CoralWeight <- BW_Mcap/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}
  
Mcap_BW$Dry.Weigh.g <- BWCalc_Mcap(BW=BW_Mcap, Temp=Temp_Mcap) #use function to calculate dry weight
hist(Mcap_BW$Dry.Weigh.g) #not normal
Mcap_BW$Dry.Weigh.g_log<-log10(Mcap_BW$Dry.Weigh.g+1)
hist(Mcap_BW$Dry.Weigh.g_log) #better still tail
boxplot(Mcap_BW$Dry.Weigh.g) #examine data
Mcap_BW <- Mcap_BW[!(Mcap_BW$Frag.ID == "797"),] # remove sample 797, error in BW record (impossible value)

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_McapBW <- reshape(Mcap_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "X",  "Parent.ID", "Species","Time.Point", "Tank.num"), idvar=c("Frag.ID", "Treatment"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0 and then divides by number of days , times 100
data_McapBW$time1.growth <- (((data_McapBW$Dry.Weigh.g.Time1 - data_McapBW$Dry.Weigh.g.Time0)/data_McapBW$Dry.Weigh.g.Time0)*100)/data_McapBW$Days.Time1 #calculate growth rate for time1
data_McapBW$time2.growth <- (((data_McapBW$Dry.Weigh.g.Time2 - data_McapBW$Dry.Weigh.g.Time1)/data_McapBW$Dry.Weigh.g.Time1)*100)/data_McapBW$Days.Time2 #calculate growth rate for time2





# mean, standard dev, and sem
time1_McapBW <-ddply(data_McapBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_McapBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_McapBW <-ddply(data_McapBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_McapBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_McapA <- rbind(time1_McapBW[1,],time2_McapBW[1,])# Greate a new column that we rename each row by treatment
G_McapH <- rbind(time1_McapBW[2,],time2_McapBW[2,])# Greate a new column that we rename each row by treatment
G_Mcap<-rbind(G_McapA, G_McapH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Mcap$newtime = ifelse(G_Mcap$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Mcap <- within(G_Mcap, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Mcap_BW_plot<-ggplot(data=G_Mcap, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
     # ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("% Change Dry.Weigh.g"))) +
  ggtitle("Calcification Mcap")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_BW_plot


```
Porites compressa
```{r}

################################     PORITES COMPRESSA
BWCalc_Pcomp <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.82){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  # Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  
  # Porites asteroides (T Hughes 1987 1.69 at 5m) (KB got 1.82)
  
  # below: Medellin-Maldonado et al 2016
  # Pavona varians 1.04 +-0.07
  # panama 8.5380° N, 80.7821° W, 
  # coasta rica 9.7489° N, 83.7534° W
  # mexico la entrega 15.7424° N, 96.1282° W
  # hawaii 19.8968° N, 155.5828° W
  # Pocillopora 1.78 +- 0.31
  
  
  # You can change the density to literatrue values for the specific coral species of interest in the function. 
  
  #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the glass Standard to calculate
  # the density of the Standard (Davies eq. 4)
  FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
  CoralWeight <- BW_Pcomp/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}


Pcomp_BW$Dry.Weigh.g <- BWCalc_Pcomp(BW=BW_Pcomp, Temp=Temp_Pcomp) #use function to calculate dry weight
hist(Pcomp_BW$Dry.Weigh.g) 
Pcomp_BW$Dry.Weigh.g_log<-log10(Pcomp_BW$Dry.Weigh.g+1)
hist(Pcomp_BW$Dry.Weigh.g_log) # normal
boxplot(Pcomp_BW$Dry.Weigh.g_log) #examine data

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PcompBW <- reshape(Pcomp_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "X", "Time.Point", "Parent.ID", "Species", "Tank.num"), idvar=c("Frag.ID", "Treatment"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PcompBW$time1.growth <- (((data_PcompBW$Dry.Weigh.g.Time1 - data_PcompBW$Dry.Weigh.g.Time0)/data_PcompBW$Dry.Weigh.g.Time0)*100)/data_PcompBW$Days.Time1 #calculate growth rate for time1
data_PcompBW$time2.growth <- (((data_PcompBW$Dry.Weigh.g.Time2 - data_PcompBW$Dry.Weigh.g.Time1)/data_PcompBW$Dry.Weigh.g.Time1)*100)/data_PcompBW$Days.Time2 #calculate growth rate for time2

# mean, standard dev, and sem
time1_PcompBW <-ddply(data_PcompBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PcompBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PcompBW <-ddply(data_PcompBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PcompBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PcompA <- rbind(time1_PcompBW[1,],time2_PcompBW[1,])# Greate a new column that we rename each row by treatment
G_PcompH <- rbind(time1_PcompBW[2,],time2_PcompBW[2,])# Greate a new column that we rename each row by treatment
G_Pcomp<-rbind(G_PcompA, G_PcompH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pcomp$newtime = ifelse(G_Pcomp$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pcomp <- within(G_Pcomp, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Pcomp_BW_plot<-ggplot(data=G_Pcomp, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("% Change Dry.Weigh.g"))) +
  ggtitle("Calcification Pcomp")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_BW_plot

```
Pavona varians
```{r}
BWCalc_Pvar <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.04){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  # Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  
  # Porites asteroides (T Hughes 1987 1.69 at 5m) (KB got 1.82)
  
  # below: Medellin-Maldonado et al 2016
  # Pavona varians 1.04 +-0.07
  # panama 8.5380° N, 80.7821° W, 
  # coasta rica 9.7489° N, 83.7534° W
  # mexico la entrega 15.7424° N, 96.1282° W
  # hawaii 19.8968° N, 155.5828° W
  # Pocillopora 1.78 +- 0.31
  
  
  # You can change the density to literatrue values for the specific coral species of interest in the function. 
  
  #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the glass Standard to calculate
  # the density of the Standard (Davies eq. 4)
  FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
  CoralWeight <- BW_Pvar/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}

Pvar_BW$Dry.Weigh.g <- BWCalc_Pvar(BW=BW_Pvar, Temp=Temp_Pvar) #use function to calculate dry weight
hist(Pvar_BW$Dry.Weigh.g) #not normal

boxplot(Pvar_BW$Dry.Weigh.g) #examine data
Pvar_BW$Dry.Weigh.g_log<-log10(Pvar_BW$Dry.Weigh.g+1)
hist(Pvar_BW$Dry.Weigh.g_log) #not normal


# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PvarBW <- reshape(Pvar_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "X",  "Parent.ID", "Species","Time.Point", "Tank.num"), idvar=c("Frag.ID", "Treatment"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PvarBW$time1.growth <- (((data_PvarBW$Dry.Weigh.g.Time1 - data_PvarBW$Dry.Weigh.g.Time0)/data_PvarBW$Dry.Weigh.g.Time0)*100)/data_PvarBW$Days.Time1 #calculate growth rate for time1
data_PvarBW$time2.growth <- (((data_PvarBW$Dry.Weigh.g.Time2 - data_PvarBW$Dry.Weigh.g.Time1)/data_PvarBW$Dry.Weigh.g.Time1)*100)/data_PvarBW$Days.Time2 #calculate growth rate for time2

# mean, standard dev, and sem
time1_PvarBW <-ddply(data_PvarBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PvarBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PvarBW <-ddply(data_PvarBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PvarBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PvarA <- rbind(time1_PvarBW[1,],time2_PvarBW[1,])# Greate a new column that we rename each row by treatment
G_PvarH <- rbind(time1_PvarBW[2,],time2_PvarBW[2,])# Greate a new column that we rename each row by treatment
G_Pvar<-rbind(G_PvarA, G_PvarH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pvar$newtime = ifelse(G_Pvar$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pvar <- within(G_Pvar, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Pvar_BW_plot<-ggplot(data=G_Pvar, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("% Change Dry.Weigh.g"))) +
  ggtitle("Calcification Pvar")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_BW_plot

```
P acuta
```{r}
BWCalc_Pacu <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.78){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  # Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  
  # Porites asteroides (T Hughes 1987 1.69 at 5m) (KB got 1.82)
  
  # below: Medellin-Maldonado et al 2016
  # Pavona varians 1.04 +-0.07
  # panama 8.5380° N, 80.7821° W, 
  # coasta rica 9.7489° N, 83.7534° W
  # mexico la entrega 15.7424° N, 96.1282° W
  # hawaii 19.8968° N, 155.5828° W
  # Pocillopora 1.78 +- 0.31
  
  
  # You can change the density to literatrue values for the specific coral species of interest in the function. 
  
  #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the glass Standard to calculate
  # the density of the Standard (Davies eq. 4)
  FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
  CoralWeight <- BW_Pacu/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}

Pacu_BW$Dry.Weigh.g <- BWCalc_Pacu(BW=BW_Pacu, Temp=Temp_Pacu) #use function to calculate dry weight
hist(Pacu_BW$Dry.Weigh.g) #not normal
Pacu_BW$Dry.Weigh.g_log<-log10(Pacu_BW$Dry.Weigh.g+1)
hist(Pacu_BW$Dry.Weigh.g_log) #better still tail
boxplot(Pacu_BW$Dry.Weigh.g) #examine data

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PacuBW <- reshape(Pacu_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "X",  "Parent.ID", "Species","Time.Point", "Tank.num"), idvar=c("Frag.ID", "Treatment"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PacuBW$time1.growth <- (((data_PacuBW$Dry.Weigh.g.Time1 - data_PacuBW$Dry.Weigh.g.Time0)/data_PacuBW$Dry.Weigh.g.Time0)*100)/data_PacuBW$Days.Time1 #calculate growth rate for time1
data_PacuBW$time2.growth <- (((data_PacuBW$Dry.Weigh.g.Time2 - data_PacuBW$Dry.Weigh.g.Time1)/data_PacuBW$Dry.Weigh.g.Time1)*100)/data_PacuBW$Days.Time2 #calculate growth rate for time2



# mean, standard dev, and sem
time1_PacuBW <-ddply(data_PacuBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PacuBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PacuBW <-ddply(data_PacuBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PacuBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PacuA <- rbind(time1_PacuBW[1,],time2_PacuBW[1,])# Greate a new column that we rename each row by treatment
G_PacuH <- rbind(time1_PacuBW[2,],time2_PacuBW[2,])# Greate a new column that we rename each row by treatment
G_Pacu<-rbind(G_PacuA, G_PacuH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pacu$newtime = ifelse(G_Pacu$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pacu <- within(G_Pacu, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Pacu_BW_plot<-ggplot(data=G_Pacu, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("% Change Dry.Weigh.g"))) + 
  ggtitle("Calcification Pacu")+ 
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_BW_plot
 
```
Plots together
```{r}
###### All plots together
Mcap_BW_plot<-Mcap_BW_plot+ theme(legend.position = "none") #remove legend
Pcomp_BW_plot<-Pcomp_BW_plot+ theme(legend.position = "none") #remove legend
Pvar_BW_plot<-Pvar_BW_plot+ theme(legend.position = "none") #remove legend
Pacu_BW_plot<-Pacu_BW_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_BW_plot, Pcomp_BW_plot, Pvar_BW_plot,Pacu_BW_plot, nrow = 2)
``` 

stats
```{r} 
Growth<- rbind(data_McapBW, data_PcompBW, data_PvarBW, data_PacuBW)
GrowthKeep<- c("Frag.ID","time1.growth","time2.growth", "Treatment")
Growth <- Growth[GrowthKeep]

Grow_m <- melt(Growth, id=c("Frag.ID","Treatment")) #melt
names(Grow_m)[names(Grow_m) == "value"] <- "percent.change"
names(Grow_m)[names(Grow_m) == "variable"] <- "Time.point"

Growth2<-merge(Grow_m, meta) #merge metadata
GrowthKeep2<- c("Frag.ID","Time.point", "Treatment", "Tank.num","Parent.ID","Species","percent.change")
Growth3 <- Growth2[GrowthKeep2]
Growth3<-na.omit(Growth3)

hist(Growth3$percent.change) 
Growth3$percent.change_log<-log10(Growth3$percent.change+1)
hist(Growth3$percent.change_log) #normal 

BW_model<-lmer(percent.change_log~Time.point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), Growth3)
anova(BW_model) 
qqPlot(residuals(BW_model)) 

  emm<-emmeans(BW_model,  ~ Time.point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)
 

# make DF for BW for Physio, Cast so 2 columns 

Growth.Percent.day<-merge(Growth, meta, all=T)

```



#Chl-a
dfs: Slurry=airbrush, SA=wax dip, 
```{r} 

 # Plate 1

Chla_plate1<- read.csv("Data/Chla_plate1.csv")

#merge 
ChlaData1 <- merge(meta, Chla_plate1)
ChlaData1 <- merge(ChlaData1, Slurry)
ChlaData1 <- merge(ChlaData1, SA)
ChlaData1$Parent.ID<-as.factor(as.character(ChlaData1$Parent.ID))
ChlaData1$Tank.num<-as.factor(as.character(ChlaData1$Tank.num))
ChlaData1$Surface.area<-as.numeric(as.character(ChlaData1$Surface.area))


ChlaData1$totChla1<-ChlaData1$Rep1*ChlaData1$TotalVolume
ChlaData1$chlaSA1 <- ChlaData1$totChla1/ChlaData1$Surface.area

ChlaData1$totChla2<-ChlaData1$Rep2*ChlaData1$TotalVolume
ChlaData1$chlaSA2 <- ChlaData1$totChla2/ChlaData1$Surface.area

plate1<-plot(ChlaData1$chlaSA1,ChlaData1$chlaSA2)

# Plate 2
Chla_plate2<- read.csv("Data/Chla_plate2.csv")

#merge 
ChlaData2 <- merge(meta, Chla_plate2)
ChlaData2 <- merge(ChlaData2, Slurry)
ChlaData2 <- merge(ChlaData2, SA)
ChlaData2$Parent.ID<-as.factor(as.character(ChlaData2$Parent.ID))
ChlaData2$Tank.num<-as.factor(as.character(ChlaData2$Tank.num))
ChlaData2$Surface.area<-as.numeric(as.character(ChlaData2$Surface.area))

ChlaData2$totChla1<-ChlaData2$Rep1*ChlaData2$TotalVolume
ChlaData2$chlaSA1 <- ChlaData2$totChla1/ChlaData2$Surface.area

ChlaData2$totChla2<-ChlaData2$Rep2*ChlaData2$TotalVolume
ChlaData2$chlaSA2 <- ChlaData2$totChla2/ChlaData2$Surface.area

plate2<-plot(ChlaData2$chlaSA1,ChlaData2$chlaSA2)

# Plate 3
Chla_plate3<- read.csv("Data/Chla_plate3.csv")

#merge 
ChlaData3 <- merge(meta, Chla_plate3)
ChlaData3 <- merge(ChlaData3, Slurry)
ChlaData3 <- merge(ChlaData3, SA)
ChlaData3$Parent.ID<-as.factor(as.character(ChlaData3$Parent.ID))
ChlaData3$Tank.num<-as.factor(as.character(ChlaData3$Tank.num))
ChlaData3$Surface.area<-as.numeric(as.character(ChlaData3$Surface.area))

ChlaData3$totChla1<-ChlaData3$Rep1*ChlaData3$TotalVolume
ChlaData3$chlaSA1 <- ChlaData3$totChla1/ChlaData3$Surface.area

ChlaData3$totChla2<-ChlaData3$Rep2*ChlaData3$TotalVolume
ChlaData3$chlaSA2 <- ChlaData3$totChla2/ChlaData3$Surface.area

plate3<-plot(ChlaData3$chlaSA1,ChlaData3$chlaSA2) #check

# Plate 4 
Chla_plate4<- read.csv("Data/test_plate4.csv")

#merge 
ChlaData4 <- merge(meta, Chla_plate4)
ChlaData4 <- merge(ChlaData4, Slurry)
ChlaData4 <- merge(ChlaData4, SA)
ChlaData4$Parent.ID<-as.factor(as.character(ChlaData4$Parent.ID))
ChlaData4$Tank.num<-as.factor(as.character(ChlaData4$Tank.num))
ChlaData4$Surface.area<-as.numeric(as.character(ChlaData4$Surface.area))


ChlaData4$totChla1<-ChlaData4$Rep1*ChlaData4$TotalVolume
ChlaData4$chlaSA1 <- ChlaData4$totChla1/ChlaData4$Surface.area

ChlaData4$totChla2<-ChlaData4$Rep2*ChlaData4$TotalVolume
ChlaData4$chlaSA2 <- ChlaData4$totChla2/ChlaData4$Surface.area

plate4<-plot(ChlaData4$chlaSA1,ChlaData4$chlaSA2)

# Plate 5 20190319
Chla_plate5<- read.csv("Data/Chla_20190319_plate5.csv")

#merge 
ChlaData5 <- merge(meta, Chla_plate5)
ChlaData5 <- merge(ChlaData5, Slurry)
ChlaData5 <- merge(ChlaData5, SA)
ChlaData5$Parent.ID<-as.factor(as.character(ChlaData5$Parent.ID))
ChlaData5$Tank.num<-as.factor(as.character(ChlaData5$Tank.num))
ChlaData5$Surface.area<-as.numeric(as.character(ChlaData5$Surface.area))


ChlaData5$totChla1<-ChlaData5$Rep1*ChlaData5$TotalVolume
ChlaData5$chlaSA1 <- ChlaData5$totChla1/ChlaData5$Surface.area

ChlaData5$totChla2<-ChlaData5$Rep2*ChlaData5$TotalVolume
ChlaData5$chlaSA2 <- ChlaData5$totChla2/ChlaData5$Surface.area

plate5<-plot(ChlaData5$chlaSA1,ChlaData5$chlaSA2) #some not close, check 



# Plate 6 20190321
Chla_plate6<- read.csv("Data/Chla_plate6.csv")

#merge 
ChlaData6 <- merge(meta, Chla_plate6)
ChlaData6 <- merge(ChlaData6, Slurry)
ChlaData6 <- merge(ChlaData6, SA)
ChlaData6$Parent.ID<-as.factor(as.character(ChlaData6$Parent.ID))
ChlaData6$Tank.num<-as.factor(as.character(ChlaData6$Tank.num))
ChlaData6$Surface.area<-as.numeric(as.character(ChlaData6$Surface.area))


ChlaData6$totChla1<-ChlaData6$Rep1*ChlaData6$TotalVolume
ChlaData6$chlaSA1 <- ChlaData6$totChla1/ChlaData6$Surface.area

ChlaData6$totChla2<-ChlaData6$Rep2*ChlaData6$TotalVolume
ChlaData6$chlaSA2 <- ChlaData6$totChla2/ChlaData6$Surface.area

plate6<-plot(ChlaData6$chlaSA1,ChlaData6$chlaSA2) #some not close, check 



```

means for plots
```{r} 
Chla<-rbind(ChlaData1, ChlaData2, ChlaData3, ChlaData4, ChlaData5, ChlaData6)

DUPtest<-duplicated(Chla) #look for duplicate entries
Chla<-unique(Chla) #remove any duplicate entries 

Chla$Chla_RepDiff<-Chla$chlaSA1-Chla$chlaSA2
Chla$ChlaSA<-(Chla$chlaSA1+Chla$chlaSA2)/2
checkChla<-merge(Chla,meta, all.y=T)

#write.csv(checkChla,"checkChla.csv")

#2285, 3491, N141 Remove sample where reps are >2 apart
Chla<-Chla[!(Chla$Frag.ID=="2285"),]
Chla<-Chla[!(Chla$Frag.ID=="N138"),]
Chla<-Chla[!(Chla$Frag.ID=="N211"),]


#make slightly neg values 0 
Chla$ChlaSA[Chla$ChlaSA < 0] <- 0 

# 
Chla_mean <- ddply(Chla, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                   N    = length(ChlaSA[!is.na(ChlaSA)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(ChlaSA, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(ChlaSA, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(ChlaSA, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Chla_mean #display table

# divide by species
Mcap_chla<-subset(Chla_mean, Species =="Montipora_capitata")
Pcomp_chla<-subset(Chla_mean, Species =="Porites_compressa")
Pvar_chla<-subset(Chla_mean, Species =="Pavona_varians")
Pacu_chla<-subset(Chla_mean, Species =="Pocillopora_acuta")

#Mcap plot

Mcap_Chla_plot<-ggplot(data=Mcap_chla, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 8)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("(µg chl-a cm" ^ "-2"*")"))) +
  ggtitle("Mcap Chla")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_Chla_plot

#Pcomp plot

Pcomp_Chla_plot<-ggplot(data=Pcomp_chla, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 8)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("(µg chl-a cm" ^ "-2"*")"))) +
  ggtitle("Pcomp Chla")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_Chla_plot

#Pvar plot

Pvar_Chla_plot<-ggplot(data=Pvar_chla, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 8)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("(µg chl-a cm" ^ "-2"*")"))) +
  ggtitle("Pvar Chla")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_Chla_plot


#Pacu plot

Pacu_Chla_plot<-ggplot(data=Pacu_chla, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 5)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("(µg chl-a cm" ^ "-2"*")"))) +
  ggtitle("Pacu Chla")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_Chla_plot



```

Plots together
```{r}
###### All plots together
Mcap_Chla_plot<-Mcap_Chla_plot+ theme(legend.position = "none") #remove legend
Pcomp_Chla_plot<-Pcomp_Chla_plot+ theme(legend.position = "none") #remove legend
Pvar_Chla_plot<-Pvar_Chla_plot+ theme(legend.position = "none") #remove legend
Pacu_Chla_plot<-Pacu_Chla_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_Chla_plot, Pcomp_Chla_plot, Pvar_Chla_plot,Pacu_Chla_plot, nrow = 2)
```

stats <- there are 2 smaples that come up negative chla when averaged across reps. they get cut out when transforming the data, which is fine. 
```{r}

hist(Chla$ChlaSA) 
Chla$ChlaSA_log<-log10(Chla$ChlaSA+1)
hist(Chla$ChlaSA_log) #pos skew this ok?
Chla$ChlaSA_sqrt<-sqrt(Chla$ChlaSA) 
hist(Chla$ChlaSA_sqrt) #nope

Chla$ChlaSA_cube<-Chla$ChlaSA^(1/3)
hist(Chla$ChlaSA_cube) #better but no
shapiro.test(Chla$ChlaSA_cube)

Chla$ChlaSA_quart<-Chla$ChlaSA^(1/4)
hist(Chla$ChlaSA_quart) #best
shapiro.test(Chla$ChlaSA_quart) # p=0.5

Chla_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), Chla)
anova(Chla_model) 
qqPlot(residuals(Chla_model)) 


emm<-emmeans(Chla_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

```


#PAM
```{r}
#Load PAM data
Time0 <- read.csv("Data/PAM_20170320.csv", header=T) #load data
Time0<-merge(Time0, meta)
Time1 <- read.csv("Data/PAM_20170321.csv", header=T) #load data
Time1<-merge(Time1, meta)
Time2 <- read.csv("Data/PAM_20170322.csv", header=T) #load data
Time2<-merge(Time2, meta)
Time3 <- read.csv("Data/PAM_20170323.csv", header=T) #load data
Time3<-merge(Time3, meta)
#Time3b <- read.csv("Data/PAM_new_20170323b.csv", header=T) #load data
Time4 <- read.csv("Data/PAM_20170406.csv", header=T) #load data
Time4<-merge(Time4, meta)
Time5 <- read.csv("Data/PAM_20170413.csv", header=T) #load data
Time5<-merge(Time5, meta)
Time6 <- read.csv("Data/PAM_6test.csv", header=T) #load data had to remove rows with no data bc wouldn't upload
Time6<-merge(Time6, meta)
Time7 <- read.csv("Data/PAM_20170427.csv", header=T) #load data
Time7<-merge(Time7, meta)
Time8 <- read.csv("Data/PAM_20170504.csv", header=T) #load data
Time8<-merge(Time8, meta)
Time9 <- read.csv("Data/PAM_20170511.csv", header=T) #load data
Time9<-merge(Time9, meta)
Time10 <- read.csv("Data/PAM_20170517.csv", header=T) #load data
Time10<-merge(Time1, meta)

# combine all data files
PAMdata<-rbind(Time0, Time1, Time2, Time3, Time4, Time5, Time6, Time7, Time8, Time9, Time10)
# F0/FM: change F0, yield, and FM to numeric
PAMdata$F0<-as.numeric(as.character(PAMdata$F0))
PAMdata$FM<-as.numeric(as.character(PAMdata$FM))
PAMdata$Tank<-as.factor(as.character(PAMdata$Tank))
PAMdata$Tank.num<-as.factor(as.character(PAMdata$Tank.num))

# Date - change date to R format and then to numeric
PAMdata$Date <- as.Date(PAMdata$Date, format="%e-%b-%y")
#PAMdata$Date[PAMdata$Date<"2017-03-24"]<-"2017-03-20" # make all T0 same starte date to get average
PAMdata$Days <- as.numeric(PAMdata$Date - as.Date("2017-03-20"))
PAMdata$Days[PAMdata$Days<4]<- 0  #If you want to make T0 all the same start time do this

# make yield ratio
PAMdata <- transform(PAMdata, Yield = PAMdata$Yield/1000)
str(PAMdata) # check

#check yield calculations versus records and build dataframe
checks <- (PAMdata[,(1:9)]) #add samples to dataframe
checks$Yield.Check <- PAMdata$Yield - ((PAMdata$FM-PAMdata$F0)/PAMdata$FM)
checks$checks <- ifelse(abs(checks$Yield.Check-checks$Yield) < 1, TRUE, FALSE) # check to see if Yield matches check
checks[checks$checks==FALSE,]#pull out FALSE

# check for outliers
#boxplot(checks$Yield.Check, main="Times") #check F0r outliers

#Check notes manulaly and remove data points as needed
#check for duplicate rows
DUP<-duplicated(PAMdata) #look for duplicate entries
PAMdata<-unique(PAMdata) #remove any duplicate entries 
#write.csv(PAMdata,"PAMdatacheck.csv")

# if NA in YIELD remove
PAMdata<-PAMdata[!is.na(PAMdata$Yield), ]







```
Stats
```{r}  
#remove notes

PAMdata_stats<-PAMdata[,c("Frag.ID","Date","Yield","Parent.ID","Treatment","Species","Tank.num","Days")] # keep only columns you need
PAMdata_stats$Days<-as.factor(as.character(PAMdata_stats$Days))

# Historgam
hist(PAMdata_stats$Yield)

#transform
PAMdata_stats$Yield_sq<-(PAMdata_stats$Yield)^2
hist(PAMdata_stats$Yield_sq)

PAMdata_stats$Yield_cu<-(PAMdata_stats$Yield)^3
hist(PAMdata_stats$Yield_cu) #beter


#lmer with ^3
PAMdata_stats_model<-lmer(Yield_cu~Days*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata_stats)
anova(PAMdata_stats_model) 
qqPlot(residuals(PAMdata_stats_model)) 

emm<-emmeans(PAMdata_stats_model,  ~ Species*Treatment|Days, adjust="Tukey")
cld(emm)
pairs(emm)



#is the data still not normal by species

Mcap_PAM<-subset(PAMdata_stats, Species=="Montipora_capitata")
hist(Mcap_PAM$Yield_cu)
Mcap_PAMdata_stats_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID)+(1|Tank.num), Mcap_PAM)
anova(Mcap_PAMdata_stats_model) 
qqPlot(residuals(Mcap_PAMdata_stats_model))

Pcomp_PAM<-subset(PAMdata_stats, Species=="Porites_compressa")
hist(Pcomp_PAM$Yield_cu)
Pcomp_PAMdata_stats_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID)+(1|Tank.num), Pcomp_PAM)
anova(Pcomp_PAMdata_stats_model) 
qqPlot(residuals(Pcomp_PAMdata_stats_model))

Pvar_PAM<-subset(PAMdata_stats, Species=="Pavona_varians") #normal AF
hist(Pvar_PAM$Yield_cu)
Pvar_PAMdata_stats_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID)+(1|Tank.num), Pvar_PAM)
anova(Pvar_PAMdata_stats_model) 
qqPlot(residuals(Pvar_PAMdata_stats_model))

Pacu_PAM<-subset(PAMdata_stats, Species=="Pocillopora_acuta")
hist(Pacu_PAM$Yield_cu)
Pacu_PAMdata_stats_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID)+(1|Tank.num), Pacu_PAM)
anova(Pacu_PAMdata_stats_model) 
qqPlot(residuals(Pacu_PAMdata_stats_model))


#set up df for physio\
  keepPAM<-c("Frag.ID", "Parent.ID","Species","Tank.num","Treatment","Days","Yield_cu") #keep cols you need
PAMdata_stats2<-PAMdata_stats[keepPAM] #keep cols you want
PAMdata_stats2$Parent.ID<-as.factor(as.character(PAMdata_stats2$Parent.ID))
PAMdata_physio<-dcast(PAMdata_stats, Frag.ID+Parent.ID+Species+Tank.num+Treatment~Days,fun.aggregate = mean) #cast

names(PAMdata_physio)[names(PAMdata_physio) == "0"] <- "T0.PAM"
names(PAMdata_physio)[names(PAMdata_physio) == "24"] <- "T1.PAM"
names(PAMdata_physio)[names(PAMdata_physio) == "52"] <- "TF.PAM"


#keep only T0 (day 0), T1 (day 24), and TF (day 52)
keepPAMdata_physio<-c("Frag.ID", "Parent.ID","Species","Tank.num","Treatment","T0.PAM","T1.PAM","TF.PAM") #keep cols you need
PAMdata_physio<-PAMdata_physio[keepPAMdata_physio] #keep cols you want



```
Plots
```{r}
PAMdata_mean <- ddply(PAMdata, c("Treatment", "Species", "Days"), summarise, #summarize cell counts
                   N    = length(Yield[!is.na(Yield)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(Yield, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(Yield, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(Yield, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
PAMdata_mean #display table

# divide by species
Mcap_PAM_mean<-subset(PAMdata_mean, Species =="Montipora_capitata")
Pcomp_PAM_mean<-subset(PAMdata_mean, Species =="Porites_compressa")
Pvar_PAM_mean<-subset(PAMdata_mean, Species =="Pavona_varians")
Pacu_PAM_mean<-subset(PAMdata_mean, Species =="Pocillopora_acuta")

#Mcap plot

Mcap_PAM_plot<-ggplot(data=Mcap_PAM_mean, aes(x=Days, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 1)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("fv/fm"))) +
  ggtitle("Mcap PAM")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_PAM_plot

#Pcomp plot

Pcomp_PAM_plot<-ggplot(data=Pcomp_PAM_mean, aes(x=Days, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 1)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("fv/fm"))) +
  ggtitle("Pcomp PAM")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_PAM_plot

#Pvar plot

Pvar_PAM_plot<-ggplot(data=Pvar_PAM_mean, aes(x=Days, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 1)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("fv/fm"))) +
  ggtitle("Pvar PAM")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_PAM_plot

#Pacu plot
Pacu_PAM_mean<-Pacu_PAM_mean[!(Pacu_PAM_mean$N<5),] #remove time points if n<5

Pacu_PAM_plot<-ggplot(data=Pacu_PAM_mean, aes(x=Days, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, 1)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("fv/fm"))) +
  ggtitle("Pacu PAM")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_PAM_plot

```
Plots together
```{r}
###### All plots together
Mcap_PAM_plot<-Mcap_PAM_plot+ theme(legend.position = "none") #remove legend
Pcomp_PAM_plot<-Pcomp_PAM_plot+ theme(legend.position = "none") #remove legend
Pvar_PAM_plot<-Pvar_PAM_plot+ theme(legend.position = "none") #remove legend
Pacu_PAM_plot<-Pacu_PAM_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_PAM_plot, Pcomp_PAM_plot, Pvar_PAM_plot,Pacu_PAM_plot, nrow = 2)
```

#Protein
```{r}
Protein <- read.csv("Data/Protein_TT17_20190214.csv")
keepPr<-c("Frag.ID", "mg.prot.ml") #keep cols you need
Protein<-Protein[keepPr]

Protein<-merge(Protein, Slurry) #merge with slurry
Protein<-merge(Protein, SA) # merge with SA
Protein$Surface.area<-as.numeric(as.character(Protein$Surface.area))
Protein<-merge(Protein, meta) #merge with metadata
Protein$Parent.ID<-as.factor(as.character(Protein$Parent.ID))
Protein$Tank.num<-as.factor(as.character(Protein$Tank.num))

# calculate total prot per total vol of slurry
Protein$prot.ml<- Protein$mg.prot.ml*Protein$TotalVolume

# create a new column to calculate per surface area (mg/mm2)
Protein$mg.mm2 <- Protein$prot.ml/Protein$Surface.area

PRotcheck<-merge(Protein, meta, all=T)
#write.csv(PRotcheck, "Proteincheck.csv")

#calc means
Protein_mean <- ddply(Protein, c("Treatment", "Species", "Time.Point"), summarise, #summarize prot
                   N    = length(mg.mm2[!is.na(mg.mm2)]), #calculate the length of the data frame, excluding NA’s *this part is important*
                   mean = mean(mg.mm2, na.rm=TRUE), #calculate mean of response variable, removing NA's
                   sd   = sd(mg.mm2, na.rm=TRUE), #calculate standard deviation
                   se   = sd / sqrt(N), #calculate standard error
                   max = max(mg.mm2, na.rm=TRUE) #calculate max, could also calculate min () if desired
)
Protein_mean

#stats

hist(Protein$mg.mm2)
Protein$mg.mm2_log<-log10(Protein$mg.mm2+1)
hist(Protein$mg.mm2_log)
Protein$mg.mm2_sqrt<-sqrt(Protein$mg.mm2)
hist(Protein$mg.mm2_sqrt) #better



Protein_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), Protein)
anova(Protein_model) 
qqPlot(residuals(Protein_model)) #not awful

  emm<-emmeans(Protein_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

  emm<-emmeans(Protein_model,  ~ Species*Treatment|Time.Point, adjust="Tukey")
cld(emm)
pairs(emm)


```
plots
```{r}
Mcap_Protein_mean<-subset(Protein_mean, Species=="Montipora_capitata")
Pcomp_Protein_mean<-subset(Protein_mean, Species=="Porites_compressa")
Pvar_Protein_mean<-subset(Protein_mean, Species=="Pavona_varians")
Pacu_Protein_mean<-subset(Protein_mean, Species=="Pocillopora_acuta")


#Mcap
Mcap_Protein_plot<-ggplot(data=Mcap_Protein_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("mg/mm2"))) +
  ggtitle("Protein Mcap")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_Protein_plot

#Pcomp
Pcomp_Protein_plot<-ggplot(data=Pcomp_Protein_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
     # ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("mg/mm2"))) +
  ggtitle("Protein Pcomp")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_Protein_plot

#Pvar
Pvar_Protein_plot<-ggplot(data=Pvar_Protein_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
     # ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("mg/mm2"))) +
  ggtitle("Protein Pvar")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_Protein_plot


#Pacu
Pacu_Protein_plot<-ggplot(data=Pacu_Protein_mean, aes(x=Time.Point, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("mg/mm2"))) +
  ggtitle("Protein Pacu")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_Protein_plot


###### All plots together
Mcap_Protein_plot<-Mcap_Protein_plot+ theme(legend.position = "none") #remove legend
Pcomp_Protein_plot<-Pcomp_Protein_plot+ theme(legend.position = "none") #remove legend
Pvar_Protein_plot<-Pvar_Protein_plot+ theme(legend.position = "none") #remove legend
Pacu_Protein_plot<-Pacu_Protein_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_Protein_plot, Pcomp_Protein_plot, Pvar_Protein_plot,Pacu_Protein_plot, nrow = 2)
```







#COMBINE all physio dfs
Set these up so they are by PARENT-TREATMENT-TIMEPOINT and average across frag reps
```{r} 
#biomass: keep Frag.ID and AFDW.cm2_log
Biomass_psy<- Biomass_stats[,c("Frag.ID","AFDWmg.cm2_log")] # keep only columns you need
#cell counts:FC_Data df and keep  Frag.ID and zoox.cm2_log
CellCounts_psy<- FC_Data[,c("Frag.ID","zoox.cm2_log")] # keep only columns you need
names(CellCounts_psy)[names(CellCounts_psy) == "zoox.cm2_log"] <- "Cellcounts_zoox.cm2_log"

#Calcification, Growth and percent.change_log do for each time point
Calcification_psy1<- Growth.Percent.day[,c("Frag.ID","time1.growth")] # keep only columns you need
names(Calcification_psy1)[names(Calcification_psy1) == "Calcification_psy1"] <- "T1_Calc_percent.change_log"
Calcification_psy2<- Growth.Percent.day[,c("Frag.ID","time2.growth")] # keep only columns you need
names(Calcification_psy2)[names(Calcification_psy2) == "Calcification_psy2"] <- "TF_Calc_percent.change_log"

Calcification_psy<- Growth.Percent.day
Calcification_psy$Code<-paste(Calcification_psy$Species,Calcification_psy$Treatment)
Calcification_psy<- Calcification_psy[,c("Code","Parent.ID","Frag.ID","time1.growth","time2.growth")] # keep only columns you need
#write.csv(Calcification_psy,"Calcification_psy.csv")

Calcification_psy$GROWTH<-group_by(Parent.ID, Code) %>% mutate(mean=mean(time1.growth))







#Chla Chla df ChlaSA_quart
Chla_psy<- Chla[,c("Frag.ID","ChlaSA_quart")] # keep only columns you need
names(Chla_psy)[names(Chla_psy) == "ChlaSA_quart"] <- "Chla_ug.chla.cm2"

#PAM df PAMdata_stats make for T0, T1, TF
PAM_psy<- PAMdata_physio[,c("Frag.ID","T0.PAM","T1.PAM","TF.PAM")] # keep only columns you need\

#Protein Protein$mg.mm2_sqrt
Protein_psy<- Protein[,c("Frag.ID","mg.mm2_sqrt")] # keep only columns you need
names(Protein_psy)[names(Protein_psy) == "mg.mm2_sqrt"] <- "Protein_mg.mm2_sqrt"

#merg: this is EVERYTHING! PAM and BW subsetted to ONLY T0, T1 and TF time points, and all data is already transformed! 

metaPhysio<-subset(meta, select= -X)#remove X from df
PhysioData<-merge(metaPhysio,Biomass_psy)
PhysioData<-merge(PhysioData,CellCounts_psy)
PhysioData<-merge(PhysioData,Calcification_psy1)
PhysioData<-merge(PhysioData,Calcification_psy2)
PhysioData<-merge(PhysioData,Chla_psy)
PhysioData<-merge(PhysioData,Protein_psy)
PhysioData<-merge(PhysioData,PAM_psy)

PhysioData$Parent.ID<-as.factor(as.character(PhysioData$Parent.ID))
PhysioData$Tank.num<-as.factor(as.character(PhysioData$Tank.num))

PhysioData3<-PhysioData #remove NaNs
PhysioData3$T0.PAM[PhysioData3$T0.PAM == "NaN"] <- NA #change NaN to NA
PhysioData3$T1.PAM[PhysioData3$T1.PAM == "NaN"] <- NA #change NaN to NA
PhysioData3$TF.PAM[PhysioData3$TF.PAM == "NaN"] <- NA #change NaN to NA
PhysioData3$Chla_ug.chla.cm2[PhysioData3$Chla_ug.chla.cm2 == "NaN"] <- NA #change NaN to NA

#write_csv(PhysioData3,"PhysioData3.csv")


#physio without PAM and BW
PhysioData4<-merge(metaPhysio,Biomass_psy)
PhysioData4<-merge(PhysioData4,CellCounts_psy)
PhysioData4<-merge(PhysioData4,Chla_psy)
PhysioData4<-merge(PhysioData4,Protein_psy)

PhysioData4$Parent.ID<-as.factor(as.character(PhysioData4$Parent.ID))
PhysioData4$Tank.num<-as.factor(as.character(PhysioData4$Tank.num))

PhysioData4$Chla_ug.chla.cm2[PhysioData4$Chla_ug.chla.cm2 == "NaN"] <- NA #change NaN to NA


```

nMDS of physio
#





























# Physio PCA
```{r} 
PhysioData4.pr <- prcomp(PhysioData4[c(8:11)], center = TRUE, scale = TRUE)
summary(PhysioData.pr)

library(VIM)
library(FactoMineR)
library(missMDA) #lets you do with incomplete dataset
library(naniar)
gg_miss_var(PhysioData)
res<-summary(aggr(PhysioData, sortVar=TRUE))$combinations


nb <- estim_ncpPCA(PhysioData,method.cv = "Kfold", verbose = FALSE) # estimate the number of components from incomplete data
#(available methods include GCV to approximate CV)
nb$ncp #2

res <- cor(PhysioData)
round(res, 2)


library("PerformanceAnalytics")
my_data <- PhysioData[, c(8:16)]
chart.Correlation(my_data, histogram=TRUE, pch=19)


#Display Pearson correlation: testing physio (normal data) correlations

cor.test(PhysioData3$AFDWmg.cm2_log, PhysioData3$Cellcounts_zoox.cm2_log, method=c("pearson")) #

PhysioData3$Treatment_level <- factor(PhysioData3$Treatment, levels = c("Ambient", "High")) #make new col

Cor1<-ggplot(PhysioData3, aes(x=AFDWmg.cm2_log, y=Cellcounts_zoox.cm2_log)) + 
  geom_point(aes(color=Treatment, shape=Treatment), size=6) +
   #scale_color_manual(name="Nutrition",
        #            values=c("orange", "purple"), 
          #          labels=c("Fed", "Unfed"))+
  scale_shape_manual(values = c(19,21))+
  theme_classic()+
  geom_text(x=800, y=20, label="r=0.50, p<0.001", size=9, color="black") +
  theme(text = element_text(size = 20))+
  theme(axis.text = element_text(size = 20, color="black"))+
  theme(axis.title = element_text(size = 20, face="bold"))+
  theme(legend.title = element_text(size = 20, face="bold"))+
  theme(legend.text = element_text(size = 20, color="black"))+
  ylab(expression(bold(paste("AFDWmg.cm2_log")))) +
  xlab(expression(bold(paste("Cellcounts_zoox.cm2_log"))));Cor1

corrModel<-lmer(AFDWmg.cm2_log~Cellcounts_zoox.cm2_log * Treatment * Species + (1|Tank.num) + (1|Parent.ID), data=PhysioData3)
summary(corrModel)
anova(corrModel, type=2)


##### trying correlations with only complete data (no PAM or BW)
correlation<-PhysioData4
correlation<-correlation[complete.cases(correlation), ] #only full data (2 samps no chla)

correlation_Mcap<-subset(correlation, Species=="Montipora_capitata")
correlation_Mcap_T1<-subset(correlation_Mcap, Time.Point=="T1")

#not workin
corrplots<-ggplot(correlation_Mcap_T1, aes(x=Treatment, y=Frag.ID))+
  geom_point()+
  facet_wrap(~compound, scales="free")+
  geom_smooth(method='lm', color='red')+
  theme_classic()+
  theme(text=element_text(size=14, face="bold"))
corrplots


#back to PCA with the shorter coor dataset that is full
PhysioData5<-PhysioData4
PhysioData5<-PhysioData5[complete.cases(PhysioData5), ] #only full data (2 samps no chla)

PhysioData5.pr <- prcomp(PhysioData5[c(8:11)], center = TRUE, scale = TRUE)
summary(PhysioData5.pr)

#amount of variance explained
screeplot(PhysioData5.pr, type = "l", npcs = 15, main = "Screeplot of the first 10 PCs")
abline(h = 1, col="red", lty=5)
legend("topright", legend=c("Eigenvalue = 1"),
       col=c("red"), lty=5, cex=0.6)
cumpro <- cumsum(PhysioData5.pr$sdev^2 / sum(PhysioData5.pr$sdev^2))
plot(cumpro[0:15], xlab = "PC #", ylab = "Amount of explained variance", main = "Cumulative variance plot")
abline(v = 6, col="blue", lty=5)
abline(h = 0.88759, col="blue", lty=5)
legend("topleft", legend=c("Cut-off @ PC6"),
       col=c("blue"), lty=5, cex=0.6)


#try plotting PC1 and 2 (how to get the percents?????)
plot(PhysioData5.pr$x[,1],PhysioData5.pr$x[,2], xlab="PC1 ()", ylab = "PC2 ()", main = "PC1 / PC2 - plot")


library("factoextra")
fviz_pca_ind(PhysioData5.pr, geom.ind = "point", pointshape = 21, 
             pointsize = 2, 
             fill.ind = PhysioData5$Treatment, 
             col.ind = "black", 
             palette = "jco", 
             addEllipses = TRUE,
             label = "var",
             col.var = "black",
             repel = TRUE,
             legend.title = "Treatment") +
  ggtitle("") +
  theme(plot.title = element_text(hjust = 0.5))


PhysioData5_mat<-PhysioData5[c(8:11)]
cor.res <- cor(PhysioData5_mat)
corrplot.mixed(cor.res, tl.cex = 0.7, tl.col = "black", addCoefasPercent = TRUE)

```



PCA hannah use physio data
```{r}
##PCA with imputation using PPCA (Probabilistic PCA, can handle ~15% missing data)

##Use the pcaMethods package for imputing
#BiocManager::install("pcaMethods")
library(pcaMethods)
sum(is.na(PhysioData)) #385
data<-PhysioData #make copy
View(data)

data$time1.growth[data$time1.growth == "NaN"] <- NA #change NaN to NA
data$time1.growth[data$Chla_ug.chla.cm2 == "NaN"] <- NA #change NaN to NA

data$T1.PAM[data$T1.PAM == "NaN"] <- NA #change NaN to NA
data$TF.PAM[data$TF.PAM == "NaN"] <- NA #change NaN to NA
data$T0.PAM[data$T0.PAM == "NaN"] <- NA #change NaN to NA

#Now we get the estimated data set by using PPCA and two principal components
#But you can use nPCs = 3 or however many principal components you want to use.

pc <- pca(data, nPcs=2, method="ppca") #probabilistic PCA
imputed <- completeObs(pc) #This creates a new dataframe with imputed values based on your probability pca

#Then you can run a pca on the imputed datafram
pca <- prcomp(imputed, center = TRUE, scale. = TRUE)
summary(pca)
View(pca)

#you can view it this way
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
ggbiplot(pca)

#Or extract the scores and make a ggplot
#Then add your metadata
library(ggplot2)
Miss_scores <- as.data.frame(pca$x)
Miss_scores$frag.id <- data$Frag.ID
Miss_scores$parent.id <- data$Parent.ID
Miss_scores$treatment <- data$Treatment
Miss_scores$species <- data$Species
Miss_scores$time.point <- data$Time.Point

#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

#plot by time and species
Miss_scores$treatSpecies<-paste0(Miss_scores$species, Miss_scores$treatment )
Miss_scores$treatTime<-paste0(Miss_scores$treatment, Miss_scores$time.point )


#subset by T0
Miss_scores_T0<-subset(Miss_scores, time.point=="T0")

Miss_scores_T0_plot<-ggplot(Miss_scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=0.25) +
  theme_classic();Miss_scores_T0_plot

#subset by T1
Miss_scores_T1<-subset(Miss_scores, time.point=="T1")
Miss_scores_T1_plot<-ggplot(Miss_scores_T1, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.25) +
  theme_classic();Miss_scores_T1_plot

#subset by TF
Miss_scores_TF<-subset(Miss_scores, time.point=="TF")
Miss_scores_TF_plot<-ggplot(Miss_scores_TF, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  #stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2) +
  theme_classic();Miss_scores_TF_plot

#plot all time plots
Miss_scores_T0_plot<-Miss_scores_T0_plot+ theme(legend.position = "none") #remove legend
Miss_scores_T1_plot<-Miss_scores_T1_plot+ theme(legend.position = "none") #remove legend
Miss_scores_TF_plot<-Miss_scores_TF_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Miss_scores_T0_plot, Miss_scores_T1_plot, Miss_scores_TF_plot, nrow = 1)

#Subset MCAP
Miss_scores_Mcap<-subset(Miss_scores, species=="Montipora_capitata")

Miss_Mcap_pca<-ggplot(Miss_scores_Mcap, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+ 
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
   ggtitle("Mcap") +
  theme_classic();Miss_Mcap_pca

#Subset Pcomp
Miss_scores_Pcomp<-subset(Miss_scores, species=="Porites_compressa")
Miss_Pcomp_pca<-ggplot(Miss_scores_Pcomp, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
      ggtitle("Pcomp") +
  theme_classic();Miss_Pcomp_pca

#Subset Pvar
Miss_scores_Pvar<-subset(Miss_scores, species=="Pavona_varians")
Miss_Pvar_pca<-ggplot(Miss_scores_Pvar, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
    ggtitle("Pvar") +
  theme_classic();Miss_Pvar_pca

#Subset Pacu
Miss_scores_Pacu<-subset(Miss_scores, species=="Pocillopora_acuta")
Miss_Pacu_pca<-ggplot(Miss_scores_Pacu, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
  ggtitle("Pacuta") +
  theme_classic();Miss_Pacu_pca

#plot all species plots
Miss_Mcap_pca<-Miss_Mcap_pca+ theme(legend.position = "none") #remove legend
Miss_Pcomp_pca<-Miss_Pcomp_pca+ theme(legend.position = "none") #remove legend
Miss_Pvar_pca<-Miss_Pvar_pca+ theme(legend.position = "none") #remove legend
Miss_Pacu_pca<-Miss_Pacu_pca+ theme(legend.position = "none") #remove legend

grid.arrange(Miss_Mcap_pca, Miss_Pcomp_pca, Miss_Pvar_pca,Miss_Pacu_pca, nrow = 2)

```


PCA not alive measurements' not PAM.BW
```{r}
#PhysioData5

PhysioData5.pca <- prcomp(PhysioData5[,c(8:11)], center = TRUE,scale. = TRUE)
summary(PhysioData5.pca)
str(PhysioData5.pca)


scores <- as.data.frame(PhysioData5.pca$x)
scores$frag.id <- data$Frag.ID
scores$parent.id <- data$Parent.ID
scores$treatment <- data$Treatment
scores$species <- data$Species
scores$time.point <- data$Time.Point
scores$treatSpecies<-paste0(scores$species, scores$treatment )
scores$treatTime<-paste0(scores$treatment, scores$time.point )


ggplot(scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()


#subset by T0
scores_T0<-subset(scores, time.point=="T0")
scores_T0_plot<-ggplot(scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=0.25) +
  theme_classic();scores_T0_plot

#subset by T1
scores_T1<-subset(scores, time.point=="T1")
scores_T1_plot<-ggplot(scores_T1, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=0.25) +
  theme_classic();scores_T1_plot

#subset by TFs
scores_TF<-subset(scores, time.point=="TF")
scores_TF_plot<-ggplot(scores_TF, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.25) +
  theme_classic();scores_TF_plot

#plot all time plots
scores_T0_plot<-scores_T0_plot+ theme(legend.position = "none") #remove legend
scores_T1_plot<-scores_T1_plot+ theme(legend.position = "none") #remove legend
scores_TF_plot<-scores_TF_plot+ theme(legend.position = "none") #remove legend

grid.arrange(scores_T0_plot, scores_T1_plot, scores_TF_plot, nrow = 1)


#Subset MCAP
scores_Mcap<-subset(scores, species=="Montipora_capitata")

Mcap_pca<-ggplot(scores_Mcap, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+ 
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
   ggtitle("Mcap") +
  theme_classic();Mcap_pca

#Subset Pcomp
scores_Pcomp<-subset(scores, species=="Porites_compressa")
Pcomp_pca<-ggplot(scores_Pcomp, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
      ggtitle("Pcomp") +
  theme_classic();Pcomp_pca

#Subset Pvar
scores_Pvar<-subset(scores, species=="Pavona_varians")
Pvar_pca<-ggplot(scores_Pvar, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
    ggtitle("Pvar") +
  theme_classic();Pvar_pca

#Subset Pacu
scores_Pacu<-subset(scores, species=="Pocillopora_acuta")
Pacu_pca<-ggplot(scores_Pacu, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
  ggtitle("Pacuta") +
  theme_classic();Pacu_pca

#plot all species plots
Mcap_pca<-Mcap_pca+ theme(legend.position = "none") #remove legend
Pcomp_pca<-Pcomp_pca+ theme(legend.position = "none") #remove legend
Pvar_pca<-Pvar_pca+ theme(legend.position = "none") #remove legend
Pacu_pca<-Pacu_pca+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_pca, Pcomp_pca, Pvar_pca,Pacu_pca, nrow = 2)
```
Lets try the PCA by Parent.ID, collapse the df by parent. 
```{r} 
 PhysioData6<-PhysioData #make a copy


Testing <- cbind(
  aggregate(PhysioData6$AFDWmg.cm2_log, by = list(PhysioData6$ParentID, PhysioData6$Treatment, PhysioData6$Species,PhysioData6$Time.Point,PhysioData6$Depth,PhysioData6$Tank.num), FUN=mean, na.rm = F))
  
  
  
  




```

