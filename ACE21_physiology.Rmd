---
title: "R Notebook"
html_document:
code_folding: hide
toc:yes
toc_depth:3
toc_float:yes
output: 
chunk_output_type: console
editor_options: 
  chunk_output_type: console
---

Data analysis for the All Coral Experiment #2021. Physiological variables:\
AFDW Flow Cytometry (cell counts) Protien Biomass BW PAM

#Data and libraries

```{r}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)


library(plyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
library(gridExtra)
library(multcomp)
library(reshape)
library(tidyverse)
library(factoextra)
library(reshape2)
library(vegan)
library(pairwiseAdonis)
library("scales")
library(RColorBrewer)
library(colorRamps)
library(devtools)
library(cowplot) 
library(ggh4x)

```

Load meta

```{r}
meta  <- read.csv("Data/Master_Metadata_20190402.csv")
meta<-meta %>%
    mutate(Species = str_replace(Species, "_", " "))
#remove frags that re duplicated or T3
meta<-meta[!(meta$X=="REMOVE"),]
meta<- meta[!(meta$Frag.ID == "3149"),] # dup
meta$Species<-as.factor(meta$Species)
meta$Species<-as.factor(meta$Species)
meta$Species <- factor(meta$Species, levels = c("Montipora capitata", "Porites compressa", "Pavona varians","Pocillopora acuta"))


meta$Parent.ID<-as.factor(meta$Parent.ID)
meta$Frag.ID<-as.factor(meta$Frag.ID)
meta$Time.Point<-as.factor(meta$Time.Point)
meta$Treatment<-as.factor(meta$Treatment)
meta$Tank.num<-as.factor(meta$Tank.num)

#add new col for Clades
 #Pcomp
  meta$Clade[meta$Parent.ID==314]<-"C15cj"
  meta$Clade[meta$Parent.ID==317]<-"C15cj"
  meta$Clade[meta$Parent.ID==319]<-"C15cj"
  meta$Clade[meta$Parent.ID==320]<-"C15cj"
  meta$Clade[meta$Parent.ID==321]<-"C15cj"
  meta$Clade[meta$Parent.ID==322]<-"C15cj"
  meta$Clade[meta$Parent.ID==313]<-"C15n"
  meta$Clade[meta$Parent.ID==315]<-"C15n"
  meta$Clade[meta$Parent.ID==316]<-"C15n"
  meta$Clade[meta$Parent.ID==318]<-"C15n"
  meta$Clade[meta$Parent.ID==323]<-"C15n"
  meta$Clade[meta$Parent.ID==324]<-"C15n"
  
  #Pvar
  meta$Clade[meta$Parent.ID==353]<-"C1"
  meta$Clade[meta$Parent.ID==358]<-"C1"
  meta$Clade[meta$Parent.ID==361]<-"C1"
  meta$Clade[meta$Parent.ID==325]<-"C1"
  meta$Clade[meta$Parent.ID==356]<-"C1"
  meta$Clade[meta$Parent.ID==351]<-"C27"
  meta$Clade[meta$Parent.ID==354]<-"C27"
  meta$Clade[meta$Parent.ID==355]<-"C27"
  meta$Clade[meta$Parent.ID==357]<-"C27"
  meta$Clade[meta$Parent.ID==359]<-"C27"
  meta$Clade[meta$Parent.ID==360]<-"C27"
  meta$Clade[meta$Parent.ID==362]<-"C27"
  
#Pacu
  meta$Clade[meta$Parent.ID==311]<-"C42_2"
  meta$Clade[meta$Parent.ID==301]<-"C1d"
  meta$Clade[meta$Parent.ID==304]<-"C1d"
  meta$Clade[meta$Parent.ID==306]<-"C1d"
  meta$Clade[meta$Parent.ID==303]<-"C1d"
  meta$Clade[meta$Parent.ID==307]<-"C42_2"
  meta$Clade[meta$Parent.ID==308]<-"C1d"
  meta$Clade[meta$Parent.ID==310]<-"C1d"
  meta$Clade[meta$Parent.ID==312]<-"C1d"
  meta$Clade[meta$Parent.ID==302]<-"C1d"
  meta$Clade[meta$Parent.ID==305]<-"C42_2"
  meta$Clade[meta$Parent.ID==309]<-"C42_2"

#Mcap
  meta$Clade[meta$Parent.ID==363]<-"C31"
  meta$Clade[meta$Parent.ID==364]<-"C31D4"
  meta$Clade[meta$Parent.ID==365]<-"C31D4"
  meta$Clade[meta$Parent.ID==366]<-"C31D4"
  meta$Clade[meta$Parent.ID==367]<-"C31"
  meta$Clade[meta$Parent.ID==368]<-"C31D4"
  meta$Clade[meta$Parent.ID==369]<-"C31D4"
  meta$Clade[meta$Parent.ID==370]<-"C31"
  meta$Clade[meta$Parent.ID==371]<-"C31"
  meta$Clade[meta$Parent.ID==372]<-"C31"
  meta$Clade[meta$Parent.ID==373]<-"C31"
  meta$Clade[meta$Parent.ID==374]<-"C31D4"

meta$Clade<-as.factor(meta$Clade)
meta$Clade <- factor(meta$Clade, levels = c("C31", "C31D4", "C15cj","C15n","C1","C27","C1d","C42_2"))


#add tissue thickness, transmission mode, 
  meta$Tissue[meta$Species=="Montipora capitata"]<-"thick"
  meta$Tissue[meta$Species=="Porites compressa"]<-"thick"
  meta$Tissue[meta$Species=="Pavona varians"]<-"thick"
  meta$Tissue[meta$Species=="Pocillopora acuta"]<-"thin"
  meta$Tissue<-as.factor(meta$Tissue)

  meta$transmission[meta$Species=="Montipora capitata"]<-"vertical"
  meta$transmission[meta$Species=="Porites compressa"]<-"vertical"
  meta$transmission[meta$Species=="Pavona varians"]<-"horizontal"
  meta$transmission[meta$Species=="Pocillopora acuta"]<-"vertical"
  meta$transmission<-as.factor(meta$transmission)

  meta$skeleton[meta$Species=="Montipora capitata"]<-"porous"
  meta$skeleton[meta$Species=="Porites compressa"]<-"porous"
  meta$skeleton[meta$Species=="Pavona varians"]<-"self-shading"
  meta$skeleton[meta$Species=="Pocillopora acuta"]<-"non-porous"
  meta$skeleton<-as.factor(meta$skeleton)

  meta$shape[meta$Species=="Montipora capitata"]<-"branch"
  meta$shape[meta$Species=="Porites compressa"]<-"branch"
  meta$shape[meta$Species=="Pavona varians"]<-"encrust"
  meta$shape[meta$Species=="Pocillopora acuta"]<-"small"
  meta$shape<-as.factor(meta$shape)

#write.csv(meta,"meta16s.csv")
#Ashfreedryweight, Wax dipping, Total airbrush volume, metadata

#respiration check

# RespCheck  <- read.csv("Data/RespCheck.csv")
# RespCheckC<-cast(RespCheck, Frag.ID~Time.Point)
# 
# metaResp<-meta
# metaResp<-metaResp[,c("Frag.ID","Time.Point")] # keep only columns you need
# Respcheck3<-merge(metaResp, RespCheckC)
# #write.csv(Respcheck3,"Respcheck3.csv")
  
AFDW <- read.csv("Data/ACE21_AFDW_20210308.csv")
#AFDW <- AFDW[!(AFDW$Frag.ID == "1195"),]
#AFDW <- AFDW[!(AFDW$Frag.ID == "N49"),]
#AFDW <- AFDW[!(AFDW$Frag.ID == "3149"),]
AFDWtest<-merge(meta, AFDW, all = T)
#write.csv(AFDWtest,"AFDWtest.csv")

WaxDipping <- read.csv("Data/WaxDipping_Results_20190403.csv")
#WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "1195"),]
#WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "N49"),]
#WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "3149"),]
#WaxDipping <- WaxDipping[!(WaxDipping$Frag.ID == "634"),]

Slurry <- read.csv("Data/TT17_airbrush_totalVol_20190420.csv")
#Slurry <- Slurry[!(Slurry$Frag.ID == "1195"),]
#Slurry <- Slurry[!(Slurry$Frag.ID == "N49"),]
#Slurry <- Slurry[!(Slurry$Frag.ID == "3149"),]
#Slurry <- Slurry[!(WaxDipping$Frag.ID == "634"),]
Slurrytest<-merge(meta, Slurry, all.x = T)

#merge 
testAFDW<-merge(AFDW, meta, all=T)
#testSlurry<-merge(Slurry, meta, all.y=T)
#testflow<-merge(tData, meta, all.y=T)
#SurfaceArea<-merge(SA, meta, all.y=T)
#write.csv(SurfaceArea, "SurfaceAreaACE21.csv")
```

#Biomass (AFDW and SA)

```{r}
SA<-WaxDipping 
SA<- SA[,c("Frag.ID","Surface.area")] # keep only columns you need

# merge AFDW and slurry
AFDW.slurry <- merge(AFDW, Slurry)
AFDW.slurry$AFDW.mg.ml <- AFDW.slurry$AFDW.g.mL*1000  # grams to mg
AFDW.slurry$AFDWmg <-AFDW.slurry$AFDW.mg.ml*AFDW.slurry$TotalVolume # now we have mg of AFDW
  DUP2<-duplicated(AFDW.slurry$Frag.ID) #look for duplicate entries

# SA cm2 and AFDW g/mL --> mg/cm2
# merge
biomass <- merge(AFDW.slurry, SA)
biomass$Surface.area<-as.numeric(as.character(biomass$Surface.area))
biomass<- biomass[,c("Frag.ID", "AFDWmg", "Surface.area")] # keep only columns you need
biomass$AFDWmg.cm2 <-biomass$AFDWmg/biomass$Surface.area # mg/cm2
 
# merge with metadata to plot by treatments
biomass2 <- merge(biomass, meta)

biomass2_mean <- ddply(biomass2, c("Treatment", "Species", "Time.Point"), summarise, #summarize cell counts
                 N    = length(AFDWmg.cm2[!is.na(AFDWmg.cm2)]), #length of the df, excluding NAs
                 mean = mean(AFDWmg.cm2, na.rm=TRUE), #mean of response variable, removing NAs
                 sd   = sd(AFDWmg.cm2, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(AFDWmg.cm2, na.rm=TRUE) #max
                 )
biomass2_mean 

biomass2_meanClade <- ddply(biomass2, c("Treatment", "Species", "Time.Point","Clade"), summarise, 
                 N    = length(AFDWmg.cm2[!is.na(AFDWmg.cm2)]), 
                 mean = mean(AFDWmg.cm2, na.rm=TRUE), 
                 sd   = sd(AFDWmg.cm2, na.rm=TRUE), 
                 se   = sd / sqrt(N), 
                 max = max(AFDWmg.cm2, na.rm=TRUE) 
)
biomass2_meanClade

#This code is if we want T0 to be both 'amb' and 'high' 
#Mcap_biomass_mean <-Mcap_biomass_mean[-3,] # Remove T0
#biomass2_mean

# Make "BOTH" into Ambeint and High...THIS IS UGLY CODE BUT IT WORKS
# Mcap 
#Mcap_biomass_mean<-subset(biomass2_mean, Species=="Montipora capitata") #Subset Mcap

#Mcap_biomass_mean_Both<-Mcap_biomass_mean #copy df
#row.names.remove <- c("1","2","13","14") #remove high and amb by row numbers
#Mcap_biomass_mean_Both<-Mcap_biomass_mean_Both[!(row.names(Mcap_biomass_mean_Both) %in% row.names.remove), ] #remove

#Mcap_biomass_mean_Both2<-Mcap_biomass_mean_Both # make a copy of the BOTH df
#Mcap_biomass_mean_Both[Mcap_biomass_mean_Both=="Both"]<-"Ambient"  #rename "Both" to "Ambient"
#Mcap_biomass_mean_Both2[Mcap_biomass_mean_Both2=="Both"]<-"High"  #rename "Both" to "High"

#row.names.remove <- c("9") #remove "high and amb by row numbers "both""
#Mcap_biomass_mean<-Mcap_biomass_mean[!(row.names(Mcap_biomass_mean) %in% row.names.remove), ]
#Mcap_biomass_mean<-rbind(Mcap_biomass_mean,Mcap_biomass_mean_Both,Mcap_biomass_mean_Both2) #bind together

#Mcap 
Mcap_biomass_mean<-subset(biomass2_mean, Species=="Montipora capitata") #Subset Mcap
Mcap_biomass_meanClade<-subset(biomass2_meanClade, Species=="Montipora capitata") #Subset Mcap

# Pcomp 
Pcomp_biomass_mean<-subset(biomass2_mean, Species=="Porites compressa") #Subset Pcomp
Pcomp_biomass_meanClade<-subset(biomass2_meanClade, Species=="Porites compressa") #Subset Mcap

# Pacu 
Pacu_biomass_mean<-subset(biomass2_mean, Species=="Pocillopora acuta") #Subset Pacu
Pacu_biomass_meanClade<-subset(biomass2_meanClade, Species=="Pocillopora acuta") #Subset Mcap

# Pvar 
Pvar_biomass_mean<-subset(biomass2_mean, Species=="Pavona varians") #Subset Pvar
Pvar_biomass_meanClade<-subset(biomass2_meanClade, Species=="Pavona varians") #Subset Mcap
```

Stats - T0 is n=6, not n=12. T1 and TF

```{r}
Biomass_stats<-biomass2
biomass_stats_T1TF<-biomass2
biomass_stats_T1TF<-subset(biomass_stats_T1TF, Time.Point=="T1"|Time.Point=="TF")

#t0
biomass_stats_T0<-biomass2
biomass_stats_T0<-subset(biomass_stats_T0, Time.Point=="T0")
hist(biomass_stats_T0$AFDWmg.cm2) 

Biomass_T0_model<-lmer(AFDWmg.cm2~Treatment*Species+(1|Tank.num), biomass_stats_T0)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)

#by algal profile
Biomass_T0_model<-lmer(AFDWmg.cm2~Species*Clade+(1|Tank.num), biomass_stats_T0)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Species*Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#t0 only by species
biomass_stats_T0.mcap<-subset(biomass_stats_T0, Species=="Montipora capitata")
biomass_stats_T0.pcomp<-subset(biomass_stats_T0, Species=="Porites compressa")
biomass_stats_T0.pvar<-subset(biomass_stats_T0, Species=="Pavona varians")
biomass_stats_T0.pacu<-subset(biomass_stats_T0, Species=="Pocillopora acuta")

# T0 by Algal profile ####
#mcap by algal species
Biomass_T0_model<-lmer(AFDWmg.cm2~Clade+(1|Tank.num), biomass_stats_T0.mcap)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
Biomass_T0_model<-lmer(AFDWmg.cm2~Clade+(1|Tank.num), biomass_stats_T0.pcomp)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
Biomass_T0_model<-lmer(AFDWmg.cm2~Clade+(1|Tank.num), biomass_stats_T0.pvar)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
Biomass_T0_model<-lmer(AFDWmg.cm2~Clade+(1|Tank.num), biomass_stats_T0.pacu)
anova(Biomass_T0_model)  #species differ
qqPlot(residuals(Biomass_T0_model)) 
emm<-emmeans(Biomass_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

hist(biomass_stats_T1TF$AFDWmg.cm2) 
# biomass_stats_T1TF$AFDWmg.cm2_log<-log10(biomass_stats_T1TF$AFDWmg.cm2)
# hist(biomass_stats_T1TF$AFDWmg.cm2_log) 

#T1TF by Algal profile ####

Biomass_model<-lmer(AFDWmg.cm2~Time.Point*Treatment*Species*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF)
anova(Biomass_model) 
qqPlot(residuals(Biomass_model)) 

  emm<-emmeans(Biomass_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

# by Species df: biomass_stats_T1TF_Mcap, biomass_stats_T1TF_Pcomp, biomass_stats_T1TF_Pvar, biomass_stats_T1TF_Pacu ####
biomass_stats_T1TF_Mcap<-subset(biomass_stats_T1TF, Species=="Montipora capitata")
  biomass_stats_T1TF_Mcap.C<-subset(biomass_stats_T1TF_Mcap, Clade=="C31")
  biomass_stats_T1TF_Mcap.CD<-subset(biomass_stats_T1TF_Mcap, Clade=="C31D4")
biomass_stats_T1TF_Pcomp<-subset(biomass_stats_T1TF, Species=="Porites compressa")
  biomass_stats_T1TF_Pcomp.C15cj<-subset(biomass_stats_T1TF_Pcomp, Clade=="C15cj")
  biomass_stats_T1TF_Pcomp.C15n<-subset(biomass_stats_T1TF_Pcomp, Clade=="C15n")
biomass_stats_T1TF_Pvar<-subset(biomass_stats_T1TF, Species=="Pavona varians")
  biomass_stats_T1TF_Pvar.C1<-subset(biomass_stats_T1TF_Pvar, Clade=="C1")
  biomass_stats_T1TF_Pvar.C27<-subset(biomass_stats_T1TF_Pvar, Clade=="C27")
biomass_stats_T1TF_Pacu<-subset(biomass_stats_T1TF, Species=="Pocillopora acuta")
  biomass_stats_T1TF_Pacu.CCC<-subset(biomass_stats_T1TF_Pacu, Clade=="C1D")
  biomass_stats_T1TF_Pacu.C42<-subset(biomass_stats_T1TF_Pacu, Clade=="C42_2")
  
#mcap by algal profile####
Biomass_Mcap_model<-lmer(AFDWmg.cm2~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Mcap)
  anova(Biomass_Mcap_model) 
  qqPlot(residuals(Biomass_Mcap_model)) 
  emm<-emmeans(Biomass_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Biomass_Mcap_model<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Mcap)
  anova(Biomass_Mcap_model) 
  qqPlot(residuals(Biomass_Mcap_model)) 
  emm<-emmeans(Biomass_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

#T1 only
  biomass_stats_Mcap.T1<-subset(biomass_stats_T1TF_Mcap, Time.Point=="T1")
   Biomass_Mcap_model.T1<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Mcap.T1)
  anova(Biomass_Mcap_model.T1) 
    Biomass_Mcap_model.T1<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Mcap.T1)
  anova(Biomass_Mcap_model.T1) 
  qqPlot(residuals(Biomass_Mcap_model.T1)) 
  emm<-emmeans(Biomass_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
biomass_stats_Mcap.TF<-subset(biomass_stats_T1TF_Mcap, Time.Point=="TF")
Biomass_Mcap_model.TF<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
Biomass_Mcap_model.TF<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
  qqPlot(residuals(Biomass_Mcap_model.TF)) 
  emm<-emmeans(Biomass_Mcap_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#mcap-C only
  Biomass_Mcap_model.C<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Mcap.C)
  anova(Biomass_Mcap_model.C) 
  qqPlot(residuals(Biomass_Mcap_model.C)) 
    emm<-emmeans(Biomass_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  Biomass_Mcap_model.CD<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Mcap.CD)
  anova(Biomass_Mcap_model.CD) 
  qqPlot(residuals(Biomass_Mcap_model.CD)) 
    emm<-emmeans(Biomass_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)*
    pairs(emm)
    
#Pcomp ####
#lmer
Biomass_Pcomp_model<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pcomp)
  anova(Biomass_Pcomp_model) 
  qqPlot(residuals(Biomass_Pcomp_model)) 
  emm<-emmeans(Biomass_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Biomass_Pcomp_model.Clade<-lmer(AFDWmg.cm2~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pcomp)
  anova(Biomass_Pcomp_model.Clade) 
  qqPlot(residuals(Biomass_Pcomp_model.Clade)) 
  emm<-emmeans(Biomass_Pcomp_model.Clade,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#T1 only
  biomass_stats_Pcomp.T1<-subset(biomass_stats_T1TF_Pcomp, Time.Point=="T1")
  Biomass_Pcomp_model.T1<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pcomp.T1)
  anova(Biomass_Pcomp_model.T1) 
    Biomass_Pcomp_model.T1<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pcomp.T1)
  anova(Biomass_Pcomp_model.T1) 
  qqPlot(residuals(Biomass_Pcomp_model.T1)) 
  emm<-emmeans(Biomass_Pcomp_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    biomass_stats_Pcomp.TF<-subset(biomass_stats_T1TF_Pcomp, Time.Point=="TF")
Biomass_Pcomp_model.TF<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pcomp.TF)
  anova(Biomass_Pcomp_model.TF) 
  Biomass_Pcomp_model.TF<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pcomp.TF)
  anova(Biomass_Pcomp_model.TF) 
  qqPlot(residuals(Biomass_Pcomp_model.TF)) 
  emm<-emmeans(Biomass_Pcomp_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)    
    
    
    
    
    
 ## pcompphylotype ####   
#Pcomp-C15cj only
  Biomass_Pcomp_model.C15cj<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pcomp.C15cj)
  anova(Biomass_Pcomp_model.C15cj) 
  qqPlot(residuals(Biomass_Pcomp_model.C15cj)) 
    emm<-emmeans(Biomass_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  Biomass_Pcomp_model.C15n<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pcomp.C15n)
  anova(Biomass_Pcomp_model.C15n) 
  qqPlot(residuals(Biomass_Pcomp_model.C15n)) 
    emm<-emmeans(Biomass_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pvar  ####
#lmer
Biomass_Pvar_model<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pvar)
  anova(Biomass_Pvar_model) 
  qqPlot(residuals(Biomass_Pvar_model)) 
  emm<-emmeans(Biomass_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

#T1 only
  biomass_stats_Pvar.T1<-subset(biomass_stats_T1TF_Pvar, Time.Point=="T1")
   Biomass_Pvar_model.T1<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pvar.T1)
  anova(Biomass_Pvar_model.T1) 
  
    Biomass_Pvar_model.T1<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pvar.T1)
  anova(Biomass_Pvar_model.T1) 
  qqPlot(residuals(Biomass_Pvar_model.T1)) 
  emm<-emmeans(Biomass_Pvar_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    biomass_stats_Pvar.TF<-subset(biomass_stats_T1TF_Pvar, Time.Point=="TF")
    
Biomass_Pvar_model.TF<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pvar.TF)
  anova(Biomass_Pvar_model.TF) 
  Biomass_Pvar_model.TF<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pvar.TF)
  anova(Biomass_Pvar_model.TF) 
  qqPlot(residuals(Biomass_Pvar_model.TF)) 
  
  emm<-emmeans(Biomass_Pvar_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  emm<-emmeans(Biomass_Pvar_model.TF,  ~ Clade*Treatment, adjust="Tukey")

  
    
#Pvar-C only ####
  Biomass_Pvar_model.C1<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pvar.C1)
  anova(Biomass_Pvar_model.C1) 
  qqPlot(residuals(Biomass_Pvar_model.C1)) 
    emm<-emmeans(Biomass_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  Biomass_Pvar_model.C27<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pvar.C27)
  anova(Biomass_Pvar_model.C27) 
  qqPlot(residuals(Biomass_Pvar_model.C27)) 
    emm<-emmeans(Biomass_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#Pacu ####
#lmer
    Biomass_Pacu_model<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pacu)
  anova(Biomass_Pacu_model)
Biomass_Pacu_model<-lmer(AFDWmg.cm2~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pacu)
  anova(Biomass_Pacu_model) 
  qqPlot(residuals(Biomass_Pacu_model)) 
  emm<-emmeans(Biomass_Pacu_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
#T1 only
  biomass_stats_Pacu.T1<-subset(biomass_stats_T1TF_Pacu, Time.Point=="T1")
  Biomass_Pacu_model.T1<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pacu.T1)
  anova(Biomass_Pacu_model.T1) 
    Biomass_Pacu_model.T1<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pacu.T1)
  anova(Biomass_Pacu_model.T1) 
  qqPlot(residuals(Biomass_Pacu_model.T1)) 
  emm<-emmeans(Biomass_Pacu_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    biomass_stats_Pacu.TF<-subset(biomass_stats_T1TF_Pacu, Time.Point=="TF")
Biomass_Pacu_model.TF<-lmer(AFDWmg.cm2~Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pacu.TF)
  anova(Biomass_Pacu_model.TF) 
  Biomass_Pacu_model.TF<-lmer(AFDWmg.cm2~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), biomass_stats_Pacu.TF)
  anova(Biomass_Pacu_model.TF) 
  qqPlot(residuals(Biomass_Pacu_model.TF)) 
  emm<-emmeans(Biomass_Pacu_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#Pacu-CCC only
  Biomass_Pacu_model.CCC<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pacu.CCC)
  anova(Biomass_Pacu_model.CCC) 
  qqPlot(residuals(Biomass_Pacu_model.CCC)) 
    emm<-emmeans(Biomass_Pacu_model.CCC,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  Biomass_Pacu_model.C42<-lmer(AFDWmg.cm2~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), biomass_stats_T1TF_Pacu.C42)
  anova(Biomass_Pacu_model.C42) 
  qqPlot(residuals(Biomass_Pacu_model.C42)) 
    emm<-emmeans(Biomass_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    





```

PLOTS

```{r}
#t0 only#### 
biomass_T0<-subset(biomass2, Time.Point=="T0") 
biomass_T0_mean <- ddply(biomass_T0, c( "Species"), summarise, 
                 N    = length(AFDWmg.cm2[!is.na(AFDWmg.cm2)]), 
                 mean = mean(AFDWmg.cm2, na.rm=TRUE), 
                 sd   = sd(AFDWmg.cm2, na.rm=TRUE), 
                 se   = sd / sqrt(N), 
                 max = max(AFDWmg.cm2, na.rm=TRUE) 
)
biomass_T0_mean

#2/16/24 boxplot ####
#T0 only
  ggplot(biomass_T0, aes(x=Species, y=AFDWmg.cm2, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Ash-free Dry Weight")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("Biomass_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(biomass_T0, aes(x=interaction(Clade, Species), y=AFDWmg.cm2, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle("Ash-free Dry Weight by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
  
ggsave("Biomass_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
  
#all species ####

#Plots T1 and TF
biomass_T1TF<-subset(biomass2, Time.Point!="T0") 

#T1TF - by species ####
BiomassT1TF<- ggplot(biomass_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Biomass")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");BiomassT1TF



#Subset by time 1 or F only ####
biomass_T1<-subset(biomass2, Time.Point=="T1") 
biomass_TF<-subset(biomass2, Time.Point=="TF") 

#T1 - by species
BiomassT1<-ggplot(biomass_T1, aes(x=Species, y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Ash-free Dry Weight Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)

#T1 - by species and algal profile - make for each species and then cowplot####
biomass_T1_mcap<-subset(biomass_T1, Species=="Montipora capitata") 
biomass_T1_pcomp<-subset(biomass_T1, Species=="Porites compressa") 
biomass_T1_pvar<-subset(biomass_T1, Species=="Pavona varians") 
biomass_T1_pacu<-subset(biomass_T1, Species=="Pocillopora acuta") 

#Mcap ####
AFDW_Mcap_plot<- 
  ggplot(biomass_T1_mcap, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");AFDW_Mcap_plot
  
#Pcomp ####
AFDW_Pcomp_plot<- ggplot(biomass_T1_pcomp, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pcomp_plot

#Pvar ####
AFDW_Pvar_plot<- ggplot(biomass_T1_pvar, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pvar_plot

#Pacu ####
AFDW_Pacu_plot<- ggplot(biomass_T1_pacu, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pacu_plot

plot_row<-plot_grid(AFDW_Mcap_plot, AFDW_Pcomp_plot, AFDW_Pvar_plot, AFDW_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Ash-free Dry Weight T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("AFDW_profiles_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF
      ggplot(biomass_TF, aes(x=Species, y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Ash-free Dry Weight Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)

#TF - by species and algal profile - make for each species and then cowplot####
      
      #TF - by species
BiomassTF<-ggplot(biomass_TF, aes(x=Species, y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      #ggtitle("Ash-free Dry Weight Post-Recovery Temperatures")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);BiomassTF
      
      
biomass_TF_mcap<-subset(biomass_TF, Species=="Montipora capitata") 
biomass_TF_pcomp<-subset(biomass_TF, Species=="Porites compressa") 
biomass_TF_pvar<-subset(biomass_TF, Species=="Pavona varians") 
biomass_TF_pacu<-subset(biomass_TF, Species=="Pocillopora acuta") 

#Mcap ####
AFDW_Mcap_plot<- 
  ggplot(biomass_TF_mcap, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Ash-free Dry Weight '(mg~cm^2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");AFDW_Mcap_plot
  
#Pcomp ####
AFDW_Pcomp_plot<- ggplot(biomass_TF_pcomp, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pcomp_plot

#Pvar ####
AFDW_Pvar_plot<- ggplot(biomass_TF_pvar, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pvar_plot

#Pacu ####
AFDW_Pacu_plot<- ggplot(biomass_TF_pacu, aes(x=interaction(Treatment,Clade), y=AFDWmg.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);AFDW_Pacu_plot

plot_row<-plot_grid(AFDW_Mcap_plot, AFDW_Pcomp_plot, AFDW_Pvar_plot, AFDW_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Ash-free Dry Weight TF", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  AFDW_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));AFDW_profilesTF

ggsave("AFDW_profiles_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```


# Flow cytometry cell counts

```{r}
#import data
Std.curve <- read.csv("Data/standard_curve_fcm20181312.csv")

###notes: 2289 isn't anywhere. 

PlateA <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateA.csv")
PlateA <- subset(PlateA, Gate.Name == "Symbiodinium")       # keep only Symbiodinium rows
keepA <- c("Sample.Name", "Concentration") # keep only Sample.name and concentration
PlateA <- PlateA[keepA]
A_meta <- read.csv("Data/TT17_FC_PlateA.csv") # load Plate A location data
PlateA <- merge(PlateA, A_meta)   # merge with location data
PlateA <-merge(PlateA, meta, all.x = TRUE) # merge with Sample metadata
PlateA <- na.omit(PlateA) # omit NAs
PlateA<- PlateA[!(PlateA$Frag.ID == "1133"),] # redid in plate E
PlateA<- PlateA[!(PlateA$Frag.ID == "N172"),] # redid in plate E


PlateB <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateB1.csv")
PlateB$Concentration<-as.numeric(as.character(PlateB$Concentration)) # this is loading in as a factor, not sure why
PlateB <- subset(PlateB, Gate.Name == "Symbiodinium")
keepB <- c("Sample.Name", "Concentration")
PlateB <- PlateB[keepB]
B_meta <- read.csv("Data/TT17_FC_PlateB.csv") # lood Plate B location data
PlateB <- merge(PlateB, B_meta)
PlateB <-merge(PlateB, meta, all.x = TRUE)
PlateB <- na.omit(PlateB)
PlateB<- PlateB[!(PlateB$Frag.ID == "428"),] # redid in plate E

PlateC <- read.csv("Data/Symbio.Counts.Dec.14.2018.PlateCredo.csv")
PlateC$Concentration<-as.numeric(as.character(PlateC$Concentration)) # this is loading in as a factor, not sure why
PlateC <- subset(PlateC, Gate.Name == "Symbiodinium")
keepC <- c("Sample.Name", "Concentration")
PlateC <- PlateC[keepC]
C_meta <- read.csv("Data/TT17_FC_PlateCredo.csv") # lood Plate C location data
PlateC <- merge(PlateC, C_meta)
PlateC <-merge(PlateC, meta, all.x = TRUE)
PlateC <- na.omit(PlateC)
PlateC<- PlateC[!(PlateC$Frag.ID == "3481"),] # redid in plate E
PlateC<- PlateC[!(PlateC$Frag.ID == "49"),] # redid in plate E
PlateC<- PlateC[!(PlateC$Frag.ID == "N49"),] # redid in plate E

#note: Frag.ID 403 Pacu seems abnormally high

PlateE <- read.csv("Data/Symbio.Count.apr.02.2019.PlateE.csv")
PlateE$Concentration<-as.numeric(as.character(PlateE$Concentration)) # this is loading in as a factor, not sure why
PlateE <- subset(PlateE, Gate.Name == "Symbiodinium")
keepE <- c("Sample.Name", "Concentration")
PlateE <- PlateE[keepE]
E_meta <- read.csv("Data/TT17_FC_PlateE.csv") # lood Plate A location data
PlateE <- merge(PlateE, E_meta)
PlateE <-merge(PlateE, meta, all.x = TRUE)
PlateE <- na.omit(PlateE)

# Bind all runs together
tData <- rbind(PlateA, PlateB, PlateC, PlateE)
tData$Parent.ID<- as.factor(tData$Parent.ID) #for some reason, "Concentration" was a chr not numeric. Check by calling str()

# Create column to relate to standard curve
tData$corrected <- tData$Concentration*3.2959 # <- also confirm you did this correctly. 

# Use Slurry
#merge with tdata
tData <- merge(tData, Slurry)
tData$TotalVolume <- tData$TotalVolume * 1000 # change total volume to from mL to uL

#write.csv(tData,"FLOW.csv")
#use SA for slurry

#merge with tData, make numeric
tData <- merge(tData, SA)
tData$Surface.area<- as.numeric(as.character(tData$Surface.area))
duplicated(tData$Frag.ID) #check 428 Pacu TF, N172mcap T1,1133 mcap t1

#add biomass to try standardizing by biomass 
Biomass4FC<-subset(biomass, select=c("Frag.ID","AFDWmg.cm2"))
tData <- merge(tData, Biomass4FC)

#write.csv(tData, "tdataCHECK.csv")
#Subset by Species and correct for 10% dilutions in Mcap and Pcomp
Mcap_FC <- subset(tData, Species == "Montipora capitata")
Mcap_FC$corrected <- Mcap_FC$corrected*10 # to compensate for the 10% dultion

Pcomp_FC <- subset(tData, Species == "Porites compressa")
Pcomp_FC$corrected <- Pcomp_FC$corrected*10 # to compensate for the 10% dultion

Pvar_FC <- subset(tData, Species == "Pavona varians") #not diluted
Pacu_FC <- subset(tData, Species == "Pocillopora acuta") #not diluted

# Create new column for total cells in total slurry
Mcap_FC$Tot.zoox <- Mcap_FC$corrected*(Mcap_FC$TotalVolume)
Pcomp_FC$Tot.zoox <- Pcomp_FC$corrected*(Pcomp_FC$TotalVolume)
Pvar_FC$Tot.zoox <- Pvar_FC$corrected*(Pvar_FC$TotalVolume)
Pacu_FC$Tot.zoox <- Pacu_FC$corrected*(Pacu_FC$TotalVolume)

# Calculate zoox/cm2
Mcap_FC$zoox.cm2<-Mcap_FC$Tot.zoox/Mcap_FC$Surface.area
Pcomp_FC$zoox.cm2<-Pcomp_FC$Tot.zoox/Pcomp_FC$Surface.area
Pvar_FC$zoox.cm2<-Pvar_FC$Tot.zoox/Pvar_FC$Surface.area
Pacu_FC$zoox.cm2<-Pacu_FC$Tot.zoox/Pacu_FC$Surface.area

# Calculate zoox/biomass
Mcap_FC$zoox.AFDWmg.cm2<-Mcap_FC$Tot.zoox/Mcap_FC$AFDWmg.cm2
Pcomp_FC$zoox.AFDWmg.cm2<-Pcomp_FC$Tot.zoox/Pcomp_FC$AFDWmg.cm2
Pvar_FC$zoox.AFDWmg.cm2<-Pvar_FC$Tot.zoox/Pvar_FC$AFDWmg.cm2
Pacu_FC$zoox.AFDWmg.cm2<-Pacu_FC$Tot.zoox/Pacu_FC$AFDWmg.cm2

FC_Data <- rbind(Mcap_FC, Pcomp_FC, Pvar_FC, Pacu_FC) #combine

```

```{r}
FC_Data$Species<-as.factor(FC_Data$Species)
FC_Data$Species <- factor(FC_Data$Species, levels = c("Montipora capitata", "Porites compressa", "Pavona varians","Pocillopora acuta"))
FC_Data$Clade <- factor(FC_Data$Clade, levels = c("C31", "C31D4", "C15cj","C15n","C1","C27","C1d","C42_2"))





```

Stats

```{r}

#T0 only
FC_stats_T0<-subset(FC_Data, Time.Point=="T0")
FC_stats_T0$zoox.cm2_log<-log10(FC_stats_T0$zoox.cm2+1)
hist(FC_stats_T0$zoox.cm2_log) #normal (use)

#t0 only
FC_T0_model<-lmer(zoox.cm2_log~Treatment*Species+(1|Tank.num), FC_stats_T0)
anova(FC_T0_model)  #species differ
qqPlot(residuals(FC_T0_model)) 
emm<-emmeans(FC_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)


#t0 only by species?
FC_stats_T0.mcap<-subset(FC_stats_T0, Species=="Montipora capitata")
FC_stats_T0.pcomp<-subset(FC_stats_T0, Species=="Porites compressa")
FC_stats_T0.pvar<-subset(FC_stats_T0, Species=="Pavona varians")
FC_stats_T0.pacu<-subset(FC_stats_T0, Species=="Pocillopora acuta")

#mcap
FC_T0_model<-lmer(zoox.cm2_log~Clade+(1|Tank.num), FC_stats_T0.mcap)
anova(FC_T0_model)  #species differ
qqPlot(residuals(FC_T0_model)) 
emm<-emmeans(FC_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
FC_T0_model<-lmer(zoox.cm2_log~Clade+(1|Tank.num), FC_stats_T0.pcomp)
anova(FC_T0_model)  #species differ
qqPlot(residuals(FC_T0_model)) 
emm<-emmeans(FC_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
FC_T0_model<-lmer(zoox.cm2_log~Clade+(1|Tank.num), FC_stats_T0.pvar)
anova(FC_T0_model)  #species differ
qqPlot(residuals(FC_T0_model)) 
emm<-emmeans(FC_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
FC_T0_model<-lmer(zoox.cm2_log~Clade+(1|Tank.num), FC_stats_T0.pacu)
anova(FC_T0_model)  #species differ
qqPlot(residuals(FC_T0_model)) 
emm<-emmeans(FC_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)












# models T1Tf####
 
hist(FC_Data$zoox.cm2) 
FC_Data$zoox.cm2_log<-log10(FC_Data$zoox.cm2+1)
hist(FC_Data$zoox.cm2_log) #normal (use)

FC_stats_T1TF<-subset(FC_Data, Time.Point=="T1"|Time.Point=="TF")

#test adding traits - not running 20250204
FC_stats_T1TF$tissue[FC_stats_T1TF$Species == "Montipora capitata"] <- "thick"  
FC_stats_T1TF$tissue[FC_stats_T1TF$Species == "Porites compressa"] <- "thick"  
FC_stats_T1TF$tissue[FC_stats_T1TF$Species == "Pavona varians"] <- "thin"  
FC_stats_T1TF$tissue[FC_stats_T1TF$Species == "Pocillopora acuta"] <- "thin"  
FC_stats_T1TF$tissue<-as.factor(FC_stats_T1TF$tissue)
FC_stats_T1TF$skeleton[FC_stats_T1TF$Species == "Montipora capitata"] <- "porous"  
FC_stats_T1TF$skeleton[FC_stats_T1TF$Species == "Porites compressa"] <- "porous"  
FC_stats_T1TF$skeleton[FC_stats_T1TF$Species == "Pavona varians"] <- "porous"  
FC_stats_T1TF$skeleton[FC_stats_T1TF$Species == "Pocillopora acuta"] <- "nonporous"  
FC_stats_T1TF$skeleton<-as.factor(FC_stats_T1TF$skeleton)

CellCount_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Species*skeleton+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF)
anova(CellCount_model) 
qqPlot(residuals(CellCount_model)) 



## T1TF mods
CellCount_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF)
anova(CellCount_model) 
qqPlot(residuals(CellCount_model)) 

  emm<-emmeans(CellCount_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

CellCount_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Species*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF)
anova(CellCount_model) 




# by Species df: FC_stats_T1TF_Mcap, FC_stats_T1TF_Pcomp, FC_stats_T1TF_Pvar, FC_stats_T1TF_Pacu
FC_stats_T1TF_Mcap<-subset(FC_stats_T1TF, Species=="Montipora capitata")
  FC_stats_T1TF_Mcap.C<-subset(FC_stats_T1TF_Mcap, Clade=="C31")
  FC_stats_T1TF_Mcap.CD<-subset(FC_stats_T1TF_Mcap, Clade=="C31D4")
FC_stats_T1TF_Pcomp<-subset(FC_stats_T1TF, Species=="Porites compressa")
  FC_stats_T1TF_Pcomp.C15cj<-subset(FC_stats_T1TF_Pcomp, Clade=="C15cj")
  FC_stats_T1TF_Pcomp.C15n<-subset(FC_stats_T1TF_Pcomp, Clade=="C15n")
FC_stats_T1TF_Pvar<-subset(FC_stats_T1TF, Species=="Pavona varians")
  FC_stats_T1TF_Pvar.C1<-subset(FC_stats_T1TF_Pvar, Clade=="C1")
  FC_stats_T1TF_Pvar.C27<-subset(FC_stats_T1TF_Pvar, Clade=="C27")
FC_stats_T1TF_Pacu<-subset(FC_stats_T1TF, Species=="Pocillopora acuta")
  FC_stats_T1TF_Pacu.CCC<-subset(FC_stats_T1TF_Pacu, Clade=="C1d")
  FC_stats_T1TF_Pacu.C42<-subset(FC_stats_T1TF_Pacu, Clade=="C42_2")
  
#mcap ####
#lmer
  FC_Mcap_model<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Mcap)
  anova(FC_Mcap_model) 
FC_Mcap_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Mcap)
  anova(FC_Mcap_model) 
  qqPlot(residuals(FC_Mcap_model)) 
  emm<-emmeans(FC_Mcap_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

#T1 only
  FC_stats_Mcap.T1<-subset(FC_stats_T1TF_Mcap, Time.Point=="T1")
      FC_Mcap_model.T1<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Mcap.T1)
  anova(FC_Mcap_model.T1) 
    FC_Mcap_model.T1<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Mcap.T1)
  anova(FC_Mcap_model.T1) 
  qqPlot(residuals(FC_Mcap_model.T1)) 
  emm<-emmeans(FC_Mcap_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    FC_stats_Mcap.TF<-subset(FC_stats_T1TF_Mcap, Time.Point=="TF")
  FC_Mcap_model.TF<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Mcap.TF)
  anova(FC_Mcap_model.TF) 
  FC_Mcap_model.TF<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Mcap.TF)
  anova(FC_Mcap_model.TF) 
  qqPlot(residuals(FC_Mcap_model.TF)) 
  emm<-emmeans(FC_Mcap_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
  
  
#mcap-C only
  FC_Mcap_model.C<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Mcap.C)
  anova(FC_Mcap_model.C) 
  qqPlot(residuals(FC_Mcap_model.C)) 
    emm<-emmeans(FC_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  FC_Mcap_model.CD<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Mcap.CD)
  anova(FC_Mcap_model.CD) 
  qqPlot(residuals(FC_Mcap_model.CD)) 
    emm<-emmeans(FC_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)*
    pairs(emm)
    
#Pcomp ####
#lmer
FC_Pcomp_model<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pcomp)
  anova(FC_Pcomp_model) 
  qqPlot(residuals(FC_Pcomp_model)) 
  emm<-emmeans(FC_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

FC_Pcomp_model.Clade<-lmer(zoox.cm2_log~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pcomp)
  anova(FC_Pcomp_model.Clade) 
  qqPlot(residuals(FC_Pcomp_model.Clade)) 
  emm<-emmeans(FC_Pcomp_model.Clade,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
 #T1 only
  FC_stats_Pcomp.T1<-subset(FC_stats_T1TF_Pcomp, Time.Point=="T1")
    FC_Pcomp_model.T1<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pcomp.T1)
  anova(FC_Pcomp_model.T1) 
    FC_Pcomp_model.T1<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pcomp.T1)
  anova(FC_Pcomp_model.T1) 
  qqPlot(residuals(FC_Pcomp_model.T1)) 
  emm<-emmeans(FC_Pcomp_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  #TF only
    FC_stats_Pcomp.TF<-subset(FC_stats_T1TF_Pcomp, Time.Point=="TF")
FC_Pcomp_model.TF<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pcomp.TF)
  anova(FC_Pcomp_model.TF) 
  FC_Pcomp_model.TF<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pcomp.TF)
  anova(FC_Pcomp_model.TF) 
  qqPlot(residuals(FC_Pcomp_model.TF)) 
  emm<-emmeans(FC_Pcomp_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
     
    
    
#Pcomp-C15cj only
  FC_Pcomp_model.C15cj<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pcomp.C15cj)
  anova(FC_Pcomp_model.C15cj) 
  qqPlot(residuals(FC_Pcomp_model.C15cj)) 
    emm<-emmeans(FC_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C15cj only
  FC_Pcomp_model.C15n<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pcomp.C15n)
  anova(FC_Pcomp_model.C15n) 
  qqPlot(residuals(FC_Pcomp_model.C15n)) 
    emm<-emmeans(FC_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pvar ####
#lmer
FC_Pvar_model<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pvar)
  anova(FC_Pvar_model) 
  qqPlot(residuals(FC_Pvar_model)) 
  emm<-emmeans(FC_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  FC_Pvar_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pvar)
  anova(FC_Pvar_model) 
  qqPlot(residuals(FC_Pvar_model)) 
  emm<-emmeans(FC_Pvar_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

#T1 only
  FC_stats_Pvar.T1<-subset(FC_stats_T1TF_Pvar, Time.Point=="T1")
   FC_Pvar_model.T1<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pvar.T1)
  anova(FC_Pvar_model.T1) 
    FC_Pvar_model.T1<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pvar.T1)
  anova(FC_Pvar_model.T1) 
  qqPlot(residuals(FC_Pvar_model.T1)) 
  emm<-emmeans(FC_Pvar_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    FC_stats_Pvar.TF<-subset(FC_stats_T1TF_Pvar, Time.Point=="TF")
  FC_Pvar_model.TF<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pvar.TF)
  anova(FC_Pvar_model.TF) 
  FC_Pvar_model.TF<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pvar.TF)
  anova(FC_Pvar_model.TF) 
  qqPlot(residuals(FC_Pvar_model.TF)) 
  emm<-emmeans(FC_Pvar_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#Pvar-C1 only  run models above not with timepoint...
  FC_Pvar_model.C1<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pvar.C1)
  anova(FC_Pvar_model.C1) 
  qqPlot(residuals(FC_Pvar_model.C1)) 
    emm<-emmeans(FC_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  FC_Pvar_model.C27<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pvar.C27)
  anova(FC_Pvar_model.C27) 
  qqPlot(residuals(FC_Pvar_model.C27)) 
    emm<-emmeans(FC_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#Pacu ####
#lmer 
    FC_Pacu_model<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pacu)
  anova(FC_Pacu_model)
  emm<-emmeans(FC_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
FC_Pacu_model<-lmer(zoox.cm2_log~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pacu)
  anova(FC_Pacu_model) 
  qqPlot(residuals(FC_Pacu_model)) 
  emm<-emmeans(FC_Pacu_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm) 

  #T1 only
  FC_stats_Pacu.T1<-subset(FC_stats_T1TF_Pacu, Time.Point=="T1")
  FC_Pacu_model.T1<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pacu.T1)
  anova(FC_Pacu_model.T1)
    FC_Pacu_model.T1<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pacu.T1)
  anova(FC_Pacu_model.T1) 
  qqPlot(residuals(FC_Pacu_model.T1)) 
  emm<-emmeans(FC_Pacu_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  emm<-emmeans(FC_Pacu_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    FC_stats_Pacu.TF<-subset(FC_stats_T1TF_Pacu, Time.Point=="TF")
FC_Pacu_model.TF<-lmer(zoox.cm2_log~Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_Pacu.TF)
  anova(FC_Pacu_model.TF) 
  FC_Pacu_model.TF<-lmer(zoox.cm2_log~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), FC_stats_Pacu.TF)
  anova(FC_Pacu_model.TF) 
  qqPlot(residuals(FC_Pacu_model.TF)) 
  emm<-emmeans(FC_Pacu_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
#Pacu-CCC only
  FC_Pacu_model.CCC<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pacu.CCC)
  anova(FC_Pacu_model.CCC) 
  qqPlot(residuals(FC_Pacu_model.CCC)) 
    emm<-emmeans(FC_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  FC_Pacu_model.C42<-lmer(zoox.cm2_log~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), FC_stats_T1TF_Pacu.C42)
  anova(FC_Pacu_model.C42) 
  qqPlot(residuals(FC_Pacu_model.C42)) 
    emm<-emmeans(FC_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    

```

Plots - FC standardized by Surface Area

```{r}
#just T0 ####  
FC_Data_T0<-subset(FC_Data, Time.Point=="T0")
FC_T0_mean <- ddply(FC_Data_T0, c( "Species"), summarise, 
                 N    = length(zoox.cm2[!is.na(zoox.cm2)]), 
                 mean = mean(zoox.cm2, na.rm=TRUE), 
                 sd   = sd(zoox.cm2, na.rm=TRUE), 
                 se   = sd / sqrt(N), 
                 max = max(zoox.cm2, na.rm=TRUE) 
);FC_T0_mean

#T0 only
  ggplot(FC_Data_T0, aes(x=Species, y=zoox.cm2, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Symbiodiniaceae Cell Density")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("FC_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T0 only - by algal profile
ggplot(FC_Data_T0, aes(x=interaction(factor(Species, levels=unique(Species)), Clade), y=zoox.cm2, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote('Symbiodiniaceae cells '(cm^-2)))+
      theme(plot.title = element_text(size=16, face="bold"))+
       theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      ggtitle("Symbiodiniaceae Cell Density by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
    scale_x_discrete(guide = "axis_nested")
  
ggsave("FC_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#Subset by time 1 or F only 
FC_T1<-subset(FC_Data, Time.Point=="T1") 
FC_TF<-subset(FC_Data, Time.Point=="TF") 


#Plots T1 and TF
flow_T1TF<-subset(FC_Data, Time.Point!="T0") 

#T1TF - by species ####
flowT1TF<- ggplot(flow_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Symbiodiniaceae Cell Density")+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2) ~ (log[10])))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");flowT1TF

FlowT1TF<-flowT1TF + scale_y_log10();FlowT1TF #to make more readble

#T1 - by species  ####
FlowT1<-ggplot(FC_T1, aes(x=Species, y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Symbiodiniaceae Cell Density Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2) ~ (log[10])))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);FlowT1

FlowT1<-FlowT1 + scale_y_log10();FlowT1 #to make more readble


ggsave("FC_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot
FC_T1_mcap<-subset(FC_T1, Species=="Montipora capitata") 
FC_T1_pcomp<-subset(FC_T1, Species=="Porites compressa") 
FC_T1_pvar<-subset(FC_T1, Species=="Pavona varians") 
FC_T1_pacu<-subset(FC_T1, Species=="Pocillopora acuta") 

#Mcap ####
FC_Mcap_plot<- 
  ggplot(FC_T1_mcap, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");FC_Mcap_plot
  
#Pcomp####
FC_Pcomp_plot<- ggplot(FC_T1_pcomp, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pcomp_plot

#Pvar####
FC_Pvar_plot<- ggplot(FC_T1_pvar, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pvar_plot

#Pacu####
FC_Pacu_plot<- ggplot(FC_T1_pacu, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pacu_plot

plot_row<-plot_grid(FC_Mcap_plot, FC_Pcomp_plot, FC_Pvar_plot, FC_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Symbiodiniaceae Cell Density T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("FC_profiles_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
     FlowTF<- ggplot(FC_TF, aes(x=Species, y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Symbiodiniaceae Cell Density Post-Recovery")+
      xlab("") + #Label the X Axis  
      ylab(bquote('Symbiodiniaceae cells '(cm^-2) ~ (log[10])))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);FlowTF

FlowTF<-FlowTF + scale_y_log10();FlowTF

ggsave("FC_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
FC_TF_mcap<-subset(FC_TF, Species=="Montipora capitata") 
FC_TF_pcomp<-subset(FC_TF, Species=="Porites compressa") 
FC_TF_pvar<-subset(FC_TF, Species=="Pavona varians") 
FC_TF_pacu<-subset(FC_TF, Species=="Pocillopora acuta") 

#Mcap 
FC_Mcap_plot<- 
  ggplot(FC_TF_mcap, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");FC_Mcap_plot
  
#Pcomp
FC_Pcomp_plot<- ggplot(FC_TF_pcomp, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pcomp_plot

#Pvar
FC_Pvar_plot<- ggplot(FC_TF_pvar, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pvar_plot

#Pacu
FC_Pacu_plot<- ggplot(FC_TF_pacu, aes(x=interaction(Treatment,Clade), y=zoox.cm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);FC_Pacu_plot

plot_row<-plot_grid(FC_Mcap_plot, FC_Pcomp_plot, FC_Pvar_plot, FC_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Ash-free Dry Weight TF", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  FC_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));FC_profilesTF

ggsave("FC_profiles_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```

#Buoyant Weight/Calcification

```{r}
#calibration
BWCalData <- read.csv('Data/Bouyant_weight_calibration_curve.csv')
#Data with Standard weights in grams in deionized water, saltwater, and the temp that they were measured at
 
### Standard Curve
#plot relationship between temp and Standard in fresh and salt water
plot(BWCalData$Temp, BWCalData$StandardSalt, col = 'red', ylab = 'Salt Weight (g)', xlab = 'Temp C')
par(new=TRUE)
plot(BWCalData$Temp, BWCalData$StandardFresh, col = 'blue',xaxt="n",yaxt="n",xlab="",ylab="")
axis(4)
mtext("'Fresh Weight (g)'",side=4,line=3)
legend("topleft",col=c("red","blue"),lty=1,legend=c("Salt","Fresh"), bty = "n")

#linear regression between temp and Standard
#Salt
StandardSaltModel <- lm(BWCalData$StandardSalt~BWCalData$Temp)
summary(StandardSaltModel)
summary(StandardSaltModel)$r.squared
StandardSaltModel$coef

#Fresh
StandardFreshModel <- lm(BWCalData$StandardFresh~BWCalData$Temp)
summary(StandardFreshModel)
summary(StandardFreshModel)$r.squared
StandardFreshModel$coef

```

Analysis

```{r}
#load coral weight data
BW.data <-read.csv('Data/BWdata_Final.csv') # this is a file I compiled with all dates
BW.data<-BW.data %>%
    mutate(Species = str_replace(Species, "_", " "))
## Split data by species, change to numeric
Mcap_BW<- subset(BW.data, Species =="Montipora capitata")
Mcap_BW$Temp.C <- as.numeric(as.character(Mcap_BW$Temp.C))
BW_Mcap <- Mcap_BW$Mass.g
Temp_Mcap <- Mcap_BW$Temp.C 

Pcomp_BW<- subset(BW.data, Species =="Porites compressa")
Pcomp_BW$Temp.C <- as.numeric(as.character(Pcomp_BW$Temp.C))
BW_Pcomp <- Pcomp_BW$Mass.g
Temp_Pcomp <- Pcomp_BW$Temp.C 

Pvar_BW<- subset(BW.data, Species =="Pavona varians")
Pvar_BW$Temp.C <- as.numeric(as.character(Pvar_BW$Temp.C))
BW_Pvar <- Pvar_BW$Mass.g
Temp_Pvar <- Pvar_BW$Temp.C 

Pacu_BW<- subset(BW.data, Species =="Pocillopora acuta")
BW_Pacu <- Pacu_BW$Mass.g
Temp_Pacu <- Pacu_BW$Temp.C  
```

Montipora capitata

```{r}
BWCalc_Mcap <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 2.03){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  #Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  # Porites asteroides T Hughes 1987 1.69 at 5m (KB got 1.82)
  # below: Medellin-Maldonado et al 2016
  # Pavona varians 1.04 +-0.07
  # panama 8.5380 N, 80.7821 W, 
  # coasta rica 9.7489 N, 83.7534 W
  # mexico la entrega 15.7424 N, 96.1282 W
  # hawaii 19.8968 N, 155.5828 W
  # Pocillopora 1.78 +- 0.31
  
  
  # You can change the density to literatrue values for the specific coral species of interest in the function. 
  
 #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the glass Standard to calculate
  # the density of the Standard (Davies eq. 4)
FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
CoralWeight <- BW_Mcap/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}
   
Mcap_BW$Dry.Weigh.g <- BWCalc_Mcap(BW=BW_Mcap, Temp=Temp_Mcap) #use function to calculate dry weight
# hist(Mcap_BW$Dry.Weigh.g) #not normal
# Mcap_BW$Dry.Weigh.g_log<-log10(Mcap_BW$Dry.Weigh.g+1)
# hist(Mcap_BW$Dry.Weigh.g_log) #better still tail
boxplot(Mcap_BW$Dry.Weigh.g) #examine data
Mcap_BW <- Mcap_BW[!(Mcap_BW$Frag.ID == "797"),] # remove sample 797, error in BW record (impossible value)

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_McapBW <- reshape(Mcap_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "Time.Point","X"), idvar=c("Frag.ID", "Treatment","Clade","Parent.ID", "Species", "Tank.num"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0 and then divides by number of days , times 100
data_McapBW$time1.growth <- (((data_McapBW$Dry.Weigh.g.Time1 - data_McapBW$Dry.Weigh.g.Time0)/data_McapBW$Dry.Weigh.g.Time0)*100)/data_McapBW$Days.Time1 #calculate growth rate for time1
data_McapBW$time2.growth <- (((data_McapBW$Dry.Weigh.g.Time2 - data_McapBW$Dry.Weigh.g.Time1)/data_McapBW$Dry.Weigh.g.Time1)*100)/data_McapBW$Days.Time2 #calculate growth rate for time2

#### Delete ####


# mean, standard dev, and sem
time1_McapBW <-ddply(data_McapBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_McapBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_McapBW <-ddply(data_McapBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_McapBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_McapA <- rbind(time1_McapBW[1,],time2_McapBW[1,])# Greate a new column that we rename each row by treatment
G_McapH <- rbind(time1_McapBW[2,],time2_McapBW[2,])# Greate a new column that we rename each row by treatment
G_Mcap<-rbind(G_McapA, G_McapH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Mcap$newtime = ifelse(G_Mcap$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Mcap <- within(G_Mcap, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order

```

Porites compressa P lobata, 1.5 scoffin 1992, prachet 2015, low and barnes 1992

```{r}
#     PORITES COMPRESSA
BWCalc_Pcomp <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.82){
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  CoralWeight <- BW_Pcomp/(1-(SWDensity/CoralDensity))
  return(CoralWeight) 
}

Pcomp_BW$Dry.Weigh.g <- BWCalc_Pcomp(BW=BW_Pcomp, Temp=Temp_Pcomp) 
#boxplot(Pcomp_BW$Dry.Weigh.g_log) #examine data

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PcompBW <- reshape(Pcomp_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank","Time.Point", "X"), idvar=c("Frag.ID", "Treatment","Clade","Parent.ID", "Species", "Tank.num"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PcompBW$time1.growth <- (((data_PcompBW$Dry.Weigh.g.Time1 - data_PcompBW$Dry.Weigh.g.Time0)/data_PcompBW$Dry.Weigh.g.Time0)*100)/data_PcompBW$Days.Time1 #calculate growth rate for time1
data_PcompBW$time2.growth <- (((data_PcompBW$Dry.Weigh.g.Time2 - data_PcompBW$Dry.Weigh.g.Time1)/data_PcompBW$Dry.Weigh.g.Time1)*100)/data_PcompBW$Days.Time2 #calculate growth rate for time2

data_PcompBW$time1.growth[data_PcompBW$time1.growth < 0] <- 0 
data_PcompBW$time2.growth[data_PcompBW$time2.growth < 0] <- 0 

#### DELETE ####
##calc BW for Pcomp in general (T0-T1 ambient only) 
#data_PcompBW.amb<-subset(data_PcompBW, Treatment=="Ambient")
#write.csv(data_PcompBW.amb,"data_PcompBW.amb.csv")




# mean, standard dev, and sem
time1_PcompBW <-ddply(data_PcompBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PcompBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PcompBW <-ddply(data_PcompBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PcompBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PcompA <- rbind(time1_PcompBW[1,],time2_PcompBW[1,])# Greate a new column that we rename each row by treatment
G_PcompH <- rbind(time1_PcompBW[2,],time2_PcompBW[2,])# Greate a new column that we rename each row by treatment
G_Pcomp<-rbind(G_PcompA, G_PcompH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pcomp$newtime = ifelse(G_Pcomp$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pcomp <- within(G_Pcomp, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Pcomp_BW_plot<-ggplot(data=G_Pcomp, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
 ylab(expression(paste(""))) +
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+  
  # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("P compressa")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pcomp_BW_plot

#by clade

# mean, standard dev, and sem
time1_PcompBW.c <-ddply(data_PcompBW, c("Treatment","Clade"), summarize, #
              N=length(na.omit(time1.growth)), # 
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #t
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PcompBW.c$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PcompBW.c <-ddply(data_PcompBW, c( "Treatment","Clade"), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PcompBW.c$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"

G_Pcomp.c<-rbind(time1_PcompBW.c, time2_PcompBW.c)

G_Pcomp.c$Code<-paste(G_Pcomp.c$Treatment,G_Pcomp.c$Clade)

Pcomp_BW_plot.c<-ggplot(data=G_Pcomp.c, aes(x=Time, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+  
  geom_line(aes(color=Code),linetype=2)+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .6)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("P compressa")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pcomp_BW_plot.c

```

old plot code mcap

```{r}
#df data_McapBW




#old

Mcap_BW_plot<-ggplot(data=G_Mcap, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("") + #Label the X Axis
      ylim(0, .6)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("M capitata")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Mcap_BW_plot

#by clade

# mean, standard dev, and sem
time1_McapBW.c <-ddply(data_McapBW, c("Treatment","Clade"), summarize, #
              N=length(na.omit(time1.growth)), # 
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #t
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_McapBW.c$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_McapBW.c <-ddply(data_McapBW, c( "Treatment","Clade"), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_McapBW.c$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"

G_Mcap.c<-rbind(time1_McapBW.c, time2_McapBW.c)

G_Mcap.c$Code<-paste(G_Mcap.c$Treatment,G_Mcap.c$Clade)

Mcap_BW_plot.c<-ggplot(data=G_Mcap.c, aes(x=Time, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+  
  geom_line(aes(color=Code),linetype=2)+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .6)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("M capitata")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Mcap_BW_plot.c

```

Pavona varians

```{r}
BWCalc_Pvar <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.04){
   # Pavona varians 1.04 +-0.07
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  FreshDensity <- 1 
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  CoralWeight <- BW_Pvar/(1-(SWDensity/CoralDensity))
  return(CoralWeight) 
}

Pvar_BW$Dry.Weigh.g <- BWCalc_Pvar(BW=BW_Pvar, Temp=Temp_Pvar) #use function to calculate dry weight
hist(Pvar_BW$Dry.Weigh.g) #not normal

boxplot(Pvar_BW$Dry.Weigh.g) #examine data
# Pvar_BW$Dry.Weigh.g_log<-log10(Pvar_BW$Dry.Weigh.g+1)
# hist(Pvar_BW$Dry.Weigh.g_log) #not normal

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PvarBW <- reshape(Pvar_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Tank", "Time.Point","X"), idvar=c("Frag.ID", "Treatment","Clade","Parent.ID", "Species", "Tank.num"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PvarBW$time1.growth <- (((data_PvarBW$Dry.Weigh.g.Time1 - data_PvarBW$Dry.Weigh.g.Time0)/data_PvarBW$Dry.Weigh.g.Time0)*100)/data_PvarBW$Days.Time1 #calculate growth rate for time1
data_PvarBW$time2.growth <- (((data_PvarBW$Dry.Weigh.g.Time2 - data_PvarBW$Dry.Weigh.g.Time1)/data_PvarBW$Dry.Weigh.g.Time1)*100)/data_PvarBW$Days.Time2 #calculate growth rate for time2

data_PvarBW$time1.growth[data_PvarBW$time1.growth < 0] <- 0 # neg values to 0 (chipped frags)
data_PvarBW$time2.growth[data_PvarBW$time2.growth < 0] <- 0 

#DELETE ####
##calc BW for Pvar in general (T0-T1 ambient only) 
#data_PvarBW.amb<-subset(data_PvarBW, Treatment=="Ambient")
#write.csv(data_PvarBW.amb,"data_PvarBW.amb.csv")


# mean, standard dev, and sem ####
time1_PvarBW <-ddply(data_PvarBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PvarBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PvarBW <-ddply(data_PvarBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PvarBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PvarA <- rbind(time1_PvarBW[1,],time2_PvarBW[1,])# Greate a new column that we rename each row by treatment
G_PvarH <- rbind(time1_PvarBW[2,],time2_PvarBW[2,])# Greate a new column that we rename each row by treatment
G_Pvar<-rbind(G_PvarA, G_PvarH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pvar$newtime = ifelse(G_Pvar$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pvar <- within(G_Pvar, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order



Pvar_BW_plot<-ggplot(data=G_Pvar, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ggtitle("P varians")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pvar_BW_plot


#by clade

# mean, standard dev, and sem
time1_PvarBW.c <-ddply(data_PvarBW, c("Treatment","Clade"), summarize, #
              N=length(na.omit(time1.growth)), # 
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #t
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PvarBW.c$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PvarBW.c <-ddply(data_PvarBW, c( "Treatment","Clade"), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PvarBW.c$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"

G_Pvar.c<-rbind(time1_PvarBW.c, time2_PvarBW.c)

G_Pvar.c$Code<-paste(G_Pvar.c$Treatment,G_Pvar.c$Clade)

Pvar_BW_plot.c<-ggplot(data=G_Pvar.c, aes(x=Time, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+  
  geom_line(aes(color=Code),linetype=2)+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("Time Point") + #Label the X Axis
      ylim(0, .6)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("P var")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pvar_BW_plot.c

```

P acuta manzello 2010 2.01, Marshalln 2000 1.72, manzello 2010 2.05

```{r}
BWCalc_Pacu <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 1.78){
  # Pocillopora 1.78 +- 0.31
  StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
  StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  FreshDensity <- 1 
  StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  CoralWeight <- BW_Pacu/(1-(SWDensity/CoralDensity))
  return(CoralWeight) 
}

Pacu_BW$Dry.Weigh.g <- BWCalc_Pacu(BW=BW_Pacu, Temp=Temp_Pacu) #use function to calculate dry weight
# hist(Pacu_BW$Dry.Weigh.g) #not normal
# Pacu_BW$Dry.Weigh.g_log<-log10(Pacu_BW$Dry.Weigh.g+1)
# hist(Pacu_BW$Dry.Weigh.g_log) #better still tail
boxplot(Pacu_BW$Dry.Weigh.g) #examine data

# below, we are getting rid of columns we don't need anymore, and reorganizing the data by Fragment and clade/color and treatment. This way our time points wil be in the same row)
data_PacuBW <- reshape(Pacu_BW, timevar = "TimePoint", drop = c("Mass.g","Temp.C", "Date","Time.Point","Tank", "X"), idvar=c("Frag.ID", "Treatment","Clade","Parent.ID", "Species", "Tank.num"), direction="wide")

# This calculates the growth rate, if you look it takes Timepoint1 subtracts timepoint0 and divides by timepoint 0, times 100
data_PacuBW$time1.growth <- (((data_PacuBW$Dry.Weigh.g.Time1 - data_PacuBW$Dry.Weigh.g.Time0)/data_PacuBW$Dry.Weigh.g.Time0)*100)/data_PacuBW$Days.Time1 #calculate growth rate for time1
data_PacuBW$time2.growth <- (((data_PacuBW$Dry.Weigh.g.Time2 - data_PacuBW$Dry.Weigh.g.Time1)/data_PacuBW$Dry.Weigh.g.Time1)*100)/data_PacuBW$Days.Time2 #calculate growth rate for time2
data_PacuBW$time1.growth[data_PacuBW$time1.growth < 0] <- 0 # neg values to 0 (chipped frags)
data_PacuBW$time2.growth[data_PacuBW$time2.growth < 0] <- 0 

#DELETE ####

# mean, standard dev, and sem
time1_PacuBW <-ddply(data_PacuBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time1.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PacuBW$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PacuBW <-ddply(data_PacuBW, .( Treatment), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PacuBW$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"
G_PacuA <- rbind(time1_PacuBW[1,],time2_PacuBW[1,])# Greate a new column that we rename each row by treatment
G_PacuH <- rbind(time1_PacuBW[2,],time2_PacuBW[2,])# Greate a new column that we rename each row by treatment
G_Pacu<-rbind(G_PacuA, G_PacuH)
# Stress.Recovery column 
 # make new column that renames "time" to Stress or Recovery
G_Pacu$newtime = ifelse(G_Pacu$Time == "Time1", "Post-Stress", "Post-Recovery")
G_Pacu <- within(G_Pacu, newtime <- factor(newtime, levels = c("Post-Stress", "Post-Recovery"))) # Set order of levels so plots in right order

##calc BW for Pacu in general (T0-T1 ambient only) 
# data_PacuBW.amb<-subset(data_PacuBW, Treatment=="Ambient")
# write.csv(data_PacuBW.amb,"data_PacuBW.amb.csv")

Pacu_BW_plot<-ggplot(data=G_Pacu, aes(x=newtime, y=mean, group = Treatment, color=Treatment)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Treatment), size=4, show.legend = T)+  
  geom_line(aes(color=Treatment),linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3", "darkred"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("") + #Label the X Axis
      ylim(0, .7)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste(" "))) + 
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
    # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("P acuta")+ 
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pacu_BW_plot
 
#by clade

# mean, standard dev, and sem
time1_PacuBW.c <-ddply(data_PacuBW, c("Treatment","Clade"), summarize, #
              N=length(na.omit(time1.growth)), # 
              mean = (mean(time1.growth, na.rm=TRUE)) ,  #t
              sd = sd(time1.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time1.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time1_PacuBW.c$Time <- "Time1"  # this puts these data in our "time1" dataframe

time2_PacuBW.c <-ddply(data_PacuBW, c( "Treatment","Clade"), summarize, #For each subset of a data frame, apply function then combine results into a data frame.
              N=length(na.omit(time2.growth)), # the sample size of the light column summarized by Tank number
              mean = (mean(time2.growth, na.rm=TRUE)) ,  #take the average of the light column summarized by Tank number
              sd = sd(time2.growth, na.rm=TRUE) ,# the standard deviation of the temp column summarized by Tank number
              sem = (sd(time2.growth,na.rm=T)/sqrt(N))) #calculate the SEM as the sd/sqrt of the count or data length
time2_PacuBW.c$Time <- "Time2"  # this puts these data in our "time1" dataframe

#save this dataframe as "G"

G_Pacu.c<-rbind(time1_PacuBW.c, time2_PacuBW.c)

G_Pacu.c$Code<-paste(G_Pacu.c$Treatment,G_Pacu.c$Clade)

Pacu_BW_plot.c<-ggplot(data=G_Pacu.c, aes(x=Time, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+  
  geom_line(aes(color=Code),linetype=2)+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
   geom_point(shape = 1,size = 4,colour = "black")+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis

      ylim(0, .6)+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  # theme(panel.grid.major = element_blank(), 
  #       panel.grid.minor = element_blank(),
  #       panel.background = element_rect(colour = "black", size=1))+
        theme(aspect.ratio=1)+
  # ylab(expression(paste("% Change Dry.Weigh.g"))) +
  # ggtitle("P acu")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.25));Pacu_BW_plot.c

```

Make DF with all coral species:

```{r}
# data_McapBW, data_PcompBW, data_PvarBW, data_PacuBW
# bind all these dataframes

BW_df<-bind_rows(data_McapBW, data_PcompBW, data_PvarBW, data_PacuBW)
BW_df2<-BW_df[,c(1:6, 16:17)]
BW_df3<-melt(BW_df2, id.vars = c("Frag.ID", "Treatment","Clade", "Parent.ID","Species","Tank.num"))
BW_df4<-na.omit(BW_df3)

#this isn't joined with meta data so add back in the clades
#add new col for Clades
 #Pcomp
  BW_df4$Clade[BW_df4$Parent.ID==314]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==317]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==319]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==320]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==321]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==322]<-"C15cj"
  BW_df4$Clade[BW_df4$Parent.ID==313]<-"C15n"
  BW_df4$Clade[BW_df4$Parent.ID==315]<-"C15n"
  BW_df4$Clade[BW_df4$Parent.ID==316]<-"C15n"
  BW_df4$Clade[BW_df4$Parent.ID==318]<-"C15n"
  BW_df4$Clade[BW_df4$Parent.ID==323]<-"C15n"
  BW_df4$Clade[BW_df4$Parent.ID==324]<-"C15n"
  
  #Pvar
  BW_df4$Clade[BW_df4$Parent.ID==353]<-"C1"
  BW_df4$Clade[BW_df4$Parent.ID==358]<-"C1"
  BW_df4$Clade[BW_df4$Parent.ID==361]<-"C1"
  BW_df4$Clade[BW_df4$Parent.ID==325]<-"C1"
  BW_df4$Clade[BW_df4$Parent.ID==356]<-"C1"
  BW_df4$Clade[BW_df4$Parent.ID==351]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==354]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==355]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==357]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==359]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==360]<-"C27"
  BW_df4$Clade[BW_df4$Parent.ID==362]<-"C27"
  
#Pacu
  BW_df4$Clade[BW_df4$Parent.ID==311]<-"C42_2"
  BW_df4$Clade[BW_df4$Parent.ID==301]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==304]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==306]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==303]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==307]<-"C42_2"
  BW_df4$Clade[BW_df4$Parent.ID==308]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==310]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==312]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==302]<-"C1d"
  BW_df4$Clade[BW_df4$Parent.ID==305]<-"C42_2"
  BW_df4$Clade[BW_df4$Parent.ID==309]<-"C42_2"

#Mcap
  BW_df4$Clade[BW_df4$Parent.ID==363]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==364]<-"C31D4"
  BW_df4$Clade[BW_df4$Parent.ID==365]<-"C31D4"
  BW_df4$Clade[BW_df4$Parent.ID==366]<-"C31D4"
  BW_df4$Clade[BW_df4$Parent.ID==367]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==368]<-"C31D4"
  BW_df4$Clade[BW_df4$Parent.ID==369]<-"C31D4"
  BW_df4$Clade[BW_df4$Parent.ID==370]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==371]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==372]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==373]<-"C31"
  BW_df4$Clade[BW_df4$Parent.ID==374]<-"C31D4"
BW_df4$Clade<-as.factor(BW_df4$Clade)
BW_df4$Clade <- factor(BW_df4$Clade, levels = c("C31", "C31D4", "C15cj","C15n","C1","C27","C1d","C42_2"))
BW_df4$Species <- factor(BW_df4$Species, levels = c("Montipora capitata", "Porites compressa", "Pavona varians","Pocillopora acuta"))

```

Plots (2024) BW_df3

```{r}
BW_df4_T1_amb<-subset(BW_df4, variable=="time1.growth")
BW_df4_T1_amb<-subset(BW_df4_T1_amb, Treatment=="Ambient")

#T0 only ####
  ggplot(BW_df4_T1_amb, aes(x=Species, y=value, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Buoyant Weight - Ambient")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("BW_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(BW_df4_T1_amb, aes(x=interaction(Clade, Species), y=value, fill=Clade))+ 
     scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle("Growth Rate - Ambient by ITS2 Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
ggsave("FC_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)



#Plots T1 and TF

#T1TF - by species ####
bwT1TF<- ggplot(BW_df4, aes(x=interaction(Treatment,variable,Species), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Growth Rate")+
      # xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");bwT1TF


#Subset by time 1 or F only  ####
BW_df4_T1<-subset(BW_df4, variable=="time1.growth") 
BW_df4_TF<-subset(BW_df4, variable=="time2.growth") 

#T1 - by species  ####
CalcT1<-ggplot(BW_df4_T1, aes(x=Species, y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Growth Rate Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);CalcT1

ggsave("BW_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot
BW_T1_mcap<-subset(BW_df4_T1, Species=="Montipora capitata") 
BW_T1_pcomp<-subset(BW_df4_T1, Species=="Porites compressa") 
BW_T1_pvar<-subset(BW_df4_T1, Species=="Pavona varians") 
BW_T1_pacu<-subset(BW_df4_T1, Species=="Pocillopora acuta") 

#by species####
#Mcap
BW_Mcap_plot<- 
  ggplot(BW_T1_mcap, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");BW_Mcap_plot
  
#Pcomp
BW_Pcomp_plot<- ggplot(BW_T1_pcomp, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pcomp_plot

#Pvar
BW_Pvar_plot<- ggplot(BW_T1_pvar, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pvar_plot

#Pacu
BW_Pacu_plot<- ggplot(BW_T1_pacu, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pacu_plot

plot_row<-plot_grid(BW_Mcap_plot, BW_Pcomp_plot, BW_Pvar_plot, BW_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Growth Rate - After Stress by ITS2 Profile", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("BW_profiles_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
   CalcTF<-   ggplot(BW_df4_TF, aes(x=Species, y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Symbiodiniaceae Cell Density Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);CalcTF
ggsave("BW_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
BW_TF_mcap<-subset(BW_df4_TF, Species=="Montipora capitata") 
BW_TF_pcomp<-subset(BW_df4_TF, Species=="Porites compressa") 
BW_TF_pvar<-subset(BW_df4_TF, Species=="Pavona varians") 
BW_TF_pacu<-subset(BW_df4_TF, Species=="Pocillopora acuta") 

#Mcap 
BW_Mcap_plot<- 
  ggplot(BW_TF_mcap, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Growth Rate '(Percent~day^-1)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");BW_Mcap_plot
  
#Pcomp
BW_Pcomp_plot<- ggplot(BW_TF_pcomp, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pcomp_plot

#Pvar
BW_Pvar_plot<- ggplot(BW_TF_pvar, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pvar_plot

#Pacu
BW_Pacu_plot<- ggplot(BW_TF_pacu, aes(x=interaction(Treatment,Clade), y=value, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);BW_Pacu_plot

plot_row<-plot_grid(BW_Mcap_plot, BW_Pcomp_plot, BW_Pvar_plot, BW_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Growth Rate - After Recovery by ITS2 Profile", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  BW_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));BW_profilesTF

ggsave("BW_profiles_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```

stats

```{r}
Growth<- rbind(data_McapBW, data_PcompBW, data_PvarBW, data_PacuBW)
GrowthKeep<- c("Frag.ID","time1.growth","time2.growth")
Growth <- Growth[GrowthKeep]

metaKeep<- c("Frag.ID","Parent.ID","Treatment","Clade","Species","Tank.num") #get rid of that X column
metaK <- meta[metaKeep]
 Growth2<-merge(Growth, metaK) #merge metadata


Growth_m <- melt(Growth2, id=c("Frag.ID","Treatment","Parent.ID","Species","Tank.num","Clade")) #melt
names(Growth_m)[names(Growth_m) == "value"] <- "percent.change"
names(Growth_m)[names(Growth_m) == "variable"] <- "Time.point"
Growth_m2<-na.omit(Growth_m) #get rid of NAs

Growth3<-Growth_m2

Growth3$Tank.num<-as.factor(as.character(Growth3$Tank.num))
Growth3$Parent.ID<-as.factor(as.character(Growth3$Parent.ID))
Growth3$percent.change<-as.numeric(as.character(Growth3$percent.change))




hist(Growth3$percent.change) 
# Growth3$percent.change_log<-log10(Growth3$percent.change+1)
# hist(Growth3$percent.change_log) # 
Growth3$percent.change_sqrt<-sqrt(Growth3$percent.change)
hist(Growth3$percent.change_sqrt) # 
# Growth3$percent.change_cube<-Growth3$percent.change^(1/3)
# hist(Growth3$percent.change_cube) 

#T0 only (ambi)
Growth3_T1Ambient<-subset(Growth3, Time.point=="time1.growth"&Treatment=="Ambient")
hist(Growth3_T1Ambient$percent.change_sqrt) 

#t0 only
Growth3_T1Ambient_model<-lmer(percent.change~Species+(1|Tank.num), Growth3_T1Ambient)
anova(Growth3_T1Ambient_model)  #species differ
qqPlot(residuals(Growth3_T1Ambient_model)) 
emm<-emmeans(Growth3_T1Ambient_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)


#t0 only by speices?
Growth3_T1Ambient_stats_T0.mcap<-subset(Growth3_T1Ambient, Species=="Montipora capitata")
Growth3_T1Ambient_stats_T0.pcomp<-subset(Growth3_T1Ambient, Species=="Porites compressa")
Growth3_T1Ambient_stats_T0.pvar<-subset(Growth3_T1Ambient, Species=="Pavona varians")
Growth3_T1Ambient_stats_T0.pacu<-subset(Growth3_T1Ambient, Species=="Pocillopora acuta")

#mcap
Growth3_T1Ambient_T0_model<-lmer(percent.change~Clade+(1|Tank.num), Growth3_T1Ambient_stats_T0.mcap)
anova(Growth3_T1Ambient_T0_model)  #species differ
qqPlot(residuals(Growth3_T1Ambient_T0_model)) 
emm<-emmeans(Growth3_T1Ambient_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
Growth3_T1Ambient_T0_model<-lmer(percent.change~Clade+(1|Tank.num), Growth3_T1Ambient_stats_T0.pcomp)
anova(Growth3_T1Ambient_T0_model)  #species differ
qqPlot(residuals(Growth3_T1Ambient_T0_model)) 
emm<-emmeans(Growth3_T1Ambient_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
Growth3_T1Ambient_T0_model<-lmer(percent.change~Clade+(1|Tank.num), Growth3_T1Ambient_stats_T0.pvar)
anova(Growth3_T1Ambient_T0_model)  #species differ
qqPlot(residuals(Growth3_T1Ambient_T0_model)) 
emm<-emmeans(Growth3_T1Ambient_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
Growth3_T1Ambient_T0_model<-lmer(percent.change~Clade+(1|Tank.num), Growth3_T1Ambient_stats_T0.pacu)
anova(Growth3_T1Ambient_T0_model)  #species differ
qqPlot(residuals(Growth3_T1Ambient_T0_model)) 
emm<-emmeans(Growth3_T1Ambient_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)


#### T1TF


BW_model<-lmer(percent.change_sqrt~Time.point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3)
anova(BW_model) 
qqPlot(residuals(BW_model)) 
  emm<-emmeans(BW_model,  ~ Time.point*Treatment|Species, adjust="Tukey")
  cld(emm)
  pairs(emm)
 
BW_model<-lmer(percent.change_sqrt~Time.point*Treatment*Species*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3)
anova(BW_model) 
#lmer

# by Species df: Growth3_Mcap, Growth3_Pcomp, Growth3_Pvar, Growth3_Pacu
Growth3_Mcap<-subset(Growth3, Species=="Montipora capitata")
  Growth3_Mcap.C<-subset(Growth3_Mcap, Clade=="C31")
  Growth3_Mcap.CD<-subset(Growth3_Mcap, Clade=="C31D4")
    Growth3_Mcap.T1<-subset(Growth3_Mcap, Time.point=="time1.growth")
    Growth3_Mcap.TF<-subset(Growth3_Mcap, Time.point=="time2.growth")

Growth3_Pcomp<-subset(Growth3, Species=="Porites compressa")
  Growth3_Pcomp.C15cj<-subset(Growth3_Pcomp, Clade=="C15cj")
  Growth3_Pcomp.C15n<-subset(Growth3_Pcomp, Clade=="C15n")
    Growth3_Pcomp.T1<-subset(Growth3_Pcomp, Time.point=="time1.growth")
    Growth3_Pcomp.TF<-subset(Growth3_Pcomp, Time.point=="time2.growth")
    
Growth3_Pvar<-subset(Growth3, Species=="Pavona varians")
  Growth3_Pvar.C1<-subset(Growth3_Pvar, Clade=="C1")
  Growth3_Pvar.C27<-subset(Growth3_Pvar, Clade=="C27")
    Growth3_Pvar.T1<-subset(Growth3_Pvar, Time.point=="time1.growth")
    Growth3_Pvar.TF<-subset(Growth3_Pvar, Time.point=="time2.growth")
    
Growth3_Pacu<-subset(Growth3, Species=="Pocillopora acuta")
  Growth3_Pacu.CCC<-subset(Growth3_Pacu, Clade=="C1d")
  Growth3_Pacu.C42<-subset(Growth3_Pacu, Clade=="C42_2") 
    Growth3_Pacu.T1<-subset(Growth3_Pacu, Time.point=="time1.growth")
    Growth3_Pacu.TF<-subset(Growth3_Pacu, Time.point=="time2.growth")



#lmer
percent.change_stats_model<-lmer(percent.change_sqrt~Time.point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3)
anova(percent.change_stats_model) 
qqPlot(residuals(percent.change_stats_model)) 

percent.change_sqrt_stats_modelC<-lmer(percent.change_sqrt~Time.point*Treatment*Species*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3)
anova(percent.change_sqrt_stats_modelC) 

emm<-emmeans(percent.change_sqrt_stats_model,  ~ Days*Treatment|Species, adjust="Tukey") #not running
 cld(emm)
 pairs(emm)
  
#mcap####
#lmer
 percent.change_sqrt_Mcap_model<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Mcap)
  anova(percent.change_sqrt_Mcap_model) 
  
percent.change_sqrt_Mcap_model<-lmer(percent.change_sqrt~Time.point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Mcap)
  anova(percent.change_sqrt_Mcap_model) 
  qqPlot(residuals(percent.change_sqrt_Mcap_model)) 
  emm<-emmeans(percent.change_sqrt_Mcap_model,  ~ Time.point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #T1 only 
     Biomass_Mcap_model.T1<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Mcap.T1)
          Biomass_Mcap_model.T1<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID), Growth3_Mcap.T1) #removing tank removes singularity error

  anova(Biomass_Mcap_model.T1) 
    Biomass_Mcap_model.T1<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Mcap.T1)
        Biomass_Mcap_model.T1<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID), Growth3_Mcap.T1)#removing tank removes singularity, does not change anything

  anova(Biomass_Mcap_model.T1) 
  qqPlot(residuals(Biomass_Mcap_model.T1)) 
  emm<-emmeans(Biomass_Mcap_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
  Biomass_Mcap_model.TF<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
  Biomass_Mcap_model.TF<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
  qqPlot(residuals(Biomass_Mcap_model.TF)) 
  emm<-emmeans(Biomass_Mcap_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  
  
  
#mcap-C only
  percent.change_sqrt_Mcap_model.C<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Mcap.C)
  anova(percent.change_sqrt_Mcap_model.C) 
  qqPlot(residuals(percent.change_sqrt_Mcap_model.C)) 
    emm<-emmeans(percent.change_sqrt_Mcap_model.C,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  percent.change_sqrt_Mcap_model.CD<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Mcap.CD)
  anova(percent.change_sqrt_Mcap_model.CD) 
  qqPlot(residuals(percent.change_sqrt_Mcap_model.CD)) 
    emm<-emmeans(percent.change_sqrt_Mcap_model.CD,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pcomp ####
#lmer 
    percent.change_sqrt_Pcomp_model<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pcomp)
  anova(percent.change_sqrt_Pcomp_model) 
  
percent.change_sqrt_Pcomp_model<-lmer(percent.change_sqrt~Time.point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pcomp)
  anova(percent.change_sqrt_Pcomp_model) 
  qqPlot(residuals(percent.change_sqrt_Pcomp_model)) 
  emm<-emmeans(percent.change_sqrt_Pcomp_model,  ~ Time.point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)


#T1 only 
   Biomass_Pcomp_model.T1<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pcomp.T1)
  anova(Biomass_Pcomp_model.T1) 
    Biomass_Pcomp_model.T1<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pcomp.T1)
  anova(Biomass_Pcomp_model.T1) 
  qqPlot(residuals(Biomass_Pcomp_model.T1)) 
  emm<-emmeans(Biomass_Pcomp_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
  Biomass_Pcomp_model.TF<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pcomp.TF)
  anova(Biomass_Pcomp_model.TF) 
  Biomass_Pcomp_model.TF<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pcomp.TF)
  anova(Biomass_Pcomp_model.TF) 
  qqPlot(residuals(Biomass_Pcomp_model.TF)) 
  emm<-emmeans(Biomass_Pcomp_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm) 

  
    
#Pcomp-C15cj only
  percent.change_sqrt_Pcomp_model.C15cj<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pcomp.C15cj)
  anova(percent.change_sqrt_Pcomp_model.C15cj) 
  qqPlot(residuals(percent.change_sqrt_Pcomp_model.C15cj)) 
    emm<-emmeans(percent.change_sqrt_Pcomp_model.C15cj,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  percent.change_sqrt_Pcomp_model.C15n<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pcomp.C15n)
  anova(percent.change_sqrt_Pcomp_model.C15n) 
  qqPlot(residuals(percent.change_sqrt_Pcomp_model.C15n)) 
    emm<-emmeans(percent.change_sqrt_Pcomp_model.C15n,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pvar ####
#lmer
    percent.change_sqrt_Pvar_model<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pvar)
  anova(percent.change_sqrt_Pvar_model) 
percent.change_sqrt_Pvar_model<-lmer(percent.change_sqrt~Time.point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pvar)
  anova(percent.change_sqrt_Pvar_model) 
  qqPlot(residuals(percent.change_sqrt_Pvar_model)) 
  emm<-emmeans(percent.change_sqrt_Pvar_model,  ~ Time.point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
  #T1 only 
   Biomass_Pvar_model.T1<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pvar.T1)
  anova(Biomass_Pvar_model.T1) 
    Biomass_Pvar_model.T1<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pvar.T1)
  anova(Biomass_Pvar_model.T1) 
  qqPlot(residuals(Biomass_Pvar_model.T1)) 
  emm<-emmeans(Biomass_Pvar_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    grow_Pvar_model.TF<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pvar.TF)
  anova(grow_Pvar_model.TF) 
  grow_Pvar_model.TF<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pvar.TF)
  anova(grow_Pvar_model.TF) 
  qqPlot(residuals(grow_Pvar_model.TF)) 
  emm<-emmeans(grow_Pvar_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
#Pvar-C1 only
  percent.change_sqrt_Pvar_model.C1<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pvar.C1)
  anova(percent.change_sqrt_Pvar_model.C1) 
  qqPlot(residuals(percent.change_sqrt_Pvar_model.C1)) 
    emm<-emmeans(percent.change_sqrt_Pvar_model.C1,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  percent.change_sqrt_Pvar_model.C27<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pvar.C27)
  anova(percent.change_sqrt_Pvar_model.C27) 
  qqPlot(residuals(percent.change_sqrt_Pvar_model.C27)) 
    emm<-emmeans(percent.change_sqrt_Pvar_model.C27,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#Pacu ####
#lmer
    percent.change_sqrt_Pacu_model<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pacu)
  anova(percent.change_sqrt_Pacu_model) 
percent.change_sqrt_Pacu_model<-lmer(percent.change_sqrt~Time.point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pacu)
  anova(percent.change_sqrt_Pacu_model) 
  qqPlot(residuals(percent.change_sqrt_Pacu_model)) 
  emm<-emmeans(percent.change_sqrt_Pacu_model,  ~ Time.point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #T1 only 
   Growth_Pacu_model.T1<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pacu.T1)
  anova(Growth_Pacu_model.T1) 
    Growth_Pacu_model.T1<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pacu.T1)
  anova(Growth_Pacu_model.T1) 
  qqPlot(residuals(Growth_Pacu_model.T1)) 
  emm<-emmeans(Growth_Pacu_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
  Growth_Pacu_model.TF<-lmer(percent.change_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Growth3_Pacu.TF)
  anova(Growth_Pacu_model.TF)
  Growth_Pacu_model.TF<-lmer(percent.change_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Growth3_Pacu.TF)
  anova(Growth_Pacu_model.TF) 
  qqPlot(residuals(Growth_Pacu_model.TF)) 
  emm<-emmeans(Growth_Pacu_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#Pacu-CCC only
  percent.change_sqrt_Pacu_model.CCC<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pacu.CCC)
  anova(percent.change_sqrt_Pacu_model.CCC) 
  qqPlot(residuals(percent.change_sqrt_Pacu_model.CCC)) 
    emm<-emmeans(percent.change_sqrt_Pacu_model.CCC,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  percent.change_sqrt_Pacu_model.C42<-lmer(percent.change_sqrt~Time.point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), Growth3_Pacu.C42)
  anova(percent.change_sqrt_Pacu_model.C42) 
  qqPlot(residuals(percent.change_sqrt_Pacu_model.C42)) 
    emm<-emmeans(percent.change_sqrt_Pacu_model.C42,  ~ Time.point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    


# make DF for BW for Physio, Cast so 2 columns 

Growth.Percent.day<-merge(Growth3, meta, all=T)

```

#Chl-a\
dfs: Slurry=airbrush, SA=wax dip

```{r}
# Plate 1
Chla_plate1<- read.csv("Data/Chla_plate1.csv")
#merge 
ChlaData1 <- merge(meta, Chla_plate1)
ChlaData1 <- merge(ChlaData1, Slurry)
ChlaData1 <- merge(ChlaData1, SA)
ChlaData1$Parent.ID<-as.factor(as.character(ChlaData1$Parent.ID))
ChlaData1$Tank.num<-as.factor(as.character(ChlaData1$Tank.num))
ChlaData1$Surface.area<-as.numeric(as.character(ChlaData1$Surface.area))
ChlaData1$totChla1<-ChlaData1$Rep1*ChlaData1$TotalVolume
ChlaData1$chlaSA1 <- ChlaData1$totChla1/ChlaData1$Surface.area
ChlaData1$totChla2<-ChlaData1$Rep2*ChlaData1$TotalVolume
ChlaData1$chlaSA2 <- ChlaData1$totChla2/ChlaData1$Surface.area
plate1<-plot(ChlaData1$chlaSA1,ChlaData1$chlaSA2)
ChlaData1<-ChlaData1[!(ChlaData1$Frag.ID=="314"),] #redid plate 8
ChlaData1<-ChlaData1[!(ChlaData1$Frag.ID=="N198"),] #redid plate 3



# Plate 2
Chla_plate2<- read.csv("Data/Chla_plate2.csv")
#merge 
ChlaData2 <- merge(meta, Chla_plate2)
ChlaData2 <- merge(ChlaData2, Slurry)
ChlaData2 <- merge(ChlaData2, SA)
ChlaData2$Parent.ID<-as.factor(as.character(ChlaData2$Parent.ID))
ChlaData2$Tank.num<-as.factor(as.character(ChlaData2$Tank.num))
ChlaData2$Surface.area<-as.numeric(as.character(ChlaData2$Surface.area))
ChlaData2$totChla1<-ChlaData2$Rep1*ChlaData2$TotalVolume
ChlaData2$chlaSA1 <- ChlaData2$totChla1/ChlaData2$Surface.area
ChlaData2$totChla2<-ChlaData2$Rep2*ChlaData2$TotalVolume
ChlaData2$chlaSA2 <- ChlaData2$totChla2/ChlaData2$Surface.area
plate2<-plot(ChlaData2$chlaSA1,ChlaData2$chlaSA2)
ChlaData2<-ChlaData2[!(ChlaData2$Frag.ID=="3476"),] #redid plate 8
ChlaData2<-ChlaData2[!(ChlaData2$Frag.ID=="N211"),] #redid plate 8

# Plate 3
Chla_plate3<- read.csv("Data/Chla_plate3.csv")
#merge 
ChlaData3 <- merge(meta, Chla_plate3)
ChlaData3 <- merge(ChlaData3, Slurry)
ChlaData3 <- merge(ChlaData3, SA)
ChlaData3$Parent.ID<-as.factor(as.character(ChlaData3$Parent.ID))
ChlaData3$Tank.num<-as.factor(as.character(ChlaData3$Tank.num))
ChlaData3$Surface.area<-as.numeric(as.character(ChlaData3$Surface.area))
ChlaData3$totChla1<-ChlaData3$Rep1*ChlaData3$TotalVolume
ChlaData3$chlaSA1 <- ChlaData3$totChla1/ChlaData3$Surface.area
ChlaData3$totChla2<-ChlaData3$Rep2*ChlaData3$TotalVolume
ChlaData3$chlaSA2 <- ChlaData3$totChla2/ChlaData3$Surface.area

plate3<-plot(ChlaData3$chlaSA1,ChlaData3$chlaSA2) #check
ChlaData3<-ChlaData3[!(ChlaData3$Frag.ID=="N158"),] #redid plate 8

# Plate 4 
Chla_plate4<- read.csv("Data/plate4.csv")
#merge 
ChlaData4 <- merge(meta, Chla_plate4)
ChlaData4 <- merge(ChlaData4, Slurry)
ChlaData4 <- merge(ChlaData4, SA)
ChlaData4$Parent.ID<-as.factor(as.character(ChlaData4$Parent.ID))
ChlaData4$Tank.num<-as.factor(as.character(ChlaData4$Tank.num))
ChlaData4$Surface.area<-as.numeric(as.character(ChlaData4$Surface.area))
ChlaData4$totChla1<-ChlaData4$Rep1*ChlaData4$TotalVolume
ChlaData4$chlaSA1 <- ChlaData4$totChla1/ChlaData4$Surface.area
ChlaData4$totChla2<-ChlaData4$Rep2*ChlaData4$TotalVolume
ChlaData4$chlaSA2 <- ChlaData4$totChla2/ChlaData4$Surface.area
plate4<-plot(ChlaData4$chlaSA1,ChlaData4$chlaSA2)
ChlaData4<-ChlaData4[!(ChlaData4$Frag.ID=="N30"),] #redid plate 8
ChlaData4<-ChlaData4[!(ChlaData4$Frag.ID=="N49"),] #accidental dup (plate1)
ChlaData4 <- ChlaData4 %>%
  group_by(Frag.ID) %>%
  mutate(
    Rep1 = ifelse(Frag.ID == "N184", mean(Rep1, na.rm = TRUE), Rep1),
    Rep2 = ifelse(Frag.ID == "N184", mean(Rep2, na.rm = TRUE), Rep2)
  ) %>%
  ungroup() %>%
  distinct(Frag.ID, .keep_all = TRUE)  # Keep only one row per Frag.ID

# Plate 5 20190319
Chla_plate5<- read.csv("Data/Chla_20190319_plate5.csv")

#merge 
ChlaData5 <- merge(meta, Chla_plate5)
ChlaData5 <- merge(ChlaData5, Slurry)
ChlaData5 <- merge(ChlaData5, SA)
ChlaData5$Parent.ID<-as.factor(as.character(ChlaData5$Parent.ID))
ChlaData5$Tank.num<-as.factor(as.character(ChlaData5$Tank.num))
ChlaData5$Surface.area<-as.numeric(as.character(ChlaData5$Surface.area))
ChlaData5$totChla1<-ChlaData5$Rep1*ChlaData5$TotalVolume
ChlaData5$chlaSA1 <- ChlaData5$totChla1/ChlaData5$Surface.area
ChlaData5$totChla2<-ChlaData5$Rep2*ChlaData5$TotalVolume
ChlaData5$chlaSA2 <- ChlaData5$totChla2/ChlaData5$Surface.area
plate5<-plot(ChlaData5$chlaSA1,ChlaData5$chlaSA2) #some not close, check 

# Plate 6 20190321
Chla_plate6<- read.csv("Data/Chla_plate6.csv")
#merge 
ChlaData6 <- merge(meta, Chla_plate6)
ChlaData6 <- merge(ChlaData6, Slurry)
ChlaData6 <- merge(ChlaData6, SA)
ChlaData6$Parent.ID<-as.factor(as.character(ChlaData6$Parent.ID))
ChlaData6$Tank.num<-as.factor(as.character(ChlaData6$Tank.num))
ChlaData6$Surface.area<-as.numeric(as.character(ChlaData6$Surface.area))

 
ChlaData6$totChla1<-ChlaData6$Rep1*ChlaData6$TotalVolume
ChlaData6$chlaSA1 <- ChlaData6$totChla1/ChlaData6$Surface.area

ChlaData6$totChla2<-ChlaData6$Rep2*ChlaData6$TotalVolume
ChlaData6$chlaSA2 <- ChlaData6$totChla2/ChlaData6$Surface.area

plate6<-plot(ChlaData6$chlaSA1,ChlaData6$chlaSA2) #some not close, check 
ChlaData6<-ChlaData6[!(ChlaData6$Frag.ID=="3484"),] #redid plate 8

# Plate 8 20190321 (original file deleted, replaced with AVG values)
Chla_plate8<- read.csv("Data/Chla_plate8.csv")

#merge 
ChlaData8 <- merge(meta, Chla_plate8)
ChlaData8 <- merge(ChlaData8, Slurry)
ChlaData8 <- merge(ChlaData8, SA)
ChlaData8$Parent.ID<-as.factor(as.character(ChlaData8$Parent.ID))
ChlaData8$Tank.num<-as.factor(as.character(ChlaData8$Tank.num))
ChlaData8$Surface.area<-as.numeric(as.character(ChlaData8$Surface.area))
 
ChlaData8$totChla1<-ChlaData8$Rep1
ChlaData8$chlaSA1 <- ChlaData8$Rep1

ChlaData8$totChla2<-ChlaData8$Rep2
ChlaData8$chlaSA2 <- ChlaData8$Rep2

#plate8<-plot(ChlaData8$chlaSA1,ChlaData8$chlaSA2) #some not close, check 
  
Chla<-rbind(ChlaData1, ChlaData2, ChlaData3, ChlaData4, ChlaData5, ChlaData6,ChlaData8)

```

means for plots
```{r}
chlatest<-merge(meta, Chla, all.x = T)

duplicated(Chla) #look for duplicate entries
Chla<-unique(Chla) #remove any duplicate entries 

Chla$Chla_RepDiff<-Chla$chlaSA1-Chla$chlaSA2
Chla$ChlaSA<-(Chla$chlaSA1+Chla$chlaSA2)/2
checkChla<-merge(Chla,meta, all.y=T)
duplicated(checkChla)
#write.csv(checkChla,"checkChla.csv")

#2285, 3491, N141 Remove sample where reps are >2 apart
#Chla<-Chla[!(Chla$Frag.ID=="N138"),]
 
#make slightly neg values 0 
Chla$ChlaSA[Chla$ChlaSA < 0] <- 0 
 
Chla_mean <- ddply(Chla, c("Treatment", "Species", "Time.Point"), summarise, 
                   N    = length(ChlaSA[!is.na(ChlaSA)]), 
                   mean = mean(ChlaSA, na.rm=TRUE), 
                   sd   = sd(ChlaSA, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                   max = max(ChlaSA, na.rm=TRUE) 
)
Chla_mean #display table

# divide by species
Mcap_chla<-subset(Chla_mean, Species =="Montipora capitata")
Pcomp_chla<-subset(Chla_mean, Species =="Porites compressa")
Pvar_chla<-subset(Chla_mean, Species =="Pavona varians")
Pacu_chla<-subset(Chla_mean, Species =="Pocillopora acuta")

#by clade
Chla_meanClade <- ddply(Chla, c("Treatment", "Species", "Time.Point","Clade"), summarise, 
                   N    = length(ChlaSA[!is.na(ChlaSA)]), 
                   mean = mean(ChlaSA, na.rm=TRUE), 
                   sd   = sd(ChlaSA, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                   max = max(ChlaSA, na.rm=TRUE) 
)
Chla_meanClade #display table
# divide by species
Mcap_chla.Clade<-subset(Chla_meanClade, Species =="Montipora capitata")
Pcomp_chla.Clade<-subset(Chla_meanClade, Species =="Porites compressa")
Pvar_chla.Clade<-subset(Chla_meanClade, Species =="Pavona varians")
Pacu_chla.Clade<-subset(Chla_meanClade, Species =="Pocillopora acuta")
```

Plots 
```{r}
#just T0 #  ylab(expression(paste("mg cm"^"-2"))) + 
Chla_T0<-subset(Chla, Time.Point=="T0")
Chla_T0_mean <- ddply(Chla_T0, c( "Species"), summarise, 
                 N    = length(ChlaSA[!is.na(ChlaSA)]), 
                 mean = mean(ChlaSA, na.rm=TRUE), 
                 sd   = sd(ChlaSA, na.rm=TRUE), 
                 se   = sd / sqrt(N), 
                 max = max(ChlaSA, na.rm=TRUE) 
);Chla_T0_mean

#T0 only ####
  ggplot(Chla_T0, aes(x=Species, y=ChlaSA, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote("Chlorophyll-"*italic(alpha)*" "*plain(cm)^{-2}))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle(bquote("Chlorophyll-"*italic(alpha))) +
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("Chla_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(Chla_T0, aes(x=interaction(Species,Clade), y=ChlaSA, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote("Chlorophyll-"*italic(alpha)*" "*plain(cm)^{-2}))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle(bquote("Chlorophyll-"*italic(alpha)* " by ITS2 Profile")) +
      geom_boxplot( show.legend = FALSE)+
              scale_x_discrete(guide = "axis_nested")
ggsave("Chla_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#Plots T1 and TF
Chla_T1TF<-subset(Chla, Time.Point!="T0") 

#T1TF - by species ####
ChlaT1TF <- ggplot(Chla_T1TF, aes(x=interaction(Treatment, Time.Point, Species), y=ChlaSA, fill=Treatment)) + 
  scale_fill_manual(values=c("deepskyblue1", "orangered")) +
  ggtitle(expression(bold("Chlorophyll-" * alpha))) +  # Bold the plot title using expression() and bold()
  xlab("") +  # Label the X Axis
  ylab(expression("Chlorophyll-" * alpha * " " * plain(cm)^{-2})) +  # Keep the y-axis label as it is
  theme(axis.text.y = element_text(size=14)) +  # Keep y-axis labels size as is
  theme(axis.title.y = element_text(size=14)) +  # Keep y-axis title size as is
  theme(plot.title = element_text(size=16)) +  # Keep the title size but without making it bold here
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_boxplot(show.legend = FALSE) +
  scale_x_discrete(guide = "axis_nested");ChlaT1TF





#Subset by time 1 or F only  ####
Chla_T1<-subset(Chla, Time.Point=="T1") 
Chla_TF<-subset(Chla, Time.Point=="TF") 

#T1 - by species  ####
ChlaT1<-ggplot(Chla_T1, aes(x=Species, y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle(bquote("Chlorophyll-"*italic(alpha))) +
      xlab("") + #Label the X Axis
      ylab(bquote("Chlorophyll-"*italic(alpha)*" "*plain(cm)^{-2}))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);ChlaT1

ggsave("Chla_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#by species ####
#T1 - by species and algal profile - make for each species and then cowplot
Chla_T1_mcap<-subset(Chla_T1, Species=="Montipora capitata") 
Chla_T1_pcomp<-subset(Chla_T1, Species=="Porites compressa") 
Chla_T1_pvar<-subset(Chla_T1, Species=="Pavona varians") 
Chla_T1_pacu<-subset(Chla_T1, Species=="Pocillopora acuta") 

#Mcap
Chla_Mcap_plot<- 
  ggplot(Chla_T1_mcap, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote("Chlorophyll-"*italic(alpha)*" "*plain(cm)^{-2}))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");Chla_Mcap_plot
  
#Pcomp
Chla_Pcomp_plot<- ggplot(Chla_T1_pcomp, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pcomp_plot

#Pvar
Chla_Pvar_plot<- ggplot(Chla_T1_pvar, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pvar_plot

#Pacu
Chla_Pacu_plot<- ggplot(Chla_T1_pacu, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pacu_plot

plot_row<-plot_grid(Chla_Mcap_plot, Chla_Pcomp_plot, Chla_Pvar_plot, Chla_Pacu_plot, nrow=1,label_size = 12)

label_expression <- expression(bold("Chlorophyll-" * italic() * " cm"^{-2}))

  title <- ggdraw() + 
  draw_label(label = label_expression,x = 0, hjust = 0)+
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))


##### FIGURE OUT HOW TO GET THIS TO EXPORT WITH THE ALPHA#########
ggsave("Chla_profiles_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
     ChlaTF<-ggplot(Chla_TF, aes(x=Species, y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle(bquote("Chlorophyll-"*italic(alpha))) +
      xlab("") + #Label the X Axis
      ylab(bquote("Chlorophyll-"*italic(alpha)*" "*plain(cm)^{-2}))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);ChlaTF

  ggsave("Chla_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
Chla_TF_mcap<-subset(Chla_TF, Species=="Montipora capitata") 
Chla_TF_pcomp<-subset(Chla_TF, Species=="Porites compressa") 
Chla_TF_pvar<-subset(Chla_TF, Species=="Pavona varians") 
Chla_TF_pacu<-subset(Chla_TF, Species=="Pocillopora acuta") 

#Mcap 
Chla_Mcap_plot<- 
  ggplot(Chla_TF_mcap, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Symbiodiniaceae cells '(cm^-2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");Chla_Mcap_plot
  
#Pcomp
Chla_Pcomp_plot<- ggplot(Chla_TF_pcomp, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pcomp_plot

#Pvar
Chla_Pvar_plot<- ggplot(Chla_TF_pvar, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pvar_plot

#Pacu
Chla_Pacu_plot<- ggplot(Chla_TF_pacu, aes(x=interaction(Treatment,Clade), y=ChlaSA, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Chla_Pacu_plot


plot_row<-plot_grid(Chla_Mcap_plot, Chla_Pcomp_plot, Chla_Pvar_plot, Chla_Pacu_plot, nrow=1,label_size = 12)
  label_expression <- expression(bold("Chlorophyll-" * italic() * " cm"^{-2}))

  title <- ggdraw() + 
  draw_label(label = label_expression,x = 0, hjust = 0)+
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))


ggsave("Chla_profiles_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```
stats

```{r}
 
#t0
Chla_stats_T0<-Chla
Chla_stats_T0<-subset(Chla_stats_T0, Time.Point=="T0")
hist (Chla_stats_T0$ChlaSA) 
Chla_stats_T0$ChlaSA_log<-log10(Chla_stats_T0$ChlaSA+1)
hist(Chla_stats_T0$ChlaSA_log) 

#t0 only
Chla_T0_model<-lmer(ChlaSA_log~Treatment*Species+(1|Tank.num), Chla_stats_T0)
anova(Chla_T0_model)  #species differ
qqPlot(residuals(Chla_T0_model)) 
emm<-emmeans(Chla_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)

#t0 only
Chla_T0_model<-lmer(ChlaSA_log~Species*Clade+(1|Tank.num), Chla_stats_T0)
anova(Chla_T0_model)  #species differ
qqPlot(residuals(Chla_T0_model)) 
emm<-emmeans(Chla_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)

#mcap
Chla_stats_T0.mcap<-subset(Chla_stats_T0, Species=="Montipora capitata")
Chla_T0_model.c<-lmer(ChlaSA_log~Clade+(1|Tank.num), Chla_stats_T0.mcap)
anova(Chla_T0_model.c)  #species differ
qqPlot(residuals(Chla_T0_model.c)) 
emm<-emmeans(Chla_T0_model.c,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#Pcomp
Chla_stats_T0.pcomp<-subset(Chla_stats_T0, Species=="Porites compressa")
Chla_T0_model.c<-lmer(ChlaSA_log~Clade+(1|Tank.num), Chla_stats_T0.pcomp)
anova(Chla_T0_model.c)  #species differ
qqPlot(residuals(Chla_T0_model.c)) 
emm<-emmeans(Chla_T0_model.c,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
Chla_stats_T0.pvar<-subset(Chla_stats_T0, Species=="Pavona varians")
Chla_T0_model.c<-lmer(ChlaSA_log~Clade+(1|Tank.num), Chla_stats_T0.pvar)
anova(Chla_T0_model.c)  #species differ
qqPlot(residuals(Chla_T0_model.c)) 
emm<-emmeans(Chla_T0_model.c,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
Chla_stats_T0.pacu<-subset(Chla_stats_T0, Species=="Porites compressa")
Chla_T0_model.c<-lmer(ChlaSA_log~Clade+(1|Tank.num), Chla_stats_T0.pacu)
anova(Chla_T0_model.c)  #species differ
qqPlot(residuals(Chla_T0_model.c)) 
emm<-emmeans(Chla_T0_model.c,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)





#Chla transform
hist (Chla$ChlaSA) 
# Chla$ChlaSA_log<-log10(Chla$ChlaSA+1)
# hist(Chla$ChlaSA_log)
Chla$ChlaSA_quart<-Chla$ChlaSA^(1/4)
hist(Chla$ChlaSA_quart) #best

Chla_stats_T1TF<-subset(Chla, Time.Point=="T1"|Time.Point=="TF")

hist (Chla_stats_T1TF$ChlaSA) 
Chla_stats_T1TF$ChlaSA_log<-log10(Chla_stats_T1TF$ChlaSA+1)
hist(Chla_stats_T1TF$ChlaSA_log) #pos skew this ok?
 # Chla_stats_T1TF$ChlaSA_sqrt<-sqrt(Chla_stats_T1TF$ChlaSA) 
 # hist(Chla_stats_T1TF$ChlaSA_sqrt) #nope
# 
# Chla_stats_T1TF$ChlaSA_cube<-Chla_stats_T1TF$ChlaSA^(1/3)
# hist(Chla_stats_T1TF$ChlaSA_cube) #better but no
# shapiro.test(Chla_stats_T1TF$ChlaSA_cube)


Chla_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF)
anova(Chla_model) 
qqPlot(residuals(Chla_model)) 
emm<-emmeans(Chla_model,  ~Species, adjust="Tukey")
cld(emm)
pairs(emm)

emm<-emmeans(Chla_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

Chla_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Species*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF)
anova(Chla_model) 
qqPlot(residuals(Chla_model)) 

# by Species df: Chla_stats_T1TF_Mcap, Chla_stats_T1TF_Pcomp, Chla_stats_T1TF_Pvar, Chla_stats_T1TF_Pacu
Chla_stats_T1TF_Mcap<-subset(Chla_stats_T1TF, Species=="Montipora capitata")
  Chla_stats_T1TF_Mcap.C<-subset(Chla_stats_T1TF_Mcap, Clade=="C31")
  Chla_stats_T1TF_Mcap.CD<-subset(Chla_stats_T1TF_Mcap, Clade=="C31D4")
Chla_stats_T1TF_Pcomp<-subset(Chla_stats_T1TF, Species=="Porites compressa")
  Chla_stats_T1TF_Pcomp.C15cj<-subset(Chla_stats_T1TF_Pcomp, Clade=="C15cj")
  Chla_stats_T1TF_Pcomp.C15n<-subset(Chla_stats_T1TF_Pcomp, Clade=="C15n")
Chla_stats_T1TF_Pvar<-subset(Chla_stats_T1TF, Species=="Pavona varians")
  Chla_stats_T1TF_Pvar.C1<-subset(Chla_stats_T1TF_Pvar, Clade=="C1")
  Chla_stats_T1TF_Pvar.C27<-subset(Chla_stats_T1TF_Pvar, Clade=="C27")
Chla_stats_T1TF_Pacu<-subset(Chla_stats_T1TF, Species=="Pocillopora acuta")
  Chla_stats_T1TF_Pacu.CCC<-subset(Chla_stats_T1TF_Pacu, Clade=="C1d")
  Chla_stats_T1TF_Pacu.C42<-subset(Chla_stats_T1TF_Pacu, Clade=="C42_2")
   
#mcap ####
#lmer
  Chla_Mcap_model<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Mcap)
  anova(Chla_Mcap_model) 
  qqPlot(residuals(Chla_Mcap_model)) 
  emm<-emmeans(Chla_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Chla_Mcap_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Mcap)
  anova(Chla_Mcap_model) 
  qqPlot(residuals(Chla_Mcap_model)) 
  emm<-emmeans(Chla_Mcap_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #T1 only
  Chla_stats_Mcap.T1<-subset(Chla_stats_T1TF_Mcap, Time.Point=="T1")
  Chla_Mcap_model.T1<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Mcap.T1)
  anova(Chla_Mcap_model.T1) 
    Chla_Mcap_model.T1<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Mcap.T1)
  anova(Chla_Mcap_model.T1) 
  qqPlot(residuals(Chla_Mcap_model.T1)) 
  emm<-emmeans(Chla_Mcap_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Chla_stats_Mcap.TF<-subset(Chla_stats_T1TF_Mcap, Time.Point=="TF")

  Chla_Mcap_model.TF<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Mcap.TF)
  anova(Chla_Mcap_model.TF) 
  Chla_Mcap_model.TF<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Mcap.TF)
  anova(Chla_Mcap_model.TF) 
  qqPlot(residuals(Chla_Mcap_model.TF)) 
  emm<-emmeans(Chla_Mcap_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
#mcap-C only
  Chla_Mcap_model.C<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Mcap.C)
  anova(Chla_Mcap_model.C) 
  qqPlot(residuals(Chla_Mcap_model.C)) 
    emm<-emmeans(Chla_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  Chla_Mcap_model.CD<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Mcap.CD)
  anova(Chla_Mcap_model.CD) 
  qqPlot(residuals(Chla_Mcap_model.CD)) 
    emm<-emmeans(Chla_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)*
    pairs(emm)
    
#Pcomp ####
#lmer
Chla_Pcomp_model<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pcomp)
  anova(Chla_Pcomp_model) 
  qqPlot(residuals(Chla_Pcomp_model)) 
  emm<-emmeans(Chla_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Chla_Pcomp_model.Clade<-lmer(ChlaSA_quart~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pcomp)
  anova(Chla_Pcomp_model.Clade) 
  qqPlot(residuals(Chla_Pcomp_model.Clade)) 
  emm<-emmeans(Chla_Pcomp_model.Clade,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
 #T1 only
  Chla_stats_Pcomp.T1<-subset(Chla_stats_T1TF_Pcomp, Time.Point=="T1")
  Chla_Pcomp_model.T1<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pcomp.T1)
  anova(Chla_Pcomp_model.T1) 
    Chla_Pcomp_model.T1<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pcomp.T1)
  anova(Chla_Pcomp_model.T1) 
  qqPlot(residuals(Chla_Pcomp_model.T1)) 
  emm<-emmeans(Chla_Pcomp_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Chla_stats_Pcomp.TF<-subset(Chla_stats_T1TF_Pcomp, Time.Point=="TF")

  Chla_Pcomp_model.TF<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pcomp.TF)
  anova(Chla_Pcomp_model.TF) 
  Chla_Pcomp_model.TF<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pcomp.TF)
  anova(Chla_Pcomp_model.TF) 
  qqPlot(residuals(Chla_Pcomp_model.TF)) 
  emm<-emmeans(Chla_Pcomp_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)      
  
  
#Pcomp-C15cj only
  Chla_Pcomp_model.C15cj<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pcomp.C15cj)
  anova(Chla_Pcomp_model.C15cj) 
  qqPlot(residuals(Chla_Pcomp_model.C15cj)) 
    emm<-emmeans(Chla_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C15cj only
  Chla_Pcomp_model.C15n<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pcomp.C15n)
  anova(Chla_Pcomp_model.C15n) 
  qqPlot(residuals(Chla_Pcomp_model.C15n)) 
    emm<-emmeans(Chla_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pvar ####
#lmer 
    Chla_Pvar_model<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pvar)
  anova(Chla_Pvar_model) 
   emm<-emmeans(Chla_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Chla_Pvar_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pvar)
  anova(Chla_Pvar_model) 
  qqPlot(residuals(Chla_Pvar_model)) 
  emm<-emmeans(Chla_Pvar_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

 #T1 only
  Chla_stats_Pvar.T1<-subset(Chla_stats_T1TF_Pvar, Time.Point=="T1")
      Chla_Pvar_model.T1<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pvar.T1)
  anova(Chla_Pvar_model.T1) 
    Chla_Pvar_model.T1<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pvar.T1)
  anova(Chla_Pvar_model.T1) 
  qqPlot(residuals(Chla_Pvar_model.T1)) 
  emm<-emmeans(Chla_Pvar_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Chla_stats_Pvar.TF<-subset(Chla_stats_T1TF_Pvar, Time.Point=="TF")
Chla_Pvar_model.TF<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pvar.TF)
  anova(Chla_Pvar_model.TF) 
  Chla_Pvar_model.TF<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pvar.TF)
  anova(Chla_Pvar_model.TF) 
  qqPlot(residuals(Chla_Pvar_model.TF)) 
  emm<-emmeans(Chla_Pvar_model.TF,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#Pvar-C only
  Chla_Pvar_model.C1<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pvar.C1)
  anova(Chla_Pvar_model.C1) 
  qqPlot(residuals(Chla_Pvar_model.C1)) 
    emm<-emmeans(Chla_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  Chla_Pvar_model.C27<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pvar.C27)
  anova(Chla_Pvar_model.C27) 
  qqPlot(residuals(Chla_Pvar_model.C27)) 
    emm<-emmeans(Chla_Pvar_model.C27,  ~ Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#Pacu ####
#lmer
    Chla_Pacu_model<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pacu)
  anova(Chla_Pacu_model)
  emm<-emmeans(Chla_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
Chla_Pacu_model<-lmer(ChlaSA_quart~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pacu)
  anova(Chla_Pacu_model) 
  qqPlot(residuals(Chla_Pacu_model)) 
  emm<-emmeans(Chla_Pacu_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
  Chla_stats_Pacu.T1<-subset(Chla_stats_T1TF_Pacu, Time.Point=="T1")
      Chla_Pacu_model.T1<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pacu.T1)
  anova(Chla_Pacu_model.T1)
    Chla_Pacu_model.T1<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pacu.T1)
  anova(Chla_Pacu_model.T1) 
  qqPlot(residuals(Chla_Pacu_model.T1)) 
  emm<-emmeans(Chla_Pacu_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Chla_stats_Pacu.TF<-subset(Chla_stats_T1TF_Pacu, Time.Point=="TF")
  Chla_Pacu_model.TF<-lmer(ChlaSA_quart~Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pacu.TF)
  anova(Chla_Pacu_model.TF) 
  Chla_Pacu_model.TF<-lmer(ChlaSA_quart~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Chla_stats_Pacu.TF)
  anova(Chla_Pacu_model.TF) 
  qqPlot(residuals(Chla_Pacu_model.TF)) 
  emm<-emmeans(Chla_Pacu_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#Pacu-CCC only
  Chla_Pacu_model.CCC<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pacu.CCC)
  anova(Chla_Pacu_model.CCC) 
  qqPlot(residuals(Chla_Pacu_model.CCC)) 
    emm<-emmeans(Chla_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  Chla_Pacu_model.C42<-lmer(ChlaSA_quart~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Chla_stats_T1TF_Pacu.C42)
  anova(Chla_Pacu_model.C42) 
  qqPlot(residuals(Chla_Pacu_model.C42)) 
    emm<-emmeans(Chla_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    

```

#PAM

```{r}
#Load PAM data
Time0 <- read.csv("Data/PAM_20170320.csv", header=T) #load data
Time0<-merge(Time0, meta)
Time1 <- read.csv("Data/PAM_20170321.csv", header=T) #load data
Time1<-merge(Time1, meta)
Time2 <- read.csv("Data/PAM_20170322.csv", header=T) #load data
Time2<-merge(Time2, meta)
Time3 <- read.csv("Data/PAM_20170323.csv", header=T) #load data
Time3<-merge(Time3, meta)
#Time3b <- read.csv("Data/PAM_new_20170323b.csv", header=T) #load data
Time4 <- read.csv("Data/PAM_20170406.csv", header=T) #load data
Time4<-merge(Time4, meta)
Time5 <- read.csv("Data/PAM_20170413.csv", header=T) #load data
Time5<-merge(Time5, meta)
Time6 <- read.csv("Data/PAM_6test.csv", header=T) #load data had to remove rows with no data bc wouldn't upload
Time6<-merge(Time6, meta)
Time7 <- read.csv("Data/PAM_20170427.csv", header=T) #load data
Time7<-merge(Time7, meta)
Time8 <- read.csv("Data/PAM_20170504.csv", header=T) #load data
Time8<-merge(Time8, meta)
Time9 <- read.csv("Data/PAM_20170511.csv", header=T) #load data
Time9<-merge(Time9, meta)
Time10 <- read.csv("Data/PAM_20170517.csv", header=T) #load data
Time10<-merge(Time10, meta)
 
# combine all data files
PAMdata<-rbind(Time0, Time1, Time2, Time3, Time4, Time5, Time6, Time7, Time8, Time9, Time10)
# F0/FM: change F0, yield, and FM to numeric
PAMdata$F0<-as.numeric(as.character(PAMdata$F0))
PAMdata$FM<-as.numeric(as.character(PAMdata$FM))
PAMdata$Tank<-as.factor(as.character(PAMdata$Tank))
PAMdata$Tank.num<-as.factor(as.character(PAMdata$Tank.num))

# Date - change date to R format and then to numeric
PAMdata$Date <- as.Date(PAMdata$Date, format="%e-%b-%y") 
#PAMdata$Date[PAMdata$Date<"2017-03-24"]<-"2017-03-20" # make all T0 same starte date to get average
PAMdata$Days <- as.numeric(PAMdata$Date - as.Date("2017-03-20"))
PAMdata$Days[PAMdata$Days<4]<- 0  #If you want to make T0 all the same start time do this

# make yield ratio
PAMdata$Yield <- PAMdata$Yield/1000
str(PAMdata) # check

#check yield calculations versus records and build dataframe
checks <- (PAMdata[,(1:9)]) #add samples to dataframe
checks$Yield.Check <- PAMdata$Yield - ((PAMdata$FM-PAMdata$F0)/PAMdata$FM)
checks$checks <- ifelse(abs(checks$Yield.Check-checks$Yield) < 1, TRUE, FALSE) # check to see if Yield matches check
checks[checks$checks==FALSE,]#pull out FALSE

# check for outliers
#boxplot(checks$Yield.Check, main="Times") #check F0r outliers

#Check notes manulaly and remove data points as needed
#check for duplicate rows
DUP<-duplicated(PAMdata) #look for duplicate entries
PAMdata<-unique(PAMdata) #remove any duplicate entries 
#write.csv(PAMdata,"PAMdatacheck.csv")

# if NA in YIELD remove 
PAMdata<-PAMdata[!is.na(PAMdata$Yield), ]

# Many frags were too low to PAM (no signal) but corals were alive. Change fv.fm to 0.1, a minimum baseline to indicate the lack of photosynthetic yield. 0.1 is below the threshold of any PAM signal in a readable coral 

LowSig<-read.csv("Data/PAM_lowSignalSamps.csv") #read in df with low sig samps

#remove samples in 'extra;
LowSig$Date <- as.Date(LowSig$Date, format="%e-%b-%y") #update date
LowSig<-unique(LowSig)
LowSig<-LowSig[!(LowSig$REMOVE=="REMOVE"),] #remove the REMOVES

PAMdata2<- left_join(PAMdata, LowSig, by=c("Date","Frag.ID")) %>%  #merge df based on frag * date
  rowwise() 
# Change Yields in lowsigs to 0.1
PAMdata2 <- within(PAMdata2, Yield[Low.Sig == 'Yes' ] <- '0.1')

PAMdata2$Yield<-as.numeric(PAMdata2$Yield)
PAMdata2$Parent.ID<-as.factor(as.character(PAMdata2$Parent.ID))
PAMdata2$Clade <- factor(PAMdata2$Clade, levels = c("C31", "C31D4", "C15cj","C15n","C1","C27","C1d","C42_2"))
PAMdata2$Species <- factor(PAMdata2$Species, levels = c("Montipora capitata", "Porites compressa", "Pavona varians","Pocillopora acuta"))

```

Stats

```{r}
#remove notes 
PAMdata2_stats<-PAMdata2[,c("Frag.ID","Date","Yield","Parent.ID","Treatment","Species","Tank.num","Days","Clade")] # keep only columns you need
PAMdata2_stats$Days<-as.factor(as.character(PAMdata2_stats$Days))
PAMdata2_stats$Yield<-as.numeric(PAMdata2_stats$Yield)
PAMdata2_stats$Parent.ID<-as.factor(as.character(PAMdata2_stats$Parent.ID))

# Historgam
hist(PAMdata2_stats$Yield)

#transform
PAMdata2_stats$Yield_sq<-(PAMdata2_stats$Yield)^2
hist(PAMdata2_stats$Yield_sq)

PAMdata2_stats$Yield_cu<-(PAMdata2_stats$Yield)^3
hist(PAMdata2_stats$Yield_cu) #beter


#t0
PAM_stats_T0<-subset(PAMdata2_stats, Days=="0")
hist (PAM_stats_T0$Yield_cu) 

#t0 only
PAM_stats_T0_model<-lmer(Yield_cu~Treatment*Species+(1|Tank.num), PAM_stats_T0)
anova(PAM_stats_T0_model)  #species differ
qqPlot(residuals(PAM_stats_T0_model)) 
emm<-emmeans(PAM_stats_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)



#t0 only by speices?
PAM_stats_T0.mcap<-subset(PAM_stats_T0, Species=="Montipora capitata")
PAM_stats_T0.pcomp<-subset(PAM_stats_T0, Species=="Porites compressa")
PAM_stats_T0.pvar<-subset(PAM_stats_T0, Species=="Pavona varians")
PAM_stats_T0.pacu<-subset(PAM_stats_T0, Species=="Pocillopora acuta")

#mcap
PAM_T0_model<-lmer(Yield_cu~Clade+(1|Tank.num), PAM_stats_T0.mcap)
anova(PAM_T0_model)  #species differ
qqPlot(residuals(PAM_T0_model)) 
emm<-emmeans(PAM_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
PAM_T0_model<-lmer(Yield_cu~Clade+(1|Tank.num), PAM_stats_T0.pcomp) #singularity
PAM_T0_model<-lmer(Yield_cu~Clade+(1|Parent.ID), PAM_stats_T0.pcomp)#singularity
PAM_T0_model<-lm(Yield_cu~Clade, PAM_stats_T0.pcomp)#THIS GIVES SAME OUTCOME ( to do update the rest 20250204)

anova(PAM_T0_model)  #species differ
qqPlot(residuals(PAM_T0_model)) 
emm<-emmeans(PAM_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
PAM_T0_model<-lmer(Yield_cu~Clade+(1|Tank.num), PAM_stats_T0.pvar)
anova(PAM_T0_model)  #species differ
qqPlot(residuals(PAM_T0_model)) 
emm<-emmeans(PAM_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
PAM_T0_model<-lmer(Yield_cu~Clade+(1|Tank.num), PAM_stats_T0.pacu)
anova(PAM_T0_model)  #species differ
qqPlot(residuals(PAM_T0_model)) 
emm<-emmeans(PAM_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)






##T1TF ####
#lmer with ^3
PAMdata2_stats_model<-lmer(Yield_cu~Days*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats)
anova(PAMdata2_stats_model) 
qqPlot(residuals(PAMdata2_stats_model)) 

emm<-emmeans(PAMdata2_stats_model,  ~ Days*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)



#lmer

PAMdata2_stats_Mcap<-subset(PAMdata2_stats, Species=="Montipora capitata")
PAMdata2_stats_Pcomp<-subset(PAMdata2_stats, Species=="Porites compressa")
PAMdata2_stats_Pvar<-subset(PAMdata2_stats, Species=="Pavona varians")
PAMdata2_stats_Pacu<-subset(PAMdata2_stats, Species=="Pocillopora acuta")

# by Species df: PAMdata2_stats_Mcap, PAMdata2_stats_Pcomp, PAMdata2_stats_Pvar, PAMdata2_stats_Pacu
PAMdata2_stats_Mcap<-subset(PAMdata2_stats, Species=="Montipora capitata")
  PAMdata2_stats_Mcap.C<-subset(PAMdata2_stats_Mcap, Clade=="C31")
  PAMdata2_stats_Mcap.CD<-subset(PAMdata2_stats_Mcap, Clade=="C31D4")
    PAMdata2_stats_Mcap.T1<-subset(PAMdata2_stats_Mcap, Days==24)
    PAMdata2_stats_Mcap.TF<-subset(PAMdata2_stats_Mcap, Days==52)

PAMdata2_stats_Pcomp<-subset(PAMdata2_stats, Species=="Porites compressa")
  PAMdata2_stats_Pcomp.C15cj<-subset(PAMdata2_stats_Pcomp, Clade=="C15cj")
  PAMdata2_stats_Pcomp.C15n<-subset(PAMdata2_stats_Pcomp, Clade=="C15n")
    PAMdata2_stats_Pcomp.T1<-subset(PAMdata2_stats_Pcomp, Days==24)
    PAMdata2_stats_Pcomp.TF<-subset(PAMdata2_stats_Pcomp, Days==52)
    
PAMdata2_stats_Pvar<-subset(PAMdata2_stats, Species=="Pavona varians")
  PAMdata2_stats_Pvar.C1<-subset(PAMdata2_stats_Pvar, Clade=="C1")
  PAMdata2_stats_Pvar.C27<-subset(PAMdata2_stats_Pvar, Clade=="C27")
    PAMdata2_stats_Pvar.T1<-subset(PAMdata2_stats_Pvar, Days==24)
    PAMdata2_stats_Pvar.TF<-subset(PAMdata2_stats_Pvar, Days==52)
    
PAMdata2_stats_Pacu<-subset(PAMdata2_stats, Species=="Pocillopora acuta")
  PAMdata2_stats_Pacu.CCC<-subset(PAMdata2_stats_Pacu, Clade=="C1d")
  PAMdata2_stats_Pacu.C42<-subset(PAMdata2_stats_Pacu, Clade=="C42_2")
    PAMdata2_stats_Pacu.T1<-subset(PAMdata2_stats_Pacu, Days==24)
    PAMdata2_stats_Pacu.TF<-subset(PAMdata2_stats_Pacu, Days==52)

    #lmer
Yield_cu_stats_model<-lmer(Yield_cu~Days*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats)
anova(Yield_cu_stats_model) 
qqPlot(residuals(Yield_cu_stats_model)) 

Yield_cu_stats_modelC<-lmer(Yield_cu~Days*Treatment*Species*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats)
anova(Yield_cu_stats_modelC) 

emm<-emmeans(Yield_cu_stats_model,  ~ Days*Treatment|Species, adjust="Tukey")
 cld(emm)
 pairs(emm)
  
#mcap ####
#lmer
 Yield_cu_Mcap_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Mcap)
  anova(Yield_cu_Mcap_model) 
    emm<-emmeans(Yield_cu_Mcap_model,  ~ Days*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Yield_cu_Mcap_model<-lmer(Yield_cu~Days*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Mcap)
  anova(Yield_cu_Mcap_model) 
  qqPlot(residuals(Yield_cu_Mcap_model)) 
  emm<-emmeans(Yield_cu_Mcap_model,  ~ Days*Treatment*Clade, adjust="Tukey")
  cld(emm)
  mcappamdsf<-as.data.frame(pairs(emm))

  #T1 only 
    Biomass_Mcap_model.T1<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.T1)
  anova(Biomass_Mcap_model.T1) 
    Biomass_Mcap_model.T1<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.T1)
  anova(Biomass_Mcap_model.T1) 
  qqPlot(residuals(Biomass_Mcap_model.T1)) 
  emm<-emmeans(Biomass_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
    emm<-emmeans(Biomass_Mcap_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Biomass_Mcap_model.TF<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
  Biomass_Mcap_model.TF<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.TF)
  anova(Biomass_Mcap_model.TF) 
  qqPlot(residuals(Biomass_Mcap_model.TF)) 
  emm<-emmeans(Biomass_Mcap_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #C only T1
  PAMdata2_stats_Mcap.C.T1<-subset(PAMdata2_stats_Mcap.C, Days=="24")
   PAMdata2_stats_Mcap.C.T1.model<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.C.T1)
  anova(PAMdata2_stats_Mcap.C.T1.model) 
  qqPlot(residuals(PAMdata2_stats_Mcap.C.T1.model)) 
  emm<-emmeans(PAMdata2_stats_Mcap.C.T1.model,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  #CD only T1
  PAMdata2_stats_Mcap.CD.T1<-subset(PAMdata2_stats_Mcap.CD, Days=="24")
   PAMdata2_stats_Mcap.CD.T1.model<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Mcap.CD.T1)
  anova(PAMdata2_stats_Mcap.CD.T1.model) 
  qqPlot(residuals(PAMdata2_stats_Mcap.CD.T1.model)) 
  emm<-emmeans(PAMdata2_stats_Mcap.CD.T1.model,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  
#mcap-C only
  Yield_cu_Mcap_model.C<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Mcap.C)
  anova(Yield_cu_Mcap_model.C) 
  qqPlot(residuals(Yield_cu_Mcap_model.C)) 
    emm<-emmeans(Yield_cu_Mcap_model.C,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  Yield_cu_Mcap_model.CD<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Mcap.CD)
  anova(Yield_cu_Mcap_model.CD) 
  qqPlot(residuals(Yield_cu_Mcap_model.CD)) 
    emm<-emmeans(Yield_cu_Mcap_model.CD,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#########Pcomp ####
#lmer 
    Yield_cu_Pcomp_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pcomp)
  anova(Yield_cu_Pcomp_model) 
   emm<-emmeans(Yield_cu_Pcomp_model,  ~ Days*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Yield_cu_Pcomp_model<-lmer(Yield_cu~Days*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pcomp)
  anova(Yield_cu_Pcomp_model) 
  qqPlot(residuals(Yield_cu_Pcomp_model)) 
  emm<-emmeans(Yield_cu_Pcomp_model,  ~ Days*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Yield_cu_Pcomp_model.Clade<-lmer(Yield_cu~Days*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pcomp)
  anova(Yield_cu_Pcomp_model.Clade) 
  qqPlot(residuals(Yield_cu_Pcomp_model.Clade)) 
  emm<-emmeans(Yield_cu_Pcomp_model.Clade,  ~ Days*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#T1 only
    set.seed(30)
      Yield_cu_Pcomp_model.T1<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.T1)
  anova(Yield_cu_Pcomp_model.T1) 
    Yield_cu_Pcomp_model.T1<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.T1)
  anova(Yield_cu_Pcomp_model.T1) 
  qqPlot(residuals(Yield_cu_Pcomp_model.T1)) 
  emm<-emmeans(Yield_cu_Pcomp_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
  Yield_cu_Pcomp_model.TF<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.TF)
  anova(Yield_cu_Pcomp_model.TF) 
  Yield_cu_Pcomp_model.TF<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.TF)
  anova(Yield_cu_Pcomp_model.TF) 
  qqPlot(residuals(Yield_cu_Pcomp_model.TF)) 
  emm<-emmeans(Yield_cu_Pcomp_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)   
    
#Pcomp-C15cj only
  Yield_cu_Pcomp_model.C15cj<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.C15cj)
  anova(Yield_cu_Pcomp_model.C15cj) 
  qqPlot(residuals(Yield_cu_Pcomp_model.C15cj)) 
    emm<-emmeans(Yield_cu_Pcomp_model.C15cj,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  Yield_cu_Pcomp_model.C15n<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pcomp.C15n)
  anova(Yield_cu_Pcomp_model.C15n) 
  qqPlot(residuals(Yield_cu_Pcomp_model.C15n)) 
    emm<-emmeans(Yield_cu_Pcomp_model.C15n,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
###Pvar #####
#lmer
    Yield_cu_Pvar_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pvar)
  anova(Yield_cu_Pvar_model) 
  qqPlot(residuals(Yield_cu_Pvar_model)) 
  emm<-emmeans(Yield_cu_Pvar_model,  ~ Days*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Yield_cu_Pvar_model<-lmer(Yield_cu~Days*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pvar)
  anova(Yield_cu_Pvar_model) 
  qqPlot(residuals(Yield_cu_Pvar_model)) 
  emm<-emmeans(Yield_cu_Pvar_model,  ~ Days*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
    emm<-emmeans(Yield_cu_Pvar_model,  ~Treatment*Clade|Days, adjust="Tukey")

  
  #T1 only 
  Yield_cu_Pvar_model.T1<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pvar.T1)
  anova(Yield_cu_Pvar_model.T1) 
    Yield_cu_Pvar_model.T1<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pvar.T1)
  anova(Yield_cu_Pvar_model.T1) 
  qqPlot(residuals(Yield_cu_Pvar_model.T1)) 
  emm<-emmeans(Yield_cu_Pvar_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Yield_cu_Pvar_model.TF<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pvar.TF)
  anova(Yield_cu_Pvar_model.TF) 
  Yield_cu_Pvar_model.TF<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pvar.TF)
  anova(Yield_cu_Pvar_model.TF) 
  qqPlot(residuals(Yield_cu_Pvar_model.TF)) 
  emm<-emmeans(Yield_cu_Pvar_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
#Pvar-C1 only
  Yield_cu_Pvar_model.C1<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pvar.C1)
  anova(Yield_cu_Pvar_model.C1) 
  qqPlot(residuals(Yield_cu_Pvar_model.C1)) 
    emm<-emmeans(Yield_cu_Pvar_model.C1,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  Yield_cu_Pvar_model.C27<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pvar.C27)
  anova(Yield_cu_Pvar_model.C27) 
  qqPlot(residuals(Yield_cu_Pvar_model.C27)) 
    emm<-emmeans(Yield_cu_Pvar_model.C27,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#####Pacu####
#lmer
    Yield_cu_Pacu_model<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pacu)
  anova(Yield_cu_Pacu_model) 
   qqPlot(residuals(Yield_cu_Pacu_model)) 
  emm<-emmeans(Yield_cu_Pacu_model,  ~ Days*Treatment, adjust="Tukey")
  cld(emm)
    pairs(emm)

Yield_cu_Pacu_model<-lmer(Yield_cu~Days*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pacu)
  anova(Yield_cu_Pacu_model) 
  qqPlot(residuals(Yield_cu_Pacu_model)) 
  emm<-emmeans(Yield_cu_Pacu_model,  ~ Treatment*Clade|Days, adjust="Tukey")
  cld(emm)
  pairs(emm)

  #T1 only 
      Yield_cu_Pacu_model.T1<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pacu.T1)
  anova(Yield_cu_Pacu_model.T1) 
    Yield_cu_Pacu_model.T1<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pacu.T1)
  anova(Yield_cu_Pacu_model.T1) 
  qqPlot(residuals(Yield_cu_Pacu_model.T1)) 
  emm<-emmeans(Yield_cu_Pacu_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
  Yield_cu_Pacu_model.TF<-lmer(Yield_cu~Treatment+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pacu.TF)
  anova(Yield_cu_Pacu_model.TF) 
  Yield_cu_Pacu_model.TF<-lmer(Yield_cu~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PAMdata2_stats_Pacu.TF)
  anova(Yield_cu_Pacu_model.TF) 
  qqPlot(residuals(Yield_cu_Pacu_model.TF)) 
  emm<-emmeans(Yield_cu_Pacu_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
#Pacu-CCC only
  Yield_cu_Pacu_model.CCC<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pacu.CCC)
  anova(Yield_cu_Pacu_model.CCC) 
  qqPlot(residuals(Yield_cu_Pacu_model.CCC)) 
    emm<-emmeans(Yield_cu_Pacu_model.CCC,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  Yield_cu_Pacu_model.C42<-lmer(Yield_cu~Days*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PAMdata2_stats_Pacu.C42)
  anova(Yield_cu_Pacu_model.C42) 
  qqPlot(residuals(Yield_cu_Pacu_model.C42)) 
    emm<-emmeans(Yield_cu_Pacu_model.C42,  ~ Days*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    



#set up df for physi
  keepPAM<-c("Frag.ID", "Parent.ID","Species","Tank.num","Treatment","Days","Yield_cu","Clade") #keep cols you need
PAMdata2_stats<-PAMdata2_stats[keepPAM] #keep cols you want
PAMdata2_stats$Parent.ID<-as.factor(as.character(PAMdata2_stats$Parent.ID))
#PAMdata2_physio<-dcast(PAMdata2_stats, Frag.ID+Parent.ID+Species+Tank.num+Treatment~Days,fun.aggregate = mean) #cast

# names(PAMdata2_physio)[names(PAMdata2_physio) == "0"] <- "T0.PAM"
# names(PAMdata2_physio)[names(PAMdata2_physio) == "24"] <- "T1.PAM"
# names(PAMdata2_physio)[names(PAMdata2_physio) == "52"] <- "TF.PAM"


 

```

Plots

```{r}
PAMdata2_mean <- ddply(PAMdata2, c("Treatment", "Species", "Days"), summarise, 
                   N    = length(Yield[!is.na(Yield)]), 
                   mean = mean(Yield, na.rm=TRUE), 
                   sd   = sd(Yield, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                  max = max(Yield, na.rm=TRUE) 
)
PAMdata2_mean #display table


Mcap_PAM<-subset(PAMdata2, Species =="Montipora capitata")
Pcomp_PAM<-subset(PAMdata2, Species =="Porites compressa")
Pvar_PAM<-subset(PAMdata2, Species =="Pavona varians")
Pacu_PAM<-subset(PAMdata2, Species =="Pocillopora acuta")


PAMdata2_meanClade <- ddply(PAMdata2, c("Treatment", "Species", "Days","Clade"), summarise, 
                   N    = length(Yield[!is.na(Yield)]), 
                   mean = mean(Yield, na.rm=TRUE), 
                   sd   = sd(Yield, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                  max = max(Yield, na.rm=TRUE) 
)
PAMdata2_meanClade #display table

# divide by clade
Mcap_PAM_mean.clade<-subset(PAMdata2_meanClade, Species =="Montipora capitata")
Pcomp_PAM_mean.clade<-subset(PAMdata2_meanClade, Species =="Porites compressa")
Pvar_PAM_mean.clade<-subset(PAMdata2_meanClade, Species =="Pavona varians")
Pacu_PAM_mean.clade<-subset(PAMdata2_meanClade, Species =="Pocillopora acuta")


#T0 ####
PAM_T0<-subset(PAMdata2, Days=="0")

ggplot(PAM_T0, aes(x=Species, y=Yield, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle(bquote("Photosynthetic Quantum Yeild")) +
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("PAM_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(PAM_T0, aes(x=interaction(Clade, Species), y=Yield, fill=Clade)) + 
         scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote("fv/fm"))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle(bquote("Photosynthetic Quantum Yeild by ITS2 Profile")) +
      geom_boxplot(show.legend = FALSE)+
              scale_x_discrete(guide = "axis_nested")

ggsave("PAM_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)


#Plots T1 and TF####
FvFm_T1TF<-subset(PAMdata2, Time.Point!="T0") 

#T1TF - by species ####
FvFmT1TF<- ggplot(FvFm_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle(bquote("Photosynthetic Quantum Yeild")) +
      xlab("") + #Label the X Axis
      ylab(bquote("Fv/Fm"))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");FvFmT1TF

#Plots T1 and TF AGAIN with Pacuta non detectable removed ####
FvFm_T1TF_ND<-FvFm_T1TF
 #Remove rows where Yield is 0.100
FvFm_T1TF_ND <- FvFm_T1TF_ND %>%
  filter(Yield != 0.100)

count_samples <- FvFm_T1TF_ND %>%
 dplyr::filter(Species == "Pocillopora acuta", Days == "58", Treatment == "High") %>%
  nrow()

FvFm_T1TF_ND_D24D58<-subset(FvFm_T1TF_ND, Days==24|Days==58)
#T1TF - by species ####
FvFmT1TF_ND<- ggplot(FvFm_T1TF_ND_D24D58, aes(x=interaction(Treatment,Days,Species), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle(bquote("Photosynthetic Quantum Yeild")) +
      xlab("") + #Label the X Axis
      ylab(bquote("Fv/Fm"))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");FvFmT1TF_ND


#### mcap ####
#plot all over time by species
#Mcap plot ####
PAM_mcap<-ggplot(Mcap_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 

ggsave("PAM_Mcap_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#by clade for mcap

p<-ggplot(Mcap_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("Days") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 
   PAM_mcapProfile<-p +facet_wrap(~Clade)
ggsave("PAM_Mcap_profile_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#### pcomp ####
#Pcomp plot ####
PAM_Pcomp<-ggplot(Pcomp_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 

ggsave("PAM_Pcomp_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#by clade for Pcomp

p<-ggplot(Pcomp_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("Days") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 
   PAM_pcompProfile<-p +facet_wrap(~Clade)
ggsave("PAM_Pcomp_profile_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#Pvar plot ####
PAM_Pvar<-ggplot(Pvar_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 

ggsave("PAM_Pvar_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#by clade for Pvar

p<-ggplot(Pvar_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("Days") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 
   PAM_pvarProfile<-p +facet_wrap(~Clade)
ggsave("PAM_Pvar_profile_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#Pacu plot ####
PAM_Pacu<-ggplot(Pacu_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 

ggsave("PAM_Pacu_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)

#by clade for Pacu

p<-ggplot(Pacu_PAM, aes(x=interaction(Days), y=Yield, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("Days") + #Label the X Axis
      ylab(bquote("fv/fm"))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F) 
  PAM_pacuProfile<-p +facet_wrap(~Clade)
ggsave("PAM_Pacu_profile_all.pdf", plot=last_plot(), path="Figures",device = "pdf", width=8, height=5, units=c("in"), dpi=300)
```

Plots together

```{r}
###### All plots together
pl<-grid.arrange(PAM_mcap,PAM_Pcomp,PAM_Pvar,PAM_Pacu, nrow =4)
ggsave("PAM_all.pdf", plot=pl, path="Figures",device = "pdf", width=8, height=25, units=c("in"), dpi=300)

pl<-grid.arrange(PAM_mcapProfile,PAM_pcompProfile,PAM_pvarProfile,PAM_pacuProfile, nrow =4)
ggsave("PAM_Profileall.pdf", plot=pl, path="Figures",device = "pdf", width=8, height=25, units=c("in"), dpi=300)
```

#Protein

```{r}
Protein <- read.csv("Data/Protein_TT17_20190214.csv")
prottest<-merge(meta, Protein, all=T)
keepPr<-c("Frag.ID", "mg.prot.ml") #keep cols you need
Protein<-Protein[keepPr]

Protein<-merge(Protein, Slurry) #merge with slurry
Protein<-merge(Protein, SA) # merge with SA
Protein$Surface.area<-as.numeric(as.character(Protein$Surface.area))
Protein<-merge(Protein, meta) #merge with metadata
Protein$Parent.ID<-as.factor(as.character(Protein$Parent.ID))
Protein$Tank.num<-as.factor(as.character(Protein$Tank.num))

# calculate total prot per total vol of slurry
Protein$prot.ml<- Protein$mg.prot.ml*Protein$TotalVolume

# create a new column to calculate per surface area (mg/mm2)
Protein$mg.mm2 <- Protein$prot.ml/Protein$Surface.area

PRotcheck<-merge(Protein, meta, all=T)
#write.csv(PRotcheck, "Proteincheck.csv")

#calc means
Protein_mean <- ddply(Protein, c("Treatment", "Species", "Time.Point"), summarise, #summarize prot
                   N    = length(mg.mm2[!is.na(mg.mm2)]), 
                   mean = mean(mg.mm2, na.rm=TRUE), 
                   sd   = sd(mg.mm2, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                   max = max(mg.mm2, na.rm=TRUE) 
)
Protein_mean

Protein_meanCLADE <- ddply(Protein, c("Treatment", "Species", "Time.Point","Clade"), summarise, #summarize prot
                   N    = length(mg.mm2[!is.na(mg.mm2)]), 
                   mean = mean(mg.mm2, na.rm=TRUE), 
                   sd   = sd(mg.mm2, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                   max = max(mg.mm2, na.rm=TRUE) 
)
Protein_meanCLADE

#stats

hist(Protein$mg.mm2)
Protein$mg.mm2_log<-log10(Protein$mg.mm2+1)
hist(Protein$mg.mm2_log)
Protein$mg.mm2_sqrt<-sqrt(Protein$mg.mm2)
hist(Protein$mg.mm2_sqrt) #better

 
```

Stats

```{r}
 
#t0
Prot_stats_T0<-subset(Protein, Time.Point=="T0")
hist (Prot_stats_T0$mg.mm2_sqrt) 

#t0 only
Prot_T0_model<-lmer(mg.mm2_sqrt~Treatment*Species+(1|Tank.num), Prot_stats_T0)
anova(Prot_T0_model)  #species differ
qqPlot(residuals(Prot_T0_model)) 
emm<-emmeans(Prot_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)

#t0 only by speices?
Prot_stats_T0.mcap<-subset(Prot_stats_T0, Species=="Montipora capitata")
Prot_stats_T0.pcomp<-subset(Prot_stats_T0, Species=="Porites compressa")
Prot_stats_T0.pvar<-subset(Prot_stats_T0, Species=="Pavona varians")
Prot_stats_T0.pacu<-subset(Prot_stats_T0, Species=="Pocillopora acuta")

#mcap
Prot_T0_model<-lmer(mg.mm2_sqrt~Clade+(1|Tank.num), Prot_stats_T0.mcap)
anova(Prot_T0_model)  #species differ
qqPlot(residuals(Prot_T0_model)) 
emm<-emmeans(Prot_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
Prot_T0_model<-lmer(mg.mm2_sqrt~Clade+(1|Tank.num), Prot_stats_T0.pcomp)
anova(Prot_T0_model)  #species differ
qqPlot(residuals(Prot_T0_model)) 
emm<-emmeans(Prot_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
Prot_T0_model<-lmer(mg.mm2_sqrt~Clade+(1|Tank.num), Prot_stats_T0.pvar)
anova(Prot_T0_model)  #species differ
qqPlot(residuals(Prot_T0_model)) 
emm<-emmeans(Prot_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
Prot_T0_model<-lmer(mg.mm2_sqrt~Clade+(1|Tank.num), Prot_stats_T0.pacu)
anova(Prot_T0_model)  #species differ
qqPlot(residuals(Prot_T0_model)) 
emm<-emmeans(Prot_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)




#T1TF ####
Prot_stats_T1TF<-subset(Protein, Time.Point=="T1"|Time.Point=="TF")



Protein_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Species+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF)
anova(Protein_model) 
qqPlot(residuals(Protein_model)) #not awful

  emm<-emmeans(Protein_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)

  emm<-emmeans(Protein_model,  ~ Species*Treatment|Time.Point, adjust="Tukey")
cld(emm) 
pairs(emm)

Protein_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Species*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF)
anova(Protein_model) 
qqPlot(residuals(Protein_model)) #not awful

  emm<-emmeans(Protein_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
cld(emm)
pairs(emm)


# by Species df: Prot_stats_T1TF_Mcap, Prot_stats_T1TF_Pcomp, Prot_stats_T1TF_Pvar, Prot_stats_T1TF_Pacu
Prot_stats_T1TF_Mcap<-subset(Prot_stats_T1TF, Species=="Montipora capitata")
  Prot_stats_T1TF_Mcap.C<-subset(Prot_stats_T1TF_Mcap, Clade=="C")
  Prot_stats_T1TF_Mcap.CD<-subset(Prot_stats_T1TF_Mcap, Clade=="CD")
Prot_stats_T1TF_Pcomp<-subset(Prot_stats_T1TF, Species=="Porites compressa")
  Prot_stats_T1TF_Pcomp.C15cj<-subset(Prot_stats_T1TF_Pcomp, Clade=="C15cj")
  Prot_stats_T1TF_Pcomp.C15n<-subset(Prot_stats_T1TF_Pcomp, Clade=="C15n")
Prot_stats_T1TF_Pvar<-subset(Prot_stats_T1TF, Species=="Pavona varians")
  Prot_stats_T1TF_Pvar.C1<-subset(Prot_stats_T1TF_Pvar, Clade=="C1")
  Prot_stats_T1TF_Pvar.C27<-subset(Prot_stats_T1TF_Pvar, Clade=="C27")
Prot_stats_T1TF_Pacu<-subset(Prot_stats_T1TF, Species=="Pocillopora acuta")
  Prot_stats_T1TF_Pacu.CCC<-subset(Prot_stats_T1TF_Pacu, Clade=="CCC")
  Prot_stats_T1TF_Pacu.C42<-subset(Prot_stats_T1TF_Pacu, Clade=="C42")
  
#mcap ####
#lmer
  Prot_Mcap_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Mcap)
  anova(Prot_Mcap_model) 
Prot_Mcap_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Mcap)
  anova(Prot_Mcap_model) 
  qqPlot(residuals(Prot_Mcap_model)) 
  emm<-emmeans(Prot_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
 #T1 only
  aProt_stats_Mcap.T1<-Prot_stats_Mcap.T1
  Prot_stats_Mcap.T1<-subset(Prot_stats_T1TF_Mcap, Time.Point=="T1")
  Prot_Mcap_model.T1<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Mcap.T1)
  anova(Prot_Mcap_model.T1) 
    Prot_Mcap_model.T1<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Mcap.T1)
  anova(Prot_Mcap_model.T1) 
  qqPlot(residuals(Prot_Mcap_model.T1)) 
  emm<-emmeans(Prot_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Prot_stats_Mcap.TF<-subset(Prot_stats_T1TF_Mcap, Time.Point=="TF")
Prot_Mcap_model.TF<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Mcap.TF)
  anova(Prot_Mcap_model.TF) 
  Prot_Mcap_model.TF<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Mcap.TF)
  anova(Prot_Mcap_model.TF) 
  qqPlot(residuals(Prot_Mcap_model.TF)) 
  emm<-emmeans(Prot_Mcap_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#mcap-C only
  Prot_Mcap_model.C<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Mcap.C)
  anova(Prot_Mcap_model.C) 
  qqPlot(residuals(Prot_Mcap_model.C)) 
    emm<-emmeans(Prot_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  Prot_Mcap_model.CD<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Mcap.CD)
  anova(Prot_Mcap_model.CD) 
  qqPlot(residuals(Prot_Mcap_model.CD)) 
    emm<-emmeans(Prot_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)*
    pairs(emm)
    
#Pcomp ####
#lmer
Prot_Pcomp_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pcomp)
  anova(Prot_Pcomp_model) 
  qqPlot(residuals(Prot_Pcomp_model)) 
  emm<-emmeans(Prot_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)


Prot_Pcomp_model.Clade<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pcomp)
  anova(Prot_Pcomp_model.Clade) 
  qqPlot(residuals(Prot_Pcomp_model.Clade)) 
  emm<-emmeans(Prot_Pcomp_model.Clade,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)

  #T1 only
  Prot_stats_Pcomp.T1<-subset(Prot_stats_T1TF_Pcomp, Time.Point=="T1")
   Prot_Pcomp_model.T1<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pcomp.T1)
  anova(Prot_Pcomp_model.T1) 
    Prot_Pcomp_model.T1<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pcomp.T1)
  anova(Prot_Pcomp_model.T1) 
  qqPlot(residuals(Prot_Pcomp_model.T1)) 
  emm<-emmeans(Prot_Pcomp_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Prot_stats_Pcomp.TF<-subset(Prot_stats_T1TF_Pcomp, Time.Point=="TF")
Prot_Pcomp_model.TF<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pcomp.TF)
  anova(Prot_Pcomp_model.TF) 
  Prot_Pcomp_model.TF<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pcomp.TF)
  anova(Prot_Pcomp_model.TF) 
  qqPlot(residuals(Prot_Pcomp_model.TF)) 
  emm<-emmeans(Prot_Pcomp_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)     
    
        
    
#Pcomp-C15cj only
  Prot_Pcomp_model.C15cj<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pcomp.C15cj)
  anova(Prot_Pcomp_model.C15cj) 
  qqPlot(residuals(Prot_Pcomp_model.C15cj)) 
    emm<-emmeans(Prot_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C15cj only
  Prot_Pcomp_model.C15n<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pcomp.C15n)
  anova(Prot_Pcomp_model.C15n) 
  qqPlot(residuals(Prot_Pcomp_model.C15n)) 
    emm<-emmeans(Prot_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#Pvar ####
#lmer 
    Prot_Pvar_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pvar)
  anova(Prot_Pvar_model) 
  emm<-emmeans(Prot_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
Prot_Pvar_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pvar)
  anova(Prot_Pvar_model) 
  qqPlot(residuals(Prot_Pvar_model)) 
  emm<-emmeans(Prot_Pvar_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

 #T1 only
  Prot_stats_Pvar.T1<-subset(Prot_stats_T1TF_Pvar, Time.Point=="T1")
  Prot_Pvar_model.T1<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pvar.T1)
  anova(Prot_Pvar_model.T1) 
    Prot_Pvar_model.T1<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pvar.T1)
  anova(Prot_Pvar_model.T1) 
  qqPlot(residuals(Prot_Pvar_model.T1)) 
  emm<-emmeans(Prot_Pvar_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Prot_stats_Pvar.TF<-subset(Prot_stats_T1TF_Pvar, Time.Point=="TF")
Prot_Pvar_model.TF<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pvar.TF)
  anova(Prot_Pvar_model.TF) 
  Prot_Pvar_model.TF<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pvar.TF)
  anova(Prot_Pvar_model.TF) 
  qqPlot(residuals(Prot_Pvar_model.TF)) 
  emm<-emmeans(Prot_Pvar_model.TF,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
    
#Pvar-C1 only
  Prot_Pvar_model.C1<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pvar.C1)
  anova(Prot_Pvar_model.C1) 
  qqPlot(residuals(Prot_Pvar_model.C1)) 
    emm<-emmeans(Prot_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  Prot_Pvar_model.C27<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pvar.C27)
  anova(Prot_Pvar_model.C27) 
  qqPlot(residuals(Prot_Pvar_model.C27)) 
    emm<-emmeans(Prot_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#Pacu ####
#lmer
    Prot_Pacu_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pacu)
  anova(Prot_Pacu_model)
   emm<-emmeans(Prot_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
   cld(emm)
    pairs(emm)
Prot_Pacu_model<-lmer(mg.mm2_sqrt~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pacu)
  anova(Prot_Pacu_model) 
  qqPlot(residuals(Prot_Pacu_model)) 
  emm<-emmeans(Prot_Pacu_model,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)

 #T1 only
  Prot_stats_Pacu.T1<-subset(Prot_stats_T1TF_Pacu, Time.Point=="T1")
  Prot_Pacu_model.T1<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pacu.T1)
  anova(Prot_Pacu_model.T1) 
    Prot_Pacu_model.T1<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pacu.T1)
  anova(Prot_Pacu_model.T1) 
  qqPlot(residuals(Prot_Pacu_model.T1)) 
  emm<-emmeans(Prot_Pacu_model.T1,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    Prot_stats_Pacu.TF<-subset(Prot_stats_T1TF_Pacu, Time.Point=="TF")
 Prot_Pacu_model.TF<-lmer(mg.mm2_sqrt~Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pacu.TF)
  anova(Prot_Pacu_model.TF) 
  Prot_Pacu_model.TF<-lmer(mg.mm2_sqrt~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), Prot_stats_Pacu.TF)
  anova(Prot_Pacu_model.TF) 
  qqPlot(residuals(Prot_Pacu_model.TF)) 
  emm<-emmeans(Prot_Pacu_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
#Pacu-CCC only
  Prot_Pacu_model.CCC<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pacu.CCC)
  anova(Prot_Pacu_model.CCC) 
  qqPlot(residuals(Prot_Pacu_model.CCC)) 
    emm<-emmeans(Prot_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  Prot_Pacu_model.C42<-lmer(mg.mm2_sqrt~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), Prot_stats_T1TF_Pacu.C42)
  anova(Prot_Pacu_model.C42) 
  qqPlot(residuals(Prot_Pacu_model.C42)) 
    emm<-emmeans(Prot_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
```

plots

```{r}

#just T0 #### 
Protein_T0<-subset(Protein, Time.Point=="T0")

#T0 only
  ggplot(Protein_T0, aes(x=Species, y=mg.mm2, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluble Protein '(mg~mm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Total Soluable Protein")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("Protein_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(Protein_T0, aes(x=interaction(Clade, Species), y=mg.mm2, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(bquote('Total Soluable Protein '(mg~mm^2)))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle("Total Soluable Protein by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
  
ggsave("Protein_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
  
#Plots T1 and TF####
Protein_T1TF<-subset(Protein, Time.Point!="T0") 

#T1TF - by species ####
ProteinT1TF<- ggplot(Protein_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Total Soluable Protein")+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluable Protein '(mg~mm^2)))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");ProteinT1TF

#all species ####
#Subset by time 1 or F only 
Protein_T1<-subset(Protein, Time.Point=="T1") 
Protein_TF<-subset(Protein, Time.Point=="TF") 

#T1 - by species
ProteinT1<-ggplot(Protein_T1, aes(x=Species, y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Total Soluable Protein Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluable Protein '(mg~mm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);ProteinT1

ggsave("Protein_T1_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot####
Protein_T1_mcap<-subset(Protein_T1, Species=="Montipora capitata") 
Protein_T1_pcomp<-subset(Protein_T1, Species=="Porites compressa") 
Protein_T1_pvar<-subset(Protein_T1, Species=="Pavona varians") 
Protein_T1_pacu<-subset(Protein_T1, Species=="Pocillopora acuta") 

#Mcap ####
Protein_Mcap_plot<- 
  ggplot(Protein_T1_mcap, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluable Protein '(mg~mm^2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");Protein_Mcap_plot
  
#Pcomp ####
Protein_Pcomp_plot<- ggplot(Protein_T1_pcomp, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pcomp_plot

#Pvar ####
Protein_Pvar_plot<- ggplot(Protein_T1_pvar, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pvar_plot

#Pacu ####
Protein_Pacu_plot<- ggplot(Protein_T1_pacu, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pacu_plot

plot_row<-plot_grid(Protein_Mcap_plot, Protein_Pcomp_plot, Protein_Pvar_plot, Protein_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Total Soluable Protein T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("Protein_profiles_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
   ProteinTF<-   ggplot(Protein_TF, aes(x=Species, y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Total Soluable Protein Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluable Protein '(mg~mm^2)))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);ProteinTF

ggsave("Protein_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)


#TF - by species and algal profile - make for each species and then cowplot####
Protein_TF_mcap<-subset(Protein_TF, Species=="Montipora capitata") 
Protein_TF_pcomp<-subset(Protein_TF, Species=="Porites compressa") 
Protein_TF_pvar<-subset(Protein_TF, Species=="Pavona varians") 
Protein_TF_pacu<-subset(Protein_TF, Species=="Pocillopora acuta") 

#Mcap ####
Protein_Mcap_plot<- 
  ggplot(Protein_TF_mcap, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(bquote('Total Soluable Protein '(mg~cm^2)))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");Protein_Mcap_plot
  
#Pcomp ####
Protein_Pcomp_plot<- ggplot(Protein_TF_pcomp, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pcomp_plot

#Pvar ####
Protein_Pvar_plot<- ggplot(Protein_TF_pvar, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pvar_plot

#Pacu ####
Protein_Pacu_plot<- ggplot(Protein_TF_pacu, aes(x=interaction(Treatment,Clade), y=mg.mm2, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);Protein_Pacu_plot

plot_row<-plot_grid(Protein_Mcap_plot, Protein_Pcomp_plot, Protein_Pvar_plot, Protein_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Total Soluable Protein TF", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  Protein_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));Protein_profilesTF

ggsave("Protein_profiles_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```

#Resp:photosynthesis

```{r}
#load data respirometry_processed.csv
PR  <- read.csv("Data/respirometry_processed_Final.csv")
#PR<-PR[,c("Frag.ID","Date","Yield","Parent.ID","Treatment","Species","Tank.num","Days")] # keep only columns you need
#write.csv(PR, "PR.df.csv")

#subset metadata for what you need 
metaPR<-meta
metaPR<-metaPR[,c("Frag.ID","Parent.ID","Treatment","Species","Tank.num")] # keep only columns you need
metaPR$Parent.ID<-as.factor(as.character(metaPR$Parent.ID))
metaPR$Tank.num<-as.factor(as.character(metaPR$Tank.num))

#subset to add metadata bc merg isnt' wroking
PR_T0<-subset(PR, Time.Point=="T0")
PR_T0m<-merge(PR_T0, metaPR, all.y=T) #this weeds out 'extra' frags
PR_T0m<-PR_T0m[!is.na(PR_T0m$PR), ] #remove rows with no PR
duplicated(PR_T0m$Frag.ID) #check for duplicated rows per frag (for redos)
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N94" & PR_T0m$round==2),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N211" & PR_T0m$round==4),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N209" & PR_T0m$round==2),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N197" & PR_T0m$round==4),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N181" & PR_T0m$round==8),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N104" & PR_T0m$round==6),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="422" & PR_T0m$round==4),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="3442" & PR_T0m$round==4),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="284" & PR_T0m$round==1),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="284" & PR_T0m$round==11),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="1736" & PR_T0m$channel==8),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="1556" & PR_T0m$round==2),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="1279" & PR_T0m$round==1),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="1226" & PR_T0m$round==8),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="1144" & PR_T0m$round==4),]  #remove the dups
PR_T0m<-PR_T0m[!(PR_T0m$Frag.ID=="N92" & PR_T0m$round==4),]  #remove the dups
duplicated(PR_T0m$Frag.ID) #check for duplicated rows per frag (for redos)



PR_T1<-subset(PR, Time.Point=="T1")
PR_T1m<-merge(PR_T1, metaPR, all.y=T) #this weeds out 'extra' frags
PR_T1m<-PR_T1m[!is.na(PR_T1m$PR), ] #remove rows with no PR
duplicated(PR_T1m$Frag.ID) #check for duplicated rows per frag (for redos)
PR_T1m<-PR_T1m[!(PR_T1m$Frag.ID=="1413" & PR_T1m$round==2),]  #remove the dups
PR_T1m<-PR_T1m[!(PR_T1m$Frag.ID=="477" & PR_T1m$Photo==2.339480e-04),]  #remove the dups
PR_T1m<-PR_T1m[!(PR_T1m$Frag.ID=="3383" & PR_T1m$round==12),]  #remove the dups
PR_T1m<-PR_T1m[!(PR_T1m$Frag.ID=="1791" & PR_T1m$round==13),]  #remove the dups

PR_TF<-subset(PR, Time.Point=="TF")
PR_TFm<-merge(PR_TF, metaPR, all.y=T) #this weeds out 'extra' frags
PR_TFm<-PR_TFm[!is.na(PR_TFm$PR), ] #remove rows with no PR
duplicated(PR_TFm$Frag.ID) #check for duplicated rows per frag (for redos)
PR_TFm<-PR_TFm[!(PR_TFm$Frag.ID=="3481" & PR_TFm$round==11),]  #remove the PR is no possible, algae note

PR.df<-rbind(PR_T0m,PR_T1m)
PR.df<-rbind(PR.df,PR_TFm)

#add the clades in 
metaPR<-meta[,c("Frag.ID","Clade")] # keep only columns you need
PR.df<-merge(PR.df, metaPR)
#write.csv(PR.df, "P_R_PR.csv")
######## 

PR.df_B<-PR.df
PR.df_B$Photo<-PR.df_B$Photo * 60 #change from per second to per min
PR.df_B$Photo<-PR.df_B$Photo * 1000 #change from umol to nanomol

PR.df_B$Resp<-PR.df_B$Resp * 60 #change from per second to per min
PR.df_B$Resp<-PR.df_B$Resp * 1000 #change from umol to nanomol


###working on this. KB uses umol O2 cm-2 hr- and my numbers are seemingly a little diff.
  #try umol and per hour
  # PR.df$Photo_hr<-PR.df$Photo * 3600 #change from per second to per min to per hour
  # 
  # #PR.df_B$Photo<-PR.df_B$Photo * 1000 #change from umol to nanomol
  # 
  # PR.df$Resp_hr<-PR.df_B$Resp * 3600 #change from per second to per hr
  # #PR.df_B$Resp<-PR.df_B$Resp * 1000 #change from umol to nanomol

#change Respiration to positive by mulit * -1 for figures and Gross P calcs
PR.df_B$RespPos<-PR.df_B$Resp*(-1)

# Make net Photosynthesis into Gross photo by adding + RespPOS
PR.df_B$GrossP<-PR.df_B$Photo+PR.df_B$RespPos

#calcualte PR ratio with gross (abs values)
PR.df_B$PR_real<-PR.df_B$GrossP/PR.df_B$RespPos

```

Plots Photosynthesis

```{r}

#just T0 #### 
PR.df_T0<-subset(PR.df_B, Time.Point=="T0")

 tapply(PR.df_T0$GrossP, PR.df_T0$Species, mean)
aggregate(GrossP ~ Species + Treatment, PR.df_T0, mean)

#T0 only
  ggplot(PR.df_T0, aes(x=Species, y=GrossP, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Gross Photosynthesis")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("GrossPhoto_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T0 only - by algal profile ####
  ggplot(PR.df_T0, aes(x=interaction(Clade, Species), y=GrossP, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle("Gross Photosynthesis by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
  
ggsave("GrossPhoto_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
  
#all species ####

#Plots T1 and TF####
Photo_T1TF<-subset(PR.df_B, Time.Point!="T0") 

#T1TF - by species ####
PhotoT1TF<- ggplot(Photo_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Gross Photosynthesis")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PhotoT1TF

#Subset by time 1 or F only 
PR.df_T1<-subset(PR.df_B, Time.Point=="T1") 
PR.df_TF<-subset(PR.df_B, Time.Point=="TF") 

#T1 - by species
PhotoT1<-ggplot(PR.df_T1, aes(x=Species, y=Photo, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Gross Photosynthesis Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);PhotoT1

ggsave("GrossPhoto_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot####
PR.df_T1_mcap<-subset(PR.df_T1, Species=="Montipora capitata") 
PR.df_T1_pcomp<-subset(PR.df_T1, Species=="Porites compressa") 
PR.df_T1_pvar<-subset(PR.df_T1, Species=="Pavona varians") 
PR.df_T1_pacu<-subset(PR.df_T1, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_T1_mcap, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste( "nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot

     # ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+

  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_T1_pcomp, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_T1_pvar, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_T1_pacu, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Gross Photosynthesis T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("GrossPhoto_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
    PhotoTF<-  ggplot(PR.df_TF, aes(x=Species, y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Gross Photosynthesis Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(expression(paste( "mol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);PhotoTF

ggsave("GrossPhoto_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
PR.df_TF_mcap<-subset(PR.df_TF, Species=="Montipora capitata") 
PR.df_TF_pcomp<-subset(PR.df_TF, Species=="Porites compressa") 
PR.df_TF_pvar<-subset(PR.df_TF, Species=="Pavona varians") 
PR.df_TF_pacu<-subset(PR.df_TF, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_TF_mcap, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(min)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot
  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_TF_pcomp, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_TF_pvar, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_TF_pacu, aes(x=interaction(Treatment,Clade), y=GrossP, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Gross Photosynthesis TF", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  PR.df_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));PR.df_profilesTF

ggsave("GrossPhoto_profile_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)


```


Gross Photosynthesis stats

```{r}
#df PR.df_B, use all time points bc repeated measures 

hist(PR.df_B$GrossP) #so normal

#t0
GrossP_stats_T0<-subset(PR.df_B, Time.Point=="T0")
hist (GrossP_stats_T0$GrossP) 

#t0 only 
GrossP_stats_T0_model<-lmer(GrossP~Treatment*Species+(1|Tank.num), GrossP_stats_T0)
anova(GrossP_stats_T0_model)  #species differ
qqPlot(residuals(GrossP_stats_T0_model)) 
emm<-emmeans(GrossP_stats_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)
emm<-emmeans(GrossP_stats_T0_model,  ~ Species*Treatment, adjust="Tukey")
cld(emm)
pairs(emm)
 

#t0 only by speices?
GrossP_stats_T0.mcap<-subset(GrossP_stats_T0, Species=="Montipora capitata")
GrossP_stats_T0.pcomp<-subset(GrossP_stats_T0, Species=="Porites compressa")
GrossP_stats_T0.pvar<-subset(GrossP_stats_T0, Species=="Pavona varians")
GrossP_stats_T0.pacu<-subset(GrossP_stats_T0, Species=="Pocillopora acuta")

#mcap
GrossP_T0_model<-lmer(GrossP~Clade+(1|Tank.num), GrossP_stats_T0.mcap)
anova(GrossP_T0_model)  #species differ
qqPlot(residuals(GrossP_T0_model)) 
emm<-emmeans(GrossP_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
GrossP_T0_model<-lmer(GrossP~Clade+(1|Tank.num), GrossP_stats_T0.pcomp)
anova(GrossP_T0_model)  #species differ
qqPlot(residuals(GrossP_T0_model)) 
emm<-emmeans(GrossP_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
GrossP_T0_model<-lmer(GrossP~Clade+(1|Tank.num), GrossP_stats_T0.pvar)
anova(GrossP_T0_model)  #species differ
qqPlot(residuals(GrossP_T0_model)) 
emm<-emmeans(GrossP_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
GrossP_T0_model<-lmer(GrossP~Clade+(1|Tank.num), GrossP_stats_T0.pacu)
anova(GrossP_T0_model)  #species differ
qqPlot(residuals(GrossP_T0_model)) 
emm<-emmeans(GrossP_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)


#T1TF#### 
#lmer
GrossP_stats_model<-lmer(GrossP~Time.Point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B)
anova(GrossP_stats_model) 
qqPlot(residuals(GrossP_stats_model)) 
GrossP_stats_modelC<-lmer(GrossP~Time.Point*Treatment*Species*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B)
anova(GrossP_stats_modelC) 

emm<-emmeans(GrossP_stats_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
 cld(emm)
 pairs(emm)

# by Species df: PR.df_B_Mcap, PR.df_B_Pcomp, PR.df_B_Pvar, PR.df_B_Pacu
PR.df_B_Mcap<-subset(PR.df_B, Species=="Montipora capitata")
  PR.df_B_Mcap.C<-subset(PR.df_B_Mcap, Clade=="C")
  PR.df_B_Mcap.CD<-subset(PR.df_B_Mcap, Clade=="CD")
PR.df_B_Pcomp<-subset(PR.df_B, Species=="Porites compressa")
  PR.df_B_Pcomp.C15cj<-subset(PR.df_B_Pcomp, Clade=="C15cj")
  PR.df_B_Pcomp.C15n<-subset(PR.df_B_Pcomp, Clade=="C15n")
PR.df_B_Pvar<-subset(PR.df_B, Species=="Pavona varians")
  PR.df_B_Pvar.C1<-subset(PR.df_B_Pvar, Clade=="C1")
  PR.df_B_Pvar.C27<-subset(PR.df_B_Pvar, Clade=="C27")
PR.df_B_Pacu<-subset(PR.df_B, Species=="Pocillopora acuta")
  PR.df_B_Pacu.CCC<-subset(PR.df_B_Pacu, Clade=="CCC")
  PR.df_B_Pacu.C42<-subset(PR.df_B_Pacu, Clade=="C42")
  
#mcap####
#lmer   
GrossP_Mcap_model<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(GrossP_Mcap_model) 
  qqPlot(residuals(GrossP_Mcap_model)) 
  emm<-emmeans(GrossP_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  GrossP_Mcap_model<-lmer(GrossP~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(GrossP_Mcap_model) 
  qqPlot(residuals(GrossP_Mcap_model)) 
  emm<-emmeans(GrossP_Mcap_model,  ~ Clade*Treatment*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
  PR.df_B_Mcap.T1<-subset(PR.df_B_Mcap, Time.Point=="T1")
      PR.df_B_Mcap_model.T1<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1) 
    PR.df_B_Mcap_model.T1<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1) 
  qqPlot(residuals(PR.df_B_Mcap_model.T1)) 
  emm<-emmeans(PR.df_B_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
    emm<-emmeans(PR.df_B_Mcap_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Mcap.TF<-subset(PR.df_B_Mcap, Time.Point=="TF")
  PR.df_B_Mcap_model.TF<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  PR.df_B_Mcap_model.TF<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  qqPlot(residuals(PR.df_B_Mcap_model.TF)) 
  emm<-emmeans(PR.df_B_Mcap_model.TF,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
  
  
  
#mcap-C only ####
  GrossP_Mcap_model.C<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.C)
  anova(GrossP_Mcap_model.C) 
  qqPlot(residuals(GrossP_Mcap_model.C)) 
    emm<-emmeans(GrossP_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  GrossP_Mcap_model.CD<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.CD)
  anova(GrossP_Mcap_model.CD) 
  qqPlot(residuals(GrossP_Mcap_model.CD)) 
    emm<-emmeans(GrossP_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
####Pcomp ####
#lmer 
GrossP_Pcomp_model<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(GrossP_Pcomp_model) 
  qqPlot(residuals(GrossP_Pcomp_model)) 
  emm<-emmeans(GrossP_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

GrossP_Pcomp_model.Clade<-lmer(GrossP~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(GrossP_Pcomp_model.Clade) 
  qqPlot(residuals(GrossP_Pcomp_model.Clade)) 
  emm<-emmeans(GrossP_Pcomp_model.Clade,  ~ Treatment*Clade|Time.Point, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
     #T1 only
  PR.df_B_Pcomp.T1<-subset(PR.df_B_Pcomp, Time.Point=="T1")
   PR.df_B_Pcomp_model.T1<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
    PR.df_B_Pcomp_model.T1<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
  qqPlot(residuals(PR.df_B_Pcomp_model.T1)) 
  emm<-emmeans(PR.df_B_Pcomp_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pcomp.TF<-subset(PR.df_B_Pcomp, Time.Point=="TF")
  PR.df_B_Pcomp_model.TF<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF) 
  PR.df_B_Pcomp_model.TF<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF) 
  qqPlot(residuals(PR.df_B_Pcomp_model.TF)) 
  emm<-emmeans(PR.df_B_Pcomp_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
    
#Pcomp-C15cj only ####
  GrossP_Pcomp_model.C15cj<-1-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15cj)
  anova(GrossP_Pcomp_model.C15cj) 
  qqPlot(residuals(GrossP_Pcomp_model.C15cj)) 
    emm<-emmeans(GrossP_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  GrossP_Pcomp_model.C15n<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15n)
  anova(GrossP_Pcomp_model.C15n) 
  qqPlot(residuals(GrossP_Pcomp_model.C15n)) 
    emm<-emmeans(GrossP_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#####Pvar ####
#lmer
    GrossP_Pvar_model<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(GrossP_Pvar_model) 
    emm<-emmeans(GrossP_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
GrossP_Pvar_model<-lmer(GrossP~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(GrossP_Pvar_model) 
  qqPlot(residuals(GrossP_Pvar_model)) 
  emm<-emmeans(GrossP_Pvar_model,  ~ Treatment*Clade|Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
  PR.df_B_Pvar.T1<-subset(PR.df_B_Pvar, Time.Point=="T1")
      PR.df_B_Pvar_model.T1<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1) 
    PR.df_B_Pvar_model.T1<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1) 
  qqPlot(residuals(PR.df_B_Pvar_model.T1)) 
  emm<-emmeans(PR.df_B_Pvar_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pvar.TF<-subset(PR.df_B_Pvar, Time.Point=="TF")
PR.df_B_Pvar_model.TF<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  PR.df_B_Pvar_model.TF<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  qqPlot(residuals(PR.df_B_Pvar_model.TF)) 
  emm<-emmeans(PR.df_B_Pvar_model.TF,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
#Pvar-C only ####
  GrossP_Pvar_model.C1<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C1)
  anova(GrossP_Pvar_model.C1) 
  qqPlot(residuals(GrossP_Pvar_model.C1)) 
    emm<-emmeans(GrossP_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-CD only
  GrossP_Pvar_model.C27<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C27)
  anova(GrossP_Pvar_model.C27) 
  qqPlot(residuals(GrossP_Pvar_model.C27)) 
    emm<-emmeans(GrossP_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#####Pacu ####
#lmer
    GrossP_Pacu_model<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(GrossP_Pacu_model) 
  emm<-emmeans(GrossP_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
GrossP_Pacu_model<-lmer(GrossP~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(GrossP_Pacu_model) 
  qqPlot(residuals(GrossP_Pacu_model)) 
  emm<-emmeans(GrossP_Pacu_model,  ~ Treatment*Clade|Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
  PR.df_B_Pacu.T1<-subset(PR.df_B_Pacu, Time.Point=="T1")
      PR.df_B_Pacu_model.T1<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1)
    PR.df_B_Pacu_model.T1<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1) 
  qqPlot(residuals(PR.df_B_Pacu_model.T1)) 
  emm<-emmeans(PR.df_B_Pacu_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pacu.TF<-subset(PR.df_B_Pacu, Time.Point=="TF")
  PR.df_B_Pacu_model.TF<-lmer(GrossP~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  PR.df_B_Pacu_model.TF<-lmer(GrossP~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  qqPlot(residuals(PR.df_B_Pacu_model.TF)) 
  emm<-emmeans(PR.df_B_Pacu_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#Pacu-CCC only
  GrossP_Pacu_model.CCC<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.CCC)
  anova(GrossP_Pacu_model.CCC) 
  qqPlot(residuals(GrossP_Pacu_model.CCC)) 
    emm<-emmeans(GrossP_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  GrossP_Pacu_model.C42<-lmer(GrossP~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.C42)
  anova(GrossP_Pacu_model.C42) 
  qqPlot(residuals(GrossP_Pacu_model.C42)) 
    emm<-emmeans(GrossP_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
    
```

Respiration plots

```{r}
#Respiration (absolute)
#just T0 #### 
PR.df_T0<-subset(PR.df_B, Time.Point=="T0")

#T0 only
  ggplot(PR.df_T0, aes(x=Species, y=Resp, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Respiration")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("Resp_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(PR.df_T0, aes(x=interaction(Clade, Species), y=Resp, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle(" Respiration by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
  
ggsave("Resp_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
  

#Plots T1 and TF####
Resp_T1TF<-subset(PR.df_B, Time.Point!="T0") 

#T1TF - by species ####
RespT1TF<- ggplot(Resp_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Respiration")+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");RespT1TF

#all species ####
#Subset by time 1 or F only 
PR.df_T1<-subset(PR.df_B, Time.Point=="T1") 
PR.df_TF<-subset(PR.df_B, Time.Point=="TF") 

#T1 - by species
RespT1<-ggplot(PR.df_T1, aes(x=Species, y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Respiration Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);RespT1

ggsave("Resp_T1_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot####
PR.df_T1_mcap<-subset(PR.df_T1, Species=="Montipora capitata") 
PR.df_T1_pcomp<-subset(PR.df_T1, Species=="Porites compressa") 
PR.df_T1_pvar<-subset(PR.df_T1, Species=="Pavona varians") 
PR.df_T1_pacu<-subset(PR.df_T1, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_T1_mcap, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot
  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_T1_pcomp, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_T1_pvar, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_T1_pacu, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Respiration T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("Resp_profile_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
      RespTF<-ggplot(PR.df_TF, aes(x=Species, y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("Respiration Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);RespTF


ggsave("Resp_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
PR.df_TF_mcap<-subset(PR.df_TF, Species=="Montipora capitata") 
PR.df_TF_pcomp<-subset(PR.df_TF, Species=="Porites compressa") 
PR.df_TF_pvar<-subset(PR.df_TF, Species=="Pavona varians") 
PR.df_TF_pacu<-subset(PR.df_TF, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_TF_mcap, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot
  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_TF_pcomp, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_TF_pvar, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_TF_pacu, aes(x=interaction(Treatment,Clade), y=Resp, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("Respiration by Algal Profile Post Recovery", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  PR.df_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));PR.df_profilesTF

ggsave("Resp_profile_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```

Resp stats

```{r}
#df PR.df_B 
 
hist(PR.df_B$Resp) #normal

#t0
Resp_stats_T0<-subset(PR.df_B, Time.Point=="T0")
hist (Resp_stats_T0$Resp) 

#t0 only
Resp_stats_T0_model<-lmer(Resp~Treatment*Species+(1|Tank.num), Resp_stats_T0)
anova(Resp_stats_T0_model)  #species differ
qqPlot(residuals(Resp_stats_T0_model)) 
emm<-emmeans(Resp_stats_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)


#t0 only by speices?
Resp_stats_T0.mcap<-subset(Resp_stats_T0, Species=="Montipora capitata")
Resp_stats_T0.pcomp<-subset(Resp_stats_T0, Species=="Porites compressa")
Resp_stats_T0.pvar<-subset(Resp_stats_T0, Species=="Pavona varians")
Resp_stats_T0.pacu<-subset(Resp_stats_T0, Species=="Pocillopora acuta")

#mcap
Resp_T0_model<-lmer(Resp~Clade+(1|Tank.num), Resp_stats_T0.mcap)
anova(Resp_T0_model)  #species differ
qqPlot(residuals(Resp_T0_model)) 
emm<-emmeans(Resp_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
Resp_T0_model<-lmer(Resp~Clade+(1|Tank.num), Resp_stats_T0.pcomp)
anova(Resp_T0_model)  #species differ
qqPlot(residuals(Resp_T0_model)) 
emm<-emmeans(Resp_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
Resp_T0_model<-lmer(Resp~Clade+(1|Tank.num), Resp_stats_T0.pvar)
anova(Resp_T0_model)  #species differ
qqPlot(residuals(Resp_T0_model)) 
emm<-emmeans(Resp_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
Resp_T0_model<-lmer(Resp~Clade+(1|Tank.num), Resp_stats_T0.pacu)
anova(Resp_T0_model)  #species differ
qqPlot(residuals(Resp_T0_model)) 
emm<-emmeans(Resp_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)
#T1TF#### 
#lmer
Resp_stats_model<-lmer(Resp~Time.Point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B)
anova(Resp_stats_model) 
qqPlot(residuals(Resp_stats_model)) 

Resp_stats_modelC<-lmer(Resp~Time.Point*Treatment*Species*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B)
anova(Resp_stats_modelC) 

emm<-emmeans(Resp_stats_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
 cld(emm)
 pairs(emm)
   
#mcap #### 
#lmer
 Resp_Mcap_model<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(Resp_Mcap_model)
  qqPlot(residuals(Resp_Mcap_model)) 
  emm<-emmeans(Resp_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
    
# Resp_Mcap_model<-lmer(Resp~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap)   SINGULAR remove nest
#   anova(Resp_Mcap_model) 
  Resp_Mcap_model<-lmer(Resp~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(Resp_Mcap_model) 
  qqPlot(residuals(Resp_Mcap_model)) 
  emm<-emmeans(Resp_Mcap_model,  ~ Clade*Treatment*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
      PR.df_B_Mcap_model.T1<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1) 
    PR.df_B_Mcap_model.T1<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1) 
  qqPlot(residuals(PR.df_B_Mcap_model.T1)) 
  emm<-emmeans(PR.df_B_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm) 
  pairs(emm)
  
  #TF only
    PR.df_B_Mcap_model.TF<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  PR.df_B_Mcap_model.TF<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  qqPlot(residuals(PR.df_B_Mcap_model.TF)) 
  emm<-emmeans(PR.df_B_Mcap_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
#mcap-C only ####
  Resp_Mcap_model.C<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.C)
  anova(Resp_Mcap_model.C) 
  qqPlot(residuals(Resp_Mcap_model.C)) 
    emm<-emmeans(Resp_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  Resp_Mcap_model.CD<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.CD)
  anova(Resp_Mcap_model.CD) 
  qqPlot(residuals(Resp_Mcap_model.CD)) 
    emm<-emmeans(Resp_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
######Pcomp ####
#lmer
Resp_Pcomp_model<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(Resp_Pcomp_model) 
  qqPlot(residuals(Resp_Pcomp_model)) 
  emm<-emmeans(Resp_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Resp_Pcomp_model.Clade<-lmer(Resp~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(Resp_Pcomp_model.Clade) 
  qqPlot(residuals(Resp_Pcomp_model.Clade)) 
  emm<-emmeans(Resp_Pcomp_model.Clade,  ~ Treatment*Clade*Time.Point, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
  #T1 only
        PR.df_B_Pcomp_model.T1<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
    PR.df_B_Pcomp_model.T1<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
  qqPlot(residuals(PR.df_B_Pcomp_model.T1)) 
  emm<-emmeans(PR.df_B_Pcomp_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pcomp_model.TF<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF) 
  PR.df_B_Pcomp_model.TF<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF) 
  qqPlot(residuals(PR.df_B_Pcomp_model.TF)) 
  emm<-emmeans(PR.df_B_Pcomp_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)      
    
#Pcomp-C15cj only ####
  Resp_Pcomp_model.C15cj<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15cj)
  anova(Resp_Pcomp_model.C15cj) 
  qqPlot(residuals(Resp_Pcomp_model.C15cj)) 
    emm<-emmeans(Resp_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  Resp_Pcomp_model.C15n<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15n)
  anova(Resp_Pcomp_model.C15n) 
  qqPlot(residuals(Resp_Pcomp_model.C15n)) 
    emm<-emmeans(Resp_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#####Pvar ####
#lmer
Resp_Pvar_model<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(Resp_Pvar_model) 
  qqPlot(residuals(Resp_Pvar_model)) 
  emm<-emmeans(Resp_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

Resp_Pvar_model<-lmer(Resp~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(Resp_Pvar_model) 
  qqPlot(residuals(Resp_Pvar_model)) 
  emm<-emmeans(Resp_Pvar_model,  ~ Treatment*Clade*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
   #T1 only
     PR.df_B_Pvar_model.T1<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1)
    PR.df_B_Pvar_model.T1<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1) 
  qqPlot(residuals(PR.df_B_Pvar_model.T1)) 
  emm<-emmeans(PR.df_B_Pvar_model.T1,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
     
    PR.df_B_Pvar_model.TF<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  PR.df_B_Pvar_model.TF<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  qqPlot(residuals(PR.df_B_Pvar_model.TF)) 
  emm<-emmeans(PR.df_B_Pvar_model.TF,  ~ Treatment*Clade, adjust="Tukey")
  cld(emm)
  pairs(emm)  
    
  
#Pvar-C1 only ####
  Resp_Pvar_model.C1<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C1)
  anova(Resp_Pvar_model.C1) 
  qqPlot(residuals(Resp_Pvar_model.C1)) 
    emm<-emmeans(Resp_Pvar_model.C1,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  Resp_Pvar_model.C27<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C27)
  anova(Resp_Pvar_model.C27) 
  qqPlot(residuals(Resp_Pvar_model.C27)) 
    emm<-emmeans(Resp_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

#####Pacu ####
#lmer
Resp_Pacu_model<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(Resp_Pacu_model) 
  qqPlot(residuals(Resp_Pacu_model)) 
  emm<-emmeans(Resp_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
Resp_Pacu_model<-lmer(Resp~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(Resp_Pacu_model) 
  qqPlot(residuals(Resp_Pacu_model)) 
  emm<-emmeans(Resp_Pacu_model,  ~ Treatment*Clade*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm) 
 
   #T1 only
      PR.df_B_Pacu_model.T1<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1) 
    PR.df_B_Pacu_model.T1<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1) 
  qqPlot(residuals(PR.df_B_Pacu_model.T1)) 
  emm<-emmeans(PR.df_B_Pacu_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pacu_model.TF<-lmer(Resp~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  PR.df_B_Pacu_model.TF<-lmer(Resp~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  qqPlot(residuals(PR.df_B_Pacu_model.TF)) 
  emm<-emmeans(PR.df_B_Pacu_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
   
#Pacu-CCC only
  Resp_Pacu_model.CCC<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.CCC)
  anova(Resp_Pacu_model.CCC) 
  qqPlot(residuals(Resp_Pacu_model.CCC)) 
    emm<-emmeans(Resp_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  Resp_Pacu_model.C42<-lmer(Resp~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.C42)
  anova(Resp_Pacu_model.C42) 
  qqPlot(residuals(Resp_Pacu_model.C42)) 
    emm<-emmeans(Resp_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
    
```

P:R plots

```{r}
#Respiration (absolute)
#just T0 #### 
PR.df_T0<-subset(PR.df_B, Time.Point=="T0")

#T0 only
  ggplot(PR.df_T0, aes(x=Species, y=PR, fill=Species)) + 
      scale_fill_manual(values=c("#E69F00", "#56B4E9", "#CC79A7","#009E73"))+
      xlab("") + #Label the X Axis
      ylab(expression(paste(plain("\u03bc"), "mol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ggtitle("Respiration")+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE)
ggsave("resp_T0.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T0 only - by algal profile
  ggplot(PR.df_T0, aes(x=interaction(Clade, Species), y=PR, fill=Clade)) + 
      scale_fill_manual(values=c("goldenrod1","darkorange3", "powderblue","#0072B2" ,"pink1","firebrick",   "palegreen2","darkgreen"))+
      xlab("") + #Label the X Axis
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14, face="bold"))+
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      ggtitle("Respiration by Algal Profile")+
      geom_boxplot( show.legend = FALSE)+
      scale_x_discrete(guide = "axis_nested")
  
ggsave("PR_T0_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
  



#Plots T1 and TF####
PR_T1TF<-subset(PR.df_B, Time.Point!="T0") 

#T1TF - by species ####
PRT1TF<- ggplot(PR_T1TF, aes(x=interaction(Treatment,Time.Point,Species), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("PR")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PRT1TF

#all species ####
#Subset by time 1 or F only 
PR.df_T1<-subset(PR.df_B, Time.Point=="T1") 
PR.df_TF<-subset(PR.df_B, Time.Point=="TF") 

#T1 - by species
PRT1<-ggplot(PR.df_T1, aes(x=Species, y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle(" PRiration Post-Elevated Temperatures")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);PRT1


ggsave("PR_T1_profile.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#T1 - by species and algal profile - make for each species and then cowplot####
PR.df_T1_mcap<-subset(PR.df_T1, Species=="Montipora capitata") 
PR.df_T1_pcomp<-subset(PR.df_T1, Species=="Porites compressa") 
PR.df_T1_pvar<-subset(PR.df_T1, Species=="Pavona varians") 
PR.df_T1_pacu<-subset(PR.df_T1, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_T1_mcap, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot
  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_T1_pcomp, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_T1_pvar, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_T1_pacu, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("PRiration T1", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1))

ggsave("PR_profile_T1.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF ####
     PRTF<- ggplot(PR.df_TF, aes(x=Species, y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("PRiration Post-Recovery")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(face = "italic",size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_boxplot(show.legend = FALSE);PRTF

ggsave("PR_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)

#TF - by species and algal profile - make for each species and then cowplot####
PR.df_TF_mcap<-subset(PR.df_TF, Species=="Montipora capitata") 
PR.df_TF_pcomp<-subset(PR.df_TF, Species=="Porites compressa") 
PR.df_TF_pvar<-subset(PR.df_TF, Species=="Pavona varians") 
PR.df_TF_pacu<-subset(PR.df_TF, Species=="Pocillopora acuta") 

#Mcap ####
PR.df_Mcap_plot<- 
  ggplot(PR.df_TF_mcap, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("M. capitata")+
      xlab("") + #Label the X Axis
      ylab(expression(paste("nmol ", O[2], " cm"^"-2 ", plain(m)^"-1")))+
      theme(axis.text.x = element_text(size=14))+
      theme(axis.text.y = element_text(size=14))+
      theme(axis.title.y = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      geom_boxplot(show.legend = F)+
          scale_x_discrete(guide = "axis_nested");PR.df_Mcap_plot
  
#Pcomp ####
PR.df_Pcomp_plot<- ggplot(PR.df_TF_pcomp, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. compressa")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pcomp_plot

#Pvar ####
PR.df_Pvar_plot<- ggplot(PR.df_TF_pvar, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. varians")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +           
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pvar_plot

#Pacu ####
PR.df_Pacu_plot<- ggplot(PR.df_TF_pacu, aes(x=interaction(Treatment,Clade), y=PR, fill=Treatment)) + 
      scale_fill_manual(values=c("deepskyblue1", "orangered"))+
      ggtitle("P. acuta")+
      xlab("") + 
      ylab("") + 
      theme(axis.text.y = element_text(size=14))+
      theme(axis.text.x = element_text(size=14))+
      theme(plot.title = element_text(size=16, face="bold.italic"))+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +        
      scale_x_discrete(guide = "axis_nested")+
      geom_boxplot(show.legend = F);PR.df_Pacu_plot

plot_row<-plot_grid(PR.df_Mcap_plot, PR.df_Pcomp_plot, PR.df_Pvar_plot, PR.df_Pacu_plot, nrow=1,label_size = 12)
  title <- ggdraw() + 
  draw_label("PRiration by Algal Profile Post Recovery", fontface = 'bold',x = 0, hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
  PR.df_profilesTF<-plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.1, 1));PR.df_profilesTF

ggsave("PR_profile_TF.pdf", plot=last_plot(), path="Figures",device = "pdf", width=15, height=4, units=c("in"), dpi=300)
```

Plots by Clades

```{r}
#Mcap 
PR_mean.Clade <- ddply(PR.df_B, c("Treatment", "Species", "Time.Point","Clade"), summarise, 
                   N    = length(PR_real[!is.na(PR_real)]), 
                   mean = mean(PR_real, na.rm=TRUE), 
                   sd   = sd(PR_real, na.rm=TRUE), 
                   se   = sd / sqrt(N), 
                   max = max(PR_real, na.rm=TRUE) 
)
PR_mean.Clade #display table

# divide by species
Mcap_PR_mean.Clade<-subset(PR_mean.Clade, Species =="Montipora capitata")
  Mcap_PR_mean.Clade$Code<-paste(Mcap_PR_mean.Clade$Clade, Mcap_PR_mean.Clade$Treatment)
Pcomp_PR_mean.Clade<-subset(PR_mean.Clade, Species =="Porites compressa")
  Pcomp_PR_mean.Clade$Code<-paste(Pcomp_PR_mean.Clade$Clade, Pcomp_PR_mean.Clade$Treatment)
Pvar_PR_mean.Clade<-subset(PR_mean.Clade, Species =="Pavona varians")
  Pvar_PR_mean.Clade$Code<-paste(Pvar_PR_mean.Clade$Clade, Pvar_PR_mean.Clade$Treatment)
Pacu_PR_mean.Clade<-subset(PR_mean.Clade, Species =="Pocillopora acuta")
  Pacu_PR_mean.Clade$Code<-paste(Pacu_PR_mean.Clade$Clade, Pacu_PR_mean.Clade$Treatment)


library(RColorBrewer)

#Mcap by clade

#Mcap by clade
Mcap_PR_mean.Clade$Code<-paste(Mcap_PR_mean.Clade$Treatment,Mcap_PR_mean.Clade$Clade)

Mcap_PR_plot.Clade<-ggplot(data=Mcap_PR_mean.Clade, aes(x=Time.Point, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
            width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+ 
  geom_line(linetype="dotted")+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
  # xlab("Time Point") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("nmol cm-2 m-"))) +
# theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_rect(colour = "black", size=2))+
        theme(aspect.ratio=1)+
  # ggtitle("Mcap PR")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Mcap_PR_plot.Clade

#Pcomp by clade
Pcomp_PR_mean.Clade$Code<-paste(Pcomp_PR_mean.Clade$Treatment,Pcomp_PR_mean.Clade$Clade)

Pcomp_PR_plot.Clade<-ggplot(data=Pcomp_PR_mean.Clade, aes(x=Time.Point, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
            width=0.1, show.legend = T)+
    geom_point(aes(color=Code), size=4, show.legend = T)+ 
  geom_line(linetype="dotted")+
    scale_linetype_manual(values=c("twodash", "dotted"))+
  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
  xlab("Time Point") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  #ylab(expression(paste("umol/sec/cm2"))) +
# theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_rect(colour = "black", size=2))+
        theme(aspect.ratio=1)+
  # ggtitle("Pcomp PR")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pcomp_PR_plot.Clade


#Pvar by clade
Pvar_PR_mean.Clade$Code<-paste(Pvar_PR_mean.Clade$Treatment,Pvar_PR_mean.Clade$Clade)

Pvar_PR_plot.Clade<-ggplot(data=Pvar_PR_mean.Clade, aes(x=Time.Point, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
            width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+ 
  geom_line(linetype="dotted")+

  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
  xlab("Time Point") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
 # ylab(expression(paste("umol/sec/cm2"))) +
# theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_rect(colour = "black", size=2))+
        theme(aspect.ratio=1)+
  # ggtitle("Pvar PR")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pvar_PR_plot.Clade

#Pacu by clade
Pacu_PR_mean.Clade$Code<-paste(Pacu_PR_mean.Clade$Treatment,Pacu_PR_mean.Clade$Clade)

Pacu_PR_plot.Clade<-ggplot(data=Pacu_PR_mean.Clade, aes(x=Time.Point, y=mean, group = Code, color=Code)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
            width=0.1, show.legend = T)+
  geom_point(aes(color=Code), size=4, show.legend = T)+ 
    geom_line(linetype="dotted")+

  scale_color_manual(values=c("dodgerblue3","blue", "darkred","red"))+
  xlab("Time Point") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border 
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
 # ylab(expression(paste("umol/sec/cm2"))) +
# theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_rect(colour = "black", size=2))+
        theme(aspect.ratio=1)+
  # ggtitle("Pacu PR")+
  theme(plot.title = element_text(size=20, face = "italic", hjust=0.5));Pacu_PR_plot.Clade


# 
Mcap_PR_plot.Clade<-Mcap_PR_plot.Clade+ theme(legend.position = "none") #remove legend
Pcomp_PR_plot.Clade<-Pcomp_PR_plot.Clade+ theme(legend.position = "none") #remove legend
Pvar_PR_plot.Clade<-Pvar_PR_plot.Clade+ theme(legend.position = "none") #remove legend
Pacu_PR_plot.Clade<-Pacu_PR_plot.Clade+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_PR_plot.Clade, Pcomp_PR_plot.Clade, Pvar_PR_plot.Clade,Pacu_PR_plot.Clade, nrow = 1)

```

PR stats

```{r}
#df PR.df_B 

hist(PR.df_B$PR_real) #good

#t0
PR_stats_T0<-subset(PR.df_B, Time.Point=="T0")
hist (PR_stats_T0$PR_real)  #good

#t0 only
PR_stats_T0_model<-lmer(PR_real~Treatment*Species+(1|Tank.num), PR_stats_T0)
anova(PR_stats_T0_model)  #species differ
qqPlot(residuals(PR_stats_T0_model)) 
emm<-emmeans(PR_stats_T0_model,  ~ Species, adjust="Tukey")
cld(emm)
pairs(emm)
emm<-emmeans(PR_stats_T0_model,  ~ Species*Treatment, adjust="Tukey")
cld(emm)
pairs(emm)
 

#t0 only by speices?
PR_stats_T0.mcap<-subset(PR_stats_T0, Species=="Montipora capitata")
PR_stats_T0.pcomp<-subset(PR_stats_T0, Species=="Porites compressa")
PR_stats_T0.pvar<-subset(PR_stats_T0, Species=="Pavona varians")
PR_stats_T0.pacu<-subset(PR_stats_T0, Species=="Pocillopora acuta")

#mcap
PR_T0_model<-lmer(PR_real~Clade+(1|Tank.num), PR_stats_T0.mcap)
anova(PR_T0_model)  #species differ
qqPlot(residuals(PR_T0_model)) 
emm<-emmeans(PR_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pcomp
PR_T0_model<-lmer(PR_real~Clade+(1|Tank.num), PR_stats_T0.pcomp)
anova(PR_T0_model)  #species differ
qqPlot(residuals(PR_T0_model)) 
emm<-emmeans(PR_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pvar
PR_T0_model<-lmer(PR_real~Clade+(1|Tank.num), PR_stats_T0.pvar)
anova(PR_T0_model)  #species differ
qqPlot(residuals(PR_T0_model)) 
emm<-emmeans(PR_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)

#pacu
PR_T0_model<-lmer(PR_real~Clade+(1|Tank.num), PR_stats_T0.pacu)
anova(PR_T0_model)  #species differ
qqPlot(residuals(PR_T0_model)) 
emm<-emmeans(PR_T0_model,  ~ Clade, adjust="Tukey")
cld(emm)
pairs(emm)




PR.df_B_Mcap<-subset(PR.df_B, Species=="Montipora capitata")
PR.df_B_Pcomp<-subset(PR.df_B, Species=="Porites compressa")
PR.df_B_Pvar<-subset(PR.df_B, Species=="Pavona varians")
PR.df_B_Pacu<-subset(PR.df_B, Species=="Pocillopora acuta")

# by Species df: PR.df_B_Mcap, PR.df_B_Pcomp, PR.df_B_Pvar, PR.df_B_Pacu
PR.df_B_Mcap<-subset(PR.df_B, Species=="Montipora capitata")
  PR.df_B_Mcap.C<-subset(PR.df_B_Mcap, Clade=="C")
  PR.df_B_Mcap.CD<-subset(PR.df_B_Mcap, Clade=="CD")
PR.df_B_Pcomp<-subset(PR.df_B, Species=="Porites compressa")
  PR.df_B_Pcomp.C15cj<-subset(PR.df_B_Pcomp, Clade=="C15cj")
  PR.df_B_Pcomp.C15n<-subset(PR.df_B_Pcomp, Clade=="C15n")
PR.df_B_Pvar<-subset(PR.df_B, Species=="Pavona varians")
  PR.df_B_Pvar.C1<-subset(PR.df_B_Pvar, Clade=="C1")
  PR.df_B_Pvar.C27<-subset(PR.df_B_Pvar, Clade=="C27")
PR.df_B_Pacu<-subset(PR.df_B, Species=="Pocillopora acuta")
  PR.df_B_Pacu.CCC<-subset(PR.df_B_Pacu, Clade=="CCC")
  PR.df_B_Pacu.C42<-subset(PR.df_B_Pacu, Clade=="C42")




#lmer
PR_stats_model<-lmer(PR_real~Time.Point*Treatment*Species+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B)
anova(PR_stats_model) 
qqPlot(residuals(PR_stats_model)) 

PR_stats_modelC<-lmer(PR~Time.Point*Treatment*Species*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B) #prob should not run this
anova(PR_stats_modelC) 

emm<-emmeans(PR_stats_model,  ~ Time.Point*Treatment|Species, adjust="Tukey")
 cld(emm)
 pairs(emm)
  
#mcap ####
#lmer
  PR_Mcap_model<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(PR_Mcap_model) 
 PR_Mcap_model<-lmer(PR~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(PR_Mcap_model) 
    emm<-emmeans(PR_Mcap_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
PR_Mcap_model<-lmer(PR_real~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap)
  anova(PR_Mcap_model) 
  qqPlot(residuals(PR_Mcap_model)) 
  emm<-emmeans(PR_Mcap_model,  ~ Clade*Treatment*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm) 

 #T1 only
      PR.df_B_Mcap_model.T1<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1)
    PR.df_B_Mcap_model.T1<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.T1)
  anova(PR.df_B_Mcap_model.T1) 
  qqPlot(residuals(PR.df_B_Mcap_model.T1)) 
  emm<-emmeans(PR.df_B_Mcap_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
    emm<-emmeans(PR.df_B_Mcap_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Mcap_model.TF<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  PR.df_B_Mcap_model.TF<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Mcap.TF)
  anova(PR.df_B_Mcap_model.TF) 
  qqPlot(residuals(PR.df_B_Mcap_model.TF)) 
  emm<-emmeans(PR.df_B_Mcap_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
  
#mcap-C only####
  PR_Mcap_model.C<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.C)
  anova(PR_Mcap_model.C) 
  qqPlot(residuals(PR_Mcap_model.C)) 
    emm<-emmeans(PR_Mcap_model.C,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#mcap-CD only
  PR_Mcap_model.CD<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Mcap.CD)
  anova(PR_Mcap_model.CD) 
  qqPlot(residuals(PR_Mcap_model.CD)) 
    emm<-emmeans(PR_Mcap_model.CD,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
########Pcomp ####
#lmer
    PR_Pcomp_model<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(PR_Pcomp_model) 
   emm<-emmeans(PR_Pcomp_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
PR_Pcomp_model<-lmer(PR_real~Time.Point*Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(PR_Pcomp_model) 
  qqPlot(residuals(PR_Pcomp_model)) 
  emm<-emmeans(PR_Pcomp_model,  ~ Clade*Treatment*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

PR_Pcomp_model.Clade<-lmer(PR~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp)
  anova(PR_Pcomp_model.Clade) 
  qqPlot(residuals(PR_Pcomp_model.Clade)) 
  emm<-emmeans(PR_Pcomp_model.Clade,  ~ Time.Point*Treatment*Clade, adjust="Tukey")
    cld(emm)
    pairs(emm)
 
  #T1 only
     PR.df_B_Pcomp_model.T1<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
    PR.df_B_Pcomp_model.T1<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.T1)
  anova(PR.df_B_Pcomp_model.T1) 
  qqPlot(residuals(PR.df_B_Pcomp_model.T1)) 
  emm<-emmeans(PR.df_B_Pcomp_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
    emm<-emmeans(PR.df_B_Pcomp_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
   PR.df_B_Pcomp_model.TF<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF)
  PR.df_B_Pcomp_model.TF<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pcomp.TF)
  anova(PR.df_B_Pcomp_model.TF) 
  qqPlot(residuals(PR.df_B_Pcomp_model.TF)) 
  emm<-emmeans(PR.df_B_Pcomp_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
  
    emm<-emmeans(PR.df_B_Pcomp_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm) 
      
    
#Pcomp-C15cj only ####
  PR_Pcomp_model.C15cj<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15cj)
  anova(PR_Pcomp_model.C15cj) 
  qqPlot(residuals(PR_Pcomp_model.C15cj)) 
    emm<-emmeans(PR_Pcomp_model.C15cj,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pcomp-C27 only
  PR_Pcomp_model.C15n<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pcomp.C15n)
  anova(PR_Pcomp_model.C15n) 
  qqPlot(residuals(PR_Pcomp_model.C15n)) 
    emm<-emmeans(PR_Pcomp_model.C15n,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
#####Pvar ####
#lmer 
    PR_Pvar_model<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(PR_Pvar_model) 
    qqPlot(residuals(PR_Pvar_model)) 
  emm<-emmeans(PR_Pvar_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
PR_Pvar_model<-lmer(PR_real~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar)
  anova(PR_Pvar_model) 
  qqPlot(residuals(PR_Pvar_model)) 
  emm<-emmeans(PR_Pvar_model,  ~ Treatment*Clade*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

 #T1 only
      PR.df_B_Pvar_model.T1<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1) 
    PR.df_B_Pvar_model.T1<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.T1)
  anova(PR.df_B_Pvar_model.T1) 
  qqPlot(residuals(PR.df_B_Pvar_model.T1)) 
  emm<-emmeans(PR.df_B_Pvar_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  emm<-emmeans(PR.df_B_Pvar_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pvar_model.TF<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  PR.df_B_Pvar_model.TF<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pvar.TF)
  anova(PR.df_B_Pvar_model.TF) 
  qqPlot(residuals(PR.df_B_Pvar_model.TF)) 
  emm<-emmeans(PR.df_B_Pvar_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)    
    emm<-emmeans(PR.df_B_Pvar_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)   
  
  
#Pvar-C1 only####
  PR_Pvar_model.C1<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C1)
  anova(PR_Pvar_model.C1) 
  qqPlot(residuals(PR_Pvar_model.C1)) 
    emm<-emmeans(PR_Pvar_model.C1,  ~ Clade*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pvar-C27 only
  PR_Pvar_model.C27<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pvar.C27)
  anova(PR_Pvar_model.C27) 
  qqPlot(residuals(PR_Pvar_model.C27)) 
    emm<-emmeans(PR_Pvar_model.C27,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)  

 #### Pacu ####
#lmer 
    PR_Pacu_model<-lmer(PR_real~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(PR_Pacu_model) 
  qqPlot(residuals(PR_Pacu_model)) 
  emm<-emmeans(PR_Pacu_model,  ~ Time.Point*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)

  
PR_Pacu_model<-lmer(PR_real~Time.Point*Treatment*Clade+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu)
  anova(PR_Pacu_model) 
  qqPlot(residuals(PR_Pacu_model)) 
  emm<-emmeans(PR_Pacu_model,  ~ Treatment*Clade*Time.Point, adjust="Tukey")
  cld(emm)
  pairs(emm)

   #T1 only
    PR.df_B_Pacu_model.T1<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1)
    PR.df_B_Pacu_model.T1<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.T1)
  anova(PR.df_B_Pacu_model.T1) 
  qqPlot(residuals(PR.df_B_Pacu_model.T1)) 
  emm<-emmeans(PR.df_B_Pacu_model.T1,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
    emm<-emmeans(PR.df_B_Pacu_model.T1,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)
  
  #TF only
    PR.df_B_Pacu_model.TF<-lmer(PR_real~Treatment+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  PR.df_B_Pacu_model.TF<-lmer(PR_real~Treatment*Clade+(1|Parent.ID)+(1|Tank.num), PR.df_B_Pacu.TF)
  anova(PR.df_B_Pacu_model.TF) 
  qqPlot(residuals(PR.df_B_Pacu_model.TF)) 
  emm<-emmeans(PR.df_B_Pacu_model.TF,  ~ Clade*Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
    emm<-emmeans(PR.df_B_Pacu_model.TF,  ~ Treatment, adjust="Tukey")
  cld(emm)
  pairs(emm)  
#Pacu-CCC only ####
  PR_Pacu_model.CCC<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.CCC)
  anova(PR_Pacu_model.CCC) 
  qqPlot(residuals(PR_Pacu_model.CCC)) 
    emm<-emmeans(PR_Pacu_model.CCC,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)

#Pacu-C42 only
  PR_Pacu_model.C42<-lmer(PR~Time.Point*Treatment+(1|Parent.ID:Frag.ID)+(1|Tank.num), PR.df_B_Pacu.C42)
  anova(PR_Pacu_model.C42) 
  qqPlot(residuals(PR_Pacu_model.C42)) 
    emm<-emmeans(PR_Pacu_model.C42,  ~ Time.Point*Treatment, adjust="Tukey")
    cld(emm)
    pairs(emm)
    
     
```

All P, R, PR plots

```{r}
grid.arrange(Mcap_Photo_plot, Pcomp_Photo_plot, Pvar_Photo_plot,Pacu_Photo_plot,Mcap_Resp_plot, Pcomp_Resp_plot, Pvar_Resp_plot,Pacu_Resp_plot,Mcap_PR_plot, Pcomp_PR_plot, Pvar_PR_plot,Pacu_PR_plot, nrow = 3)

 
#by clade
grid.arrange(Mcap_Photo_plot.Clade, Pcomp_Photo_plot.Clade, Pvar_Photo_plot.Clade,Pacu_Photo_plot.Clade,Mcap_Resp_plot.Clade, Pcomp_Resp_plot.Clade, Pvar_Resp_plot.Clade,Pacu_Resp_plot.Clade,Mcap_PR_plot.Clade, Pcomp_PR_plot.Clade, Pvar_PR_plot.Clade,Pacu_PR_plot.Clade, nrow = 3)

```

# all physio figure T1 and TF boxplots Figure 4

```{r}
library(patchwork)

# Adjust y-axis text size and hide x-axis labels/underlines except for the bottom plot
BiomassT1TF <- BiomassT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 9),
        panel.spacing = unit(1, "lines"))

bwT1TF <- bwT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

FlowT1TF <- FlowT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

ChlaT1TF <- ChlaT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

FvFmT1TF <- FvFmT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

ProteinT1TF <- ProteinT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

PhotoT1TF <- PhotoT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

RespT1TF <- RespT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

PRT1TF <- PRT1TF + 
  theme(axis.text.y = element_text(size = 10),axis.title.y = element_text(size = 9))  # Keep x-axis on bottom plot

# Combine plots vertically using patchwork
combined_plot <- BiomassT1TF / bwT1TF / FlowT1TF / ChlaT1TF / FvFmT1TF / 
                 ProteinT1TF / PhotoT1TF / RespT1TF / PRT1TF +
                 plot_layout(ncol = 1)



pdf("CombinedPhysioPlots.pdf", width = 10, height = 18)
print(combined_plot)
dev.off()

```

#same as above with FvFm for P.acuta 0s removed
```{r}
library(patchwork)

FvFmT1TF <- FvFmT1TF +
  theme(axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

# Combine plots vertically using patchwork
combined_plot <- BiomassT1TF / bwT1TF / FlowT1TF / ChlaT1TF / FvFmT1TF / 
                 ProteinT1TF / PhotoT1TF / RespT1TF / PRT1TF +
                 plot_layout(ncol = 1)



pdf("CombinedPhysioPlots.pdf", width = 10, height = 18)
print(combined_plot)
dev.off()

```



#COMBINE all physio dfs Set these up so they are by PARENT-TREATMENT-TIMEPOINT and average across frag reps

```{r}
#prep metadata for by Parent.ID df for ordinations
metaPhysio<-subset(meta, select= -X)#remove X from df
metaPhysio<-subset(metaPhysio, select= -Tank.num)#remove tank from df
metaPhysio<-subset(metaPhysio, select= -Frag.ID)#remove tank from df
metaPhysio$Code<-paste(metaPhysio$Species,metaPhysio$Treatment,metaPhysio$Parent.ID, metaPhysio$Time.Point)


#biomass: keep Frag.ID and AFDW.cm2_log
Biomass_psy<- Biomass_stats[,c("Frag.ID","Parent.ID" ,"Species","Treatment","Tank.num","Time.Point","AFDWmg.cm2")] # keep only columns you need
  
# #create duplicate T0 for H or A that isn't there for each parent. ONLY IF YOU WANTT0
#   Biomass_psyT0<-Biomass_psy #copy
#   Biomass_psyT0<-subset(Biomass_psyT0, Time.Point=="T0")
#   Biomass_psyT0Amb<-Biomass_psyT0
#   Biomass_psyT0Amb$Treatment[Biomass_psyT0Amb$Treatment == "High"] <- "Ambient" #change 
#   Biomass_psyT0High<-Biomass_psyT0
#   Biomass_psyT0High$Treatment[Biomass_psyT0High$Treatment == "Ambient"] <- "High" #change 
#   Biomass_psyT02<-rbind(Biomass_psyT0Amb,Biomass_psyT0High) #now oyu have T0 for Amb and High
# 
#   Biomass_psy<-Biomass_psy[!(Biomass_psy$Time.Point=="T0"),] #remove T0s
#   Biomass_psy<-rbind(Biomass_psy,Biomass_psyT02) # add the full T0 dataset
# duplicated(Biomass_psy)
  Biomass_psy$Code<-paste(Biomass_psy$Species,Biomass_psy$Treatment,Biomass_psy$Parent.ID, Biomass_psy$Time.Point)

  Biomass_psy<- Biomass_psy[,c("Code" ,"AFDWmg.cm2")] # keep only columns you need
duplicated(Biomass_psy) #check
Biomass_psy<-unique(Biomass_psy) # remove dups

#cell counts:FC_Data df and keep  Frag.ID and zoox.cm2_log
CellCounts_psy<- FC_Data[,c("Frag.ID","Parent.ID" ,"Species","Treatment","Tank.num","Time.Point","zoox.cm2_log")] # keep only columns you need

# #create duplicate T0 for H or A that isn't there for each parent. id
#   CellCounts_psyT0<-CellCounts_psy #copy
#   CellCounts_psyT0<-subset(CellCounts_psyT0, Time.Point=="T0")
#   CellCounts_psyT0Amb<-CellCounts_psyT0
#   CellCounts_psyT0Amb$Treatment[CellCounts_psyT0Amb$Treatment == "High"] <- "Ambient" #change 
#   CellCounts_psyT0High<-CellCounts_psyT0
#   CellCounts_psyT0High$Treatment[CellCounts_psyT0High$Treatment == "Ambient"] <- "High" #change 
#   CellCounts_psyT02<-rbind(CellCounts_psyT0Amb,CellCounts_psyT0High) #now oyu have T0 for Amb and High
# 
#   CellCounts_psy<-CellCounts_psy[!(CellCounts_psy$Time.Point=="T0"),] #remove T0s
#   CellCounts_psy<-rbind(CellCounts_psy,CellCounts_psyT02) # add the full T0 dataset

  CellCounts_psy$Code<-paste(CellCounts_psy$Species,CellCounts_psy$Treatment,CellCounts_psy$Parent.ID, CellCounts_psy$Time.Point)

  CellCounts_psy<- CellCounts_psy[,c("Code" ,"zoox.cm2_log")] # keep only columns you need
names(CellCounts_psy)[names(CellCounts_psy) == "zoox.cm2_log"] <- "Zoox Density"
  duplicated(CellCounts_psy)
  CellCounts_psy<-unique(CellCounts_psy) #keep uniques


#Chla Chla df ChlaSA_quart
 Chla_psy<- Chla 
Chla_psy<- Chla_psy[,c("Parent.ID" ,"Species","Treatment","Time.Point","ChlaSA")] # keep only columns you need
names(Chla_psy)[names(Chla_psy) == "ChlaSA"] <- "Chl a"

# #create duplicate T0 for H or A that isn't there for each parent. id
#   Chla_psyT0<-Chla_psy #copy
#   Chla_psyT0<-subset(Chla_psyT0, Time.Point=="T0")
#   Chla_psyT0Amb<-Chla_psyT0
#   Chla_psyT0Amb$Treatment[Chla_psyT0Amb$Treatment == "High"] <- "Ambient" #change 
#   Chla_psyT0High<-Chla_psyT0
#   Chla_psyT0High$Treatment[Chla_psyT0High$Treatment == "Ambient"] <- "High" #change 
#   Chla_psyT02<-rbind(Chla_psyT0Amb,Chla_psyT0High) #now oyu have T0 for Amb and High
# 
#   Chla_psy<-Chla_psy[!(Chla_psy$Time.Point=="T0"),] #remove T0s
#   Chla_psy<-rbind(Chla_psy,Chla_psyT02) # add the full T0 dataset

  Chla_psy$Code<-paste(Chla_psy$Species,Chla_psy$Treatment,Chla_psy$Parent.ID, Chla_psy$Time.Point)
Chla_psy<- Chla_psy[,c("Code","Chl a")] # keep only columns you need

duplicated(Chla_psy)


#Protein Protein$mg.mm2_sqrt
Protein_psy<- Protein[,c("Parent.ID" ,"Species","Treatment","Time.Point","mg.mm2_sqrt")] # keep only columns you need
names(Protein_psy)[names(Protein_psy) == "mg.mm2_sqrt"] <- "Protein"

# #create duplicate T0 for H or A that isn't there for each parent. id
#   Protein_psyT0<-Protein_psy #copy
#   Protein_psyT0<-subset(Protein_psyT0, Time.Point=="T0")
#   Protein_psyAmb<-Protein_psyT0
#   Protein_psyAmb$Treatment[Protein_psyAmb$Treatment == "High"] <- "Ambient" #change 
#   Protein_psyHigh<-Protein_psyT0
#   Protein_psyHigh$Treatment[Protein_psyHigh$Treatment == "Ambient"] <- "High" #change 
#   Protein_psy2<-rbind(Protein_psyAmb,Protein_psyHigh) #now oyu have T0 for Amb and High
# 
#   Protein_psy<-Protein_psy[!(Protein_psy$Time.Point=="T0"),] #remove T0s
#   Protein_psy<-rbind(Protein_psy,Protein_psy2) # add the full T0 dataset

  Protein_psy$Code<-paste(Protein_psy$Species,Protein_psy$Treatment,Protein_psy$Parent.ID, Protein_psy$Time.Point)
Protein_psy<- Protein_psy[,c("Code","Protein")] # keep only columns you need
duplicated(Protein_psy)

#Repeate measures ####
#Calcification, Growth and percent.change_log do for each time point ####

Calcification_psy<- Growth.Percent.day #copy df

Calcification_psy <- Calcification_psy %>%
  mutate(percent.change = ifelse(Time.Point == "T0", 0, percent.change))
(Calcification_psy <- Calcification_psy %>%
  drop_na() )
Calcification_psy$Time.point<-as.character(Calcification_psy$Time.point)
Calcification_psy$Time.point[Calcification_psy$Time.point == "time1.growth"] <- "T1" #change 
Calcification_psy$Time.point[Calcification_psy$Time.point == "time2.growth"] <- "TF" #change 
Calcification_psy$Time.point<-as.factor(Calcification_psy$Time.point)
 names(Calcification_psy)[names(Calcification_psy) == "Time.point"] <- "Time.Point" #change name

Calcification_psy$Code<-paste(Calcification_psy$Species,Calcification_psy$Treatment,Calcification_psy$Parent.ID,Calcification_psy$Time.Point) #make code

Calcification_psy<- Calcification_psy[,c("Code","percent.change","Parent.ID", "Treatment","Species","Time.Point")] # keep only columns you need



# Calcification_psy<-Calcification_psy %>% group_by(Code) %>% mutate(mean=mean(percent.change_sqrt)) # mean by code, this worked
# names(Calcification_psy)[names(Calcification_psy) == "mean"] <- "calc.percentchange" #change name
# Calcification_psy<-Calcification_psy[,c("Code","Parent.ID", "Treatment","Species","calc.percentchange")] #remove col
# Calcification_psy<-unique(Calcification_psy) #remove duplicates, now you have 
 Calcification_psy<-aggregate(x = Calcification_psy$percent.change,                # Specify data column
          by = list(Calcification_psy$Code),              # Specify group indicator
          FUN = mean)        
        names(Calcification_psy)[names(Calcification_psy) == "x"] <- "Calcification" #change name
        names(Calcification_psy)[names(Calcification_psy) == "Group.1"] <- "Code" #change name

Calcification_psy<-merge(metaPhysio, Calcification_psy, all.x = T)

Calcification_psy$Calcification[is.na(Calcification_psy$Calcification) & Calcification_psy$Time.Point == "T0"] <- 0 #for Time 0
Calcification_psy<- Calcification_psy[,c("Code","Calcification")] # keep only columns you need
Calcification_psy <- Calcification_psy %>%
  drop_na()
 
#PAM df PAMdata_stats make for T0, T1, TF ####
PAM_psy<- PAMdata2_stats 

PAM_psy$Days<-as.character(PAM_psy$Days)
PAM_psy$Days[PAM_psy$Days == "0"] <- "T0" #change 
PAM_psy$Days[PAM_psy$Days == "24"] <- "T1" #change 
PAM_psy$Days[PAM_psy$Days == "58"] <- "TF" #change 

PAM_psy<-PAM_psy[!(PAM_psy$Days=="17"),] #remove other days by name
PAM_psy<-PAM_psy[!(PAM_psy$Days=="31"),] #remove other days by name
PAM_psy<-PAM_psy[!(PAM_psy$Days=="38"),] #remove other days by name
PAM_psy<-PAM_psy[!(PAM_psy$Days=="45"),] #remove other days by name
PAM_psy<-PAM_psy[!(PAM_psy$Days=="52"),] #remove other days by name

#now you need to figure out the sample 'day' for each parent.id, and subset out only those. 
names(PAM_psy)[names(PAM_psy) == "Days"] <- "Time.Point" #change name

PAM_psyDF<-PAM_psy #make copy for dissertation plot

PAM_psy$Code<-paste(PAM_psy$Species,PAM_psy$Treatment,PAM_psy$Parent.ID,PAM_psy$Time.Point) #make code
PAM_psy$Code<-as.factor(PAM_psy$Code)

PAM_psy<- PAM_psy[,c("Code","Yield_cu")] # keep only columns you need
# PAM_psy<-PAM_psy %>% group_by(Code) %>% mutate(mean=mean(Yield_cu)) # mean by code, this worked
# names(PAM_psy)[names(PAM_psy) == "mean"] <- "PAM.Yield_cu" #change name
# PAM_psy<-PAM_psy[,c("Code","Parent.ID", "Treatment","Species","PAM.Yield_cu","Time.Point")] #remove col
# PAM_psy<-unique(PAM_psy) #remove duplicates, now you have 
 
PAM_psy<-aggregate(x = PAM_psy$Yield_cu,                # Specify data column
          by = list(PAM_psy$Code),              # Specify group indicator
          FUN = mean)        
        names(PAM_psy)[names(PAM_psy) == "x"] <- "Fv/Fm" #change name
        names(PAM_psy)[names(PAM_psy) == "Group.1"] <- "Code" #change name



# Photosynthesis PR.df_B ####
 
PR_psy<-PR.df_B
    PR_psy$Code<-paste(PR_psy$Species,PR_psy$Treatment,PR_psy$Parent.ID, PR_psy$Time.Point)
 
  #photo  code stopped working. 
  Photo_psy<- PR_psy[,c("GrossP","Code")] 
    # Photo_psy<-Photo_psy %>% group_by(Code) %>% mutate(mean=mean(Photo)) # mean by code, this STOPPED WORKING use below
    # names(Photo_psy)[names(Photo_psy) == "mean"] <- "Photosynthesis" #change name
    # Photo_psy<-Photo_psy[,c("Code","Photosynthesis")] #remove col with uniq
    # Photo_psy<-unique(Photo_psy) #remove duplicates, now you have 
    
  Photo_psy<-aggregate(x = Photo_psy$GrossP,                # Specify data column
          by = list(Photo_psy$Code),              # Specify group indicator
          FUN = mean)        
        names(Photo_psy)[names(Photo_psy) == "x"] <- "Photosynthesis" #change name
        names(Photo_psy)[names(Photo_psy) == "Group.1"] <- "Code" #change name

  
   #Resp
   Resp_psy<- PR_psy[,c("Resp","Code")] 
    # Resp_psy<-Resp_psy %>% group_by(Code) %>% mutate(mean=mean(Resp)) # mean by code, this worked
    # names(Resp_psy)[names(Resp_psy) == "mean"] <- "Respiration" #change name
    # Resp_psy<-Resp_psy[,c("Code","Respiration")] #remove col
    # Resp_psy<-unique(Resp_psy) #remove duplicates, now you have 
 Resp_psy<-aggregate(x = Resp_psy$Resp,                # Specify data column
          by = list(Resp_psy$Code),              # Specify group indicator
          FUN = mean)        
        names(Resp_psy)[names(Resp_psy) == "x"] <- "Respiration" #change name
        names(Resp_psy)[names(Resp_psy) == "Group.1"] <- "Code" #change name

  
   #PR
  P_R_psy<- PR_psy[,c("PR_real","Code")] 
    # P_R_psy2<-P_R_psy %>% group_by(Code) %>% mutate(mean=mean(PR)) # mean by code, this worked
    # names(P_R_psy2)[names(P_R_psy2) == "mean"] <- "P_R" #change name
    # P_R_psy2<-P_R_psy2[,c("Code","P_R")] #remove col
    # P_R_psy2<-unique(P_R_psy2) #remove duplicates, now you have 
    # 
    P_R_psy<-aggregate(x = P_R_psy$PR_real,                # Specify data column
          by = list(P_R_psy$Code),              # Specify group indicator
          FUN = mean)        
        names(P_R_psy)[names(P_R_psy) == "x"] <- "PR" #change name
        names(P_R_psy)[names(P_R_psy) == "Group.1"] <- "Code" #change name
    
    
    
#merge
 PRPR_psy<-merge(Photo_psy,Resp_psy, all = T)   
     PRPR_psy<-merge(PRPR_psy,P_R_psy, all = T)   
 
```

#merging full physio

```{r}
#merg: this is EVERYTHING! PAM and BW subsetted to ONLY T0, T1 and TF time points, and all data is already transformed! 
 

# #create duplicate T0 for H or A that isn't there for each parent. id
# MetaT0<-metaPhysio #copy
# MetaT0<-subset(MetaT0, Time.Point=="T0")
# MetaT0Amb<-MetaT0
# MetaT0Amb$Treatment[MetaT0Amb$Treatment == "High"] <- "Ambient" #change 
# MetaT0High<-MetaT0
# MetaT0High$Treatment[MetaT0High$Treatment == "Ambient"] <- "High" #change 
# MetaT02<-rbind(MetaT0Amb,MetaT0High) #now oyu have T0 for Amb and High
# metaPhysio<-metaPhysio[!(metaPhysio$Time.Point=="T0"),] #remove T0s 
# metaPhysio<-rbind(metaPhysio,MetaT02) # add the full T0 dataset
# metaPhysio$Code<-paste(metaPhysio$Species,metaPhysio$Treatment,metaPhysio$Parent.ID,metaPhysio$Time.Point) #make code
# 

#MERGE
 
PhysioData<-merge(metaPhysio,Calcification_psy , all.x=T)
PhysioData<-merge(PhysioData,Biomass_psy,all.x=T)

PhysioData<-merge(PhysioData,CellCounts_psy,all.x=T)
PhysioData<-merge(PhysioData,Chla_psy,all.x=T)
PhysioData<-merge(PhysioData,Protein_psy,all.x=T)
PhysioData<-merge(PhysioData,PAM_psy,all.x=T)
PhysioData<-merge(PhysioData,PRPR_psy,all.x=T)
  PhysioData$Parent.ID<-as.factor(PhysioData$Parent.ID)
  PhysioData$Code<-as.factor(PhysioData$Code)

#check
duplicated(PhysioData$Code)
PhysioData$Code[duplicated(PhysioData$Code)]
PhysioData<-unique(PhysioData) #this is the df. 
# PhysioData <- PhysioData[, c(10,11,1,2,3,4,5,6,7,12, 13,8,9,14:20)]

#write.csv(PhysioData,"PhysioData.csv") #export for gauntlet


```

#nMDS of physio, PhysioData df, by Parent.ID, all data \<- no reason to do nmds for physio.

New section - testing Gower which lets us keep missing data rows to see if it impacts the results
```{r}
library(cluster)

# Compute Gower distance
dist_matrix <- daisy(PhysioData, metric = "gower")

# Run NMDS using the distance matrix
nmds <- metaMDS(dist_matrix)
plot(nmds)

```



```{r}
#make a copy
pData<-PhysioData

pData<-na.omit(pData) #remove anything without a value

#deal with negatives by adding multiplying by -1 to make these values positive while keeping distances the same
pData$Respiration<-(pData$Respiration)*-1

Phy_nmds<-pData #new copy

#make just for T1 and TF
pData.T1TF<-subset(Phy_nmds, Time.Point=="T1"|Time.Point=="TF")

#for T0 only
pData.T0 <- pData %>% dplyr::select(-Calcification)
pData.T0<-subset(pData.T0, Time.Point=="T0")



## Create NMDS for T0, T1 and TFphysio ####
#bray curtis presence-absense and abundance

library(vegan)  #hannah code below, edited
set.seed(30)

Phy_nmds.MDS<-metaMDS(Phy_nmds[,12:20], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds.MDS)
Phy_nmds.MDS
Phy_nmds.MDS.scores <- as.data.frame(scores(Phy_nmds.MDS, "sites"))
Phy_nmds.MDS #get summary info, stress is .22 great

##Add variables that you want to test to your scores data sheet
Phy_nmds.MDS.scores$Parent.ID <- Phy_nmds$Parent.ID
Phy_nmds.MDS.scores$Treatment <- Phy_nmds$Treatment
Phy_nmds.MDS.scores$Species <- Phy_nmds$Species
Phy_nmds.MDS.scores$transmission <- Phy_nmds$transmission
Phy_nmds.MDS.scores$skeleton <- Phy_nmds$skeleton
Phy_nmds.MDS.scores$Tissue <- Phy_nmds$Tissue
Phy_nmds.MDS.scores$Time.Point <- Phy_nmds$Time.Point
Phy_nmds.MDS.scores$Code <- Phy_nmds$Code # move the code 
Phy_nmds.MDS.scores$Code2 <- paste(Phy_nmds.MDS.scores$Species,Phy_nmds.MDS.scores$Treatment,Phy_nmds.MDS.scores$Time.Point) # create new code species, time point treatment 
Phy_nmds.MDS.scores$Code2<-as.factor(Phy_nmds.MDS.scores$Code2)
Phy_nmds.MDS.scores$Code3 <- paste(Phy_nmds.MDS.scores$Species,Phy_nmds.MDS.scores$Treatment) # create new code species, time point treatment 
Phy_nmds.MDS.scores$Code3<-as.factor(Phy_nmds.MDS.scores$Code3)


Sp.colors <- c("Montipora capitata"= "#D43F3AFF","Porites compressa"="#EEA236FF","Pavona varians"="#5CB85CFF","Pocillopora acuta"="#46B8DAFF", "High"="darkRed","Ambient"="navyBlue")


ggplot(Phy_nmds.MDS.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 1) +
  ggtitle("NMDS phyio Bray Curtis") +
  theme_classic()
#ggsave("bc_all.pdf")


### T0 only



Phy_nmds.MDS.scores_T0<-subset(Phy_nmds.MDS.scores, Time.Point=="T0")

ggplot(Phy_nmds.MDS.scores_T0, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS physio T0") +
  theme_classic()
#ggsave("bc_all.pdf")



#################### Subset PLOTS (do not rerun nmds) for T1 and TF visualizations ####
  

Phy_nmds.MDS.scores_T1<-subset(Phy_nmds.MDS.scores, Time.Point=="T1")

ggplot(Phy_nmds.MDS.scores_T1, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
    stat_ellipse(aes(x = NMDS1, y = NMDS2, color=Species, group=Code3,lty = Code3)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS physio T1") +
  theme_classic()
#ggsave("bc_all.pdf")

ggplot(Phy_nmds.MDS.scores_T1, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
    #stat_ellipse(aes(x = NMDS1, y = NMDS2, color=Species, group=Code3,lty = Code3)) +
#scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS physio T1") +
  theme_classic()
#ggsave("bc_all.pdf")

#################### Subset PLOTS (do not rerun nmds) for TF visualizations####


Phy_nmds.MDS.scores_TF<-subset(Phy_nmds.MDS.scores, Time.Point=="TF")


ggplot(Phy_nmds.MDS.scores_TF, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species), size = 4) +
  geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  scale_color_manual(values=Sp.colors)+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
  ggtitle("NMDS physio  TF") +
  theme_classic()

######### ok now do it by rerun T1 #### 
Phy_nmds.T1<-subset(Phy_nmds, Time.Point=="T1")
  set.seed(30)
Phy_nmds.MDS.T1<-metaMDS(Phy_nmds.T1[,12:20], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds.MDS.T1)
Phy_nmds.MDS.T1.scores <- as.data.frame(scores(Phy_nmds.MDS.T1)) #make the nMDS scores into a dataframe
Phy_nmds.MDS.T1 #get summary info, stress is 0.096 great

##Add variables that you want to test to your scores data sheet
Phy_nmds.MDS.T1.scores$Parent.ID <- Phy_nmds.T1$Parent.ID
Phy_nmds.MDS.T1.scores$Treatment <- Phy_nmds.T1$Treatment
Phy_nmds.MDS.T1.scores$Species <- Phy_nmds.T1$Species
Phy_nmds.MDS.T1.scores$Time.Point <- Phy_nmds.T1$Time.Point
Phy_nmds.MDS.T1.scores$Code <- Phy_nmds.T1$Code # move the code 
Phy_nmds.MDS.T1.scores$Code2 <- paste(Phy_nmds.MDS.T1.scores$Species,Phy_nmds.MDS.T1.scores$Treatment) # create new code species, time point treatment 
Phy_nmds.MDS.T1.scores$Code2<-as.factor(Phy_nmds.MDS.T1.scores$Code2)

Phy_nmds.MDS.T1.scores$Code3 <- paste(Phy_nmds.MDS.T1.scores$Species,Phy_nmds.MDS.T1.scores$Treatment) # create new code species, time point treatment 
Phy_nmds.MDS.T1.scores$Code3<-as.factor(Phy_nmds.MDS.T1.scores$Code3)



#make loading vectors
# vec.sp<-envfit(Phy_nmds.MDS.T1, Phy_nmds.T1[,8:20], perm=1000)
# vec.sp2<-vec.sp$vectors$arrows*sqrt(vec.sp$vectors$r)
# 
# en_coord_cont = as.data.frame(scores(vec.sp, "vectors")) * ordiArrowMul(vec.sp, fill=6)
# en_coord_cat = as.data.frame(scores(vec.sp, "factors")) * ordiArrowMul(vec.sp, fill=6)
# 
# vec.sp.df<-as.data.frame(vec.sp$vectors$arrows*sqrt(vec.sp$vectors$r))
# vec.sp.df$Code<-rownames(vec.sp.df)

ggplot(Phy_nmds.MDS.T1.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
    stat_ellipse(aes(x = NMDS1, y = NMDS2, color=Species, group=Code3,lty = Code3)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS physio T1") +
  theme_classic()

## Do by TF RERUN
Phy_nmds.TF<-subset(Phy_nmds, Time.Point=="TF")
  set.seed(30)
Phy_nmds.MDS.TF<-metaMDS(Phy_nmds.TF[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds.MDS.TF)
Phy_nmds.MDS.TF.scores <- as.data.frame(scores(Phy_nmds.MDS.TF)) #make the nMDS scores into a dataframe
Phy_nmds.MDS.TF #get summary info, stress is 0.096 great

##Add variables that you want to test to your scores data sheet
Phy_nmds.MDS.TF.scores$Parent.ID <- Phy_nmds.TF$Parent.ID
Phy_nmds.MDS.TF.scores$Treatment <- Phy_nmds.TF$Treatment
Phy_nmds.MDS.TF.scores$Species <- Phy_nmds.TF$Species
Phy_nmds.MDS.TF.scores$Time.Point <- Phy_nmds.TF$Time.Point
Phy_nmds.MDS.TF.scores$Code <- Phy_nmds.TF$Code # move the code 
Phy_nmds.MDS.TF.scores$Code2 <- paste(Phy_nmds.MDS.TF.scores$Species,Phy_nmds.MDS.TF.scores$Treatment) # create new code species, time point treatment 
Phy_nmds.MDS.TF.scores$Code2<-as.factor(Phy_nmds.MDS.TF.scores$Code2)

Phy_nmds.MDS.TF.scores$Code3 <- paste(Phy_nmds.MDS.TF.scores$Species,Phy_nmds.MDS.TF.scores$Treatment) # create new code species, time point treatment 
Phy_nmds.MDS.TF.scores$Code3<-as.factor(Phy_nmds.MDS.TF.scores$Code3)



#make loading vectors
# vec.sp<-envfit(Phy_nmds.MDS.TF, Phy_nmds.TF[,8:20], perm=1000)
# vec.sp2<-vec.sp$vectors$arrows*sqrt(vec.sp$vectors$r)
# 
# en_coord_cont = as.data.frame(scores(vec.sp, "vectors")) * ordiArrowMul(vec.sp, fill=6)
# en_coord_cat = as.data.frame(scores(vec.sp, "factors")) * ordiArrowMul(vec.sp, fill=6)
# 
# vec.sp.df<-as.data.frame(vec.sp$vectors$arrows*sqrt(vec.sp$vectors$r))
# vec.sp.df$Code<-rownames(vec.sp.df)

ggplot(Phy_nmds.MDS.TF.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species, shape=Treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(aes(label=Parent.ID),hjust=-.5, vjust=-.5)+
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
    stat_ellipse(aes(x = NMDS1, y = NMDS2, color=Species, group=Code3,lty = Code3)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  ggtitle("NMDS physio TF") +
  theme_classic()






######### ok now Rerun by T0 ####
#keep time 0
  

  set.seed(30)

Phy_nmds.MDS.T0<-metaMDS(pData.T0[,(12:19)], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS"))
stressplot(Phy_nmds.MDS.T0)

Phy_nmds.MDS.scores_T0 <- as.data.frame(scores(Phy_nmds.MDS.T0, "sites"))

Phy_nmds.MDS.T0 #get summary info, stress .19

##Add variables that you want to test to your scores data sheet
Phy_nmds.MDS.scores_T0$Parent.ID <- pData.T0$Parent.ID
Phy_nmds.MDS.scores_T0$Treatment <- pData.T0$Treatment
Phy_nmds.MDS.scores_T0$Species <- pData.T0$Species
Phy_nmds.MDS.scores_T0$Time.Point <- pData.T0$Time.Point
Phy_nmds.MDS.scores_T0$Code <- pData.T0$Code # move the code 

#make loading vectors
vec.spT0<-envfit(Phy_nmds.MDS.scores_T0, pData.T0[,12:19], perm=1000)
vec.sp.dfT0<-as.data.frame(vec.spT0$vectors$arrows*sqrt(vec.spT0$vectors$r))
vec.sp.dfT0$traits<-rownames(vec.sp.dfT0)

mult <- .25

ggplot(Phy_nmds.MDS.T0.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = Species), size = 4) +
  scale_color_manual(values=Sp.colors)+
  #geom_text(label = rownames(scores), nudge_x = 0.05, nudge_y = 0.05,check_overlap = T) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Species), linetype = 2) +
    # geom_segment(data=vec.sp.df,aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
    #   arrow = arrow(length = unit(0.25, "cm")),colour="grey",inherit_aes=FALSE) + 
    # geom_text(data=vec.sp.dfT0,aes(x=NMDS1,y=NMDS2,label=traits),size=4)+
  geom_segment(data = vec.sp.dfT0,
                    aes(x = 0, xend = mult*NMDS1, y = 0, yend = mult*NMDS2),
                    arrow = arrow(length = unit(0.25, "cm")), colour = "black") + #arrows for envfit.  doubled the length for similarity to the plot() function. NB check ?envfit regarding arrow length if not familiar with lengths
       geom_text(data = vec.sp.dfT0, aes(x = mult*NMDS1, y = mult*NMDS2, label=traits),size = 3)+#labels the environmental variable arrows * "mult" as for the arrows
  ggtitle("NMDS Physio T0") +
  
  theme_classic()

write.csv(Phy_nmds.MDS.T0,"Phy_nmds.MDS.T0.csv") #for gauntlet figure
 
```

#### By SPECIES. Make a NEW ordination for each species.

Mcap phys

```{r}
Phy_nmds_Mcap<-pData.T1TF
  

Phy_nmds_Mcap<-subset(Phy_nmds_Mcap, Species=="Montipora capitata")

set.seed(30)

Phy_nmds_Mcap.MDS<-metaMDS(Phy_nmds_Mcap[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds_Mcap.MDS)
Phy_nmds_Mcap.MDS.scores <- as.data.frame(scores(Phy_nmds_Mcap.MDS)) #make the nMDS scores into a dataframe
Phy_nmds_Mcap.MDS #get summary info, stress is 0.096 great

##Add variables that you want to test to your scores data sheet
Phy_nmds_Mcap.MDS.scores$Parent.ID <- Phy_nmds_Mcap$Parent.ID
Phy_nmds_Mcap.MDS.scores$Treatment <- Phy_nmds_Mcap$Treatment
Phy_nmds_Mcap.MDS.scores$Species <- Phy_nmds_Mcap$Species
Phy_nmds_Mcap.MDS.scores$Time.Point <- Phy_nmds_Mcap$Time.Point
Phy_nmds_Mcap.MDS.scores$Code <- paste(Phy_nmds_Mcap$Parent.ID,Phy_nmds_Mcap$Time.Point)
Phy_nmds_Mcap.MDS.scores$Code2 <- paste(Phy_nmds_Mcap$Treatment,Phy_nmds_Mcap$Time.Point)
Phy_nmds_Mcap.MDS.scores$Code3 <- paste(Phy_nmds_Mcap$Treatment,Phy_nmds_Mcap$Time.Point,Phy_nmds_Mcap$Parent.ID)

#colors
## create palette for parent.ID and treatments
Mcap.Parent.colors <- c("363" = "green4",  "364" = "firebrick3", "365" ="deeppink4", "366" = "orange", "367" = "green1","368" = "gold",  "369"= "hotpink", "370" ="darkslateblue", "371" = "cyan", "372" = "darkorange","373" ="darkorchid1", "374" = "lightblue", 
                        "Ambient" = "dodgerblue", "High" = "darkred",
                        "C Ambient"="#DDCC77","C High"="#999933", "CD Ambient"="#44AA99", "CD High"="#117733", 
                        "Ambient T1"="darkblue", "Ambient TF"="skyblue", "High T1"="darkred","High TF"="hotpink") 


ggplot(Phy_nmds_Mcap.MDS.scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(shape = Code2, color = Parent.ID, fill=Treatment), size = 5) + 
  scale_shape_manual(values = c(21, 22,24,25)) + 
    scale_color_manual(values=Mcap.Parent.colors)+
stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("M. capitata T1TF") +
  theme_classic()

ggplot(Phy_nmds_Mcap.MDS.scores, aes(x = NMDS1, y = NMDS2, shape=Code2, fill=Treatment)) + 
 geom_point(aes(size = 5) )+
    #geom_point(aes(colour = Treatment, size = 4, shape=Code2)) +
    scale_shape_manual(values = c(21, 22,24,25)) + 
  scale_color_manual(values=Mcap.Parent.colors)+
   # geom_line(aes(group = Code), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("M. capitata T1TF") +
  theme_classic()
#ggsave("McapT1its2.pdf")

#T1
Phy_nmds_Mcap.T1<-subset(Phy_nmds_Mcap, Time.Point=="T1")
ord.mcap.T1<-metaMDS(Phy_nmds_Mcap.T1[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.mcap.T1)
ord.mcap.T1.df<-as.data.frame(cbind(vegan::scores(ord.mcap.T1, display="sites"))) # these are "points" ask hannah 
ord.mcap.T1.df$Time.Point <- Phy_nmds_Mcap.T1$Time.Point
ord.mcap.T1.df$Parent.ID <- Phy_nmds_Mcap.T1$Parent.ID
ord.mcap.T1.df$Treatment <- Phy_nmds_Mcap.T1$Treatment
ord.mcap.T1.df$Clade <- Phy_nmds_Mcap.T1$Clade
ord.mcap.T1.df$Code <- paste(ord.mcap.T1.df$Parent.ID,ord.mcap.T1.df$Time.Point)
ord.mcap.T1.df$Code2 <- paste(ord.mcap.T1.df$Clade,ord.mcap.T1.df$Treatment)
ord.mcap.T1.df$Code2 <- as.factor(ord.mcap.T1.df$Code2)

ggplot(ord.mcap.T1.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Mcap.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("M. capitata physio T1") +
  theme_classic()
#ggsave("McapT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(mcap.bac.TF, ordinate(mcap.bac, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)


#TF
Phy_nmds_Mcap.TF<-subset(Phy_nmds_Mcap, Time.Point=="TF")
ord.mcap.TF<-metaMDS(Phy_nmds_Mcap.TF[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.mcap.TF)
ord.mcap.TF.df<-as.data.frame(cbind(vegan::scores(ord.mcap.TF, display="sites"))) # these are "points" ask hannah 
ord.mcap.TF.df$Time.Point <- Phy_nmds_Mcap.TF$Time.Point
ord.mcap.TF.df$Parent.ID <- Phy_nmds_Mcap.TF$Parent.ID
ord.mcap.TF.df$Treatment <- Phy_nmds_Mcap.TF$Treatment
ord.mcap.TF.df$Clade <- Phy_nmds_Mcap.TF$Clade
ord.mcap.TF.df$Code <- paste(Phy_nmds_Mcap.TF$Parent.ID,Phy_nmds_Mcap.TF$Time.Point)
ord.mcap.TF.df$Code2 <- paste(Phy_nmds_Mcap.TF$Clade,Phy_nmds_Mcap.TF$Treatment)
ord.mcap.TF.df$Code2 <- as.factor(Phy_nmds_Mcap.TF$Code2)

ggplot(ord.mcap.TF.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Mcap.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("M. capitata physio TF") +
  theme_classic()




```

pcomp phys

```{r}

#colors
## create palette for parent.ID and treatments
pcomp.Parent.colors <- c("313" = "green4",  "314" = "firebrick3", "315" ="deeppink4", "316" = "orange", "317" = "green1","318" = "gold",  "319"= "hotpink", "320" ="darkslateblue", "321" = "cyan", "322" = "darkorange","323" ="darkorchid1", "324" = "lightblue", 
                         "Ambient" = "Blue", "High" = "Red",
                         "C Ambient"="blue","C High"="red", "CD Ambient"="darkblue", "CD High"="darkred", 
                         "Ambient T1"="blue", "Ambient TF"="darkblue", "High T1"="pink","High TF"="darkred") 
 

Phy_nmds_pcomp<-pData.T1TF
Phy_nmds_pcomp<-subset(Phy_nmds_pcomp, Species=="Porites compressa")

set.seed(30)

Phy_nmds_pcomp.MDS<-metaMDS(Phy_nmds_pcomp[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds_pcomp.MDS)
Phy_nmds_pcomp.MDS.scores <- as.data.frame(scores(Phy_nmds_pcomp.MDS)) #make the nMDS scores into a dataframe
Phy_nmds_pcomp.MDS #get summary info,

##Add variables that you want to test to your scores data sheet
Phy_nmds_pcomp.MDS.scores$Parent.ID <- Phy_nmds_pcomp$Parent.ID
Phy_nmds_pcomp.MDS.scores$Treatment <- Phy_nmds_pcomp$Treatment
Phy_nmds_pcomp.MDS.scores$Species <- Phy_nmds_pcomp$Species
Phy_nmds_pcomp.MDS.scores$Time.Point <- Phy_nmds_pcomp$Time.Point
Phy_nmds_pcomp.MDS.scores$Code <- paste(Phy_nmds_pcomp$Parent.ID,Phy_nmds_pcomp$Time.Point)
Phy_nmds_pcomp.MDS.scores$Code2 <- paste(Phy_nmds_pcomp$Treatment,Phy_nmds_pcomp$Time.Point)
Phy_nmds_pcomp.MDS.scores$Code3 <- paste(Phy_nmds_pcomp$Treatment,Phy_nmds_pcomp$Time.Point,Phy_nmds_pcomp$Parent.ID)

#plot
ggplot(Phy_nmds_pcomp.MDS.scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(shape = Code2, color = Parent.ID, fill=Treatment), size = 5) + 
  scale_shape_manual(values = c(21, 22,24,25)) + 
    scale_color_manual(values=pcomp.Parent.colors)+
stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. comp T1TF") +
  theme_classic()

ggplot(Phy_nmds_pcomp.MDS.scores, aes(x = NMDS1, y = NMDS2, shape=Code2, fill=Treatment)) + 
 geom_point(aes(size = 5) )+
    #geom_point(aes(colour = Treatment, size = 4, shape=Code2)) +
    scale_shape_manual(values = c(21, 22,24,25)) + 
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Code), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. comp T1TF") +
  theme_classic()
#ggsave("pcompT1its2.pdf")

#T1
Phy_nmds_pcomp.T1<-subset(Phy_nmds_pcomp, Time.Point=="T1")
ord.pcomp.T1<-metaMDS(Phy_nmds_pcomp.T1[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pcomp.T1)
ord.pcomp.T1.df<-as.data.frame(cbind(vegan::scores(ord.pcomp.T1, display="sites"))) # these are "points" ask hannah 
ord.pcomp.T1.df$Time.Point <- Phy_nmds_pcomp.T1$Time.Point
ord.pcomp.T1.df$Parent.ID <- Phy_nmds_pcomp.T1$Parent.ID
ord.pcomp.T1.df$Treatment <- Phy_nmds_pcomp.T1$Treatment
ord.pcomp.T1.df$Clade <- Phy_nmds_pcomp.T1$Clade
ord.pcomp.T1.df$Code <- paste(Phy_nmds_pcomp.T1$Parent.ID,Phy_nmds_pcomp.T1$Time.Point)
ord.pcomp.T1.df$Code2 <- paste(Phy_nmds_pcomp.T1$Clade,Phy_nmds_pcomp.T1$Treatment)
ord.pcomp.T1.df$Code2 <- as.factor(Phy_nmds_pcomp.T1$Code2)

ggplot(ord.pcomp.T1.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. comp physio T1") +
  theme_classic()
#ggsave("pcompT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(pcomp.bac.TF, ordinate(pcomp.bac, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)


#TF
Phy_nmds_pcomp.TF<-subset(Phy_nmds_pcomp, Time.Point=="TF")
ord.pcomp.TF<-metaMDS(Phy_nmds_pcomp.TF[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pcomp.TF)
ord.pcomp.TF.df<-as.data.frame(cbind(vegan::scores(ord.pcomp.TF, display="sites"))) # these are "points" ask hannah 
ord.pcomp.TF.df$Time.Point <- Phy_nmds_pcomp.TF$Time.Point
ord.pcomp.TF.df$Parent.ID <- Phy_nmds_pcomp.TF$Parent.ID
ord.pcomp.TF.df$Treatment <- Phy_nmds_pcomp.TF$Treatment
ord.pcomp.TF.df$Clade <- Phy_nmds_pcomp.TF$Clade
ord.pcomp.TF.df$Code <- paste(Phy_nmds_pcomp.TF$Parent.ID,Phy_nmds_pcomp.TF$Time.Point)
ord.pcomp.TF.df$Code2 <- paste(Phy_nmds_pcomp.TF$Clade,Phy_nmds_pcomp.TF$Treatment)
ord.pcomp.TF.df$Code2 <- as.factor(Phy_nmds_pcomp.TF$Code2)

#try envfit
# env = Phy_nmds_pcomp.TF[,3] NOT WORKING SORT OUT LATER
# 
# en = envfit(ord.pcomp.TF, env, permutations = 999, na.rm = TRUE)


ggplot(ord.pcomp.TF.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=Pcomp.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. comp physio TF") +
  theme_classic()


```

pvar phys

```{r}
pvar.Parent.colors <- c("325" = "green4",  "353" = "firebrick3", "356" ="deeppink4", "358" = "orange", "361" = "green1","354" = "gold",  "351"= "hotpink", "355" ="darkslateblue", "357" = "cyan", "359" = "darkorange","360" ="darkorchid1", "362" = "lightblue", 
                       "Ambient" = "dodgerblue", "High" = "darkred",
                        "C1 Ambient"="#DDCC77","C1 High"="#999933", "C27 Ambient"="#44AA99", "C27 High"="#117733", 
                         "Ambient T1"="darkblue", "Ambient TF"="skyblue", "High T1"="darkred","High TF"="hotpink") 

Phy_nmds_pvar<-pData.T1TF
  

Phy_nmds_pvar<-subset(Phy_nmds_pvar, Species=="Pavona varians")

set.seed(30)

Phy_nmds_pvar.MDS<-metaMDS(Phy_nmds_pvar[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds_pvar.MDS)
Phy_nmds_pvar.MDS.scores <- as.data.frame(scores(Phy_nmds_pvar.MDS)) #make the nMDS scores into a dataframe
Phy_nmds_pvar.MDS #get summary info, stress is 0.096 great

##Add variables that you want to test to your scores data sheet
Phy_nmds_pvar.MDS.scores$Parent.ID <- Phy_nmds_pvar$Parent.ID
Phy_nmds_pvar.MDS.scores$Treatment <- Phy_nmds_pvar$Treatment
Phy_nmds_pvar.MDS.scores$Species <- Phy_nmds_pvar$Species
Phy_nmds_pvar.MDS.scores$Time.Point <- Phy_nmds_pvar$Time.Point
Phy_nmds_pvar.MDS.scores$Code <- paste(Phy_nmds_pvar$Parent.ID,Phy_nmds_pvar$Time.Point)
Phy_nmds_pvar.MDS.scores$Code2 <- paste(Phy_nmds_pvar$Treatment,Phy_nmds_pvar$Time.Point)
Phy_nmds_pvar.MDS.scores$Code3 <- paste(Phy_nmds_pvar$Treatment,Phy_nmds_pvar$Time.Point,Phy_nmds_pvar$Parent.ID)


ggplot(Phy_nmds_pvar.MDS.scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(shape = Code2, color = Parent.ID, fill=Treatment), size = 5) + 
  scale_shape_manual(values = c(21, 22,24,25)) + 
    scale_color_manual(values=pvar.Parent.colors)+
stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. varians T1TF") +
  theme_classic()

ggplot(Phy_nmds_pvar.MDS.scores, aes(x = NMDS1, y = NMDS2, shape=Code2, fill=Treatment)) + 
 geom_point(aes(size = 5) )+
    #geom_point(aes(colour = Treatment, size = 4, shape=Code2)) +
    scale_shape_manual(values = c(21, 22,24,25)) + 
  scale_color_manual(values=pvar.Parent.colors)+
   # geom_line(aes(group = Code), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. varians T1TF") +
  theme_classic()
#ggsave("pvarT1its2.pdf")

#T1
Phy_nmds_pvar.T1<-subset(Phy_nmds_pvar, Time.Point=="T1")
ord.pvar.T1<-metaMDS(Phy_nmds_pvar.T1[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pvar.T1)
ord.pvar.T1.df<-as.data.frame(cbind(vegan::scores(ord.pvar.T1, display="sites"))) # these are "points" ask hannah 
ord.pvar.T1.df$Time.Point <- Phy_nmds_pvar.T1$Time.Point
ord.pvar.T1.df$Parent.ID <- Phy_nmds_pvar.T1$Parent.ID
ord.pvar.T1.df$Treatment <- Phy_nmds_pvar.T1$Treatment
ord.pvar.T1.df$Clade <- Phy_nmds_pvar.T1$Clade
ord.pvar.T1.df$Code <- paste(Phy_nmds_pvar.T1$Parent.ID,Phy_nmds_pvar.T1$Time.Point)
ord.pvar.T1.df$Code2 <- paste(Phy_nmds_pvar.T1$Clade,Phy_nmds_pvar.T1$Treatment)
ord.pvar.T1.df$Code2 <- as.factor(Phy_nmds_pvar.T1$Code2)

ggplot(ord.pvar.T1.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=pvar.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. varians physio T1") +
  theme_classic()
#ggsave("pvarT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(pvar.bac.TF, ordinate(pvar.bac, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)


#TF
Phy_nmds_pvar.TF<-subset(Phy_nmds_pvar, Time.Point=="TF")
ord.pvar.TF<-metaMDS(Phy_nmds_pvar.TF[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pvar.TF)
ord.pvar.TF.df<-as.data.frame(cbind(vegan::scores(ord.pvar.TF, display="sites"))) # these are "points" ask hannah 
ord.pvar.TF.df$Time.Point <- Phy_nmds_pvar.TF$Time.Point
ord.pvar.TF.df$Parent.ID <- Phy_nmds_pvar.TF$Parent.ID
ord.pvar.TF.df$Treatment <- Phy_nmds_pvar.TF$Treatment
ord.pvar.TF.df$Clade <- Phy_nmds_pvar.TF$Clade
ord.pvar.TF.df$Code <- paste(Phy_nmds_pvar.TF$Parent.ID,Phy_nmds_pvar.TF$Time.Point)
ord.pvar.TF.df$Code2 <- paste(Phy_nmds_pvar.TF$Clade,Phy_nmds_pvar.TF$Treatment)
ord.pvar.TF.df$Code2 <- as.factor(Phy_nmds_pvar.TF$Code2)

ggplot(ord.pvar.TF.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=pvar.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. varians physio TF") +
  theme_classic()

 


```

pacu phys

```{r}
## create palette for parent.ID and treatments
pacu.Parent.colors <- c("305" = "green4",  "307" = "firebrick3", "309" ="deeppink4", "311" = "orange", "301" = "green1","302" = "gold",  "308"= "hotpink", "310" ="darkslateblue", "312" = "cyan", "303" = "darkorange","304" ="darkorchid1", "306" = "lightblue", 
                        "Ambient" = "dodgerblue", "High" = "darkred",
                        "C42 Ambient"="#DDCC77","C42 High"="#999933", "CCC Ambient"="#44AA99", "CCC High"="#117733", 
                        "Ambient T1"="darkblue", "Ambient TF"="skyblue", "High T1"="darkred","High TF"="hotpink") 



Phy_nmds_pacu<-pData.T1TF
Phy_nmds_pacu<-subset(Phy_nmds_pacu, Species=="Pocillopora acuta")

set.seed(30)

Phy_nmds_pacu.MDS<-metaMDS(Phy_nmds_pacu[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(Phy_nmds_pacu.MDS)
Phy_nmds_pacu.MDS.scores <- as.data.frame(scores(Phy_nmds_pacu.MDS)) #make the nMDS scores into a dataframe
Phy_nmds_pacu.MDS #get summary info, stress is 0.096 great

##Add variables that you want to test to your scores data sheet
Phy_nmds_pacu.MDS.scores$Parent.ID <- Phy_nmds_pacu$Parent.ID
Phy_nmds_pacu.MDS.scores$Treatment <- Phy_nmds_pacu$Treatment
Phy_nmds_pacu.MDS.scores$Species <- Phy_nmds_pacu$Species
Phy_nmds_pacu.MDS.scores$Time.Point <- Phy_nmds_pacu$Time.Point
Phy_nmds_pacu.MDS.scores$Code <- paste(Phy_nmds_pacu$Parent.ID,Phy_nmds_pacu$Time.Point)
Phy_nmds_pacu.MDS.scores$Code2 <- paste(Phy_nmds_pacu$Treatment,Phy_nmds_pacu$Time.Point)
Phy_nmds_pacu.MDS.scores$Code3 <- paste(Phy_nmds_pacu$Treatment,Phy_nmds_pacu$Time.Point,Phy_nmds_pacu$Parent.ID)

ggplot(Phy_nmds_pacu.MDS.scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(shape = Code2, color = Parent.ID, fill=Treatment), size = 5) + 
  scale_shape_manual(values = c(21, 22,24,25)) + 
    scale_color_manual(values=pacu.Parent.colors)+
stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. acuta T1TF") +
  theme_classic()

ggplot(Phy_nmds_pacu.MDS.scores, aes(x = NMDS1, y = NMDS2, shape=Code2, fill=Treatment)) + 
 geom_point(aes(size = 5) )+
    #geom_point(aes(colour = Treatment, size = 4, shape=Code2)) +
    scale_shape_manual(values = c(21, 22,24,25)) + 
  scale_color_manual(values=pacu.Parent.colors)+
   # geom_line(aes(group = Code), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Code2, lty=factor(Time.Point))) +
  scale_linetype_manual(values=c(2,3,2,3))+
  ggtitle("P. acuta T1TF") +
  theme_classic()
#ggsave("pacuT1its2.pdf")

#T1
Phy_nmds_pacu.T1<-subset(Phy_nmds_pacu, Time.Point=="T1")
ord.pacu.T1<-metaMDS(Phy_nmds_pacu.T1[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pacu.T1)
ord.pacu.T1.df<-as.data.frame(cbind(vegan::scores(ord.pacu.T1, display="sites"))) # these are "points" ask hannah 
ord.pacu.T1.df$Time.Point <- Phy_nmds_pacu.T1$Time.Point
ord.pacu.T1.df$Parent.ID <- Phy_nmds_pacu.T1$Parent.ID
ord.pacu.T1.df$Treatment <- Phy_nmds_pacu.T1$Treatment
ord.pacu.T1.df$Clade <- Phy_nmds_pacu.T1$Clade
ord.pacu.T1.df$Code <- paste(Phy_nmds_pacu.T1$Parent.ID,Phy_nmds_pacu.T1$Time.Point)
ord.pacu.T1.df$Code2 <- paste(Phy_nmds_pacu.T1$Clade,Phy_nmds_pacu.T1$Treatment)
ord.pacu.T1.df$Code2 <- as.factor(Phy_nmds_pacu.T1$Code2)

ggplot(ord.pacu.T1.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=pacu.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. acuta physio T1") +
  theme_classic()
#ggsave("pacuT1its2.pdf")

#workaround-for when this randomly breaks
# plot_ordination(pacu.bac.TF, ordinate(pacu.bac, "MDS", set.seed=(30)), color = "Treatment", shape="Clade") + geom_point(size = 5)


#TF
Phy_nmds_pacu.TF<-subset(Phy_nmds_pacu, Time.Point=="TF")
ord.pacu.TF<-metaMDS(Phy_nmds_pacu.TF[,8:16], distance = "bray", k = 2, trymax = 200, engine = c("monoMDS", "isoMDS"))
stressplot(ord.pacu.TF)
ord.pacu.TF.df<-as.data.frame(cbind(vegan::scores(ord.pacu.TF, display="sites"))) # these are "points" ask hannah 
ord.pacu.TF.df$Time.Point <- Phy_nmds_pacu.TF$Time.Point
ord.pacu.TF.df$Parent.ID <- Phy_nmds_pacu.TF$Parent.ID
ord.pacu.TF.df$Treatment <- Phy_nmds_pacu.TF$Treatment
ord.pacu.TF.df$Clade <- Phy_nmds_pacu.TF$Clade
ord.pacu.TF.df$Code <- paste(ord.pacu.TF.df$Parent.ID,ord.pacu.TF.df$Time.Point)
ord.pacu.TF.df$Code2 <- paste(ord.pacu.TF.df$Clade,ord.pacu.TF.df$Treatment)
ord.pacu.TF.df$Code2 <- as.factor(ord.pacu.TF.df$Code2)

ggplot(ord.pacu.TF.df, aes(x = NMDS1, y = NMDS2)) + 
   geom_point(aes(stroke=3, colour = Parent.ID, shape=Treatment,size = 4) )+
    geom_point(aes(colour = Treatment, size = 4, shape=Treatment)) +
  scale_color_manual(values=pacu.Parent.colors)+
   # geom_line(aes(group = Parent.ID), color = "black") + 
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = Treatment, lty=factor(Treatment))) +
    scale_linetype_manual(values=c(3,3))+
  ggtitle("P. acuta physio TF") +
  theme_classic()




```

#PERMANOVA on physio only

```{r}
  
#ALL THE DATA T1TF

phy.dist <- vegdist(pData.T1TF [8:16], method="bray") #make dist matrix
phy.div <- adonis2(pData.T1TF [8:16] ~ Species*Treatment*Time.Point, data = pData.T1TF [1:6], permutations = 999, method="bray")
phy.div #view, 

##Check for homogeneity of dispersions (you want this to be insignificant)
phy.dist.disp <- betadisper(phy.dist, pData.T1TF$Species, type = "centroid")
#par(pty = 's')
boxplot(phy.dist.disp) #visualise your dispersion
permutest(phy.dist.disp) #this is your PERMDISP test

#this runs but it's only univariate so not helpful. 
# pairwise.adonis(PhysioData_noMissing [7:12], PhysioData_noMissing$Species)

#ALL THE DATA T0

phy.dist.T0 <- vegdist(pData.T0 [9:16], method="bray") #make dist matrix
phy.div.T0 <- adonis2(pData.T0 [9:16] ~ Species, data = pData.T0 [1:7], permutations = 999, method="bray")
phy.div.T0 #view, 

##Check for homogeneity of dispersions (you want this to be insignificant)
phy.dist.disp <- betadisper(phy.dist.T0, pData.T0$Species, type = "centroid")
#par(pty = 's')
boxplot(phy.dist.disp) #visualise your dispersion
permutest(phy.dist.disp) #this is your PERMDISP test

```

##By SPECIES

```{r}
#Mcap, Phy_nmds_Mcap
phy_Mcap.dist <- vegdist(Phy_nmds_Mcap [8:16], method="bray") #make dist matrix
phy_Mcap.div <- adonis2(Phy_nmds_Mcap [8:16] ~ Treatment*Time.Point, data = Phy_nmds_Mcap [1:7], permutations = 999, method="bray")
phy_Mcap.div #view, Time is significant
  ##Check for homogeneity of dispersions (you want this to be insignificant)
  phy.dist.disp <- betadisper(phy_Mcap.dist, Phy_nmds_Mcap$Treatment, type = "centroid")
  boxplot(phy.dist.disp) #visualise your dispersion
  permutest(phy.dist.disp) #this is your PERMDISP test

#Pcomp, Phy_nmds_Pcomp 
phy_Pcomp.dist <- vegdist(Phy_nmds_pcomp [8:16], method="bray") #make dist matrix
phy_Pcomp.div <- adonis2(Phy_nmds_pcomp [8:16] ~ Treatment*Time.Point, data = Phy_nmds_pcomp [1:7], permutations = 999, method="bray")
phy_Pcomp.div 
  ##Check for homogeneity of dispersions (you want this to be insignificant)
  phy.dist.disp <- betadisper(phy_Pcomp.dist, Phy_nmds_pcomp$Treatment, type = "centroid")
  boxplot(phy.dist.disp) #visualise your dispersion
  permutest(phy.dist.disp) #this is your PERMDISP test

#Pvar, Phy_nmds_Pvar
phy_Pvar.dist <- vegdist(Phy_nmds_pvar [8:16], method="bray") #make dist matrix
phy_Pvar.div <- adonis2(Phy_nmds_pvar [8:16] ~ Treatment*Time.Point, data = Phy_nmds_pvar [1:7], permutations = 999, method="bray")
phy_Pvar.div #view, all is significant
    ##Check for homogeneity of dispersions (you want this to be insignificant)
  phy.dist.disp <- betadisper(phy_Pvar.dist, Phy_nmds_pvar$Treatment, type = "centroid")
  boxplot(phy.dist.disp) #visualise your dispersion
  permutest(phy.dist.disp) #this is your PERMDISP test
  
  
#Pacu, Phy_nmds_Pacu
phy_Pacu.dist <- vegdist(Phy_nmds_pacu [8:16], method="bray") #make dist matrix
phy_Pacu.div <- adonis2(Phy_nmds_pacu [8:16] ~ Treatment*Time.Point, data = Phy_nmds_pacu [1:7], permutations = 999, method="bray")
phy_Pacu.div #view, all is significant
   ##Check for homogeneity of dispersions (you want this to be insignificant)
  phy.dist.disp <- betadisper(phy_Pacu.dist, Phy_nmds_pacu$Treatment, type = "centroid")
  boxplot(phy.dist.disp) #visualise your dispersion
  permutest(phy.dist.disp) #this is your PERMDISP test

```

# Physio PCA THIS IS THE WAY df= PhysioData
This is the PCA plot for figure 2A
```{r}
library(ggbiplot)

#for T0 only

apData<-PhysioData #make a copy
apData$Respiration<-apData$Respiration*-1 #make respiration all positive
apData<-subset(apData, Time.Point=="T1"|Time.Point=="TF") #only T1 and TF
apData<-na.omit(apData) #remove NAs
apData<-apData[,c("Parent.ID","Treatment","Species", "Time.Point", "Calcification","AFDWmg.cm2","Zoox Density","Chl a","Protein", "Fv/Fm","Photosynthesis", "Respiration","PR","Code")] #put cols in correct order

apData2 <- prcomp(apData[c(5:13)], center = TRUE, scale = TRUE) #center and scale
summary(apData2)
 
str(apData2)

ggbiplot(apData2) #quick look at plot

#exract scores for gg
Miss_scores <- as.data.frame(apData2$x)
Miss_scores$frag.id <- apData$Frag.ID
Miss_scores$parent.id <- apData$Parent.ID
Miss_scores$treatment <- apData$Treatment
Miss_scores$species <- apData$Species
Miss_scores$time.point <- apData$Time.Point


#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

#plot by time and species
Miss_scores$treatSpecies<-paste0(Miss_scores$species, Miss_scores$treatment )
Miss_scores$treatTime<-paste0(Miss_scores$treatment, Miss_scores$time.point )

ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2) +
  theme_classic()



#stats THIS WORKS 10/18/21
#first center and scale
apData3 <- as.data.frame(scale(apData[c(5:13)], center = TRUE, scale = TRUE)) #this removes metadata, add it back in
apData4<-merge(apData[1:4], apData3, by="row.names") #this should merge them
apData5<-subset(apData4, select = -c(1) ) #remove rownames

#trying to recode correct stats, scaled/centered and euclidian 10/18/21
phy.dist.test <- vegdist(apData2[c(5:13)],  method="euclidian") #make dist matrix
phy.divTest <- adonis2(apData5[c(5:13)] ~ Species*Treatment*Time.Point, data = apData5 [1:4], permutations = 999, method="euclidian")
phy.divTest #view, 

##Check for homogeneity of dispersions - this runs for the above
phy.dist.disptest <- betadisper(phy.dist.test, apData$Species, type = "centroid")
#par(pty = 's')
boxplot(phy.dist.disp) #visualise your dispersion
permutest(phy.dist.disp) #this is your PERMDISP test







#subset by T0#### 
apDataT0<-PhysioData #make a copy
apDataT0<-subset(apDataT0, Time.Point=="T0") #
apDataT0<-na.omit(apDataT0) #remove NAs
apDataT0<-apDataT0[,c("Parent.ID","Treatment","Species", "Time.Point", "Calcification","AFDWmg.cm2","Zoox Density","Chl a","Protein", "Fv/Fm","Photosynthesis", "Respiration","PR","Code")] #put cols in correct order

apDataT02 <- prcomp(apDataT0[c(5:13)], center = TRUE, scale = TRUE) #center and scale
summary(apData2)
 
str(apData2)

ggbiplot(apData2) #quick look at plot

#exract scores for gg
Miss_scores <- as.data.frame(apData2$x)
Miss_scores$frag.id <- apData$Frag.ID
Miss_scores$parent.id <- apData$Parent.ID
Miss_scores$treatment <- apData$Treatment
Miss_scores$species <- apData$Species
Miss_scores$time.point <- apData$Time.Point


#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

#plot by time and species
Miss_scores$treatSpecies<-paste0(Miss_scores$species, Miss_scores$treatment )
Miss_scores$treatTime<-paste0(Miss_scores$treatment, Miss_scores$time.point )

ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2) +
  theme_classic()



apDataT0<-PhysioData #copy
apDataT0<-subset(apDataT0, Time.Point=="T0") #
#remove calcification
apDataT0<-apDataT0[,c("Parent.ID","Treatment","Species", "Time.Point","AFDWmg.cm2","zoox.cm2_log","Chl a","Protein", "Fv/Fm","Photosynthesis", "Respiration","PR")] #put cols in correct order, remove calcificaiton
apDataT0<-na.omit(apDataT0)
apDataT02 <- prcomp(apDataT0[c(5:12)], center = TRUE, scale = TRUE)
summary(apDataT02)
 
str(apDataT02)

ggbiplot(apDataT02) #quick look at plot
ggbiplot(apDataT02, color=Species, ellipes=T )

#exract scores for gg
Miss_scores_T0 <- as.data.frame(apDataT02$x)
Miss_scores_T0$frag.id <- apDataT0$Frag.ID
Miss_scores_T0$parent.id <- apDataT0$Parent.ID
Miss_scores_T0$treatment <- apDataT0$Treatment
Miss_scores_T0$species <- apDataT0$Species
Miss_scores_T0$time.point <- apDataT0$Time.Point
Miss_scores_T0$treatSpecies<-paste0(Miss_scores_T0$species, Miss_scores_T0$treatment )

Miss_scores_T0_plot<-ggplot(Miss_scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2, level=0.75) +
  theme_classic();Miss_scores_T0_plot

#PCA T0 for defense
Miss_scores_T0_plot<-ggplot(Miss_scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species, geom="polygon",fill=species, alpha=.2), linetype = 2, level=0.75) ;Miss_scores_T0_plot

ggplot(Miss_scores_T0, aes(PC1,PC2, color = species)) +
  geom_point(alpha=1) +
  stat_ellipse(aes(fill = species), geom="polygon",level=0.9,alpha=0.2) +
    theme_classic()

ggbiplot(pcobj = apDataT02,
         choices=c(1,2),
         ellipse=TRUE, groups=Miss_scores_T0$species, geom="polygon", ellipse_fill=T, alpha=.8, size=.1)+
  theme_classic()

#working
apDataT0<-PhysioData #copy
apDataT0<-subset(apDataT0, Time.Point=="T0") #
#remove calcification
apDataT0<-apDataT0[,c("Parent.ID","Treatment","Species", "Time.Point","AFDWmg.cm2","zoox.cm2_log","Chl a","Protein", "Fv/Fm","Photosynthesis", "Respiration","PR")] #put cols in correct order, remove calcificaiton
apDataT0<-na.omit(apDataT0)
 
 apDataT0 <- apDataT0 %>%
 dplyr:: rename(
    Biomass = AFDWmg.cm2,
    Symbiont_density = zoox.cm2_log,
    Soluable_protein=Protein
  )

apDataT02 <- prcomp(apDataT0[c(5:12)], center = TRUE, scale = TRUE)
summary(apDataT02)

loadings <- as.data.frame(apDataT02$rotation)
loadings <- as.data.frame(lapply(loadings, as.numeric))
rownames(loadings) <- colnames(apDataT0[, 5:12])
scores <- as.data.frame(apDataT02$x)
scores$species <- apDataT0$Species


# Scale loadings for better visualization
scaling_factor <- 6
loadings_scaled <- loadings * scaling_factor

# Create the plot - FIGURE 2A
plot<-ggplot(scores, aes(PC1, PC2, color = species)) +
  geom_point(alpha = 1, size = 3) +
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#CC79A7", "#009E73")) + # Manually set colors for points
  stat_ellipse(aes(fill = species), geom = "polygon", level = 0.9, alpha = 0.2) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#CC79A7", "#009E73")) + # Manually set colors for ellipses
  theme_classic() +
  geom_segment(data = loadings_scaled, aes(x = 0, y = 0, xend = PC1, yend = PC2),
               arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = loadings_scaled, aes(x = PC1, y = PC2, label = rownames(loadings_scaled)),
            color = "black", vjust = 1.5, size=6);plot
ggsave("Figures/PCA_T0_physio.pdf", plot = plot, device = "pdf", width = 8, height = 6)








  #subset by T1####
Miss_scores_T1<-subset(Miss_scores, time.point=="T1")

Miss_scores_T1_plot<-ggplot(Miss_scores_T1, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
geom_point(aes(colour = species, shape=treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  # stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.75) +
  stat_ellipse(aes(x = PC1, y = PC2, color=species, group=treatSpecies,lty = treatSpecies)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  theme_classic();Miss_scores_T1_plot





#subset by TF
Miss_scores_TF<-subset(Miss_scores, time.point=="TF")

Miss_scores_TF_plot<-ggplot(Miss_scores_TF, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
geom_point(aes(colour = species, shape=treatment), size = 4) +
  scale_color_manual(values=Sp.colors)+
  # stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.75) +
  stat_ellipse(aes(x = PC1, y = PC2, color=species, group=treatSpecies,lty = treatSpecies)) +
scale_linetype_manual(values=c(1,2,1,2,1,2,1,2))+
  theme_classic();Miss_scores_TF_plot

###### OLD BELOW, DELETE when you figure it out ####

# library(VIM)
# library(FactoMineR)
# library(missMDA) #lets you do with incomplete dataset
# library(naniar)
# gg_miss_var(PhysioData)
# res<-summary(aggr(PhysioData, sortVar=TRUE))$combinations


# nb <- estim_ncpPCA(PhysioData,method.cv = "Kfold", verbose = FALSE) # estimate the number of components from incomplete data
# #(available methods include GCV to approximate CV)
# nb$ncp #2
# 
# res <- cor(PhysioData)
# round(res, 2)


library("PerformanceAnalytics")
my_data <- PhysioData[, c(8:16)]
chart.Correlation(my_data, histogram=TRUE, pch=19)


#Display Pearson correlation: testing physio (normal data) correlations

cor.test(PhysioData3$AFDWmg.cm2_log, PhysioData3$Cellcounts_zoox.cm2_log, method=c("pearson")) #

PhysioData3$Treatment_level <- factor(PhysioData3$Treatment, levels = c("Ambient", "High")) #make new col

Cor1<-ggplot(PhysioData3, aes(x=AFDWmg.cm2_log, y=Cellcounts_zoox.cm2_log)) + 
  geom_point(aes(color=Treatment, shape=Treatment), size=6) +
   #scale_color_manual(name="Nutrition",
        #            values=c("orange", "purple"), 
          #          labels=c("Fed", "Unfed"))+
  scale_shape_manual(values = c(19,21))+
  theme_classic()+
  geom_text(x=800, y=20, label="r=0.50, p<0.001", size=9, color="black") +
  theme(text = element_text(size = 20))+
  theme(axis.text = element_text(size = 20, color="black"))+
  theme(axis.title = element_text(size = 20, face="bold"))+
  theme(legend.title = element_text(size = 20, face="bold"))+
  theme(legend.text = element_text(size = 20, color="black"))+
  ylab(expression(bold(paste("AFDWmg.cm2_log")))) +
  xlab(expression(bold(paste("Cellcounts_zoox.cm2_log"))));Cor1

corrModel<-lmer(AFDWmg.cm2_log~Cellcounts_zoox.cm2_log * Treatment * Species + (1|Tank.num) + (1|Parent.ID), data=PhysioData3)
summary(corrModel)
anova(corrModel, type=2)


##### trying correlations with only complete data (no PAM or BW)
correlation<-PhysioData4
correlation<-correlation[complete.cases(correlation), ] #only full data (2 samps no chla)

correlation_Mcap<-subset(correlation, Species=="Montipora capitata")
correlation_Mcap_T1<-subset(correlation_Mcap, Time.Point=="T1")

#not workin
corrplots<-ggplot(correlation_Mcap_T1, aes(x=Treatment, y=Frag.ID))+
  geom_point()+
  facet_wrap(~compound, scales="free")+
  geom_smooth(method='lm', color='red')+
  theme_classic()+
  theme(text=element_text(size=14, face="bold"))
corrplots


#back to PCA with the shorter coor dataset that is full
PhysioData5<-PhysioData4
PhysioData5<-PhysioData5[complete.cases(PhysioData5), ] #only full data (2 samps no chla)

PhysioData5.pr <- prcomp(PhysioData5[c(8:11)], center = TRUE, scale = TRUE)
summary(PhysioData5.pr)

#amount of variance explained
screeplot(PhysioData5.pr, type = "l", npcs = 15, main = "Screeplot of the first 10 PCs")
abline(h = 1, col="red", lty=5)
legend("topright", legend=c("Eigenvalue = 1"),
       col=c("red"), lty=5, cex=0.6)
cumpro <- cumsum(PhysioData5.pr$sdev^2 / sum(PhysioData5.pr$sdev^2))
plot(cumpro[0:15], xlab = "PC #", ylab = "Amount of explained variance", main = "Cumulative variance plot")
abline(v = 6, col="blue", lty=5)
abline(h = 0.88759, col="blue", lty=5)
legend("topleft", legend=c("Cut-off @ PC6"),
       col=c("blue"), lty=5, cex=0.6)


#try plotting PC1 and 2 (how to get the percents?????)
plot(PhysioData5.pr$x[,1],PhysioData5.pr$x[,2], xlab="PC1 ()", ylab = "PC2 ()", main = "PC1 / PC2 - plot")


library("factoextra")
fviz_pca_ind(PhysioData5.pr, geom.ind = "point", pointshape = 21, 
             pointsize = 2, 
             fill.ind = PhysioData5$Treatment, 
             col.ind = "black", 
             palette = "jco", 
             addEllipses = TRUE,
             label = "var",
             col.var = "black",
             repel = TRUE,
             legend.title = "Treatment") +
  ggtitle("") +
  theme(plot.title = element_text(hjust = 0.5))


PhysioData5_mat<-PhysioData5[c(8:11)]
cor.res <- cor(PhysioData5_mat)
corrplot.mixed(cor.res, tl.cex = 0.7, tl.col = "black", addCoefasPercent = TRUE)
 
```

PCA hannah use physio data

```{r}
##PCA with imputation using PPCA (Probabilistic PCA, can handle ~15% missing data)

##Use the pcaMethods package for imputing
#BiocManager::install("pcaMethods")
library(pcaMethods)
sum(is.na(PhysioData)) #385
data<-PhysioData #make copy
View(data)

data$time1.growth[data$time1.growth == "NaN"] <- NA #change NaN to NA
data$time1.growth[data$Chla_ug.chla.cm2 == "NaN"] <- NA #change NaN to NA

data$T1.PAM[data$T1.PAM == "NaN"] <- NA #change NaN to NA
data$TF.PAM[data$TF.PAM == "NaN"] <- NA #change NaN to NA
data$T0.PAM[data$T0.PAM == "NaN"] <- NA #change NaN to NA

#Now we get the estimated data set by using PPCA and two principal components
#But you can use nPCs = 3 or however many principal components you want to use.

pc <- pca(data, nPcs=2, method="ppca") #probabilistic PCA
imputed <- completeObs(pc) #This creates a new dataframe with imputed values based on your probability pca

#Then you can run a pca on the imputed datafram
pca <- prcomp(imputed, center = TRUE, scale. = TRUE)
summary(pca)
View(pca)

#you can view it this way
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
ggbiplot(pca)

#Or extract the scores and make a ggplot
#Then add your metadata
library(ggplot2)
Miss_scores <- as.data.frame(pca$x)
Miss_scores$frag.id <- data$Frag.ID
Miss_scores$parent.id <- data$Parent.ID
Miss_scores$treatment <- data$Treatment
Miss_scores$species <- data$Species
Miss_scores$time.point <- data$Time.Point

#Plot
ggplot(Miss_scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()

#plot by time and species
Miss_scores$treatSpecies<-paste0(Miss_scores$species, Miss_scores$treatment )
Miss_scores$treatTime<-paste0(Miss_scores$treatment, Miss_scores$time.point )


#subset by T0
Miss_scores_T0<-subset(Miss_scores, time.point=="T0")

Miss_scores_T0_plot<-ggplot(Miss_scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = species), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2, level=0.95) +
  theme_classic();Miss_scores_T0_plot

#subset by T1
Miss_scores_T1<-subset(Miss_scores, time.point=="T1")
Miss_scores_T1_plot<-ggplot(Miss_scores_T1, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.25) +
  theme_classic();Miss_scores_T1_plot

#subset by TF
Miss_scores_TF<-subset(Miss_scores, time.point=="TF")
Miss_scores_TF_plot<-ggplot(Miss_scores_TF, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  #stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2) +
  theme_classic();Miss_scores_TF_plot

#plot all time plots
Miss_scores_T0_plot<-Miss_scores_T0_plot+ theme(legend.position = "none") #remove legend
Miss_scores_T1_plot<-Miss_scores_T1_plot+ theme(legend.position = "none") #remove legend
Miss_scores_TF_plot<-Miss_scores_TF_plot+ theme(legend.position = "none") #remove legend

grid.arrange(Miss_scores_T0_plot, Miss_scores_T1_plot, Miss_scores_TF_plot, nrow = 1)

#Subset MCAP
Miss_scores_Mcap<-subset(Miss_scores, species=="Montipora capitata")

Miss_Mcap_pca<-ggplot(Miss_scores_Mcap, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+ 
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
   ggtitle("Mcap") +
  theme_classic();Miss_Mcap_pca

#Subset Pcomp
Miss_scores_Pcomp<-subset(Miss_scores, species=="Porites compressa")
Miss_Pcomp_pca<-ggplot(Miss_scores_Pcomp, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
      ggtitle("Pcomp") +
  theme_classic();Miss_Pcomp_pca

#Subset Pvar
Miss_scores_Pvar<-subset(Miss_scores, species=="Pavona varians")
Miss_Pvar_pca<-ggplot(Miss_scores_Pvar, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
    ggtitle("Pvar") +
  theme_classic();Miss_Pvar_pca

#Subset Pacu
Miss_scores_Pacu<-subset(Miss_scores, species=="Pocillopora acuta")
Miss_Pacu_pca<-ggplot(Miss_scores_Pacu, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
  ggtitle("Pacuta") +
  theme_classic();Miss_Pacu_pca

#plot all species plots
Miss_Mcap_pca<-Miss_Mcap_pca+ theme(legend.position = "none") #remove legend
Miss_Pcomp_pca<-Miss_Pcomp_pca+ theme(legend.position = "none") #remove legend
Miss_Pvar_pca<-Miss_Pvar_pca+ theme(legend.position = "none") #remove legend
Miss_Pacu_pca<-Miss_Pacu_pca+ theme(legend.position = "none") #remove legend

grid.arrange(Miss_Mcap_pca, Miss_Pcomp_pca, Miss_Pvar_pca,Miss_Pacu_pca, nrow = 2)

```

PCA not alive measurements' not PAM.BW

```{r}
#PhysioData5 

PhysioData5.pca <- prcomp(PhysioData5[,c(8:11)], center = TRUE,scale. = TRUE)
summary(PhysioData5.pca)
str(PhysioData5.pca)


scores <- as.data.frame(PhysioData5.pca$x)
scores$frag.id <- data$Frag.ID
scores$parent.id <- data$Parent.ID
scores$treatment <- data$Treatment
scores$species <- data$Species
scores$time.point <- data$Time.Point
scores$treatSpecies<-paste0(scores$species, scores$treatment )
scores$treatTime<-paste0(scores$treatment, scores$time.point )


ggplot(scores, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = time.point), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = species), linetype = 2) +
  theme_classic()


#subset by T0
scores_T0<-subset(scores, time.point=="T0")
scores_T0_plot<-ggplot(scores_T0, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=0.25) +
  theme_classic();scores_T0_plot

#subset by T1
scores_T1<-subset(scores, time.point=="T1")
scores_T1_plot<-ggplot(scores_T1, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=0.25) +
  theme_classic();scores_T1_plot

#subset by TFs
scores_TF<-subset(scores, time.point=="TF")
scores_TF_plot<-ggplot(scores_TF, aes(x = PC1, y= PC2)) + geom_point(aes(colour = species, shape = treatment), size = 4) +
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatSpecies), linetype = 2, level=.25) +
  theme_classic();scores_TF_plot

#plot all time plots
scores_T0_plot<-scores_T0_plot+ theme(legend.position = "none") #remove legend
scores_T1_plot<-scores_T1_plot+ theme(legend.position = "none") #remove legend
scores_TF_plot<-scores_TF_plot+ theme(legend.position = "none") #remove legend

grid.arrange(scores_T0_plot, scores_T1_plot, scores_TF_plot, nrow = 1)


#Subset MCAP
scores_Mcap<-subset(scores, species=="Montipora capitata")

Mcap_pca<-ggplot(scores_Mcap, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+ 
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
   ggtitle("Mcap") +
  theme_classic();Mcap_pca

#Subset Pcomp
scores_Pcomp<-subset(scores, species=="Porites compressa")
Pcomp_pca<-ggplot(scores_Pcomp, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
      ggtitle("Pcomp") +
  theme_classic();Pcomp_pca

#Subset Pvar
scores_Pvar<-subset(scores, species=="Pavona varians")
Pvar_pca<-ggplot(scores_Pvar, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
    ggtitle("Pvar") +
  theme_classic();Pvar_pca

#Subset Pacu
scores_Pacu<-subset(scores, species=="Pocillopora acuta")
Pacu_pca<-ggplot(scores_Pacu, aes(x = PC1, y= PC2)) + geom_point(aes(colour = treatment, shape = time.point), size = 4)+
  stat_ellipse(aes(x = PC1, y = PC2, colour = treatTime), linetype = 2, level=.25) +
  ggtitle("Pacuta") +
  theme_classic();Pacu_pca

#plot all species plots
Mcap_pca<-Mcap_pca+ theme(legend.position = "none") #remove legend
Pcomp_pca<-Pcomp_pca+ theme(legend.position = "none") #remove legend
Pvar_pca<-Pvar_pca+ theme(legend.position = "none") #remove legend
Pacu_pca<-Pacu_pca+ theme(legend.position = "none") #remove legend

grid.arrange(Mcap_pca, Pcomp_pca, Pvar_pca,Pacu_pca, nrow = 2)
```

Lets try the PCA by Parent.ID, collapse the df by parent.

```{r}
 PhysioData6<-PhysioData #make a copy


Testing <- cbind(
  aggregate(PhysioData6$AFDWmg.cm2_log, by = list(PhysioData6$ParentID, PhysioData6$Treatment, PhysioData6$Species,PhysioData6$Time.Point,PhysioData6$Depth,PhysioData6$Tank.num), FUN=mean, na.rm = F))
  
  
  
  




```


# 20250404 Fig 2 Showing PCA of physio changing over time. 
```{r}
library(tidyverse)
library(vegan)     # for PCA
library(ggrepel)   # for better text labeling

PhysioData2<-PhysioData #make a copy

# Subset numeric physiological columns
physio_vars <- PhysioData2 %>% 
  dplyr::select( Calcification, `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  # include all relevant physiological columns

# Filter for T0 and duplicate the rows for both Ambient and High
T0_data_ambient <- PhysioData2 %>%
  filter(Time.Point == "T0") %>%
  mutate(Treatment = "Ambient")

T0_data_high <- PhysioData2 %>%
  filter(Time.Point == "T0") %>%
  mutate(Treatment = "High")

# Combine the two copies of T0 data (one for Ambient and one for High)
T0_data <- bind_rows(T0_data_ambient, T0_data_high)

# Remove the original T0 rows from the dataset
PhysioData_no_T0 <- PhysioData2 %>%
  filter(Time.Point != "T0")

# Combine the updated T0 data with the rest of the data
PhysioData_updated <- bind_rows(PhysioData_no_T0, T0_data)

#change calcification T0 0s into the ambient at T1 values by parent (this is to ensure PCA isn't heavily impacted by these 0s)

# First, create a lookup table of T1 Ambient calcification values by Parent.ID
T1_ambient_lookup <- PhysioData_updated %>%
  filter(Time.Point == "T1", Treatment == "Ambient") %>%
  dplyr::select(Parent.ID, Calcification) %>%
  dplyr::rename(Calcification_T1 = Calcification)

# Now, update the T0 Calcification values
PhysioData_updated2 <- PhysioData_updated %>%
  left_join(T1_ambient_lookup, by = "Parent.ID") %>%
  mutate(Calcification = ifelse(Time.Point == "T0" & Calcification == 0,
                                Calcification_T1,
                                Calcification)) %>%
  dplyr::select(-Calcification_T1)  # remove the temporary column


#select cols for the PCA
PhysioData_updated3 <- PhysioData_updated2 %>%  
  dplyr::select(Parent.ID, Treatment,Species, Time.Point, Calcification, `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  #get rid of unused cols

# Subset numeric physiological columns
physio_vars <- PhysioData_updated3 %>% 
  dplyr::select( Calcification, `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  # include all relevant physiological columns


# you have missing values. Try two ways - 1 way remove rows with missing data. Then 2. try imputation

#1
Physio_for_pca_NA<-physio_vars %>% drop_na()
PhysioData_updated3<-PhysioData_updated3 %>% drop_na()

# Scale the data
scaled_data <- scale(Physio_for_pca_NA)

# Perform PCA
pca <- prcomp(scaled_data, center = TRUE, scale. = TRUE)

# Combine scores with metadata
pca_scores <- as.data.frame(pca$x)
pca_scores <- bind_cols(pca_scores, PhysioData_updated3 %>% dplyr::select(Species, Treatment, Time.Point, Parent.ID))

# calc centroid
centroids <- pca_scores %>%
  group_by(Species, Treatment, Time.Point) %>%
  summarise(PC1 = mean(PC1), PC2 = mean(PC2), .groups = "drop")

# prepare arrows
arrows <- centroids %>%
  arrange(Species, Treatment, Time.Point) %>%
  group_by(Species, Treatment) %>%
  mutate(PC1_next = lead(PC1), PC2_next = lead(PC2)) %>%
  filter(!is.na(PC1_next))

plot<-ggplot() +
  # Plot T0 Ambient circles first (more visible, higher alpha)
  geom_point(data = pca_scores, aes(x = PC1, y = PC2, color = Treatment), alpha = 0.4) +

  # Centroids (same treatment coloring)
  geom_point(data = centroids, aes(x = PC1, y = PC2, color = Treatment), size = 4) +

  # Arrows by Treatment
  geom_segment(data = arrows, 
               aes(x = PC1, y = PC2, xend = PC1_next, yend = PC2_next, 
                   color = Treatment, linetype = Treatment), 
               arrow = arrow(length = unit(0.3, "cm")), linewidth = 0.5) +

  # Timepoint labels (optional: still colored by Species or change to Treatment if you want)
  geom_text_repel(data = centroids, 
                  aes(x = PC1, y = PC2, label = Time.Point, color = Treatment), size = 3.5) +

  # Manual color and linetype scales for Treatment ", "
  scale_color_manual(values = c("Ambient" = "deepskyblue1", "High" = "orangered")) +
  scale_linetype_manual(values = c("Ambient" = "solid", "High" = "dashed")) +

  theme_minimal() +
  labs(title = "PCA of Physiological Measurements Over Time",
       x = "PC1", y = "PC2") +
  theme(legend.position = "right")

#Facet by species
plot+facet_wrap(~Species, scales = "free", nrow=1)+

# Customize the facet titles (species names) with more specific styling
  theme(
    strip.text = element_text(face = "bold.italic", size = 14),  # Bold, italic, and larger size for all facet labels
    strip.background = element_blank()  # Optionally remove background behind the facet labels
  ) +
  
  theme_minimal() +
  labs(title = "PCA of Physiological Measurements Over Time",
       x = "PC1", y = "PC2") +
  theme(legend.position = "right")

# Save the plot to a PDF with 8x10 size
ggsave("PhysPCAAarow_plot.pdf", 
       plot = last_plot(), 
       width = 10, 
       height = 5, 
       units = "in", 
       device = "pdf")







#### Try this again but with Calcification T0 as 0 and then just removed to see how big a visual different it makes ####
# Subset numeric physiological columns
physio_vars <- PhysioData2 %>% 
  dplyr::select(  `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  # include all relevant physiological columns

# Filter for T0 and duplicate the rows for both Ambient and High
T0_data_ambient <- PhysioData2 %>%
  filter(Time.Point == "T0") %>%
  mutate(Treatment = "Ambient")

T0_data_high <- PhysioData2 %>%
  filter(Time.Point == "T0") %>%
  mutate(Treatment = "High")

# Combine the two copies of T0 data (one for Ambient and one for High)
T0_data <- bind_rows(T0_data_ambient, T0_data_high)

# Remove the original T0 rows from the dataset
PhysioData_no_T0 <- PhysioData2 %>%
  filter(Time.Point != "T0")

# Combine the updated T0 data with the rest of the data
PhysioData_updated <- bind_rows(PhysioData_no_T0, T0_data)



#select cols for the PCA
PhysioData_updated3 <- PhysioData_updated %>%  
  dplyr::select(Parent.ID, Treatment,Species, Time.Point, `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  #get rid of unused cols

# Subset numeric physiological columns
physio_vars <- PhysioData_updated3 %>% 
  dplyr::select(  `Chl a`, Protein, `Zoox Density`, AFDWmg.cm2, `Fv/Fm`, Photosynthesis, Respiration, PR)  # include all relevant physiological columns


#1
Physio_for_pca_NA<-physio_vars %>% drop_na()
PhysioData_updated3<-PhysioData_updated3 %>% drop_na()

# Scale the data
scaled_data <- scale(Physio_for_pca_NA)

# Perform PCA
pca <- prcomp(scaled_data, center = TRUE, scale. = TRUE)

# Combine scores with metadata
pca_scores <- as.data.frame(pca$x)
pca_scores <- bind_cols(pca_scores, PhysioData_updated3 %>% dplyr::select(Species, Treatment, Time.Point, Parent.ID))

# calc centroid
centroids <- pca_scores %>%
  group_by(Species, Treatment, Time.Point) %>%
  summarise(PC1 = mean(PC1), PC2 = mean(PC2), .groups = "drop")

# prepare arrows
arrows <- centroids %>%
  arrange(Species, Treatment, Time.Point) %>%
  group_by(Species, Treatment) %>%
  mutate(PC1_next = lead(PC1), PC2_next = lead(PC2)) %>%
  filter(!is.na(PC1_next))

plot<-ggplot() +
  # Plot T0 Ambient circles first (more visible, higher alpha)
  geom_point(data = pca_scores, aes(x = PC1, y = PC2, color = Treatment), alpha = 0.4) +

  # Centroids (same treatment coloring)
  geom_point(data = centroids, aes(x = PC1, y = PC2, color = Treatment), size = 4) +

  # Arrows by Treatment
  geom_segment(data = arrows, 
               aes(x = PC1, y = PC2, xend = PC1_next, yend = PC2_next, 
                   color = Treatment, linetype = Treatment), 
               arrow = arrow(length = unit(0.3, "cm")), linewidth = 0.5) +

  # Timepoint labels (optional: still colored by Species or change to Treatment if you want)
  geom_text_repel(data = centroids, 
                  aes(x = PC1, y = PC2, label = Time.Point, color = Treatment), size = 3.5) +

  # Manual color and linetype scales for Treatment ", "
  scale_color_manual(values = c("Ambient" = "deepskyblue1", "High" = "orangered")) +
  scale_linetype_manual(values = c("Ambient" = "solid", "High" = "dashed")) +

  theme_minimal() +
  labs(title = "PCA of Physiological Measurements Over Time",
       x = "PC1", y = "PC2") +
  theme(legend.position = "right")

#Facet by species
plot+facet_wrap(~Species, scales = "free", nrow=1)+

# Customize the facet titles (species names) with more specific styling
  theme(
    strip.text = element_text(face = "bold.italic", size = 14),  # Bold, italic, and larger size for all facet labels
    strip.background = element_blank()  # Optionally remove background behind the facet labels
  ) +
  
  theme_minimal() +
  labs(title = "PCA of Physiological Measurements Over Time",
       x = "PC1", y = "PC2") +
  theme(legend.position = "right")

# Save the plot to a PDF with 8x10 size
ggsave("PhysPCAAarow_NoCalc_plot.pdf", 
       plot = last_plot(), 
       width = 10, 
       height = 5, 
       units = "in", 
       device = "pdf")

```


#editing for fig 4 main manuscript 20250407 see below for more
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)


PhysioData_clean <- PhysioData %>%
  dplyr::select(-Code, -Depth, -Clade, -Tissue,-transmission, -skeleton, -shape)

# Step 1: Reshape to long format
physio_long <- PhysioData_clean %>%
  pivot_longer(cols = -c(Species, Treatment, Time.Point, Parent.ID),
               names_to = "Variable",
               values_to = "Value")

physio_long <- physio_long[complete.cases(physio_long), ] #remove NAs


# Step 2: Get T0 baseline values
T0_vals <- physio_long %>%
  filter(Time.Point == "T0") %>%
  dplyr::rename(T0_Value = Value) %>%
  dplyr::select(Species, Treatment, Parent.ID, Variable, T0_Value)

# Step 3: Join T0 values back to all timepoints
physio_pct_change <- physio_long %>%
  left_join(T0_vals, by = c("Species", "Treatment", "Parent.ID", "Variable")) %>%
  filter(Time.Point != "T0") %>%
  mutate(PercentChange = ((Value - T0_Value) / T0_Value) * 100)

# Summarize percent change by Species, Treatment, Time.Point, and Variable
summary_data <- physio_pct_change %>%
  group_by(Species, Treatment, Time.Point, Variable) %>%
  summarise(
    MeanChange = mean(PercentChange, na.rm = TRUE),
    SE = sd(PercentChange, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )


ggplot(summary_data, aes(x = Time.Point, y = MeanChange, color = Treatment)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = MeanChange - SE, ymax = MeanChange + SE),
                position = position_dodge(width = 0.5), width = 0.2) +
  geom_line(aes(group = Treatment), position = position_dodge(width = 0.5)) +
  facet_grid(Variable ~ Species, scales = "free_y") +
  scale_color_manual(values = c("Ambient" = "blue", "High" = "red")) +
  labs(y = "Percent Change from T0", x = "Time Point") +
  theme_minimal() +
  theme(strip.text.x = element_text(face = "italic", size = 12),
        strip.text.y = element_text(face = "bold", size = 11))



```
# trying again with the focus between treatments at each time point
```{r}

PhysioData_clean <- PhysioData %>%
  dplyr::select(-Code, -Depth, -Clade, -Tissue,-transmission, -skeleton, -shape)

# Step 1: Reshape to long format
physio_long <- PhysioData_clean %>%
  pivot_longer(cols = -c(Species, Treatment, Time.Point, Parent.ID),
               names_to = "Variable",
               values_to = "Value")

physio_long <- physio_long[complete.cases(physio_long), ] #remove NAs

time_data <- physio_long %>%
  filter(Time.Point %in% c("T1", "TF"))

# Separate Ambient and High
ambient <- time_data %>% filter(Treatment == "Ambient") %>% dplyr::rename(Ambient_Value = Value)
high <- time_data %>% filter(Treatment == "High") %>% dplyr::rename(High_Value = Value)

# Join and calculate percent difference
treatment_diff <- left_join(ambient, high,
                            by = c("Species", "Time.Point", "Parent.ID", "Variable")) %>%
  mutate(PercentDiff = ((High_Value - Ambient_Value) / Ambient_Value) * 100)

summary_diff <- treatment_diff %>%
  group_by(Species, Variable, Time.Point) %>%
  summarise(
    MeanDiff = mean(PercentDiff, na.rm = TRUE),
    SE = sd(PercentDiff, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

ggplot(summary_diff, aes(x = Time.Point, y = MeanDiff, fill = Time.Point)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_errorbar(aes(ymin = MeanDiff - SE, ymax = MeanDiff + SE),
                width = 0.2, position = position_dodge(width = 0.7)) +
  facet_grid(Variable ~ Species, scales = "free_y") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(y = "Percent Difference (High vs Ambient)", x = "Time Point") +
  scale_fill_manual(values = c("T1" = "#D55E00", "TF" = "#009E73")) +
  theme_minimal() +
  theme(strip.text.x = element_text(face = "italic", size = 12),
        strip.text.y = element_text(face = "bold", size = 11))

# Save the plot as a PDF
ggsave("percent_difference_plot.pdf", 
       plot = last_plot(),    # Use the most recent plot
       width = 8, height = 12, units = "in")

```
test
```{r}
# Step 1: Calculate average per Parent.ID for each timepoint and treatment
avg_by_parent <- PhysioData_clean %>%
  group_by(Species, Parent.ID, Treatment, Time.Point) %>%
  summarize(across(starts_with("Var"), mean, na.rm = TRUE)) %>%  # Replace "Var" with actual physiological variables
  ungroup()

# Step 2: Reshape to long format
physio_long_avg <- avg_by_parent %>%
  pivot_longer(cols = starts_with("Var"),  # Replace with the names of your physiological variables
               names_to = "Variable",
               values_to = "Value")

# Step 3: Get T0 baseline values (average per Parent.ID)
T0_vals_avg <- physio_long_avg %>%
  filter(Time.Point == "T0") %>%
  rename(T0_Value = Value) %>%
  select(Species, Parent.ID, Variable, T0_Value)

# Step 4: Calculate Percent Change for T1 and TF based on T0 (averaged)
physio_pct_change_avg <- physio_long_avg %>%
  left_join(T0_vals_avg, by = c("Species", "Parent.ID", "Variable")) %>%
  filter(Time.Point != "T0") %>%
  mutate(PercentChange = ((Value - T0_Value) / T0_Value) * 100)

# Step 5: Plot percent change by Species and Treatment
ggplot(physio_pct_change_avg, aes(x = Time.Point, y = PercentChange, color = Treatment, group = Parent.ID)) +
  geom_line(aes(linetype = Treatment), size = 1) +  # Lines to show the change over time
  geom_point(size = 3) +  # Add points for each time point
  facet_grid(Variable ~ Species, scales = "free_y") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Ambient" = "blue", "High" = "red")) +  # Color treatments
  scale_linetype_manual(values = c("Ambient" = "solid", "High" = "dashed")) +  # Line style
  labs(y = "Percent Change (High - Ambient)", x = "Time Point") +
  theme_minimal() +
  theme(strip.text.x = element_text(face = "italic", size = 12),
        strip.text.y = element_text(face = "bold", size = 11)) +
  theme(legend.position = "top")

```


# % change plots for defense

```{r}
 
#cell counts ####  
#data=zoox.cm2_log, df=FC_stats_T1TF
FC_pc<-FC_stats_T1TF #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","Clade","zoox.cm2")
FC_pc.k<-FC_pc[keep]

#cast
# FC_pc.2<-cast(FC_pc.k )
# FC_pc.2<-dcast(FC_pc.k, Parent.ID+Species+Time.Point~Treatment) #cast
# FC_pc.2<-na.omit(FC_pc.2) #remove NA
# 
# FC_pc.2$PercentChange<- ((FC_pc.2$High-FC_pc.2$Ambient)/FC_pc.2$Ambient)*100 #percent change equation


FC.2_mean <- ddply(FC_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(zoox.cm2[!is.na(zoox.cm2)]),
                 mean = mean((zoox.cm2), na.rm=TRUE), 
                 sd   = sd((zoox.cm2), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((zoox.cm2), na.rm=TRUE) 
)
FC.2_mean #display table 

FC.2_mean<-dcast(FC.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast
FC.2_mean$PercentChange<- ((FC.2_mean$High-FC.2_mean$Ambient)/FC.2_mean$Ambient)*100 #percent change equation
FC.2_mean$Trait<-"CellCounts"

FC.2_mean.2_mean_T1<-subset(FC.2_mean, Time.Point=="T1") #subset



#plot 
FC_T1_plot<-ggplot(data=FC.2_mean.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=4, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("Flow")+
  theme(plot.title = element_text(size=20, face = "italic"));FC_T1_plot


#biomass #### 
#data=AFDWmg.cm2, df=biomass2
biomass_pc<-biomass2 #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","AFDWmg.cm2")
biomass_pc.k<-biomass_pc[keep]

# #cast
# biomass_pc.2<-dcast(biomass_pc.k, Parent.ID+Species+Time.Point~Treatment) #cast
# biomass_pc.2<-na.omit(biomass_pc.2) #remove NA
# 
# biomass_pc.2$PercentChange<- ((biomass_pc.2$High-biomass_pc.2$Ambient)/biomass_pc.2$Ambient)*100 #percent change equation


biomass_pc.2_mean <- ddply(biomass_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(AFDWmg.cm2[!is.na(AFDWmg.cm2)]),
                 mean = mean((AFDWmg.cm2), na.rm=TRUE), 
                 sd   = sd((AFDWmg.cm2), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((AFDWmg.cm2), na.rm=TRUE) 
)
biomass_pc.2_mean #display table 

biomass_pc.2_mean<-dcast(biomass_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast
biomass_pc.2_mean$PercentChange<- ((biomass_pc.2_mean$High-biomass_pc.2_mean$Ambient)/biomass_pc.2_mean$Ambient)*100 #percent change equation
biomass_pc.2_mean$Trait<-"Biomass"




biomass_pc.2_mean_T1<-subset(biomass_pc.2_mean, Time.Point=="T1") #subset

#plot 
biomass_T1_plot<-ggplot(data=biomass_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=4, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("biomass")+
  theme(plot.title = element_text(size=20, face = "italic"));biomass_T1_plot


#calcification ####  
#data=percent.change, df=Growth3
calcification_pc<-Growth3 #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.point","percent.change")
calcification_pc.k<-calcification_pc[keep]

# #cast
# calcification_pc.2<-dcast(calcification_pc.k, Species+Parent.ID+Time.point~Treatment,mean, value.var = "percent.change") #cast use mean due to repeated 
# calcification_pc.2<-na.omit(calcification_pc.2) #remove NA
# 
# calcification_pc.2$Ambient<-calcification_pc.2$Ambient+1 #add 1 to high and ambient to deal with zeros and negatives
# calcification_pc.2$High<-calcification_pc.2$High+1


# calcification_pc.2$PercentChange<- ((calcification_pc.2$High-calcification_pc.2$Ambient)/calcification_pc.2$Ambient)*100 #percent change equation
# 

calcification_pc.2_mean <- ddply(calcification_pc.k, c( "Time.point","Species","Treatment"), summarise, #mean
                 N    = length(percent.change[!is.na(percent.change)]),
                 mean = mean((percent.change), na.rm=TRUE), 
                 sd   = sd((percent.change), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((percent.change), na.rm=TRUE) 
)
calcification_pc.2_mean #display table 

calcification_pc.2_mean<-dcast(calcification_pc.2_mean, Species+Time.point~Treatment, value.var = "mean") #cast

calcification_pc.2_mean$PercentChange<- ((calcification_pc.2_mean$High-calcification_pc.2_mean$Ambient)/calcification_pc.2_mean$Ambient)*100 #percent change equation
calcification_pc.2_mean$Trait<-"Calcification"




calcification_pc.2_mean_T1<-subset(calcification_pc.2_mean, Time.point=="time1.growth") #subset

#plot 
calcification_T1_plot<-ggplot(data=calcification_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("calcification")+
  theme(plot.title = element_text(size=20, face = "italic"));calcification_T1_plot






#Chla #### 
#data=ChlaSA, df=Chla
Chla_pc<-Chla #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","ChlaSA")
Chla_pc.k<-Chla_pc[keep]

# #cast
# Chla_pc.2<-dcast(Chla_pc.k, Parent.ID+Species+Time.Point~Treatment) #cast
# Chla_pc.2<-na.omit(Chla_pc.2) #remove NA
# 
# Chla_pc.2$PercentChange<- ((Chla_pc.2$High-Chla_pc.2$Ambient)/Chla_pc.2$Ambient)*100 #percent change equation


Chla_pc.2_mean <- ddply(Chla_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(ChlaSA[!is.na(ChlaSA)]),
                 mean = mean((ChlaSA), na.rm=TRUE), 
                 sd   = sd((ChlaSA), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((ChlaSA), na.rm=TRUE) 
)
Chla_pc.2_mean #display table 


Chla_pc.2_mean<-dcast(Chla_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

Chla_pc.2_mean$PercentChange<- ((Chla_pc.2_mean$High-Chla_pc.2_mean$Ambient)/Chla_pc.2_mean$Ambient)*100 #percent change equation

Chla_pc.2_mean$Trait<-"Chl a"




Chla_pc.2_mean_T1<-subset(Chla_pc.2_mean, Time.Point=="T1") #subset





#plot 


Chla_T1_plot<-ggplot(data=Chla_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("Chla")+
  theme(plot.title = element_text(size=20, face = "italic"));Chla_T1_plot





#Protein #### 
#data=mg.mm2, df=Protein
Protein_pc<-Protein #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","mg.mm2")
Protein_pc.k<-Protein_pc[keep]

#remove T1 372 for QC N49
Protein_pc.k <- Protein_pc.k[!(Protein_pc.k$Parent.ID == "372" & Protein_pc.k$Time.Point == "T1"),] 
# #cast
# Protein_pc.2<-dcast(Protein_pc.k, Parent.ID+Species+Time.Point~Treatment) #cast
# Protein_pc.2<-na.omit(Protein_pc.2) #remove NA
# 
# Protein_pc.2$PercentChange<- (Protein_pc.2$High-Protein_pc.2$Ambient)/Protein_pc.2$Ambient #percent change equation

Protein_pc.2_mean <- ddply(Protein_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(mg.mm2[!is.na(mg.mm2)]),
                 mean = mean((mg.mm2), na.rm=TRUE), 
                 sd   = sd((mg.mm2), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((mg.mm2), na.rm=TRUE) 
)
Protein_pc.2_mean #display table 
Protein_pc.2_mean<-dcast(Protein_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

Protein_pc.2_mean$PercentChange<- ((Protein_pc.2_mean$High-Protein_pc.2_mean$Ambient)/Protein_pc.2_mean$Ambient)*100 #percent change equation
Protein_pc.2_mean$Trait<-"Protein"




Protein_pc.2_mean_T1<-subset(Protein_pc.2_mean, Time.Point=="T1") #subset

#plot 
Protein_T1_plot<-ggplot(data=Protein_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("Protein")+
  theme(plot.title = element_text(size=20, face = "italic"));Protein_T1_plot




# 
#PAM #### 
#data=Yeild, df=PAMdata2_stats
PAM_pc<-PAM_psyDF #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","Yield")
PAM_pc.k<-PAM_pc[keep]

# #cast
# PAM_pc.2<-dcast(PAM_pc.k, Species+Parent.ID+Time.Point~Treatment,mean, value.var = "Yield") #cast use mean due to repeated 
# PAM_pc.2<-na.omit(PAM_pc.2) #remove NA
# 
# 
# PAM_pc.2$PercentChange<- (PAM_pc.2$High-PAM_pc.2$Ambient)/PAM_pc.2$Ambient #percent change equation


PAM_pc.2_mean <- ddply(PAM_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(Yield[!is.na(Yield)]),
                 mean = mean((Yield), na.rm=TRUE), 
                 sd   = sd((Yield), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((Yield), na.rm=TRUE) 
)
PAM_pc.2_mean #display table 


PAM_pc.2_mean<-dcast(PAM_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

PAM_pc.2_mean$PercentChange<- ((PAM_pc.2_mean$High-PAM_pc.2_mean$Ambient)/PAM_pc.2_mean$Ambient)*100 #percent change equation
PAM_pc.2_mean$Trait<-"Fv/Fm"




PAM_pc.2_mean_T1<-subset(PAM_pc.2_mean, Time.Point=="T1") #subset

#plot 
PAM_T1_plot<-ggplot(data=PAM_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("PAM")+
  theme(plot.title = element_text(size=20, face = "italic"));PAM_T1_plot





#Photo #### 
#data=GrossP, df=PR.df_B
Photo_pc<-PR.df_B #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","GrossP")
Photo_pc.k<-Photo_pc[keep]

# #cast
# Photo_pc.2<-dcast(Photo_pc.k, Species+Parent.ID+Time.Point~Treatment,mean, value.var = "GrossP") #cast use mean due to repeated 
# Photo_pc.2<-na.omit(Photo_pc.2) #remove NA
# 
# 
# Photo_pc.2$PercentChange<- (Photo_pc.2$High-Photo_pc.2$Ambient)/Photo_pc.2$Ambient #percent change equation


Photo_pc.2_mean <- ddply(Photo_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(GrossP[!is.na(GrossP)]),
                 mean = mean((GrossP), na.rm=TRUE), 
                 sd   = sd((GrossP), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((GrossP), na.rm=TRUE) 
)
Photo_pc.2_mean #display table 


Photo_pc.2_mean<-dcast(Photo_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

Photo_pc.2_mean$PercentChange<- ((Photo_pc.2_mean$High-Photo_pc.2_mean$Ambient)/Photo_pc.2_mean$Ambient)*100 #percent change equation
Photo_pc.2_mean$Trait<-"Gross Photosynthesis"



Photo_pc.2_mean_T1<-subset(Photo_pc.2_mean, Time.Point=="T1") #subset

#plot 
Photo_T1_plot<-ggplot(data=Photo_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("Photo")+
  theme(plot.title = element_text(size=20, face = "italic"));Photo_T1_plot



#RespPos #### 
#data=RespPos, df=PR.df_B
RespPos_pc<-PR.df_B #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","RespPos")
RespPos_pc.k<-RespPos_pc[keep]

# #cast
# RespPos_pc.2<-dcast(RespPos_pc.k, Species+Parent.ID+Time.Point~Treatment,mean, value.var = "RespPos") #cast use mean due to repeated 
# RespPos_pc.2<-na.omit(RespPos_pc.2) #remove NA
# 
# 
# RespPos_pc.2$PercentChange<- (RespPos_pc.2$High-RespPos_pc.2$Ambient)/RespPos_pc.2$Ambient #percent change equation


RespPos_pc.2_mean <- ddply(RespPos_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(RespPos[!is.na(RespPos)]),
                 mean = mean((RespPos), na.rm=TRUE), 
                 sd   = sd((RespPos), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((RespPos), na.rm=TRUE) 
)
RespPos_pc.2_mean #display table 


RespPos_pc.2_mean<-dcast(RespPos_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

RespPos_pc.2_mean$PercentChange<- ((RespPos_pc.2_mean$High-RespPos_pc.2_mean$Ambient)/RespPos_pc.2_mean$Ambient)*100 #percent change equation

RespPos_pc.2_mean$Trait<-"Respiration"



RespPos_pc.2_mean_T1<-subset(RespPos_pc.2_mean, Time.Point=="T1") #subset



#plot 
RespPos_T1_plot<-ggplot(data=RespPos_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("RespPos")+
  theme(plot.title = element_text(size=20, face = "italic"));RespPos_T1_plot






#PR #### 
#data=GrossP, df=PR.df_B 
PR_pc<-PR.df_B #make a copy of df

#keep cols you need 
keep<-c("Species","Parent.ID","Treatment","Time.Point","PR_real")
PR_pc.k<-PR_pc[keep]

# #cast
# PR_pc.2<-dcast(PR_pc.k, Species+Parent.ID+Time.Point~Treatment,mean, value.var = "PR_real") #cast use mean due to repeated 
# PR_pc.2<-na.omit(PR_pc.2) #remove NA
# 
# 
# PR_pc.2$PercentChange<- (PR_pc.2$High-PR_pc.2$Ambient)/PR_pc.2$Ambient #percent change equation


PR_pc.2_mean <- ddply(PR_pc.k, c( "Time.Point","Species","Treatment"), summarise, #mean
                 N    = length(PR_real[!is.na(PR_real)]),
                 mean = mean((PR_real), na.rm=TRUE), 
                 sd   = sd((PR_real), na.rm=TRUE),  
                 se   = sd / sqrt(N), 
                 max = max((PR_real), na.rm=TRUE) 
)
PR_pc.2_mean #display table 

PR_pc.2_mean<-dcast(PR_pc.2_mean, Species+Time.Point~Treatment, value.var = "mean") #cast

PR_pc.2_mean$PercentChange<- ((PR_pc.2_mean$High-PR_pc.2_mean$Ambient)/PR_pc.2_mean$Ambient)*100 #percent change equation

PR_pc.2_mean$Trait<-"P:R"




PR_pc.2_mean_T1<-subset(PR_pc.2_mean, Time.Point=="T1") #subset

#plot 
PR_T1_plot<-ggplot(data=PR_pc.2_mean_T1, aes(x=Species, y=PercentChange, color=Species)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Species), size=8, show.legend = T)+ 
  geom_line(aes(color=Species))+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  geom_hline(yintercept=0, linetype="dotted", size=1) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("T1 Percent Change"))) +
  ggtitle("PR")+
  theme(plot.title = element_text(size=20, face = "italic"));PR_T1_plot




# combine and then split by species #### 
names(calcification_pc.2_mean)[names(calcification_pc.2_mean) == "Time.point"] <- "Time.Point" #rename
names(calcification_pc.2_mean)[names(calcification_pc.2_mean) == "Time.point"] <- "Time.Point" #rename

calcification_pc.2_mean$Time.Point <- as.character(calcification_pc.2_mean$Time.Point)
calcification_pc.2_mean[calcification_pc.2_mean == "time1.growth"] <- "T1"
calcification_pc.2_mean[calcification_pc.2_mean == "time2.growth"] <- "TF"

PchangeDF<-rbind(biomass_pc.2_mean,FC.2_mean, calcification_pc.2_mean,PAM_pc.2_mean, Chla_pc.2_mean,
Protein_pc.2_mean,
Photo_pc.2_mean,
RespPos_pc.2_mean ,
PR_pc.2_mean)

PchangeDF_T1TF<-subset(PchangeDF, Time.Point=="T1"|Time.Point=="TF")
PchangeDF_T1TF$Trait<-as.factor(PchangeDF_T1TF$Trait)

PchangeDF_T1TF$Trait <- ordered(c("P:R","Respiration","Gross Photosynthesis","Protein", "Biomass", "Chl a", "Fv/Fm", "CellCounts"))

PchangeDF_T1TF$Trait <- factor(PchangeDF_T1TF$Trait, levels = c("P:R","Respiration","Gross Photosynthesis","Protein", "Biomass", "Chl a", "Fv/Fm", "Calcification","CellCounts"))

#mcap
PchangeDF_T1TF_mcap<-subset(PchangeDF_T1TF, Species=="Montipora capitata")
PchangeDF_T1_mcap<-subset(PchangeDF_T1TF_mcap, Time.Point=="T1")
PchangeDF_TF_mcap<-subset(PchangeDF_T1TF_mcap, Time.Point=="TF")

#pcomp
PchangeDF_T1TF_pcomp<-subset(PchangeDF_T1TF, Species=="Porites compressa")
PchangeDF_T1_pcomp<-subset(PchangeDF_T1TF_pcomp, Time.Point=="T1")
PchangeDF_TF_pcomp<-subset(PchangeDF_T1TF_pcomp, Time.Point=="TF")

#pvar
PchangeDF_T1TF_pvar<-subset(PchangeDF_T1TF, Species=="Pavona varians")
PchangeDF_T1_pvar<-subset(PchangeDF_T1TF_pvar, Time.Point=="T1")
PchangeDF_TF_pvar<-subset(PchangeDF_T1TF_pvar, Time.Point=="TF")

#pacu
PchangeDF_T1TF_pacu<-subset(PchangeDF_T1TF, Species=="Pocillopora acuta")
PchangeDF_T1_pacu<-subset(PchangeDF_T1TF_pacu, Time.Point=="T1")
PchangeDF_TF_pacu<-subset(PchangeDF_T1TF_pacu, Time.Point=="TF")

#T1####

#Mcap
#T1
Mcap_T1_plot<-ggplot(data=PchangeDF_T1_mcap, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("Mcap T1")+
  theme(plot.title = element_text(size=20, face = "italic"));Mcap_T1_plot

Mcapt1<-Mcap_T1_plot + coord_flip() 
ggsave("Mcapt1.pdf",Mcapt1, height = 11, width = 7)



#PcompT1
Pcomp_T1_plot<-ggplot(data=PchangeDF_T1_pcomp, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("Pcomp T1")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_T1_plot

Pcomp_T1_plot<-Pcomp_T1_plot + coord_flip() 
ggsave("Pcompt1.pdf",Pcomp_T1_plot, height = 11, width = 7)

#pvar
#T1
pvar_T1_plot<-ggplot(data=PchangeDF_T1_pvar, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("pvar T1")+
  theme(plot.title = element_text(size=20, face = "italic"));pvar_T1_plot

pvar_T1_plot<-pvar_T1_plot + coord_flip() 
ggsave("Pvart1.pdf",pvar_T1_plot, height = 11, width = 7)

#pacu
#T1
pacu_T1_plot<-ggplot(data=PchangeDF_T1_pacu, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-85,85)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("pacu T1")+
  theme(plot.title = element_text(size=20, face = "italic"));pacu_T1_plot

pacu_T1_plot<-pacu_T1_plot + coord_flip() 
ggsave("Pacut1aga.pdf",pacu_T1_plot, height = 11, width = 7)



grid.arrange(mcap_T1_plot, Pcomp_T1_plot, pvar_T1_plot,pacu_T1_plot, nrow = 1)



#TF#### 


#TF
mcap_TF_plot<-ggplot(data=PchangeDF_TF_mcap, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), shape=1,stroke=2,size=10,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("TF mcap")+
  theme(plot.title = element_text(size=20, face = "italic"));mcap_TF_plot

mcap_TF_plot<-mcap_TF_plot + coord_flip() 
ggsave("mcap_TF_plot.pdf",mcap_TF_plot, height = 11, width = 7)


#PcompTF
Pcomp_TF_plot<-ggplot(data=PchangeDF_TF_pcomp, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), shape=1,size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("Pcomp TF")+
  theme(plot.title = element_text(size=20, face = "italic"));Pcomp_TF_plot

Pcomp_TF_plot<-Pcomp_TF_plot + coord_flip() 
ggsave("Pcomp_TF_plot.pdf",Pcomp_TF_plot, height = 11, width = 7)

#pvar
#TF
pvar_TF_plot<-ggplot(data=PchangeDF_TF_pvar, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), shape=1,size=10,stroke=2,show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-80,80)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("pvar TF")+
  theme(plot.title = element_text(size=20, face = "italic"));pvar_TF_plot

pvar_TF_plot<-pvar_TF_plot + coord_flip() 
ggsave("pvar_TF_plot.pdf",pvar_TF_plot, height = 11, width = 7)

#pacu
#TF
pacu_TF_plot<-ggplot(data=PchangeDF_TF_pacu, aes(x=Trait, y=PercentChange, color=Trait)) +
  # geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
  #               width=0.1, show.legend = T)+
  geom_point(aes(color=Trait), shape=1,size=10,stroke=2, show.legend = F)+ 
  geom_line(aes(color=Trait), show.legend = F)+
  #scale_color_manual(values=c("dodgerblue3", "darkorange", "darkred"))+
  xlab("mean") + #Label the X Axis
  ylim(-85,85)+
  geom_hline(yintercept=0, linetype="dashed", size=.5) +
  #ylim(0,2000) + #set Y limits
   #scale_y_log10()+
       #scale_y_log10(breaks = c(0,1,100,1000, 10000), limits=c(1,5000))+
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
  ylab(expression(paste("Percent Change"))) +
  ggtitle("pacu TF")+
  theme(plot.title = element_text(size=20, face = "italic"));pacu_TF_plot

pacu_TF_plot<-pacu_TF_plot + coord_flip() 
ggsave("pacu_TF_plot.pdf",pacu_TF_plot, height = 11, width = 7)



grid.arrange(TF_TF_plot, Pcomp_TF_plot, pvar_TF_plot,pacu_TF_plot, nrow = 1)
```

#Plot mean ordi

```{r}
 
## load packagesx
library(lmerTest)
library(naniar)
library(multcomp)
library(lmtest)
library(lme4)
library(car)
library(effects)
library(gplots)
library(plotrix)
library(psych)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(MASS)
library(lsmeans)
library(pbkrtest)
library(cowplot)
library(devtools)
library(dplyr)
library(vegclust)
library(smacof) #not loading
library(devtools)
library(zoo)
library(lubridate)

#install_github("vqv/ggbiplot")
library(ggbiplot)
require(graphics)
library(tidyr)
library(vegan)

#if (!requireNamespace("BiocManager", quietly = TRUE))
#install.packages("BiocManager")
#BiocManager::install("mixOmics")
#library("mixOmics")
library(RVAideMemoire)
```

why did you do nmds for physio. not right. but euclidian is right

```{r}
AA_PhysioData<-PhysioData #copy df
AA_PhysioData$Respiration<-AA_PhysioData$Respiration*-1
AA_PhysioData<-AA_PhysioData[,c("Parent.ID","Treatment","Species", "Time.Point", "Calcification","AFDWmg.cm2","Zoox Density","Chl a","Protein", "Fv/Fm","Photosynthesis", "Respiration","PR")] # keep only columns you need


fullNMDS<-subset(AA_PhysioData, Time.Point=="T1"|Time.Point=="TF") #only T1 and TF
fullNMDS<-na.omit(fullNMDS)

#CW code
# cleaned data for full dataframe NMDS (Site, Period, dom)

fullNMDS$SpTrTi<-interaction(fullNMDS$Species, fullNMDS$Treatment, fullNMDS$Time.Point)

 fac.fullNMDS<-fullNMDS[,c("Treatment","Species", "Time.Point", "SpTrTi")] #  sans responses

resp.fullNMDS<-fullNMDS[, 5:13] # just responses

resp.fullNMDS <- scale(resp.fullNMDS, center = TRUE, scale = TRUE) 

##  Run MANOVA 
all.Manova<-adonis2(resp.fullNMDS~Species*Treatment*Time.Point, data=fullNMDS, permutations=1000,  method="euclidian")
all.Manova


allNMDS<-metaMDS(resp.fullNMDS, distance='euclidean', k=2, trymax=100) 

stressplot(allNMDS)

##### next  #### 

allNMDS.df<-data.frame(x=allNMDS$point[,1], y=allNMDS$point[,2], 
                            Species=as.factor(fac.AA_PhysioData2[,2]),
                            Treatment=as.factor(fac.AA_PhysioData2[,1]),
                            Time.Point=as.factor(fac.AA_PhysioData2[,3]),
                            SpTrTi=as.factor(fac.AA_PhysioData2[,4]))

colnames(allNMDS.df)[1:2]<-c("MDS1", "MDS2")

#centroid means
NMDS.mean=aggregate(allNMDS.df[,1:2],list(group=allNMDS.df$SpTrTi), mean) # mean by species*treatment*time


############### All groups NMDS
fullNMDS$SpTrTi<-droplevels(fullNMDS$SpTrTi)
groups<-fullNMDS$SpTrTi
groups2<-c("Montipora capitata.Ambient.T1", "Montipora capitata.Ambient.TF", "Montipora capitata.High.T1","Montipora capitata.High.TF", "Porites compressa.Ambient.T1", "Porites compressa.Ambient.TF", "Porites compressa.High.T1","Porites compressa.High.TF","Pavona varians.Ambient.T1", "Pavona varians.Ambient.TF", "Pavona varians.High.T1","Pavona varians.High.TF","Pocillopora acuta.Ambient.T1", "Pocillopora acuta.Ambient.TF", "Pocillopora acutaa.High.T1","Pocillopora acuta.High.TF")
colors=c(
  "#F8766D", #Mcap 
  "#C77CFF", #Porites
  "#7CAE00", # Pvar
  "#00BFC4" # Pacu
   ) 
plot<-ordiplot(allNMDS, type="n", cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8) #ylim=c(-0.3, 0.3))
axis(side = 1, labels = FALSE)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
ordihull(plot, groups=paste(fullNMDS$Species,fullNMDS$Treatment), draw="polygon", alpha=20, col=c("#F8766D", "#7CAE00","#00BFC4","#C77CFF"), border=F)

# points for start and end
with(plot, points(NMDS.mean[5,2], NMDS.mean[5,3], bg="white", col=colors[1], pch=21, cex=4, lwd=1)) #mcap T1 H
with(plot, points(NMDS.mean[1,2], NMDS.mean[1,3], col=colors[1], pch=16, cex=4, lwd=1)) # Mcap A T1
with(plot, points(NMDS.mean[13,2], NMDS.mean[13,3], bg="white",col=colors[1], pch=24, cex=4, lwd=1)) #mcap TF H
with(plot, points(NMDS.mean[9,2], NMDS.mean[9,3], col=colors[1], pch=17, cex=4, lwd=1)) # Mcap A TF

with(plot, points(NMDS.mean[8,2], NMDS.mean[8,3], bg="white", col=colors[2], pch=21, cex=4, lwd=1)) # Pcomp H T1
with(plot, points(NMDS.mean[4,2], NMDS.mean[4,3], col=colors[2], pch=16, cex=4, lwd=1)) # Pcomp  A T1
with(plot, points(NMDS.mean[16,2], NMDS.mean[16,3], bg="white", col=colors[2], pch=24, cex=4, lwd=1)) # Pcomp H TF
with(plot, points(NMDS.mean[12,2], NMDS.mean[12,3], col=colors[2], pch=17, cex=4, lwd=1)) # PcompA TF

with(plot, points(NMDS.mean[6,2], NMDS.mean[6,3], bg="white", col=colors[3], pch=21, cex=4, lwd=1)) # Pvar H T1
with(plot, points(NMDS.mean[2,2], NMDS.mean[2,3], col=colors[3], pch=16, cex=4, lwd=1)) # Pvar A T1
with(plot, points(NMDS.mean[14,2], NMDS.mean[14,3], bg="white", col=colors[3], pch=24, cex=4, lwd=1)) # Pvar H TF
with(plot, points(NMDS.mean[10,2], NMDS.mean[10,3], col=colors[3], pch=17, cex=4, lwd=1)) # Pvar A TF

with(plot, points(NMDS.mean[7,2], NMDS.mean[7,3], bg="white", col=colors[4], pch=21, cex=4, lwd=1)) # Pacu H T1
with(plot, points(NMDS.mean[3,2], NMDS.mean[3,3], col=colors[4], pch=16, cex=4, lwd=1)) # Pac A Ta
with(plot, points(NMDS.mean[15,2], NMDS.mean[15,3], bg="white", col=colors[4], pch=24, cex=4, lwd=1)) # Pacu H TF
with(plot, points(NMDS.mean[11,2], NMDS.mean[11,3], col=colors[4], pch=17, cex=4, lwd=1)) # Pac A TF



# # points for others (if want)
# with(plot, points(NMDS.mean[2,2], NMDS.mean[2,3], col=colors[1], pch=16, cex=1, lwd=1)) # Lil C
# with(plot, points(NMDS.mean[3,2], NMDS.mean[3,3], col=colors[1], pch=16, cex=1, lwd=1)) # Lil C
# with(plot, points(NMDS.mean[6,2], NMDS.mean[6,3], col=colors[2], pch=16, cex=1, lwd=1)) # R14 C
# with(plot, points(NMDS.mean[7,2], NMDS.mean[7,3], col=colors[2], pch=16, cex=1, lwd=1)) # R14 C
# with(plot, points(NMDS.mean[10,2], NMDS.mean[10,3], col=colors[3], pch=16, cex=1, lwd=1)) # Lil D
# with(plot, points(NMDS.mean[11,2], NMDS.mean[11,3], col=colors[3], pch=16, cex=1, lwd=1)) # Lil D
# with(plot, points(NMDS.mean[14,2], NMDS.mean[14,3], col=colors[4], pch=16, cex=1, lwd=1)) # R14 D
# with(plot, points(NMDS.mean[15,2], NMDS.mean[15,3], col=colors[4], pch=16, cex=1, lwd=1)) # R14 D

# lines for start and end
with(plot, lines(NMDS.mean[c(1,9),2], NMDS.mean[c(1,9),3], lwd=1.5, col =colors[1], lty=1))# Mcap A
with(plot, lines(NMDS.mean[c(5,13),2], NMDS.mean[c(5,13),3], lwd=1.5, col =colors[1], lty=2))# Mcap H
with(plot, lines(NMDS.mean[c(8,16),2], NMDS.mean[c(8,16),3], lwd=1.5, col =colors[2], lty=2))# Pcomp H
with(plot, lines(NMDS.mean[c(4,12),2], NMDS.mean[c(4,12),3], lwd=1.5, col =colors[2], lty=1))# Pcomp A
with(plot, lines(NMDS.mean[c(6, 14),2], NMDS.mean[c(6,14),3], lwd=1.5, col =colors[3], lty=2))# Pvar H
with(plot, lines(NMDS.mean[c(2,10),2], NMDS.mean[c(2,10),3], lwd=1.5, col =colors[3], lty=1))# Pvar A
with(plot, lines(NMDS.mean[c(7,15),2], NMDS.mean[c(7,15),3], lwd=1.5, col =colors[4], lty=2))# Pacu H
with(plot, lines(NMDS.mean[c(3,11),2], NMDS.mean[c(3,11),3], lwd=1.5, col =colors[4], lty=1))# Pacu A

# add labels
text(0, -4, "Montipora capitata", cex=0.8, col=colors[1])
text(-5, -3, "Porites compressa", cex=0.8, col=colors[2])
text(4, -3, "Pavona varians", cex=0.8, col=colors[3])
text(4, 2, "Pocillopora acuta", cex=0.8, col=colors[4])

text(-6, -4.5, "2D Stress = 0.14", cex=0.8, col="black")
legend("topright", legend=groups2, inset=c(0.03, -0.01), x.intersp=0.6, y.intersp=0.9, cex=0.7, pch=16, col=colors, lty=c(1,3,1,3), seg.len=2, pt.cex=1, bty="n")

dev.copy(pdf, "PhysioNMDS.pdf", height=5.5, width=6, useDingbats=FALSE)
dev.off() 


```

Try T0 apDataT0

```{r}

AA_PhysioT0<-apDataT0 #copy df
AA_PhysioT0$Respiration<-AA_PhysioT0$Respiration*-1
AA_PhysioT0<-AA_PhysioT0[,c("Parent.ID","Treatment","Species", "Time.Point","AFDWmg.cm2","zoox.cm2_log","Chl a","Protein", "Yield","Photosynthesis", "Respiration","PR")] # keep only columns you need



# T0NMDS<-subset(AA_PhysioData, Time.Point=="T1"|Time.Point=="TF") #only T1 and TF
T0NMDS<-na.omit(AA_PhysioT0)
#CW code
# cleaned data for T0 dataframe NMDS (Site, Period, dom)

T0NMDS$SpTrTi<-interaction(T0NMDS$Species, T0NMDS$Treatment, T0NMDS$Time.Point)

 fac.T0NMDS<-T0NMDS[,c("Treatment","Species", "Time.Point", "SpTrTi")] #  sans responses

resp.T0NMDS<-T0NMDS[, 5:12] # just responses

resp.T0NMDS <- scale(resp.T0NMDS, center = TRUE, scale = TRUE) 

##  Run MANOVA 
all.Manova<-adonis2(resp.T0NMDS~Species, data=T0NMDS, permutations=1000,  method="euclidian")
all.Manova


allNMDS<-metaMDS(resp.T0NMDS, distance='euclidean', k=2, trymax=100) 

stressplot(allNMDS)

##### next  #### 

allNMDS.df<-data.frame(x=allNMDS$point[,1], y=allNMDS$point[,2], 
                            Species=as.factor(fac.T0NMDS[,2]))

colnames(allNMDS.df)[1:2]<-c("MDS1", "MDS2")

#centroid means
NMDS.mean=aggregate(allNMDS.df[,1:2],list(group=allNMDS.df$Species), mean) # mean by species*treatment*time

############### All groups NMDS
T0NMDS$Species<-droplevels(T0NMDS$Species)
groups<-T0NMDS$Species
groups2<-c("Montipora capitata", "Porites compressa","Pavona varians","Pocillopora acuta")
colors=c(
  "#F8766D", #Mcap 
  "#C77CFF", #Porites
  "#7CAE00", # Pvar
  "#00BFC4" # Pacu
   ) 
plot<-ordiplot(allNMDS, type="n", cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8) #ylim=c(-0.3, 0.3))
axis(side = 1, labels = FALSE)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
ordihull(plot, groups=paste(T0NMDS$Species), draw="polygon", alpha=20, col=c("#F8766D", "#7CAE00","#00BFC4","#C77CFF"), border=F)

# points for start and end
with(plot, points(NMDS.mean[1,2], NMDS.mean[1,3],  col=colors[1], pch=16, cex=4, lwd=1)) #mcap 
with(plot, points(NMDS.mean[2,2], NMDS.mean[2,3], col=colors[3], pch=16, cex=4, lwd=1)) # Pav
with(plot, points(NMDS.mean[3,2], NMDS.mean[3,3], col=colors[4], pch=16, cex=4, lwd=1)) #poc
with(plot, points(NMDS.mean[4,2], NMDS.mean[4,3], col=colors[2], pch=16, cex=4, lwd=1)) # por





# # points for others (if want)
# with(plot, points(NMDS.mean[2,2], NMDS.mean[2,3], col=colors[1], pch=16, cex=1, lwd=1)) # Lil C
# with(plot, points(NMDS.mean[3,2], NMDS.mean[3,3], col=colors[1], pch=16, cex=1, lwd=1)) # Lil C
# with(plot, points(NMDS.mean[6,2], NMDS.mean[6,3], col=colors[2], pch=16, cex=1, lwd=1)) # R14 C
# with(plot, points(NMDS.mean[7,2], NMDS.mean[7,3], col=colors[2], pch=16, cex=1, lwd=1)) # R14 C
# with(plot, points(NMDS.mean[10,2], NMDS.mean[10,3], col=colors[3], pch=16, cex=1, lwd=1)) # Lil D
# with(plot, points(NMDS.mean[11,2], NMDS.mean[11,3], col=colors[3], pch=16, cex=1, lwd=1)) # Lil D
# with(plot, points(NMDS.mean[14,2], NMDS.mean[14,3], col=colors[4], pch=16, cex=1, lwd=1)) # R14 D
# with(plot, points(NMDS.mean[15,2], NMDS.mean[15,3], col=colors[4], pch=16, cex=1, lwd=1)) # R14 D

# lines for start and end
with(plot, lines(NMDS.mean[c(1,9),2], NMDS.mean[c(1,9),3], lwd=1.5, col =colors[1], lty=1))# Mcap A
with(plot, lines(NMDS.mean[c(5,13),2], NMDS.mean[c(5,13),3], lwd=1.5, col =colors[1], lty=2))# Mcap H
with(plot, lines(NMDS.mean[c(8,16),2], NMDS.mean[c(8,16),3], lwd=1.5, col =colors[2], lty=2))# Pcomp H
with(plot, lines(NMDS.mean[c(4,12),2], NMDS.mean[c(4,12),3], lwd=1.5, col =colors[2], lty=1))# Pcomp A
with(plot, lines(NMDS.mean[c(6, 14),2], NMDS.mean[c(6,14),3], lwd=1.5, col =colors[3], lty=2))# Pvar H
with(plot, lines(NMDS.mean[c(2,10),2], NMDS.mean[c(2,10),3], lwd=1.5, col =colors[3], lty=1))# Pvar A
with(plot, lines(NMDS.mean[c(7,15),2], NMDS.mean[c(7,15),3], lwd=1.5, col =colors[4], lty=2))# Pacu H
with(plot, lines(NMDS.mean[c(3,11),2], NMDS.mean[c(3,11),3], lwd=1.5, col =colors[4], lty=1))# Pacu A

# add labels
text(0, -4, "Montipora capitata", cex=0.8, col=colors[1])
text(-5, -3, "Porites compressa", cex=0.8, col=colors[2])
text(4, -3, "Pavona varians", cex=0.8, col=colors[3])
text(4, 2, "Pocillopora acuta", cex=0.8, col=colors[4])

text(-6, -4.5, "2D Stress = 0.14", cex=0.8, col="black")
legend("topright", legend=groups2, inset=c(0.03, -0.01), x.intersp=0.6, y.intersp=0.9, cex=0.7, pch=16, col=colors, lty=c(1,3,1,3), seg.len=2, pt.cex=1, bty="n")

dev.copy(pdf, "PhysioNMDS.pdf", height=5.5, width=6, useDingbats=FALSE)
dev.off() 
```
